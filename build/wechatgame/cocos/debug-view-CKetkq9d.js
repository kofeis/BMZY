System.register(["./gc-object-CKHc4SnS.js","./global-exports-CR3GRnjt.js","./device-manager-BvjvoelW.js","./buffer-barrier-CuX_5NUR.js","./index-C5lmLqDW.js","./pipeline-state-manager-Cdpe3is6.js","./scene-7MDSMR3j.js","./component-BaGvu7EF.js"],(function(t){"use strict";var e,i,n,r,s,o,a,h,u,_,c,l,d,f,p,m,w,g,T,y,E,R,v,P,C,I,b,A,N,S,x,F,O,k,D,V,M,L,j,W,z,G,U,B;return{setters:[function(t){e=t.a,i=t.w,n=t._,r=t.h,s=t.n},function(t){o=t.c},function(t){a=t.d},function(t){h=t.C,u=t.ac,_=t.ad,c=t.x,l=t.F,d=t.y,f=t.R,p=t.p,m=t.ae,w=t.af,g=t.f},function(t){T=t.u,y=t.w,E=t.k,R=t.M,v=t.l,P=t.b,C=t.R,I=t.Z,b=t.e,A=t.f,N=t.x,S=t.F,x=t.c,F=t.g,O=t.A,k=t.V,D=t.Q,V=t.C,M=t._,L=t.a,j=t.s},function(t){W=t.C},function(t){z=t.i,G=t.T,U=t.m},function(t){B=t.A}],execute:function(){var H,X,Y,K,Z,Q,q,J;t("k",Tt),t("b",H),function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(H||t("b",H={})),t("C",X),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(X||t("C",X={})),t("c",Y),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(Y||t("c",Y={})),t("e",K),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(K||t("e",K={})),t("d",Z),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(Z||t("d",Z={})),t("f",Q),function(t){t[t.DEFAULT=-1]="DEFAULT",t[t.LEFT_EYE=0]="LEFT_EYE",t[t.RIGHT_EYE=1]="RIGHT_EYE",t[t.MAIN=2]="MAIN"}(Q||t("f",Q={})),t("T",q),function(t){t[t.NO_TRACKING=0]="NO_TRACKING",t[t.POSITION_AND_ROTATION=1]="POSITION_AND_ROTATION",t[t.POSITION=2]="POSITION",t[t.ROTATION=3]="ROTATION"}(q||t("T",q={})),t("j",J),function(t){t[t.EDITOR=0]="EDITOR",t[t.GAME_VIEW=1]="GAME_VIEW",t[t.SCENE_VIEW=2]="SCENE_VIEW",t[t.PREVIEW=3]="PREVIEW",t[t.GAME=100]="GAME"}(J||t("j",J={}));var $,tt=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],et=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],it=[100,200,400,800],nt=T(),rt=T(),st=y();t("a",$),function(t){t[t.VALUE=h.STENCIL<<1]="VALUE"}($||t("a",$={})),t("p",$.VALUE);var ot,at=[],ht=0,ut=(t("g",function(){function t(t){if(this.isWindowSize=!0,this.screenScale=1,this.postProcess=null,this.usePostProcess=!1,this.pipeline="",this.pipelineSettings=null,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=1,this._orthoHeight=10,this._fovAxis=H.VERTICAL,this._fov=A(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new _(.2,.2,.2,1),this._viewport=N(0,0,1,1),this._orientedViewport=N(0,0,1,1),this._curTransform=u.IDENTITY,this._isProjDirty=!0,this._matView=y(),this._matProj=y(),this._matProjInv=y(),this._matViewProj=y(),this._matViewProjInv=y(),this._frustum=new S,this._forward=T(),this._position=T(),this._priority=0,this._aperture=Y.F16_0,this._shutter=Z.D125,this._shutterValue=0,this._iso=K.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=h.NONE,this._clearDepth=1,this._visibility=W,this._exposure=0,this._clearStencil=0,this._geometryRenderer=null,this._windowId=0,this._cameraType=Q.DEFAULT,this._trackingType=q.NO_TRACKING,this._usage=J.GAME,this._cameraId=ht++,this._device=t,this._apertureValue=tt[this._aperture],this._shutterValue=et[this._shutter],this._isoValue=it[this._iso],this._frustum.accurate=!0,!at.length){var e=t.capabilities.clipSpaceSignY;at[u.IDENTITY]=new R(1,0,0,0,0,e),at[u.ROTATE_90]=new R(0,1,0,0,-e,0),at[u.ROTATE_180]=new R(-1,0,0,0,0,-e),at[u.ROTATE_270]=new R(0,-1,0,0,e,0)}}var n=t.prototype;return n._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||u.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},n.initialize=function(t){void 0!==t.usage?this._usage=t.usage:this.setDefaultUsage(),void 0!==t.trackingType&&(this._trackingType=t.trackingType),void 0!==t.cameraType&&(this._cameraType=t.cameraType),this.node=t.node,this._width=1,this._height=1,this.clearFlag=h.NONE,this.clearDepth=1,this.visibility=W,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},n.destroy=function(){var t;this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,null==(t=this._geometryRenderer)||t.destroy()},n.attachToScene=function(t){this._enabled=!0,this._scene=t},n.detachFromScene=function(){this._enabled=!1,this._scene=null},n.resize=function(t,e){this._window&&(this._width=t,this._height=e,this._aspect=t*this._viewport.width/(e*this._viewport.height),this._isProjDirty=!0)},n.setFixedSize=function(t,e){this._width=t,this._height=e,this._updateAspect(),this.isWindowSize=!1},n.syncCameraEditor=function(){},n.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var i=!1,n=globalThis.__globalXR;if(n&&n.isWebXR&&n.webXRWindowMap&&n.updateViewport){var r=n.webXRMatProjs?1/n.webXRMatProjs.length:1,s=n.webXRWindowMap.get(this._window);this.setViewportInOrientedSpace(new E(r*s,0,r,1))}var o=this._forward,a=this._matView,h=this._matProj;(this._node.hasChangedFlags||t)&&(R.invert(a,this._node.worldMatrix),o.x=-a.m02,o.y=-a.m06,o.z=-a.m10,R.multiply(a,(new R).scale(this._node.worldScale),a),this._node.getWorldPosition(this._position),i=!0);var _=null==(e=this.window)?void 0:e.swapchain,c=_&&_.surfaceTransform||u.IDENTITY;if(this._isProjDirty||this._curTransform!==c){this._curTransform=c;var l=this._device.capabilities.clipSpaceSignY;if(this._proj===X.PERSPECTIVE)if(n&&n.isWebXR&&n.webXRWindowMap&&n.webXRMatProjs){var d=n.webXRWindowMap.get(this._window);h.set(n.webXRMatProjs[d])}else R.perspective(h,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===H.VERTICAL,this._device.capabilities.clipSpaceMinZ,l,c);else{var f=this._orthoHeight*this._aspect,p=this._orthoHeight;R.ortho(h,-f,f,-p,p,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,l,c)}R.invert(this._matProjInv,h),i=!0,this._isProjDirty=!1}i&&(R.multiply(this._matViewProj,h,a),R.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},n.setViewportInOrientedSpace=function(t){var e,i=t.x,n=t.width,r=t.height,s=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,o=null==(e=this.window)?void 0:e.swapchain;switch(o&&o.surfaceTransform||u.IDENTITY){case u.ROTATE_90:this._viewport.x=1-s-r,this._viewport.y=i,this._viewport.width=r,this._viewport.height=n;break;case u.ROTATE_180:this._viewport.x=1-i-n,this._viewport.y=1-s-r,this._viewport.width=n,this._viewport.height=r;break;case u.ROTATE_270:this._viewport.x=s,this._viewport.y=1-i-n,this._viewport.width=r,this._viewport.height=n;break;case u.IDENTITY:this._viewport.x=i,this._viewport.y=s,this._viewport.width=n,this._viewport.height=r}this._orientedViewport.x=i,this._orientedViewport.y=s,this._orientedViewport.width=n,this._orientedViewport.height=r,this.resize(this.width,this.height)},n.initGeometryRenderer=function(){if(!this._geometryRenderer){var t,e=o.internal.GeometryRenderer;this._geometryRenderer=e?new e:null,null==(t=this._geometryRenderer)||t.activate(this._device)}},n.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||o.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var i=e.swapchain;(i&&i.surfaceTransform||u.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},n.detachCamera=function(){this._window&&this._window.detachCamera(this)},n.screenPointToRay=function(t,e,i){if(!this._node)return null;var n=this.width,r=this.height,s=this._orientedViewport.x*n,o=this._orientedViewport.y*r,a=this._orientedViewport.width*n,h=this._orientedViewport.height*r,u=this._proj===X.PERSPECTIVE,_=this._device.capabilities.clipSpaceSignY,c=v[this._curTransform];P.set(nt,(e-s)/a*2-1,(i-o)/h*2-1,u?1:-1);var l=nt.x,d=nt.y;return nt.x=l*c[0]+d*c[2]*_,nt.y=l*c[1]+d*c[3]*_,P.transformMat4(u?nt:t.o,nt,this._matViewProjInv),u?(this._node.getWorldPosition(rt),C.fromPoints(t,rt,nt)):P.transformQuat(t.d,P.FORWARD,this._node.worldRotation),t},n.screenToWorld=function(t,e){var i=this.width,n=this.height,r=this._orientedViewport.x*i,s=this._orientedViewport.y*n,o=this._orientedViewport.width*i,a=this._orientedViewport.height*n,h=this._device.capabilities.clipSpaceSignY,u=v[this._curTransform];if(this._proj===X.PERSPECTIVE){P.set(t,(e.x-r)/o*2-1,(e.y-s)/a*2-1,1);var _=t.x,c=t.y;t.x=_*u[0]+c*u[2]*h,t.y=_*u[1]+c*u[3]*h,P.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(nt),P.lerp(t,nt,t,I(this._nearClip/this._farClip,1,e.z))}else{P.set(t,(e.x-r)/o*2-1,(e.y-s)/a*2-1,2*e.z-1);var l=t.x,d=t.y;t.x=l*u[0]+d*u[2]*h,t.y=l*u[1]+d*u[3]*h,P.transformMat4(t,t,this._matViewProjInv)}return t},n.worldToScreen=function(t,e){var i=this._device.capabilities.clipSpaceSignY,n=v[this._curTransform];P.transformMat4(t,e,this._matViewProj);var r=t.x,s=t.y;t.x=r*n[0]+s*n[2]*i,t.y=r*n[1]+s*n[3]*i;var o=this.width,a=this.height,h=this._orientedViewport.x*o,u=this._orientedViewport.y*a,_=this._orientedViewport.width*o,c=this._orientedViewport.height*a;return t.x=h+.5*(t.x+1)*_,t.y=u+.5*(t.y+1)*c,t.z=.5*t.z+.5,t},n.worldMatrixToScreen=function(t,e,i,n){R.multiply(t,this._matViewProj,e),R.multiply(t,at[this._curTransform],t);var r=i/2,s=n/2;return R.identity(st),R.transform(st,st,P.set(nt,r,s,0)),R.scale(st,st,P.set(nt,r,s,1)),R.multiply(t,st,t),t},n.calculateObliqueMat=function(t){var e=new b(Math.sign(t.x),Math.sign(t.y),1,1).transformMat4(this._matProjInv),i=new b(this._matProj.m03,this._matProj.m07,this._matProj.m11,this._matProj.m15),n=2/b.dot(t,e),r=t.multiplyScalar(n).subtract(i);this._matProj.m02=r.x,this._matProj.m06=r.y,this._matProj.m10=r.z,this._matProj.m14=r.w},n.getClipSpaceMinz=function(){return this._device.capabilities.clipSpaceMinZ},n.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},n.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},n.setDefaultUsage=function(){this._usage=J.GAME},e(t,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"systemWindowId",get:function(){return this._windowId}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=tt[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=et[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=it[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(t){i(8302),this.setViewportInOrientedSpace(t)}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"cameraId",get:function(){return this._cameraId}},{key:"surfaceTransform",get:function(){return this._curTransform}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"cameraType",get:function(){return this._cameraType},set:function(t){this._cameraType=t}},{key:"trackingType",get:function(){return this._trackingType},set:function(t){this._trackingType=t}},{key:"cameraUsage",get:function(){return this._usage},set:function(t){this._usage=t}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}()),new c);ut.format=l.RGBA8;var _t=new d;_t.format=l.DEPTH_STENCIL;var ct,lt,dt=new f([ut],_t),ft={width:1,height:1,renderPassInfo:dt},pt=t("R",x("cc.RenderTexture")(ot=function(t){function i(e){var i;return(i=t.call(this,e)||this)._window=null,i}n(i,t);var s=i.prototype;return s.initialize=function(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)},s.reset=function(t){this.initialize(t)},s.destroy=function(){if(this._window){var e=o.director.root;null==e||e.destroyWindow(this._window),this._window=null}return t.prototype.destroy.call(this)},s.resize=function(t,e){this._width=Math.floor(F(t,1,2048)),this._height=Math.floor(F(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},s._serialize=function(){return{}},s._deserialize=function(e,i){var n=e;this._width=n.w,this._height=n.h,this._name=n.n,t.prototype._deserialize.call(this,n.base,i)},s.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},s.onLoaded=function(){this._initWindow()},s._initWindow=function(t){var e=o.director.root;ft.title=this._name,ft.width=this._width,ft.height=this._height,ft.renderPassInfo=t&&t.passInfo?t.passInfo:dt,ft.externalResLow=t&&t.externalResLow?t.externalResLow:0,ft.externalResHigh=t&&t.externalResHigh?t.externalResHigh:0,ft.externalFlag=t&&t.externalFlag?t.externalFlag:p.NONE,ft.renderPassInfo.colorAttachments.forEach((function(t){t.format=e.device.swapchainFormat})),ut.barrier=a.gfxDevice.getGeneralBarrier(new m(w.FRAGMENT_SHADER_READ_TEXTURE,w.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(a.gfxDevice,ft)):this._window=e.createWindow(ft)},s.initDefault=function(e){t.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},s.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},s.readPixels=function(t,e,i,n,s){t=t||0,e=e||0,i=i||this.width,n=n||this.height;var o=this.getGFXTexture();if(!o)return r(7606),null;var a=4*i*n;if(void 0===s)s=new Uint8Array(a);else if(s.length<a)return r(7607,a),null;var h=this._getGFXDevice(),u=[],_=[],c=new g;return c.texOffset.x=t,c.texOffset.y=e,c.texExtent.width=i,c.texExtent.height=n,_.push(c),u.push(s),null==h||h.copyTextureToBuffers(o,u,_),s},e(i,[{key:"window",get:function(){return this._window}}]),i}(z))||ot);o.RenderTexture=pt,t("m",ct),function(t){t[t.SKYBOX=$.VALUE|h.DEPTH_STENCIL]="SKYBOX",t[t.SOLID_COLOR=h.ALL]="SOLID_COLOR"}(ct||t("m",ct={})),t("n",lt),function(t){t[t.CUBE=0]="CUBE",t[t.PLANAR=1]="PLANAR"}(lt||t("n",lt={}));var mt,wt=[T(0,-90,0),T(0,90,0),T(90,0,0),T(-90,0,0),T(0,0,0),T(0,180,0)],gt=T();function Tt(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var i=e*e,n=(.860117757+.000154118254*e+1.28641212e-7*i)/(1+.000842420235*e+7.08145163e-7*i),r=(.317398726+422806245e-13*e+4.20481691e-8*i)/(1-289741816e-13*e+1.61456053e-7*i),s=2*n-8*r+4,o=3*n/s,a=2*r/s,h=1/a*o,u=1/a*(1-o-a);t.x=3.2404542*h-1.5371385+-.4985314*u,t.y=-.969266*h+1.8760108+.041556*u,t.z=.0556434*h-.2040259+1.0572252*u}t("o",function(){function t(t){this.bakedCubeTextures=[],this.realtimePlanarTexture=null,this._resolution=256,this._clearFlag=ct.SKYBOX,this._backgroundColor=new V(0,0,0,255),this._visibility=W,this._probeType=lt.CUBE,this._cubemap=null,this._size=T(1,1,1),this._camera=null,this._probeId=0,this._needRefresh=!1,this._needRender=!1,this._node=null,this._cameraNode=null,this._boundingBox=null,this._cameraWorldPos=T(),this._cameraWorldRotation=M(),this._forward=T(),this._up=T(),this._previewSphere=null,this._previewPlane=null,this._probeId=t}var i=t.prototype;return i.initialize=function(t,e){this._node=t,this._cameraNode=e,this.node.getWorldPosition(gt);var i=this._size;this._boundingBox=O.create(gt.x,gt.y,gt.z,i.x,i.y,i.z),this._createCamera(e)},i.initBakedTextures=function(){if(0===this.bakedCubeTextures.length)for(var t=0;t<6;t++){var e=this._createTargetTexture(this._resolution,this._resolution);this.bakedCubeTextures.push(e)}},i.captureCubemap=function(){this.initBakedTextures(),this._resetCameraParams(),this._needRender=!0},i.renderPlanarReflection=function(t){if(t){if(!this.realtimePlanarTexture){var e=o.view.getDesignResolutionSize();this.realtimePlanarTexture=this._createTargetTexture(e.width,e.height),o.internal.reflectionProbeManager.updatePlanarMap(this,this.realtimePlanarTexture.getGFXTexture())}this._syncCameraParams(t),this._transformReflectionCamera(t),this._needRender=!0}},i.switchProbeType=function(t,e){t===lt.CUBE?this._needRender=!1:null!==e&&this.renderPlanarReflection(e)},i.getProbeId=function(){return this._probeId},i.updateProbeId=function(t){this._probeId=t},i.renderArea=function(){return this._probeType===lt.PLANAR?new k(this.realtimePlanarTexture.width,this.realtimePlanarTexture.height):new k(this.resolution,this.resolution)},i.isFinishedRendering=function(){return!0},i.validate=function(){return null!==this.cubemap},i.destroy=function(){this._camera&&(this._camera.destroy(),this._camera=null);for(var t=0;t<this.bakedCubeTextures.length;t++)this.bakedCubeTextures[t].destroy();this.bakedCubeTextures=[],this.realtimePlanarTexture&&(this.realtimePlanarTexture.destroy(),this.realtimePlanarTexture=null)},i.enable=function(){},i.disable=function(){},i.updateCameraDir=function(t){this.cameraNode.setRotationFromEuler(wt[t]),this.camera.update(!0)},i.updateBoundingBox=function(){if(this.node){this.node.getWorldPosition(gt);var t=this._size;O.set(this._boundingBox,gt.x,gt.y,gt.z,t.x,t.y,t.z)}},i.hasFrameBuffer=function(t){if(this.probeType===lt.PLANAR){var e;if(!this.realtimePlanarTexture)return!1;if((null==(e=this.realtimePlanarTexture.window)?void 0:e.framebuffer)===t)return!0}else{if(0===this.bakedCubeTextures.length)return!1;for(var i=0;i<this.bakedCubeTextures.length;i++){var n;if((null==(n=this.bakedCubeTextures[i].window)?void 0:n.framebuffer)===t)return!0}}return!1},i.isRGBE=function(){return!0},i._syncCameraParams=function(t){this.camera.projectionType=t.projectionType,this.camera.orthoHeight=t.orthoHeight,this.camera.nearClip=t.nearClip,this.camera.farClip=t.farClip,this.camera.fov=t.fov,this.camera.clearFlag=t.clearFlag,this.camera.clearColor=t.clearColor,this.camera.priority=t.priority-1,this.camera.resize(t.width,t.height)},i._createCamera=function(t){var e=o.director.root;if(!this._camera){if(this._camera=e.createCamera(),!this._camera)return null;this._camera.initialize({name:t.name,node:t,projection:X.PERSPECTIVE,window:e&&e.tempWindow,priority:0,cameraType:Q.DEFAULT,trackingType:q.NO_TRACKING})}return this._camera.setViewportInOrientedSpace(new E(0,0,1,1)),this._camera.fovAxis=H.VERTICAL,this._camera.fov=A(90),this._camera.orthoHeight=10,this._camera.nearClip=1,this._camera.farClip=1e3,this._camera.clearColor=this._backgroundColor,this._camera.clearDepth=1,this._camera.clearStencil=0,this._camera.clearFlag=this._clearFlag,this._camera.visibility=this._visibility,this._camera.aperture=Y.F16_0,this._camera.shutter=Z.D125,this._camera.iso=K.ISO100,this._camera},i._resetCameraParams=function(){this.camera.projectionType=X.PERSPECTIVE,this.camera.orthoHeight=10,this.camera.nearClip=1,this.camera.farClip=1e3,this.camera.fov=A(90),this.camera.priority=0,this.camera.resize(this.resolution,this.resolution),this.camera.visibility=this._visibility,this.camera.clearFlag=this._clearFlag,this.camera.clearColor=this._backgroundColor,this.cameraNode.worldPosition=this.node.worldPosition,this.cameraNode.worldRotation=this.node.worldRotation,this.camera.update(!0)},i._createTargetTexture=function(t,e){var i=new pt;return i.reset({width:t,height:e}),i},i._transformReflectionCamera=function(t){var e=P.dot(this.node.worldPosition,this.node.up);this._reflect(this._cameraWorldPos,t.node.worldPosition,this.node.up,e),this.cameraNode.worldPosition=this._cameraWorldPos,P.transformQuat(this._forward,P.FORWARD,t.node.worldRotation),this._reflect(this._forward,this._forward,this.node.up,0),this._forward.normalize(),this._forward.negative(),P.transformQuat(this._up,P.UP,t.node.worldRotation),this._reflect(this._up,this._up,this.node.up,0),this._up.normalize(),D.fromViewUp(this._cameraWorldRotation,this._forward,this._up),this.cameraNode.worldRotation=this._cameraWorldRotation,this.camera.update(!0);var i=new b(this.node.up.x,this.node.up.y,this.node.up.z,-P.dot(this.node.up,this.node.worldPosition));i.transformMat4(this.camera.matView.clone().invert().transpose()),this.camera.calculateObliqueMat(i)},i._reflect=function(t,e,i,n){var r=P.clone(i);r.normalize();var s=P.dot(r,e)-n;return r.multiplyScalar(2*s),P.subtract(t,e,r),t},e(t,[{key:"probeType",get:function(){return this._probeType},set:function(t){this._probeType=t}},{key:"resolution",get:function(){return this._resolution},set:function(t){t!==this._resolution&&this.bakedCubeTextures.forEach((function(e){e.resize(t,t)})),this._resolution=t}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t,this.camera.clearFlag=this._clearFlag}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(t){this._backgroundColor=t,this.camera.clearColor=this._backgroundColor}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t,this._camera.visibility=this._visibility}},{key:"size",get:function(){return this._size},set:function(t){this._size.set(t),this.node.getWorldPosition(gt),O.set(this._boundingBox,gt.x,gt.y,gt.z,t.x,t.y,t.z)}},{key:"cubemap",get:function(){return this._cubemap},set:function(t){this._cubemap=t}},{key:"node",get:function(){return this._node}},{key:"camera",get:function(){return this._camera}},{key:"needRefresh",get:function(){return this._needRefresh},set:function(t){this._needRefresh=t}},{key:"needRender",get:function(){return this._needRender},set:function(t){this._needRender=t}},{key:"boundingBox",get:function(){return this._boundingBox}},{key:"cameraNode",get:function(){return this._cameraNode},set:function(t){this._cameraNode=t}},{key:"previewSphere",get:function(){return this._previewSphere},set:function(t){this._previewSphere=t}},{key:"previewPlane",get:function(){return this._previewPlane},set:function(t){this._previewPlane=t}}]),t}()),t("O",function(){function t(){this._enabled=!1,this._minPos=new P(0,0,0),this._maxPos=new P(0,0,0),this._depth=0}return t.prototype.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},e(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}}]),t}()),t("S",function(){function t(){this._enabled=!0,this._blurRadius=.01,this._sssIntensity=3}return t.prototype.initialize=function(t){this._enabled=t.enabled,this._blurRadius=t.blurRadius,this._sssIntensity=t.sssIntensity},e(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"blurRadius",get:function(){return this._blurRadius},set:function(t){this._blurRadius=t}},{key:"sssIntensity",get:function(){return this._sssIntensity},set:function(t){this._sssIntensity=t}}]),t}()),t("L",mt),function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.POINT=3]="POINT",t[t.RANGED_DIRECTIONAL=4]="RANGED_DIRECTIONAL",t[t.UNKNOWN=5]="UNKNOWN"}(mt||t("L",mt={})),t("q",(function(t){return 4*Math.PI*Math.PI*t*t})),t("l",function(){function t(){this._baked=!1,this._color=T(1,1,1),this._colorTemp=6550,this._colorTempRGB=T(1,1,1),this._finalColor=T(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=mt.UNKNOWN,this._visibility=W}var i=t.prototype;return i.initialize=function(){this.color=T(1,1,1),this.colorTemperature=6550},i.attachToScene=function(t){this._scene=t},i.detachFromScene=function(){this._scene=null},i.destroy=function(){this._name=null,this._node=null},i.update=function(){},e(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t),this._useColorTemperature&&P.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,t&&P.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,Tt(this._colorTempRGB,this._colorTemp),this._useColorTemperature&&P.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"finalColor",get:function(){return this._finalColor}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=G.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}}]),t}());var yt,Et,Rt,vt,Pt=t("i",x("cc.SceneAsset")((Et=function(t){function e(e){var i;return(i=t.call(this,e)||this).scene=Rt&&Rt(),i}n(e,t);var i=e.prototype;return i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.scene=new U("New Scene")},i.validate=function(){return!!this.scene},e}(B),Rt=L(Et.prototype,"scene",[j],(function(){return null})),yt=Et))||yt);o.SceneAsset=Pt,t("P",vt),function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(vt||t("P",vt={})),t("h",function(t){function e(){var e;return(e=t.call(this)||this).eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e}n(e,t);var i=e.prototype;return i.on=function(t,e,i,n){return this.eventTargetOn(t,e,i,n)},i.once=function(t,e,i){return this.eventTargetOnce(t,e,i)},e}(s));var Ct=t("s",{NONE:0,VERTEX_COLOR:1,VERTEX_NORMAL:2,VERTEX_TANGENT:3,WORLD_POS:4,VERTEX_MIRROR:5,FACE_SIDE:6,UV0:7,UV1:8,UV_LIGHTMAP:9,PROJ_DEPTH:10,LINEAR_DEPTH:11,FRAGMENT_NORMAL:12,FRAGMENT_TANGENT:13,FRAGMENT_BINORMAL:14,BASE_COLOR:15,DIFFUSE_COLOR:16,SPECULAR_COLOR:17,TRANSPARENCY:18,METALLIC:19,ROUGHNESS:20,SPECULAR_INTENSITY:21,IOR:22,DIRECT_DIFFUSE:23,DIRECT_SPECULAR:24,DIRECT_ALL:25,ENV_DIFFUSE:26,ENV_SPECULAR:27,ENV_ALL:28,EMISSIVE:29,LIGHT_MAP:30,SHADOW:31,AO:32,FRESNEL:33,DIRECT_TRANSMIT_DIFFUSE:34,DIRECT_TRANSMIT_SPECULAR:35,ENV_TRANSMIT_DIFFUSE:36,ENV_TRANSMIT_SPECULAR:37,TRANSMIT_ALL:38,DIRECT_TRT:39,ENV_TRT:40,TRT_ALL:41,FOG:42}),It=t("r",{DIRECT_DIFFUSE:0,DIRECT_SPECULAR:1,ENV_DIFFUSE:2,ENV_SPECULAR:3,EMISSIVE:4,LIGHT_MAP:5,SHADOW:6,AO:7,NORMAL_MAP:8,FOG:9,TONE_MAPPING:10,GAMMA_CORRECTION:11,FRESNEL:12,TRANSMIT_DIFFUSE:13,TRANSMIT_SPECULAR:14,TRT:15,TT:16,MAX_BIT_COUNT:17});t("D",function(){function t(){this._singleMode=Ct.NONE,this._compositeModeValue=0,this._lightingWithAlbedo=!0,this._csmLayerColoration=!1,this._activate()}var i=t.prototype;return i.isCompositeModeEnabled=function(t){return!!(this._compositeModeValue&1<<t)},i.enableCompositeMode=function(t,e){this._enableCompositeMode(t,e),this._updatePipeline()},i.enableAllCompositeMode=function(t){this._enableAllCompositeMode(t),this._updatePipeline()},i.isEnabled=function(){return 0!==this._getType()},i.reset=function(){this._activate(),this._updatePipeline()},i._activate=function(){this._singleMode=Ct.NONE,this._enableAllCompositeMode(!0),this._lightingWithAlbedo=!0,this._csmLayerColoration=!1},i._updatePipeline=function(){var t=o.director.root,e=t.pipeline,i=this._getType();e.macros.CC_USE_DEBUG_VIEW!==i&&(e.macros.CC_USE_DEBUG_VIEW=i,t.onGlobalPipelineStateChanged())},i._enableCompositeMode=function(t,e){e?this._compositeModeValue|=1<<t:this._compositeModeValue&=~(1<<t)},i._enableAllCompositeMode=function(t){for(var e=0;e<It.MAX_BIT_COUNT;e++)t?this._compositeModeValue|=1<<e:this._compositeModeValue&=~(1<<e)},i._getType=function(){if(this._singleMode!==Ct.NONE)return 1;if(!0!==this._lightingWithAlbedo||!1!==this._csmLayerColoration)return 2;for(var t=0;t<It.MAX_BIT_COUNT;t++)if(!this.isCompositeModeEnabled(t))return 2;return 0},e(t,[{key:"singleMode",get:function(){return this._singleMode},set:function(t){this._singleMode=t,this._updatePipeline()}},{key:"lightingWithAlbedo",get:function(){return this._lightingWithAlbedo},set:function(t){this._lightingWithAlbedo=t,this._updatePipeline()}},{key:"csmLayerColoration",get:function(){return this._csmLayerColoration},set:function(t){this._csmLayerColoration=t,this._updatePipeline()}},{key:"debugViewType",get:function(){return this._getType()}}]),t}())}}}));
