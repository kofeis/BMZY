System.register(["./gc-object-CKHc4SnS.js","./index-C5lmLqDW.js","./global-exports-CR3GRnjt.js","./component-BaGvu7EF.js","./rendering-sub-mesh-CowWLfXC.js","./factory-D9_8ZCqM.js","./debug-view-CKetkq9d.js","./scene-7MDSMR3j.js","./device-manager-BvjvoelW.js","./buffer-barrier-CuX_5NUR.js","./pipeline-state-manager-Cdpe3is6.js","./wasm-minigame-DoCiKH-Y.js","./deprecated-T2yM9nsJ.js","./director-DIlqD2Nd.js","./zlib.min-CyXMsivM.js"],(function(t,e){"use strict";var r,n,i,s,a,u,o,f,c,h,d,l,v,_,m,g,w,x,p,b,y,A,T,B,I,E,M,R,P,U,S,O,V,N,D,F,C,L,G,k,z,j,H,X,W,q,J,Q,Z,K,Y;return{setters:[function(t){r=t.a,n=t.l,i=t.w,s=t.x,a=t.Q,u=t.R,o=t.L,f=t._,c=t.j,h=t.h},function(t){d=t.H,l=t.b,v=t.A,_=t.c,m=t.u,g=t.Q,w=t.a,x=t.m,p=t.s,b=t.q},function(t){y=t.c},function(t){A=t.A},function(t){T=t.R},function(t){B=t.P,I=t.I,E=t.T,M=t.W},null,function(t){R=t.k},function(t){P=t.d},function(t){U=t.a,S=t.B,O=t.b,V=t.M,N=t.F,D=t.o,F=t.A,C=t.D,L=t.a8,G=t.c,k=t.v,z=t.u,j=t.m},function(t){H=t.e,X=t.f,W=t.g,q=t.h,J=t.j},function(t){Q=t.e,Z=t.i},function(t){K=t.g},null,function(t){Y=t._}],execute:function(){t({d:Vt,i:Nt});var $=t("B",function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var r=t-e;this._arrayBufferOrPaddings.push(r),this._length+=r}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(r){"number"==typeof r?e+=r:(t.set(new Uint8Array(r),e),e+=r.byteLength)})),t.buffer},t}());function tt(t,e){return new et(t,e)}var et=function(){function t(t,e){if(this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var r=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(r).fill(null);for(var n=0;n<r;++n){var i=this._mesh.struct.morph.subMeshMorphs[n];i&&(i.targets.length>H.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[n]=new nt(this._mesh,n,this._mesh.struct.morph,e):this._subMeshRenderings[n]=new rt(this._mesh,n,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,r=new Array(e),n=0;n<e;++n){var i,s;r[n]=null!==(i=null==(s=this._subMeshRenderings[n])?void 0:s.createInstance())&&void 0!==i?i:null}return{setWeights:function(t,e){var n;null==(n=r[t])||n.setWeights(e)},requiredPatches:function(e){a(t._mesh.struct.morph);var n=t._mesh.struct.morph.subMeshMorphs[e],i=r[e];if(null===i)return null;var s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(U.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(U.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(U.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push.apply(s,i.requiredPatches()),s},adaptPipelineState:function(t,e){var n;null==(n=r[t])||n.adaptPipelineState(e)},destroy:function(){r.forEach((function(t){t&&t.destroy()}))}}},t}(),rt=function(){function t(t,e,r,n){this._gfxDevice=n;var i=r.subMeshMorphs[e];this._subMeshMorph=i,ut(t,e,n);var s=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=s;var a=i.targets.length,u=at(n,s*a);this._textureInfo={width:u.width,height:u.height},this._attributes=i.attributes.map((function(e,r){var n=u.create(),a=n.valueView;return i.targets.forEach((function(e,n){for(var i=e.displacements[r],u=new Float32Array(t.data.buffer,t.data.byteOffset+i.offset,i.count),o=s*n*4,f=0;f<s;++f)a[o+4*f+0]=u[3*f+0],a[o+4*f+1]=u[3*f+1],a[o+4*f+2]=u[3*f+2]})),n.updatePixels(),{name:e,morphTexture:n}}))}var e=t.prototype;return e.destroy=function(){this._attributes.forEach((function(t){t.morphTexture.destroy()}))},e.createInstance=function(){var t=this,e=new st(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(r){for(var n=0;n<t._attributes.length;++n){var s=t._attributes[n],a=void 0;switch(s.name){case U.ATTR_POSITION:a=J;break;case U.ATTR_NORMAL:a=q;break;case U.ATTR_TANGENT:a=W;break;default:i(16374)}void 0!==a&&(r.bindSampler(a,s.morphTexture.sampler),r.bindTexture(a,s.morphTexture.texture))}r.bindBuffer(X.BINDING,e.buffer),r.update()},destroy:function(){}}},t}(),nt=function(){function t(t,e,r,n){this._attributes=[],this._gfxDevice=n;var i=r.subMeshMorphs[e];ut(t,e,n),this._attributes=i.attributes.map((function(e,r){return{name:e,targets:i.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[r].offset,e.displacements[r].count)}}))}}))}return t.prototype.createInstance=function(){return new it(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},r(t,[{key:"data",get:function(){return this._attributes}}]),t}(),it=function(){function t(t,e,r){this._owner=t,this._morphUniforms=new st(r,0);var n=at(r,e);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=n.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var r=this._attributes[e],i=r.morphTexture.valueView,s=this._owner.data[e];n(t.length===s.targets.length);for(var a=0;a<s.targets.length;++a){var u=s.targets[a].displacements,o=t[a],f=u.length/3;if(0===a)for(var c=0;c<f;++c)i[4*c+0]=u[3*c+0]*o,i[4*c+1]=u[3*c+1]*o,i[4*c+2]=u[3*c+2]*o;else if(0!==o)for(var h=0;h<f;++h)i[4*h+0]+=u[3*h+0]*o,i[4*h+1]+=u[3*h+1]*o,i[4*h+2]+=u[3*h+2]*o}r.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e=0;e<this._attributes.length;++e){var r=this._attributes[e],n=void 0;switch(r.attributeName){case U.ATTR_POSITION:n=J;break;case U.ATTR_NORMAL:n=q;break;case U.ATTR_TANGENT:n=W;break;default:i(16374)}void 0!==n&&(t.bindSampler(n,r.morphTexture.sampler),t.bindTexture(n,r.morphTexture.texture))}t.bindBuffer(X.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),st=function(){function t(t,e){this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(H.SIZE)),this._remoteBuffer=t.createBuffer(new S(O.UNIFORM|O.TRANSFER_DST,V.HOST|V.DEVICE,H.SIZE,H.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){n(t.length===this._targetCount);for(var e=y.sys.isLittleEndian,r=0;r<t.length;++r)this._localBuffer.setFloat32(H.OFFSET_OF_WEIGHTS+4*r,t[r],e)},e.setMorphTextureInfo=function(t,e){var r=y.sys.isLittleEndian;this._localBuffer.setFloat32(H.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,r),this._localBuffer.setFloat32(H.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,r)},e.setVerticesCount=function(t){var e=y.sys.isLittleEndian;this._localBuffer.setFloat32(H.OFFSET_OF_VERTICES_COUNT,t,e)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},r(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function at(t,e){var r,n,s,a;t.getFormatFeatures(N.RGBA32F)&D.SAMPLED_TEXTURE?(r=e,s=16,n=B.RGBA32F,a=Float32Array):(r=4*e,s=4,n=B.RGBA8888,a=Uint8Array);var u=ot(r),o=u.width,f=u.height;return{width:o,height:f,create:function(){var e=new ArrayBuffer(o*f*s),r=new Float32Array(e),u=a===Float32Array?r:new a(e),c=new I({width:o,height:f,_data:u,_compressed:!1,format:n}),h=new R;h.setFilters(E.NEAREST,E.NEAREST),h.setMipFilter(E.NONE),h.setWrapMode(M.CLAMP_TO_EDGE,M.CLAMP_TO_EDGE,M.CLAMP_TO_EDGE),h.image=c,h.getGFXTexture()||i(16375);var d=t.getSampler(h.getSamplerInfo());return{get texture(){return h.getGFXTexture()},get sampler(){return d},get valueView(){return r},destroy:function(){h.destroy()},updatePixels:function(){h.uploadData(u)}}}}}function ut(t,e,r){t.renderingSubMeshes[e].enableVertexIdChannel(r)}function ot(t){t<5&&(t=5);var e=d(t),r=s(e),n=r>>1;return{width:1<<(1&r?n+1:n),height:1<<n}}var ft,ct,ht,dt,lt,vt={};K.onPostInfrastructureInitDelegate.add((function(){return Q().then((function(){return Promise.all([e.import("./meshopt_decoder.wasm-DKe5VOQW.js"),e.import("./meshopt_decoder.wasm-Cvy1kpGq.js")]).then((function(t){var e,r,n=t[0].default,i=t[1].default;return e=n,r=i,Promise.all([e.ready((function(t){return Z(r,t)}))]).then((function(){vt.supported=e.supported,vt.ready=Promise.resolve(),vt.decodeVertexBuffer=e.decodeVertexBuffer,vt.decodeIndexBuffer=e.decodeIndexBuffer,vt.decodeIndexSequence=e.decodeIndexSequence,vt.decodeGltfBuffer=e.decodeGltfBuffer,vt.useWorkers=e.useWorkers,vt.decodeGltfBufferAsync=e.decodeGltfBufferAsync,u(14203)}))}))})).catch((function(t){o(t)}))}));var _t=l.add,mt=l.multiplyScalar,gt=l.subtract,wt=v.transform,xt=v.fromPoints,pt=l.max,bt=l.min,yt=l.transformQuat,At=l.transformMat4;function Tt(t){switch(t){case 1:default:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}}var Bt=new l,It=new l,Et=new Uint8Array,Mt=t("M",_("cc.Mesh")((ct=function(t){function e(e){var r;return(r=t.call(this,e)||this).morphRendering=null,r._struct=ht&&ht(),r._hash=dt&&dt(),r._data=Et,r._initialized=!1,r._allowDataAccess=lt&&lt(),r._isMeshDataUploaded=!1,r._renderingSubMeshes=null,r._boneSpaceBounds=new Map,r._jointBufferIndices=null,r}f(e,t);var s=e.prototype;return s.onLoaded=function(){this.initialize()},s.initialize=function(){if(!this._initialized){this._initialized=!0;var t={struct:this.struct,data:this.data};if(t.struct.compressed&&(t=Nt(t)),this.struct.encoded&&(t=Vt(t)),!this.struct.quantized||P.gfxDevice.getFormatFeatures(N.RGB16F)&D.VERTEX_ATTRIBUTE||(t=Dt(t)),this._struct=t.struct,this._data=t.data,this._struct.dynamic){for(var e=P.gfxDevice,r=[],n=[],s=0;s<this._struct.vertexBundles.length;s++){var a=this._struct.vertexBundles[s],u=e.createBuffer(new S(O.VERTEX|O.TRANSFER_DST,V.DEVICE,a.view.length,a.view.stride));r.push(u)}for(var o=0;o<this._struct.primitives.length;o++){var f=this._struct.primitives[o],c=f.indexView,h=null;c&&(h=e.createBuffer(new S(O.INDEX|O.TRANSFER_DST,V.DEVICE,c.length,c.stride)));for(var d=[],l=0;l<f.vertexBundelIndices.length;l++){var v=f.vertexBundelIndices[l];d.push(r[v])}for(var _=[],m=0;m<f.vertexBundelIndices.length;m++)for(var g=f.vertexBundelIndices[m],w=this._struct.vertexBundles[g].attributes,x=0;x<w.length;x++){var p=w[x],b=new F;b.copy(p),_.push(b)}var y=new T(d,_,f.primitiveMode,h);y.drawInfo=new C,y.mesh=this,y.subMeshIdx=o,n.push(y)}this._renderingSubMeshes=n}else{for(var A=this._data.buffer,B=P.gfxDevice,I=this._createVertexBuffers(B,A),E=[],M=[],R=0;R<this._struct.primitives.length;R++){var U=this._struct.primitives[R];if(0!==U.vertexBundelIndices.length){var G=null,k=void 0;if(U.indexView){var z=U.indexView,j=z.stride,H=z.length;if(4===j&&!B.hasFeature(L.ELEMENT_INDEX_UINT)){var X=this._struct.vertexBundles[U.vertexBundelIndices[0]].view.count;if(X>=65536){i(10001,X,65536);continue}j>>=1,H>>=1}G=B.createBuffer(new S(O.INDEX,V.DEVICE,H,j)),E.push(G),k=new(Tt(z.stride))(A,z.offset,z.count),z.stride!==j&&(k=Tt(j).from(k)),G.update(k)}var W=U.vertexBundelIndices.map((function(t){return I[t]})),q=[];if(U.vertexBundelIndices.length>0)for(var J=U.vertexBundelIndices[0],Q=this._struct.vertexBundles[J].attributes,Z=0;Z<Q.length;++Z){var K=Q[Z];q[Z]=new F(K.name,K.format,K.isNormalized,K.stream,K.isInstanced,K.location)}var Y=new T(W,q,U.primitiveMode,G);Y.mesh=this,Y.subMeshIdx=R,M.push(Y)}}this._renderingSubMeshes=M,this._struct.morph&&(this.morphRendering=tt(this,B)),this._isMeshDataUploaded=!0,this._allowDataAccess||this.releaseData()}}},s.updateSubMesh=function(t,e){if(this._struct.dynamic)if(t>=this._struct.primitives.length)i(14201);else{var r=[];if(e.positions.length>0&&r.push(e.positions),e.normals&&e.normals.length>0&&r.push(e.normals),e.uvs&&e.uvs.length>0&&r.push(e.uvs),e.tangents&&e.tangents.length>0&&r.push(e.tangents),e.colors&&e.colors.length>0&&r.push(e.colors),e.customAttributes)for(var s=0;s<e.customAttributes.length;s++)r.push(e.customAttributes[s].values);for(var a=this._struct.dynamic,u=a.info,o=this._struct.primitives[t],f=this._renderingSubMeshes[t],c=f.drawInfo,h=0;h<r.length;h++){var d=r[h],l=this._struct.vertexBundles[o.vertexBundelIndices[h]],_=l.view.stride,g=d.byteLength/_,w=d.byteLength,x=new Uint8Array(this._data.buffer,l.view.offset,w),p=new Uint8Array(d.buffer,d.byteOffset,w),b=f.vertexBuffers[h];n(g<=u.maxSubMeshVertices),w>0&&(x.set(p),b.update(p,w)),l.view.count=g,c.vertexCount=g}if(o.indexView){var y=o.indexView,A=y.stride,T=2===A?e.indices16.length:e.indices32.length,B=T*A,I=new Uint8Array(this._data.buffer,y.offset,B),E=2===A?new Uint8Array(e.indices16.buffer,e.indices16.byteOffset,B):new Uint8Array(e.indices32.buffer,e.indices32.byteOffset,B),M=f.indexBuffer;n(T<=u.maxSubMeshIndices),B>0&&(I.set(E),M.update(E,B)),y.count=T,c.indexCount=T}if(e.minPos&&e.maxPos){var R=m(e.minPos.x,e.minPos.y,e.minPos.z),P=m(e.maxPos.x,e.maxPos.y,e.maxPos.z);a.bounds[t]||(a.bounds[t]=new v),xt(a.bounds[t],R,P);var U=m(),S=m();a.bounds.forEach((function(t){t&&(t.getBoundary(U,S),bt(R,U,R),pt(P,S,P))})),this._struct.minPosition=m(R.x,R.y,R.z),this._struct.maxPosition=m(P.x,P.y,P.z)}f.invalidateGeometricInfo()}else i(14200)},s.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},s.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1,this._isMeshDataUploaded=!1}},s.assign=function(t,e){this.reset({struct:t,data:e})},s.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},s.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var r=[],n=t.bindposes,i=0;i<n.length;i++)e.push(new v(1/0,1/0,1/0,-1/0,-1/0,-1/0)),r.push(!1);for(var s=this._struct.primitives,a=0;a<s.length;a++){var u=this.readAttribute(a,U.ATTR_JOINTS),o=this.readAttribute(a,U.ATTR_WEIGHTS),f=this.readAttribute(a,U.ATTR_POSITION);if(u&&o&&f)for(var c=Math.min(u.length/4,o.length/4,f.length/3),h=0;h<c;h++){l.set(Bt,f[3*h+0],f[3*h+1],f[3*h+2]);for(var d=0;d<4;++d){var _=4*h+d,m=u[_];if(!(0===o[_]||m>=n.length)){At(It,Bt,n[m]),r[m]=!0;var g=e[m];bt(g.center,g.center,It),pt(g.halfExtents,g.halfExtents,It)}}}}for(var w=0;w<n.length;w++){var x=e[w];r[w]?xt(x,x.center,x.halfExtents):e[w]=null}return e},s.merge=function(t,e,r){if(r&&!this.validateMergingMesh(t))return!1;var n=new l,i=e&&new g,s=e&&new v;if(i&&e.getRotation(i),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),u=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(_t(s.center,a.maxPosition,a.minPosition),mt(s.center,s.center,.5),gt(s.halfExtents,a.maxPosition,a.minPosition),mt(s.halfExtents,s.halfExtents,.5),wt(s,s,e),_t(a.maxPosition,s.center,s.halfExtents),gt(a.minPosition,s.center,s.halfExtents));for(var o=0;o<a.vertexBundles.length;o++)for(var f=a.vertexBundles[o],h=0;h<f.attributes.length;h++)if(f.attributes[h].name===U.ATTR_POSITION||f.attributes[h].name===U.ATTR_NORMAL){var d=f.attributes[h].format,_=new DataView(u.buffer,f.view.offset+Rt(f.attributes,h)),m=St(_,d),w=Ot(_,d);if(!m||!w)continue;for(var x=f.view.count,p=f.view.stride,b=Ut(d),y=0;y<x;y++){var A=y*p,T=A+b,B=T+b;switch(n.set(m(A),m(T),m(B)),f.attributes[h].name){case U.ATTR_POSITION:n.transformMat4(e);break;case U.ATTR_NORMAL:yt(n,n,i)}w(A,n.x),w(T,n.y),w(B,n.z)}}}return this.reset({struct:a,data:u}),this.initialize(),!0}for(var I,E,M,R,P,S=new $,O=0,V=0,N=0,D=0,F=0,C=0,L=0,k=0,z=!1,j=new Array(this._struct.vertexBundles.length),H=0;H<this._struct.vertexBundles.length;++H){var X=this._struct.vertexBundles[H],W=t._struct.vertexBundles[H];N=X.view.offset,D=W.view.offset,V=X.view.stride,O=X.view.count+W.view.count,I=new ArrayBuffer(O*V),E=new Uint8Array(I),N+=(M=this._data.subarray(N,N+X.view.length)).length,D+=(R=t._data.subarray(D,D+W.view.length)).length,E.set(M),F=0;for(var q,J=c(X.attributes);!(q=J()).done;){var Q=q.value;L=0,z=!1;for(var Z,K=c(W.attributes);!(Z=K()).done;){var Y=Z.value;if(Q.name===Y.name&&Q.format===Y.format){z=!0;break}L+=G[Y.format].size}if(z){k=G[Q.format].size,C=X.view.length+F;for(var tt=0;tt<W.view.count;++tt){if(P=R.subarray(L,L+k),E.set(P,C),(Q.name===U.ATTR_POSITION||Q.name===U.ATTR_NORMAL)&&e){var et=new Float32Array(E.buffer,C,3);switch(n.set(et[0],et[1],et[2]),Q.name){case U.ATTR_POSITION:n.transformMat4(e);break;case U.ATTR_NORMAL:yt(n,n,i)}et[0]=n.x,et[1]=n.y,et[2]=n.z}C+=X.view.stride,L+=W.view.stride}}F+=G[Q.format].size}j[H]={attributes:X.attributes,view:{offset:S.getLength(),length:I.byteLength,count:O,stride:V}},S.addBuffer(I)}for(var rt,nt,it,st=0,at=2,ut=new Array(this._struct.primitives.length),ot=0;ot<this._struct.primitives.length;++ot){var ft=this._struct.primitives[ot],ct=t._struct.primitives[ot];ut[ot]={primitiveMode:ft.primitiveMode,vertexBundelIndices:ft.vertexBundelIndices};for(var ht,dt=0,lt=c(ft.vertexBundelIndices);!(ht=lt()).done;){var vt=ht.value;dt=Math.max(dt,this._struct.vertexBundles[vt].view.count)}if(ft.indexView&&ct.indexView){st=ft.indexView.count,st+=ct.indexView.count,N=ft.indexView.offset,D=ct.indexView.offset,at=st<256?1:st<65536?2:4;var xt=new ArrayBuffer(st*at);if(rt=2===at?new Uint16Array(xt):1===at?new Uint8Array(xt):new Uint32Array(xt),nt=2===ft.indexView.stride?new Uint16Array(this._data.buffer,N,ft.indexView.count):1===ft.indexView.stride?new Uint8Array(this._data.buffer,N,ft.indexView.count):new Uint32Array(this._data.buffer,N,ft.indexView.count),at===ft.indexView.stride)rt.set(nt);else for(var At=0;At<ft.indexView.count;++At)rt[At]=nt[At];N+=ft.indexView.length,it=2===ct.indexView.stride?new Uint16Array(t._data.buffer,D,ct.indexView.count):1===ct.indexView.stride?new Uint8Array(t._data.buffer,D,ct.indexView.count):new Uint32Array(t._data.buffer,D,ct.indexView.count);for(var Tt=0;Tt<ct.indexView.count;++Tt)rt[ft.indexView.count+Tt]=dt+it[Tt];D+=ct.indexView.length,ut[ot].indexView={offset:S.getLength(),length:xt.byteLength,count:st,stride:at},S.setNextAlignment(at),S.addBuffer(xt)}}var Bt={vertexBundles:j,primitives:ut,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return Bt.minPosition&&t._struct.minPosition&&Bt.maxPosition&&t._struct.maxPosition&&(e?(_t(s.center,t._struct.maxPosition,t._struct.minPosition),mt(s.center,s.center,.5),gt(s.halfExtents,t._struct.maxPosition,t._struct.minPosition),mt(s.halfExtents,s.halfExtents,.5),wt(s,s,e),_t(n,s.center,s.halfExtents),pt(Bt.maxPosition,Bt.maxPosition,n),gt(n,s.center,s.halfExtents),bt(Bt.minPosition,Bt.minPosition,n)):(bt(Bt.minPosition,Bt.minPosition,t._struct.minPosition),pt(Bt.maxPosition,Bt.maxPosition,t._struct.maxPosition))),this.reset({struct:Bt,data:new Uint8Array(S.getCombined())}),this.initialize(),!0},s.validateMergingMesh=function(t){if(this._struct.dynamic||t._struct.dynamic)return!1;if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var r=this._struct.vertexBundles[e],n=t._struct.vertexBundles[e];if(r.attributes.length!==n.attributes.length)return!1;for(var i=0;i<r.attributes.length;++i)if(r.attributes[i].format!==n.attributes[i].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var s=0;s<this._struct.primitives.length;++s){var a=this._struct.primitives[s],u=t._struct.primitives[s];if(a.vertexBundelIndices.length!==u.vertexBundelIndices.length)return!1;for(var o=0;o<a.vertexBundelIndices.length;++o)if(a.vertexBundelIndices[o]!==u.vertexBundelIndices[o])return!1;if(a.primitiveMode!==u.primitiveMode)return!1;if(a.indexView){if(void 0===u.indexView)return!1}else if(u.indexView)return!1}return!0},s.readAttribute=function(t,e){var r=this,n=null;return this._accessAttribute(t,e,(function(t,e){var i=t.view.count,s=t.attributes[e].format,a=k(G[s]);if(0!==i){var u=new DataView(r._data.buffer,t.view.offset+Rt(t.attributes,e)),o=G[s],f=St(u,s);if(a&&f){for(var c=o.count,h=new a(i*c),d=t.view.stride,l=0;l<i;++l)for(var v=0;v<c;++v)h[c*l+v]=f(d*l+h.BYTES_PER_ELEMENT*v);n=h}}})),n},s.copyAttribute=function(t,e,r,n,i){var s=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var u=t.view.count;if(0!==u){var o=t.attributes[e].format,f=new DataView(s._data.buffer,t.view.offset+Rt(t.attributes,e)),c=new DataView(r,i),h=G[o],d=St(f,o),l=Ot(c,o);if(d&&l){for(var v=h.count,_=t.view.stride,m=Ut(o),g=n,w=m,x=0;x<u;++x)for(var p=0;p<v;++p)l(g*x+w*p,d(_*x+m*p));a=!0}}else a=!0})),a},s.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var r=e.indexView.stride;return new(1===r?Uint8Array:2===r?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},s.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var r=this._struct.primitives[t];if(!r.indexView)return!1;for(var n=r.indexView.count,i=1===r.indexView.stride?N.R8UI:2===r.indexView.stride?N.R16UI:N.R32UI,s=St(new DataView(this._data.buffer),i),a=0;a<n;++a)e[a]=s(r.indexView.offset+G[i].size*a);return!0},s.readAttributeFormat=function(t,e){var r=null;return this._accessAttribute(t,e,(function(t,e){var n=t.attributes[e].format;r=G[n]})),r},s._accessAttribute=function(t,e,r){if(!(t>=this._struct.primitives.length))for(var n=this._struct.primitives[t].vertexBundelIndices,i=0;i<n.length;i++){var s=n[i],a=this._struct.vertexBundles[s],u=a.attributes.findIndex((function(t){return t.name===e}));if(!(u<0)){r(a,u);break}}},s._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(r){var n=t.createBuffer(new S(O.VERTEX,V.DEVICE,r.view.length,r.view.stride)),i=new Uint8Array(e,r.view.offset,r.view.length);return n.update(i),n}))},s.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:Et})},s.releaseData=function(){this._data=Et},r(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=j(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}},{key:"allowDataAccess",get:function(){return this._allowDataAccess},set:function(t){this._allowDataAccess=t,this._isMeshDataUploaded&&!this._allowDataAccess&&this.releaseData()}}]),e}(A),ht=w(ct.prototype,"_struct",[p],(function(){return{vertexBundles:[],primitives:[]}})),dt=w(ct.prototype,"_hash",[p],(function(){return 0})),lt=w(ct.prototype,"_allowDataAccess",[p],(function(){return!0})),ft=ct))||ft);function Rt(t,e){for(var r=0,n=0;n<e;++n){var i=t[n];r+=G[i.format].size}return r}y.Mesh=Mt;var Pt=x.isLittleEndian;function Ut(t){var e=G[t];return e.size/e.count}function St(t,e){var r=G[e],n=r.size/r.count;switch(r.type){case z.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Pt)};case 4:return function(e){return t.getUint32(e,Pt)}}break;case z.SNORM:case z.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Pt)};case 4:return function(e){return t.getInt32(e,Pt)}}break;case z.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Pt)};case 4:return function(e){return t.getUint32(e,Pt)}}break;case z.FLOAT:switch(n){case 2:return function(e){return t.getUint16(e,Pt)};case 4:return function(e){return t.getFloat32(e,Pt)}}}return null}function Ot(t,e){var r=G[e],n=r.size/r.count;switch(r.type){case z.UNORM:switch(n){case 1:return function(e,r){return t.setUint8(e,r)};case 2:return function(e,r){return t.setUint16(e,r,Pt)};case 4:return function(e,r){return t.setUint32(e,r,Pt)}}break;case z.SNORM:case z.INT:switch(n){case 1:return function(e,r){return t.setInt8(e,r)};case 2:return function(e,r){return t.setInt16(e,r,Pt)};case 4:return function(e,r){return t.setInt32(e,r,Pt)}}break;case z.UINT:switch(n){case 1:return function(e,r){return t.setUint8(e,r)};case 2:return function(e,r){return t.setUint16(e,r,Pt)};case 4:return function(e,r){return t.setUint32(e,r,Pt)}}break;case z.FLOAT:switch(n){case 2:return function(e,r){return t.setUint16(e,r,Pt)};case 4:return function(e,r){return t.setFloat32(e,r,Pt)}}}return null}function Vt(t){if(!t.struct.encoded)return t;var e=function(t){t<0&&h(14204,t)},r=JSON.parse(JSON.stringify(t.struct)),n=new $;n.setNextAlignment(0);for(var i,s=c(r.vertexBundles);!(i=s()).done;){var a=i.value,u=a.view,o=u.count*u.stride,f=new Uint8Array(o),d=new Uint8Array(t.data.buffer,u.offset,u.length);e(vt.decodeVertexBuffer(f,u.count,u.stride,d)),n.setNextAlignment(u.stride);var l={offset:n.getLength(),length:f.byteLength,count:u.count,stride:u.stride};a.view=l,n.addBuffer(f)}for(var v,_=c(r.primitives);!(v=_()).done;){var m=v.value;if(void 0!==m.indexView){var g=m.indexView,w=g.count*g.stride,x=new Uint8Array(w),p=new Uint8Array(t.data.buffer,g.offset,g.length);e(vt.decodeIndexBuffer(x,g.count,g.stride,p)),n.setNextAlignment(g.stride);var b={offset:n.getLength(),length:x.byteLength,count:g.count,stride:g.stride};m.indexView=b,n.addBuffer(x)}}return{struct:r,data:new Uint8Array(n.getCombined())}}function Nt(t){var e=new Y.Inflate(t.data).decompress();return t.data=e,t.struct.compressed=!1,t}function Dt(t){var e=JSON.parse(JSON.stringify(t.struct)),r=new $;function n(t,e,r,n,i,s,a){for(var u=0;u<r;u++)for(var o=0;o<n;o++)e(a*u+i*o,t(s*u+i*o))}function i(t,e,r,n,i,s){for(var a=0;a<r;a++)for(var u=0;u<n;u++)e(s*a+4*u,b(t(i*a+2*u)))}r.setNextAlignment(0);for(var s=0;s<e.vertexBundles.length;++s){for(var a=e.vertexBundles[s],u=a.view,o=a.attributes,f=t.struct.vertexBundles[s].attributes,h=[],d=[],l=[],v=0;v<o.length;++v){var _=o[v],m=St(new DataView(t.data.buffer,u.offset+Rt(f,v)),_.format),g=!0;switch(_.format){case N.R16F:_.format=N.R32F;break;case N.RG16F:_.format=N.RG32F;break;case N.RGB16F:_.format=N.RGB32F;break;case N.RGBA16F:_.format=N.RGBA32F;break;default:g=!1}h.push(G[_.format].size),d.push(g),l.push(m)}for(var w=h.reduce((function(t,e){return t+e}),0),x=new Uint8Array(w*u.count),p=0;p<o.length;++p){var y=o[p],A=l[p],T=Ot(new DataView(x.buffer,Rt(o,p)),y.format),B=d[p],I=G[y.format];B?i(A,T,u.count,I.count,u.stride,w):n(A,T,u.count,I.count,I.size/I.count,u.stride,w)}r.setNextAlignment(w);var E={offset:r.getLength(),length:x.byteLength,count:u.count,stride:w};a.view=E,r.addBuffer(x)}for(var M,R=c(e.primitives);!(M=R()).done;){var P=M.value;if(void 0!==P.indexView){var U=P.indexView,S=new Uint8Array(t.data.buffer,U.offset,U.length);r.setNextAlignment(U.stride);var O={offset:r.getLength(),length:S.byteLength,count:U.count,stride:U.stride};P.indexView=O,r.addBuffer(S)}}var V=new Uint8Array(r.getCombined());return e.quantized=!1,{struct:e,data:V}}}}}));
