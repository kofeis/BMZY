System.register(["./global-exports-CR3GRnjt.js","./index-C5lmLqDW.js","./gc-object-CKHc4SnS.js","./debug-view-CKetkq9d.js","./pipeline-state-manager-Cdpe3is6.js","./scene-7MDSMR3j.js","./component-BaGvu7EF.js","./device-manager-BvjvoelW.js","./buffer-barrier-CuX_5NUR.js","./render-types-DTmbYHic.js","./pipeline-scene-data-B9tBPl1_.js","./rendering-sub-mesh-CowWLfXC.js","./factory-D9_8ZCqM.js","./node-event-DTNosVQv.js","./touch-DB0AR-Sc.js"],(function(e){"use strict";var t,r,i,a,s,n,o,h,d,l,u,_,p,c,f,S,g,O,A,T,E,m,F,I,v,w,D,b,B,y,R,P,N,C,L,M,H,x,U,G,W,Q,V,z,q,k,j,J,Z,X,Y,K,$,ee,te,re,ie,ae,se,ne,oe,he,de,le,ue,_e,pe,ce,fe,Se,ge,Oe,Ae,Te,Ee,me,Fe,Ie,ve,we,De,be,Be,ye,Re,Pe,Ne,Ce,Le,Me,He,xe,Ue,Ge,We,Qe,Ve,ze,qe,ke,je,Je,Ze,Xe,Ye,Ke,$e,et,tt,rt,it,at;return{setters:[function(e){t=e.c,r=e.l},function(e){i=e.b,a=e.X,s=e.A,n=e.n,o=e.M,h=e.e,d=e.C,l=e.f,u=e.c,_=e.a,p=e.s,c=e.t,f=e.o,S=e.H,g=e.b2},function(e){O=e.P,A=e.w,T=e.a,E=e._,m=e.W,F=e.a2,I=e.A,v=e.j,w=e.t,D=e.f,b=e.a6,B=e.p,y=e.h},function(e){R=e.a,P=e.j,N=e.r,C=e.g,L=e.L,M=e.P,H=e.h,x=e.R,U=e.n},function(e){G=e.b,W=e.J,Q=e.K,V=e.N,z=e.U,q=e.a,k=e.O,j=e.z,J=e.i,Z=e.Q,X=e.T,Y=e.V,K=e.W,$=e.G,ee=e.X,te=e.n,re=e.P,ie=e.S,ae=e.A,se=e.B,ne=e.L,oe=e.Y,he=e.Z,de=e.c,le=e.E,ue=e._},function(e){_e=e.t,pe=e.C,ce=e.r,fe=e.f,Se=e.ae,ge=e.b,Oe=e.g,Ae=e.B,Te=e.an,Ee=e.ao,me=e.d},function(e){Fe=e.A},function(e){Ie=e.d},function(e){ve=e.ak,we=e.w,De=e.al,be=e.az,Be=e.B,ye=e.b,Re=e.M,Pe=e.aA,Ne=e.x,Ce=e.y,Le=e.z,Me=e.C,He=e.aQ,xe=e.ae,Ue=e.af,Ge=e.R,We=e.m,Qe=e.aL,Ve=e.ac,ze=e.A,qe=e.F,ke=e.I,je=e.o,Je=e.a8,Ze=e.T,Xe=e.d,Ye=e.e,Ke=e.b1,$e=e.bo,et=e.ap,tt=e.ad,rt=e.r},function(e){it=e.P},function(e){at=e.P},null,null,null,null],execute:function(){e("createDefaultPipeline",Xa);var st=new i,nt=a.create(0,0,0,1),ot=new s(0,0,0,.5,.5,.5),ht=new s,dt=new O((function(){return{model:null,depth:0}}),128);function lt(e,t){var r=0;e.node&&(i.subtract(st,e.worldBounds?e.worldBounds.center:e.node.worldPosition,t.position),r=i.dot(st,t.forward));var a=dt.alloc();return a.model=e,a.depth=r,a}function ut(e,t){var r=e.validPunctualLights;r.length=0;for(var i=t.scene.spotLights,o=t.node.scene.globals.disableLightmap,h=0;h<i.length;h++){var d=i[h];d.baked&&!o||(a.set(nt,d.position.x,d.position.y,d.position.z,d.range),n.sphereFrustum(nt,t.frustum)&&r.push(d))}for(var l=t.scene.sphereLights,u=0;u<l.length;u++){var _=l[u];_.baked&&!o||(a.set(nt,_.position.x,_.position.y,_.position.z,_.range),n.sphereFrustum(nt,t.frustum)&&r.push(_))}for(var p=t.scene.pointLights,c=0;c<p.length;c++){var f=p[c];f.baked||(a.set(nt,f.position.x,f.position.y,f.position.z,f.range),n.sphereFrustum(nt,t.frustum)&&r.push(f))}for(var S=t.scene.rangedDirLights,g=0;g<S.length;g++){var O=S[g];s.transform(ht,ot,O.node.getWorldMatrix()),n.aabbFrustum(ht,t.frustum)&&r.push(O)}e.validPunctualLights=r}function _t(e,t,r){var i=e.scene.mainLight,a=t.csmLayers.layerObjects,s=r.validFrustum,o=r.shadowObjects;o.length=0;for(var h=e.visibility,d=a.length-1;d>=0;d--){var l=a.array[d];if(l){var u=l.model;u&&u.enabled&&u.node&&((h&u.node.layer)===u.node.layer||h&u.visFlags)&&u.worldBounds&&u.castShadow?n.aabbFrustum(u.worldBounds,s)&&(o.push(l),r.level<i.csmLevel&&i.csmOptimizationMode===pe.RemoveDuplicates&&n.aabbFrustumCompletelyInside(u.worldBounds,s)&&a.fastRemove(d)):a.fastRemove(d)}else a.fastRemove(d)}}function pt(e,t,r){var i=r.scene,a=i.mainLight,s=e.shadows,o=e.skybox,h=e.csmLayers,d=e.renderObjects;dt.freeArray(d),d.length=0;var l=h.castShadowObjects;l.length=0;var u=h.layerObjects;u.clear(),s.enabled&&(t.updateShadowUBORange(G.SHADOW_COLOR_OFFSET,s.shadowColor),s.type===_e.ShadowMap&&a&&a.node&&h.update(e,r)),r.clearFlag&R.VALUE&&(o.enabled&&o.model?d.push(lt(o.model,r)):r.cameraUsage!==P.EDITOR&&r.cameraUsage!==P.SCENE_VIEW&&A(15100,r.name));var _=i.models,p=r.visibility;function c(e){if(e.enabled){if(i.isCulledByLod(r,e))return;if(e.castShadow&&(l.push(lt(e,r)),u.push(lt(e,r))),e.node&&(p&e.node.layer)===e.node.layer||p&e.visFlags){if(e.worldBounds&&!n.aabbFrustum(e.worldBounds,r.frustum))return;d.push(lt(e,r))}}}for(var f=0;f<_.length;f++)c(_[f])}var ct,ft,St,gt,Ot,At=new ve(we.LINEAR,we.LINEAR,we.NONE,De.CLAMP,De.CLAMP,De.CLAMP),Tt=new ve(we.POINT,we.POINT,we.NONE,De.CLAMP,De.CLAMP,De.CLAMP),Et=function(){function e(e){this._descriptorSetMap=new Map,this._device=e,this._linearSampler=this._device.getSampler(At),this._pointSampler=this._device.getSampler(Tt);var t=new Pe(V.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new be(this._descriptorSetLayout))}var t=e.prototype;return t.regenLayout=function(){var e=new Pe(V.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new be(this._descriptorSetLayout))},t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var r=this._descriptorSetMap.values(),i=r.next();!i.done;)i.value.bindBuffer(e,t),i=r.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var r=this._descriptorSetMap.values(),i=r.next();!i.done;)i.value.bindSampler(e,t),i=r.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var r=this._descriptorSetMap.values(),i=r.next();!i.done;)i.value.bindTexture(e,t),i=r.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var r=this._globalDescriptorSet,i=t.createDescriptorSet(new be(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var a=W.UBO_GLOBAL;a<W.COUNT;a++)i.bindBuffer(a,r.getBuffer(a)),i.bindSampler(a,r.getSampler(a)),i.bindTexture(a,r.getTexture(a));var s=t.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.HOST|Re.DEVICE,G.SIZE,G.SIZE));i.bindBuffer(Q.BINDING,s),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},T(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet},set:function(e){this._globalDescriptorSet=e}}]),e}(),mt=new o,Ft=new o,It=new o,vt=new h,wt=new h(0,0,1,0),Dt=new i,bt=o.toArray,Bt=h.toArray,yt=d.toArray,Rt=function(){function e(){this._globalUBO=new Float32Array(z.COUNT),this._cameraUBO=new Float32Array(q.COUNT),this._shadowUBO=new Float32Array(G.COUNT),this._csmUBO=new Float32Array(k.COUNT)}e.updateGlobalUBOView=function(e,r){var i=t.director,a=i.root,s=r,n=Math.floor(e.width),o=Math.floor(e.height);s[z.TIME_OFFSET]=a.cumulativeTime,s[z.TIME_OFFSET+1]=a.frameTime,s[z.TIME_OFFSET+2]=i.getTotalFrames(),s[z.TIME_OFFSET+3]=a.cumulativeTime-Math.floor(a.frameTime),s[z.SCREEN_SIZE_OFFSET]=n,s[z.SCREEN_SIZE_OFFSET+1]=o,s[z.SCREEN_SIZE_OFFSET+2]=1/n,s[z.SCREEN_SIZE_OFFSET+3]=1/o,s[z.NATIVE_SIZE_OFFSET]=n,s[z.NATIVE_SIZE_OFFSET+1]=o,s[z.NATIVE_SIZE_OFFSET+2]=1/s[z.NATIVE_SIZE_OFFSET],s[z.NATIVE_SIZE_OFFSET+3]=1/s[z.NATIVE_SIZE_OFFSET+1],t.internal.reflectionProbeManager&&(s[z.PROBE_INFO_OFFSET]=t.internal.reflectionProbeManager.getMaxProbeId()+1);for(var h=a.debugView,d=0;d<=3;d++)s[z.DEBUG_VIEW_MODE_OFFSET+d]=0;if(h.isEnabled()){s[z.DEBUG_VIEW_MODE_OFFSET]=h.singleMode;for(var l=N.DIRECT_DIFFUSE;l<N.MAX_BIT_COUNT;l++){var u=l>>3,_=l%8;s[z.DEBUG_VIEW_MODE_OFFSET+1+u]+=(h.isCompositeModeEnabled(l)?1:0)*Math.pow(10,_)}s[z.DEBUG_VIEW_MODE_OFFSET+3]+=(h.lightingWithAlbedo?1:0)*Math.pow(10,6),s[z.DEBUG_VIEW_MODE_OFFSET+3]+=(h.csmLayerColoration?1:0)*Math.pow(10,7)}},e.updateCameraUBOView=function(e,r,a){var s,n=(a.scene?a.scene:t.director.getScene().renderScene).mainLight,o=e.pipelineSceneData,d=o.ambient,u=o.skybox,_=o.fog,p=o.shadows,c=r,f=a.exposure,S=o.isHDR;if(c[q.SCREEN_SCALE_OFFSET]=o.shadingScale,c[q.SCREEN_SCALE_OFFSET+1]=o.shadingScale,c[q.SCREEN_SCALE_OFFSET+2]=1/c[q.SCREEN_SCALE_OFFSET],c[q.SCREEN_SCALE_OFFSET+3]=1/c[q.SCREEN_SCALE_OFFSET+1],c[q.EXPOSURE_OFFSET]=f,c[q.EXPOSURE_OFFSET+1]=1/f,c[q.EXPOSURE_OFFSET+2]=S?1:0,c[q.EXPOSURE_OFFSET+3]=1/C.standardExposureValue,n){var g=n.shadowEnabled&&p.type===_e.ShadowMap?1:0,O=n.direction;if(wt.set(O.x,O.y,O.z,g),Bt(c,wt,q.MAIN_LIT_DIR_OFFSET),i.toArray(c,n.color,q.MAIN_LIT_COLOR_OFFSET),n.useColorTemperature){var A=n.colorTemperatureRGB;c[q.MAIN_LIT_COLOR_OFFSET]*=A.x,c[q.MAIN_LIT_COLOR_OFFSET+1]*=A.y,c[q.MAIN_LIT_COLOR_OFFSET+2]*=A.z}c[q.MAIN_LIT_COLOR_OFFSET+3]=S?n.illuminance*f:n.illuminance}else wt.set(0,0,1,0),Bt(c,wt,q.MAIN_LIT_DIR_OFFSET),Bt(c,h.ZERO,q.MAIN_LIT_COLOR_OFFSET);var T=d.skyColor;T.w=S?d.skyIllum*f:d.skyIllum,c[q.AMBIENT_SKY_OFFSET+0]=T.x,c[q.AMBIENT_SKY_OFFSET+1]=T.y,c[q.AMBIENT_SKY_OFFSET+2]=T.z,c[q.AMBIENT_SKY_OFFSET+3]=T.w,c[q.AMBIENT_GROUND_OFFSET+0]=d.groundAlbedo.x,c[q.AMBIENT_GROUND_OFFSET+1]=d.groundAlbedo.y,c[q.AMBIENT_GROUND_OFFSET+2]=d.groundAlbedo.z,c[q.AMBIENT_GROUND_OFFSET+3]=u.envmap?null==(s=u.envmap)?void 0:s.mipmapLevel:1,bt(c,a.matView,q.MAT_VIEW_OFFSET),bt(c,a.node.worldMatrix,q.MAT_VIEW_INV_OFFSET),i.toArray(c,a.position,q.CAMERA_POS_OFFSET),bt(c,a.matProj,q.MAT_PROJ_OFFSET),bt(c,a.matProjInv,q.MAT_PROJ_INV_OFFSET),bt(c,a.matViewProj,q.MAT_VIEW_PROJ_OFFSET),bt(c,a.matViewProjInv,q.MAT_VIEW_PROJ_INV_OFFSET),c[q.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),c[q.SURFACE_TRANSFORM_OFFSET]=a.surfaceTransform,c[q.SURFACE_TRANSFORM_OFFSET+1]=a.cameraUsage,c[q.SURFACE_TRANSFORM_OFFSET+2]=Math.cos(l(o.skybox.getRotationAngle())),c[q.SURFACE_TRANSFORM_OFFSET+3]=Math.sin(l(o.skybox.getRotationAngle()));var E=_.colorArray;c[q.GLOBAL_FOG_COLOR_OFFSET]=E.x,c[q.GLOBAL_FOG_COLOR_OFFSET+1]=E.y,c[q.GLOBAL_FOG_COLOR_OFFSET+2]=E.z,c[q.GLOBAL_FOG_COLOR_OFFSET+3]=E.z,c[q.GLOBAL_FOG_BASE_OFFSET]=_.fogStart,c[q.GLOBAL_FOG_BASE_OFFSET+1]=_.fogEnd,c[q.GLOBAL_FOG_BASE_OFFSET+2]=_.fogDensity,c[q.GLOBAL_FOG_ADD_OFFSET]=_.fogTop,c[q.GLOBAL_FOG_ADD_OFFSET+1]=_.fogRange,c[q.GLOBAL_FOG_ADD_OFFSET+2]=_.fogAtten,c[q.NEAR_FAR_OFFSET]=a.nearClip,c[q.NEAR_FAR_OFFSET+1]=a.farClip,c[q.NEAR_FAR_OFFSET+2]=a.getClipSpaceMinz(),c[q.VIEW_PORT_OFFSET]=o.shadingScale*a.window.width*a.viewport.x,c[q.VIEW_PORT_OFFSET+1]=o.shadingScale*a.window.height*a.viewport.y,c[q.VIEW_PORT_OFFSET+2]=o.shadingScale*a.window.width*a.viewport.z,c[q.VIEW_PORT_OFFSET+3]=o.shadingScale*a.window.height*a.viewport.w},e.getPCFRadius=function(e,t){var r=e.size.x;switch(t.shadowPcf){case ce.HARD:return 0;case ce.SOFT:return 1/(.5*r);case ce.SOFT_2X:return 2/(.5*r);case ce.SOFT_4X:return 3/(.5*r)}return 0},e.updatePlanarNormalAndDistance=function(e,t){i.normalize(Dt,e.normal),t[G.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Dt.x,t[G.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Dt.y,t[G.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Dt.z,t[G.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=-e.distance},e.updateShadowUBOView=function(t,r,i,a){var s=t.device,n=a.scene.mainLight,o=t.pipelineSceneData,h=o.shadows,d=o.csmLayers,l=r,u=i,_=o.csmSupported,p=j(s)?0:1;if(n&&h.enabled){if(h.type===_e.ShadowMap){if(n.shadowEnabled){if(n.shadowFixedArea||n.csmLevel===fe.LEVEL_1||!_){var c=d.specialLayer.matShadowView,f=d.specialLayer.matShadowProj,S=d.specialLayer.matShadowViewProj,g=.1,O=0,A=0;n.shadowFixedArea?(g=n.shadowNear,O=n.shadowFar,A=0):(O=d.specialLayer.shadowCameraFar,A=1),bt(l,c,G.MAT_LIGHT_VIEW_OFFSET),l[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,l[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,l[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,l[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,l[G.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,l[G.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,l[G.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,l[G.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,bt(l,S,G.MAT_LIGHT_VIEW_PROJ_OFFSET),vt.set(g,O,0,1-n.shadowSaturation),Bt(l,vt,G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),vt.set(L.DIRECTIONAL,p,n.shadowNormalBias,A),Bt(l,vt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}else{for(var T=this.getPCFRadius(h,n),E=0;E<n.csmLevel;E++){var m=d.layers[E],F=m.matShadowView;vt.set(F.m00,F.m04,F.m08,T),Bt(u,vt,k.CSM_VIEW_DIR_0_OFFSET+4*E),vt.set(F.m01,F.m05,F.m09,m.splitCameraNear),Bt(u,vt,k.CSM_VIEW_DIR_1_OFFSET+4*E),vt.set(F.m02,F.m06,F.m10,m.splitCameraFar),Bt(u,vt,k.CSM_VIEW_DIR_2_OFFSET+4*E);var I=m.csmAtlas;Bt(u,I,k.CSM_ATLAS_OFFSET+4*E);var v=m.matShadowViewProj;bt(u,v,k.MAT_CSM_VIEW_PROJ_OFFSET+16*E);var w=m.matShadowProj;u[k.CSM_PROJ_DEPTH_INFO_OFFSET+0+4*E]=w.m10,u[k.CSM_PROJ_DEPTH_INFO_OFFSET+1+4*E]=w.m14,u[k.CSM_PROJ_DEPTH_INFO_OFFSET+2+4*E]=w.m11,u[k.CSM_PROJ_DEPTH_INFO_OFFSET+3+4*E]=w.m15,u[k.CSM_PROJ_INFO_OFFSET+0+4*E]=w.m00,u[k.CSM_PROJ_INFO_OFFSET+1+4*E]=w.m05,u[k.CSM_PROJ_INFO_OFFSET+2+4*E]=1/w.m00,u[k.CSM_PROJ_INFO_OFFSET+3+4*E]=1/w.m05}vt.set(n.csmTransitionRange,0,0,0),Bt(u,vt,k.CSM_SPLITS_INFO_OFFSET),vt.set(.1,n.shadowDistance,0,1-n.shadowSaturation),Bt(l,vt,G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),vt.set(L.DIRECTIONAL,p,n.shadowNormalBias,n.csmLevel),Bt(l,vt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}vt.set(h.size.x,h.size.y,n.shadowPcf,n.shadowBias),Bt(l,vt,G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}}else e.updatePlanarNormalAndDistance(h,l),vt.set(0,0,0,h.planeBias),Bt(l,vt,G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);yt(l,h.shadowColor,G.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,r,i){var a=e.device,s=e.pipelineSceneData,n=s.shadows,h=s.csmLayers,d=t,l=j(a)?0:1,u=e.device.capabilities,_=s.csmSupported;switch(r.type){case L.DIRECTIONAL:var p=r;if(n.enabled&&p&&p.shadowEnabled&&n.type===_e.ShadowMap){var c,f,S,g=.1,O=0,A=0;if(p.shadowFixedArea||p.csmLevel===fe.LEVEL_1||!_)c=h.specialLayer.matShadowView,f=h.specialLayer.matShadowProj,S=h.specialLayer.matShadowViewProj,p.shadowFixedArea?(g=p.shadowNear,O=p.shadowFar,A=0):(g=.1,O=h.specialLayer.shadowCameraFar,A=1),vt.set(L.DIRECTIONAL,l,p.shadowNormalBias,0),Bt(d,vt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);else{var T=h.layers[i];c=T.matShadowView,f=T.matShadowProj,S=T.matShadowViewProj,g=T.splitCameraNear,O=T.splitCameraFar,A=p.csmLevel}bt(d,c,G.MAT_LIGHT_VIEW_OFFSET),d[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,d[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,d[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,d[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,d[G.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,d[G.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,d[G.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,d[G.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,bt(d,S,G.MAT_LIGHT_VIEW_PROJ_OFFSET),vt.set(g,O,0,1-p.shadowSaturation),Bt(d,vt,G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),vt.set(L.DIRECTIONAL,l,p.shadowNormalBias,A),Bt(d,vt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),vt.set(n.size.x,n.size.y,p.shadowPcf,p.shadowBias),Bt(d,vt,G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}break;case L.SPOT:var E=r;n.enabled&&E&&E.shadowEnabled&&(o.invert(mt,r.node.getWorldMatrix()),bt(d,mt,G.MAT_LIGHT_VIEW_OFFSET),o.perspective(Ft,E.angle,1,.001,E.range,!0,u.clipSpaceMinZ,u.clipSpaceSignY,0),o.multiply(It,Ft,mt),bt(d,It,G.MAT_LIGHT_VIEW_PROJ_OFFSET),vt.set(.01,r.range,0,0),Bt(d,vt,G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),vt.set(n.size.x,n.size.y,E.shadowPcf,E.shadowBias),Bt(d,vt,G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),vt.set(L.SPOT,l,E.shadowNormalBias,0),Bt(d,vt,G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET))}yt(d,n.shadowColor,G.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var r=e.prototype;return r._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},r.activate=function(e,t){this._device=e,this._pipeline=t;var r=this._pipeline.descriptorSet;if(!J()){this._initCombineSignY();var i=e.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.HOST|Re.DEVICE,z.SIZE,z.SIZE));r.bindBuffer(Z.BINDING,i);var a=e.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.HOST|Re.DEVICE,q.SIZE,q.SIZE));r.bindBuffer(X.BINDING,a);var s=e.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.HOST|Re.DEVICE,G.SIZE,G.SIZE));r.bindBuffer(Q.BINDING,s);var n=e.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.HOST|Re.DEVICE,k.SIZE,k.SIZE));r.bindBuffer(Y.BINDING,n)}},r.updateGlobalUBO=function(t){var r=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,a=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),a[0].updateBuffer(i.getBuffer(Z.BINDING),this._globalUBO),r.bindBuffer(Z.BINDING,i.getBuffer(Z.BINDING)),r.update()},r.updateCameraUBO=function(t){var r=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,a=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),a[0].updateBuffer(i.getBuffer(X.BINDING),this._cameraUBO),r.bindBuffer(X.BINDING,i.getBuffer(X.BINDING)),r.update()},r.updateShadowUBO=function(t){var r=this._pipeline.pipelineSceneData;if(r.shadows.enabled){var i=this._pipeline.globalDSManager,a=this._pipeline.descriptorSet,s=this._pipeline.commandBuffers,n=r.shadowFrameBufferMap,o=t.scene.mainLight;o&&n.has(o)&&i.bindTexture(K,n.get(o).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,this._csmUBO,t),i.update(),s[0].updateBuffer(a.getBuffer(Q.BINDING),this._shadowUBO),s[0].updateBuffer(a.getBuffer(Y.BINDING),this._csmUBO)}},r.updateShadowUBOLight=function(t,r,i){void 0===i&&(i=0),e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,r,i),t.bindTexture(K,$(this._pipeline.device)),t.bindTexture(ee,$(this._pipeline.device)),t.update(),this._pipeline.commandBuffers[0].updateBuffer(t.getBuffer(Q.BINDING),this._shadowUBO)},r.updateShadowUBORange=function(e,t){t instanceof o?bt(this._shadowUBO,t,e):t instanceof d&&yt(this._shadowUBO,t,e)},r.destroy=function(){},e}();Rt._combineSignY=0;var Pt,Nt,Ct,Lt,Mt,Ht,xt,Ut,Gt=e("RenderStage",u("RenderStage")((ft=function(){function e(){this._name=St&&St(),this._priority=gt&&gt(),this._enabled=!0,this._tag=Ot&&Ot(),this._pipeline=void 0,this._flow=void 0}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},T(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),St=_(ft.prototype,"_name",[p],(function(){return""})),gt=_(ft.prototype,"_priority",[p],(function(){return 0})),Ot=_(ft.prototype,"_tag",[p],(function(){return 0})),ct=ft))||ct);t.RenderStage=Gt;var Wt,Qt,Vt,zt,qt,kt,jt=e("RenderFlow",(Pt=u("RenderFlow"),Nt=c([Gt]),Pt((Lt=function(){function e(){this._name=Mt&&Mt(),this._priority=Ht&&Ht(),this._tag=xt&&xt(),this._stages=Ut&&Ut(),this._pipeline=void 0}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,r=this._stages.length;t<r;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,r=this._stages.length;t<r;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},T(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),Mt=_(Lt.prototype,"_name",[p],(function(){return""})),Ht=_(Lt.prototype,"_priority",[p],(function(){return 0})),xt=_(Lt.prototype,"_tag",[p],(function(){return 0})),Ut=_(Lt.prototype,"_stages",[Nt,p],(function(){return[]})),Ct=Lt))||Ct));t.RenderFlow=jt;var Jt=new Ke,Zt=new $e,Xt=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null};function Yt(e){for(var t,r=666,i=v(e.colorTextures);!(t=i()).done;){var a=t.value,s=null==a?void 0:a.info,n=s.type+"_"+s.usage+"_"+s.format+"_"+s.width+"_"+s.height+"_"+s.flags+"_\n            "+s.layerCount+"_"+s.levelCount+"_"+s.samples+"_"+s.depth+"_"+s.externalRes;r=We(n,r)}if(e.depthStencilTexture){var o=e.depthStencilTexture.info,h=o.type+"_"+o.usage+"_"+o.format+"_"+o.width+"_"+o.height+"_"+o.flags+"_\n            "+o.layerCount+"_"+o.levelCount+"_"+o.samples+"_"+o.depth+"_"+o.externalRes;r=We(h,r)}return r}var Kt,$t,er,tr,rr,ir,ar,sr,nr,or,hr,dr,lr,ur,_r,pr,cr,fr,Sr,gr,Or,Ar,Tr,Er,mr,Fr,Ir,vr,wr,Dr,br,Br,yr,Rr,Pr,Nr,Cr,Lr,Mr,Hr,xr,Ur,Gr,Wr,Qr,Vr,zr,qr,kr,jr,Jr,Zr,Xr,Yr,Kr,$r,ei,ti,ri,ii,ai,si,ni,oi,hi,di,li,ui,_i,pi,ci,fi,Si,gi,Oi,Ai,Ti,Ei,mi,Fi,Ii,vi,wi,Di,bi=e("RenderPipeline",(Wt=u("cc.RenderPipeline"),Qt=c([jt]),Wt((zt=function(e){function t(t){var r;return(r=e.call(this,t)||this)._tag=qt&&qt(),r._flows=kt&&kt(),r._quadIB=null,r._quadVBOnscreen=null,r._quadVBOffscreen=null,r._quadIAOnscreen=null,r._quadIAOffscreen=null,r._eventProcessor=new H,r._device=void 0,r._globalDSManager=void 0,r._descriptorSet=void 0,r._commandBuffers=[],r._pipelineUBO=new Rt,r._macros={},r._constantMacros="",r._profiler=null,r._geometryRenderer=null,r._pipelineRenderData=null,r._renderPasses=new Map,r._width=0,r._height=0,r._lastUsedRenderArea=new Ke,r._clusterEnabled=!1,r._bloomEnabled=!1,r}E(t,e);var r=t.prototype;return r.getPipelineRenderData=function(){return this._pipelineRenderData},r.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},r.createRenderPass=function(e,t,r){var i=this._device,a=new Ne,s=new Ce;a.format=t,s.format=r,s.stencilStoreOp=Le.DISCARD,s.depthStoreOp=Le.DISCARD,e&Me.COLOR||(e&R.VALUE?a.loadOp=He.CLEAR:(a.loadOp=He.LOAD,a.barrier=i.getGeneralBarrier(new xe(Ue.COLOR_ATTACHMENT_WRITE,Ue.COLOR_ATTACHMENT_WRITE)))),(e&Me.DEPTH_STENCIL)!==Me.DEPTH_STENCIL&&(e&Me.DEPTH||(s.depthLoadOp=He.LOAD),e&Me.STENCIL||(s.stencilLoadOp=He.LOAD)),s.barrier=i.getGeneralBarrier(new xe(Ue.DEPTH_STENCIL_ATTACHMENT_WRITE,Ue.DEPTH_STENCIL_ATTACHMENT_WRITE));var n=new Ge([a],s);return i.createRenderPass(n)},r.getRenderPass=function(e,t){var r=Yt(t),i=We(r+"_"+e,666),a=this._renderPasses.get(i);return a||(a=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(i,a),a)},r.newFramebufferByRatio=function(e){for(var t=this.pipelineSceneData,r=this._width*t.shadingScale,i=this._height*t.shadingScale,a=e.colorTextures,s=0;s<a.length;s++)a[s].resize(r,i);e.depthStencilTexture&&e.depthStencilTexture.resize(r,i);var n=this._device.createFramebuffer(new Qe(e.renderPass,a,e.depthStencilTexture));return e.destroy(),n},r.generateRenderArea=function(e,t){var r=e.viewport,i=e.window.width,a=e.window.height;t.x=r.x*i,t.y=r.y*a,t.width=r.width*i,t.height=r.height*a},r.generateViewport=function(e,t){this.generateRenderArea(e,Jt),t||(t=Zt);var r=this.pipelineSceneData.shadingScale;return t.left=Jt.x*r,t.top=Jt.y*r,t.width=Jt.width*r,t.height=Jt.height*r,t},r.generateScissor=function(e,t){t||(t=Jt),this.generateRenderArea(e,t);var r=this.pipelineSceneData.shadingScale;return t.x*=r,t.y*=r,t.width*=r,t.height*=r,t},r.getMacroString=function(e){var t=this._macros[e];return void 0===t?"":t},r.getMacroInt=function(e){var t=this._macros[e];return void 0===t?0:t},r.getMacroBool=function(e){var t=this._macros[e];return void 0!==t&&t},r.setMacroString=function(e,t){this._macros[e]=t},r.setMacroInt=function(e,t){this._macros[e]=t},r.setMacroBool=function(e,t){this._macros[e]=t},r.activate=function(){this._device=Ie.gfxDevice,this._generateConstantMacros(),this._globalDSManager=new Et(this._device),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._macros.CC_USE_DEBUG_VIEW=0,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},r._ensureEnoughSize=function(){},r.render=function(e){if(0!==e.length){this.updateGeometryRenderer(e),this._commandBuffers[0].begin(),this.emit(M.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),Se(e);for(var t=0;t<e.length;t++){var r=e[t];if(r.scene){this.emit(M.RENDER_CAMERA_BEGIN,r),ut(this.pipelineSceneData,r),pt(this.pipelineSceneData,this.pipelineUBO,r),this._pipelineUBO.updateGlobalUBO(r.window),this._pipelineUBO.updateCameraUBO(r);for(var i=0;i<this._flows.length;i++)this._flows[i].render(r);this.emit(M.RENDER_CAMERA_END,r)}}this.emit(M.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},r._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},r._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var r=0;r<t.downsampleTexs.length;++r)t.downsampleTexs[r].destroy(),t.downsampleFramebuffers[r].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null==(e=t.renderPass)||e.destroy(),this._pipelineRenderData.bloom=null}},r._genQuadVertexData=function(e,t){var r=new Float32Array(16),i=t.x/this._width,a=(t.x+t.width)/this._width,s=t.y/this._height,n=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var o=n;n=s,s=o}var h=0;switch(e){case Ve.IDENTITY:h=0,r[h++]=-1,r[h++]=-1,r[h++]=i,r[h++]=n,r[h++]=1,r[h++]=-1,r[h++]=a,r[h++]=n,r[h++]=-1,r[h++]=1,r[h++]=i,r[h++]=s,r[h++]=1,r[h++]=1,r[h++]=a,r[h++]=s;break;case Ve.ROTATE_90:h=0,r[h++]=-1,r[h++]=-1,r[h++]=a,r[h++]=n,r[h++]=1,r[h++]=-1,r[h++]=a,r[h++]=s,r[h++]=-1,r[h++]=1,r[h++]=i,r[h++]=n,r[h++]=1,r[h++]=1,r[h++]=i,r[h++]=s;break;case Ve.ROTATE_180:h=0,r[h++]=-1,r[h++]=-1,r[h++]=i,r[h++]=s,r[h++]=1,r[h++]=-1,r[h++]=a,r[h++]=s,r[h++]=-1,r[h++]=1,r[h++]=i,r[h++]=n,r[h++]=1,r[h++]=1,r[h++]=a,r[h++]=n;break;case Ve.ROTATE_270:h=0,r[h++]=-1,r[h++]=-1,r[h++]=i,r[h++]=s,r[h++]=1,r[h++]=-1,r[h++]=i,r[h++]=n,r[h++]=-1,r[h++]=1,r[h++]=a,r[h++]=s,r[h++]=1,r[h++]=1,r[h++]=a,r[h++]=n}return r},r._createQuadInputAssembler=function(){var e=new it,t=4*Float32Array.BYTES_PER_ELEMENT,r=4*t,i=this._device.createBuffer(new Be(ye.VERTEX|ye.TRANSFER_DST,Re.DEVICE|Re.HOST,r,t));if(!i)return e;var a=Uint8Array.BYTES_PER_ELEMENT,s=6*a,n=this._device.createBuffer(new Be(ye.INDEX|ye.TRANSFER_DST,Re.DEVICE,s,a));if(!n)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,n.update(o);var h=new Array(2);h[0]=new ze("a_position",qe.RG32F),h[1]=new ze("a_texCoord",qe.RG32F);var d=this._device.createInputAssembler(new ke(h,[i],n));return e.quadIB=n,e.quadVB=i,e.quadIA=d,e},r.updateQuadVertexData=function(e,t){var r=this._lastUsedRenderArea;if(r.x!==e.x||r.y!==e.y||r.width!==e.width||r.height!==e.height){var i=this._genQuadVertexData(Ve.IDENTITY,e);this._quadVBOffscreen.update(i);var a=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||Ve.IDENTITY,e);this._quadVBOnscreen.update(a),r.copy(e)}},r.destroy=function(){for(var t,r,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null==(t=this._globalDSManager)||t.destroy();for(var a=0;a<this._commandBuffers.length;a++)this._commandBuffers[a].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null==(r=this._pipelineSceneData)||r.destroy(),e.prototype.destroy.call(this)},r.onGlobalPipelineStateChanged=function(){},r._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(qe.RGBA32F)&(je.RENDER_TARGET|je.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(Je.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(m.os===F.ANDROID&&m.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(I.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",e+="#define CC_JOINT_UNIFORM_CAPACITY "+te.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=e},r.updateGeometryRenderer=function(e){if(!this._geometryRenderer)for(var t=0;t<e.length;t++){var r=e[t];if(r&&r.window&&r.window.swapchain)return r.initGeometryRenderer(),void(this._geometryRenderer=r.geometryRenderer)}},r.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new Xt,t=this.device,r=new Ne;r.format=qe.RGBA8,r.loadOp=He.CLEAR,r.storeOp=Le.STORE,r.barrier=t.getGeneralBarrier(new xe(Ue.NONE,Ue.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new Ge([r]));var i=this._width,a=this._height;e.prefiterTex=t.createTexture(new Ze(Xe.TEX2D,Ye.COLOR_ATTACHMENT|Ye.SAMPLED,qe.RGBA8,i>>1,a>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Qe(e.renderPass,[e.prefiterTex])),i>>=1,a>>=1;for(var s=0;s<6;++s)e.downsampleTexs.push(t.createTexture(new Ze(Xe.TEX2D,Ye.COLOR_ATTACHMENT|Ye.SAMPLED,qe.RGBA8,i>>1,a>>1))),e.downsampleFramebuffers[s]=t.createFramebuffer(new Qe(e.renderPass,[e.downsampleTexs[s]])),e.upsampleTexs.push(t.createTexture(new Ze(Xe.TEX2D,Ye.COLOR_ATTACHMENT|Ye.SAMPLED,qe.RGBA8,i,a))),e.upsampleFramebuffers[s]=t.createFramebuffer(new Qe(e.renderPass,[e.upsampleTexs[s]])),i>>=1,a>>=1;e.combineTex=t.createTexture(new Ze(Xe.TEX2D,Ye.COLOR_ATTACHMENT|Ye.SAMPLED,qe.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Qe(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},r.on=function(e,t,r,i){return this._eventProcessor.on(e,t,r,i)},r.once=function(e,t,r){return this._eventProcessor.once(e,t,r)},r.off=function(e,t,r){this._eventProcessor.off(e,t,r)},r.emit=function(e,t,r,i,a,s){this._eventProcessor.emit(e,t,r,i,a,s)},r.targetOff=function(e){this._eventProcessor.targetOff(e)},r.removeAll=function(e){this._eventProcessor.removeAll(e)},r.hasEventListener=function(e,t,r){return this._eventProcessor.hasEventListener(e,t,r)},T(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale!==e&&(this._pipelineSceneData.shadingScale=e,this.emit(M.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(Fe),qt=_(zt.prototype,"_tag",[p],(function(){return 0})),kt=_(zt.prototype,"_flows",[Qt,p],(function(){return[]})),Vt=zt))||Vt));t.RenderPipeline=bi,f(bi.prototype,"RenderPipeline.prototype",[{name:"geometryRenderer",suggest:"please use camera.geometryRenderer instead."}]),function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(Kt||(Kt={})),function(e){e[e.AR=5]="AR",e[e.FORWARD=10]="FORWARD"}($t||($t={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(er||(er={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(tr||(tr={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(rr||(rr={})),w(Xe),w(Ye),w(Le),w(He),w(Ue),w(qe),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(Di||(Di={})),w(Di),ir=u("RenderTextureDesc"),ar=c(Xe),sr=c(Ye),nr=c(qe),ir((or=function(){this.name=hr&&hr(),this.type=dr&&dr(),this.usage=lr&&lr(),this.format=ur&&ur(),this.width=_r&&_r(),this.height=pr&&pr()},hr=_(or.prototype,"name",[p],(function(){return""})),dr=_(or.prototype,"type",[ar],(function(){return Xe.TEX2D})),lr=_(or.prototype,"usage",[sr],(function(){return Ye.COLOR_ATTACHMENT})),ur=_(or.prototype,"format",[nr],(function(){return qe.UNKNOWN})),_r=_(or.prototype,"width",[p],(function(){return-1})),pr=_(or.prototype,"height",[p],(function(){return-1})),or));var Bi=(cr=u("RenderTextureConfig"),fr=c(x),cr((gr=function(){this.name=Or&&Or(),this.texture=Ar&&Ar()},Or=_(gr.prototype,"name",[p],(function(){return""})),Ar=_(gr.prototype,"texture",[fr],(function(){return null})),Sr=gr))||Sr);Tr=u("MaterialConfig"),Er=c(ge),Tr((mr=function(){this.name=Fr&&Fr(),this.material=Ir&&Ir()},Fr=_(mr.prototype,"name",[p],(function(){return""})),Ir=_(mr.prototype,"material",[Er],(function(){return null})),mr)),vr=u("FrameBufferDesc"),wr=c([D]),Dr=c(x),vr((br=function(){this.name=Br&&Br(),this.renderPass=yr&&yr(),this.colorTextures=Rr&&Rr(),this.depthStencilTexture=Pr&&Pr(),this.texture=Nr&&Nr()},Br=_(br.prototype,"name",[p],(function(){return""})),yr=_(br.prototype,"renderPass",[p],(function(){return 0})),Rr=_(br.prototype,"colorTextures",[wr],(function(){return[]})),Pr=_(br.prototype,"depthStencilTexture",[p],(function(){return""})),Nr=_(br.prototype,"texture",[Dr],(function(){return null})),br));var yi,Ri=(Cr=u("ColorDesc"),Lr=c(qe),Mr=c(He),Hr=c(Le),xr=c(Ue),Ur=c(Ue),Cr((Wr=function(){this.format=Qr&&Qr(),this.loadOp=Vr&&Vr(),this.storeOp=zr&&zr(),this.sampleCount=qr&&qr(),this.beginAccesses=kr&&kr(),this.endAccesses=jr&&jr()},Qr=_(Wr.prototype,"format",[Lr],(function(){return qe.UNKNOWN})),Vr=_(Wr.prototype,"loadOp",[Mr],(function(){return He.CLEAR})),zr=_(Wr.prototype,"storeOp",[Hr],(function(){return Le.STORE})),qr=_(Wr.prototype,"sampleCount",[p],(function(){return 1})),kr=_(Wr.prototype,"beginAccesses",[xr],(function(){return Ue.NONE})),jr=_(Wr.prototype,"endAccesses",[Ur],(function(){return Ue.COLOR_ATTACHMENT_WRITE})),Gr=Wr))||Gr),Pi=(Jr=u("DepthStencilDesc"),Zr=c(qe),Xr=c(He),Yr=c(Le),Kr=c(He),$r=c(Le),ei=c(Ue),ti=c(Ue),Jr((ii=function(){this.format=ai&&ai(),this.depthLoadOp=si&&si(),this.depthStoreOp=ni&&ni(),this.stencilLoadOp=oi&&oi(),this.stencilStoreOp=hi&&hi(),this.sampleCount=di&&di(),this.beginAccesses=li&&li(),this.endAccesses=ui&&ui()},ai=_(ii.prototype,"format",[Zr],(function(){return qe.UNKNOWN})),si=_(ii.prototype,"depthLoadOp",[Xr],(function(){return He.CLEAR})),ni=_(ii.prototype,"depthStoreOp",[Yr],(function(){return Le.STORE})),oi=_(ii.prototype,"stencilLoadOp",[Kr],(function(){return He.CLEAR})),hi=_(ii.prototype,"stencilStoreOp",[$r],(function(){return Le.STORE})),di=_(ii.prototype,"sampleCount",[p],(function(){return 1})),li=_(ii.prototype,"beginAccesses",[ei],(function(){return Ue.NONE})),ui=_(ii.prototype,"endAccesses",[ti],(function(){return Ue.DEPTH_STENCIL_ATTACHMENT_WRITE})),ri=ii))||ri);_i=u("RenderPassDesc"),pi=c([Ri]),ci=c(Pi),_i((fi=function(){this.index=Si&&Si(),this.colorAttachments=gi&&gi(),this.depthStencilAttachment=Oi&&Oi()},Si=_(fi.prototype,"index",[p],(function(){return-1})),gi=_(fi.prototype,"colorAttachments",[pi],(function(){return[]})),Oi=_(fi.prototype,"depthStencilAttachment",[ci],(function(){return new Pi})),fi)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(yi||(yi={})),w(yi);var Ni=(Ai=u("RenderQueueDesc"),Ti=c(yi),Ei=c([D]),Ai((Fi=function(){this.isTransparent=Ii&&Ii(),this.sortMode=vi&&vi(),this.stages=wi&&wi()},Ii=_(Fi.prototype,"isTransparent",[p],(function(){return!1})),vi=_(Fi.prototype,"sortMode",[Ti],(function(){return yi.FRONT_TO_BACK})),wi=_(Fi.prototype,"stages",[Ei],(function(){return[]})),mi=Fi))||mi);function Ci(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function Li(e,t){return e.priority-t.priority||e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var Mi=function(){function e(e){this._passDesc=e,this._passPool=new b((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new B(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,r){var i=e.model.subModels[t],a=i.passes[r],s=i.shaders[r];if(a.blendState.targets[0].blend!==this._passDesc.isTransparent||!(a.phase&this._passDesc.phases))return!1;var n=a.priority<<16|i.priority<<8|r,o=this._passPool.add();return o.priority=e.model.priority,o.hash=n,o.depth=e.depth||0,o.shaderId=s.typedID,o.subModel=i,o.passIdx=r,this.queue.push(o),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,r){for(var i=0;i<this.queue.length;++i){var a=this.queue.array[i],s=a.subModel,n=a.passIdx,o=s.inputAssembler,h=s.passes[n],d=s.shaders[n],l=re.getOrCreatePipelineState(e,h,d,t,o);r.bindPipelineState(l),r.bindDescriptorSet(ie.MATERIAL,h.descriptorSet),r.bindDescriptorSet(ie.LOCAL,s.descriptorSet),r.bindInputAssembler(o),r.draw(o)}},e}();function Hi(e){for(var t=0,r=0;r<e.stages.length;r++)t|=Oe(e.stages[r]);var i=Ci;switch(e.sortMode){case yi.BACK_TO_FRONT:i=Li;break;case yi.FRONT_TO_BACK:i=Ci}return new Mi({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function xi(e){e.clear()}function Ui(e){e.sort()}var Gi=function(){function e(){this.queue=new Set,this._renderQueue=[]}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._renderQueue.length=0,this.queue.clear()},t.sort=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.pass.blendState.targets[0].blend||this._renderQueue.push(t.value),t=e.next();for(t=(e=this.queue.values()).next();!t.done;)t.value.pass.blendState.targets[0].blend&&this._renderQueue.push(t.value),t=e.next()},t.uploadBuffers=function(e){for(var t=this.queue.values(),r=t.next();!r.done;)r.value.hasPendingModels&&r.value.uploadBuffers(e),r=t.next()},t.recordCommandBuffer=function(e,t,r,i,a){void 0===i&&(i=null);for(var s=0===this._renderQueue.length?this.queue.values():this._renderQueue[Symbol.iterator](),n=s.next();!n.done;){var o=n.value,h=o.instances,d=o.pass;if(o.hasPendingModels){r.bindDescriptorSet(ie.MATERIAL,d.descriptorSet);for(var l=null,u=0;u<h.length;++u){var _=h[u];if(_.count){var p=_.shader,c=re.getOrCreatePipelineState(e,d,p,t,_.ia);l!==c&&(r.bindPipelineState(c),l=c),i&&r.bindDescriptorSet(ie.GLOBAL,i),a?r.bindDescriptorSet(ie.LOCAL,_.descriptorSet,a):r.bindDescriptorSet(ie.LOCAL,_.descriptorSet,n.value.dynamicOffsets),r.bindInputAssembler(_.ia),r.draw(_.ia)}}}n=s.next()}},e}(),Wi=new O((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),Qi=new i,Vi=new Float32Array(4),zi=[],qi=[],ki=new o,ji=new o,Ji=new s(0,0,0,.5,.5,.5),Zi=new s;function Xi(e,t){return!(!t.worldBounds||n.aabbWithAABB(t.worldBounds,e.aabb))}function Yi(e,t){return!(!t.worldBounds||n.aabbWithAABB(t.worldBounds,e.aabb)&&n.aabbFrustum(t.worldBounds,e.frustum))}function Ki(e,t){return!(!t.worldBounds||n.aabbWithAABB(t.worldBounds,e.aabb))}function $i(e,t){return s.transform(Zi,Ji,e.node.getWorldMatrix()),!(!t.worldBounds||n.aabbWithAABB(t.worldBounds,Zi))}var ea="forward-add",ta=Oe(ea),ra=[];function ia(e,r,i){void 0===i&&(i="default");var a=t.rendering;J()&&(ta=a.getPhaseID(a.getPassID(i),ea)),r.length=0;for(var s=!1,n=0;n<e.length;n++){for(var o=e[n].passes,h=-1,d=0;d<o.length;d++)if((!a||!a.enableEffectImport)&&o[d].phase===ta||J()&&o[d].phaseID===ta){h=d,s=!0;break}r.push(h)}return s}var aa=function(){function e(e){this._lightPasses=[],this._instancedLightPassPool=Wi.alloc(),this._shadowUBO=new Float32Array(G.COUNT),this._lightBufferCount=16,this._instancedQueues=[],this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(ae.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.HOST|Re.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new et(this._lightBuffer,0,ae.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueues.forEach((function(e){e.clear()})),this._instancedQueues.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}Wi.freeArray(this._lightPasses),this._lightPasses.length=0,this._instancedLightPassPool.dynamicOffsets.length=0,this._instancedLightPassPool.lights.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,r=0;r<t.length;r++){var i=t[r],a=e.get(i);a&&(a.getBuffer(Q.BINDING).destroy(),a.getTexture(K).destroy(),a.getTexture(ee).destroy(),a.destroy()),e.delete(i)}},t._bindForwardAddLight=function(e,t){void 0===t&&(t="default");for(var r=this._pipeline.pipelineSceneData.renderObjects,i=0;i<r.length;i++){var a=r[i].model,s=a.subModels;if(ia(s,ra,t)&&(qi.length=0,this._lightCulling(a,e),qi.length||!(e.length>0)))for(var n=0;n<s.length;n++){var o=ra[n];if(!(o<0)){var h=s[n],d=h.passes[o];h.passes[0].blendState.targets[0].blend||(h.descriptorSet.bindBuffer(se.BINDING,this._firstLightBufferView),h.descriptorSet.update(),this._addRenderQueue(d,h,a,o))}}}},t.gatherLightPasses=function(e,t,r){void 0===r&&(r="default"),this.clear();var i=this._pipeline.pipelineSceneData.validPunctualLights;if(i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t),this._bindForwardAddLight(i,r);for(var a=0;a<i.length;a++){var s=i[a];this._instancedLightPassPool.lights.push(s),this._instancedLightPassPool.dynamicOffsets.push(this._lightBufferStride*a)}this._instancedQueues.forEach((function(e){e.uploadBuffers(t)}))}else this._bindForwardAddLight(i,r)},t.recordCommandBuffer=function(e,t,r){for(var i=this._pipeline.globalDSManager,a=0;a<this._instancedQueues.length;++a){var s=this._instancedLightPassPool.lights[a];zi[0]=this._instancedLightPassPool.dynamicOffsets[a];var n=i.getOrCreateDescriptorSet(s);this._instancedQueues[a].recordCommandBuffer(e,t,r,n,zi)}for(var o=0;o<this._lightPasses.length;o++){var h=this._lightPasses[o],d=h.subModel,l=h.passIdx,u=h.dynamicOffsets,_=h.lights,p=d.passes[l],c=d.shaders[l],f=d.inputAssembler,S=re.getOrCreatePipelineState(e,p,c,t,f),g=p.descriptorSet,O=d.descriptorSet;r.bindPipelineState(S),r.bindDescriptorSet(ie.MATERIAL,g),r.bindInputAssembler(f);for(var A=0;A<u.length;++A){var T=_[A],E=i.getOrCreateDescriptorSet(T);zi[0]=u[A],r.bindDescriptorSet(ie.GLOBAL,E),r.bindDescriptorSet(ie.LOCAL,O,zi),r.draw(f)}}},t._lightCulling=function(e,t){for(var r=!1,i=0;i<t.length;i++){var a=t[i];switch(a.type){case L.SPHERE:r=Xi(a,e);break;case L.SPOT:r=Yi(a,e);break;case L.POINT:r=Ki(a,e);break;case L.RANGED_DIRECTIONAL:r=$i(a,e)}r||qi.push(i)}},t._addRenderQueue=function(e,t,r,i){var a=this._pipeline.pipelineSceneData.validPunctualLights,s=e.batchingScheme,n=null;s===Ae.NONE&&((n=Wi.alloc()).subModel=t,n.passIdx=i);for(var o=0;o<qi.length;o++){var h=qi[o],d=a[h];if((d.visibility&r.node.layer)===r.node.layer)if(s===Ae.INSTANCING){var l=e.getInstancedBuffer(o);l.merge(t,i),l.dynamicOffsets[0]=this._lightBufferStride,this._instancedQueues[o]||(this._instancedQueues[o]=new Gi),this._instancedQueues[o].queue.add(l)}else n.lights.push(d),n.dynamicOffsets.push(this._lightBufferStride*h)}s===Ae.NONE&&this._lightPasses.push(n)},t._updateLightDescriptorSet=function(e,t){for(var r=this._pipeline.device,i=this._pipeline.pipelineSceneData,a=i.shadows,s=i.shadowFrameBufferMap,n=e.scene.mainLight,h=j(r)?0:1,l=this._pipeline.globalDSManager,u=i.validPunctualLights,_=this._pipeline.device.capabilities,p=0;p<u.length;p++){var c=u[p],f=l.getOrCreateDescriptorSet(c);if(f){var S=void 0,g=void 0;switch(c.type){case L.SPHERE:n&&Rt.updatePlanarNormalAndDistance(a,this._shadowUBO),this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=L.SPHERE,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,d.toArray(this._shadowUBO,a.shadowColor,G.SHADOW_COLOR_OFFSET);break;case L.SPOT:var O=c;if(n&&Rt.updatePlanarNormalAndDistance(a,this._shadowUBO),o.invert(ki,c.node.getWorldMatrix()),o.perspective(ji,c.angle,1,.001,c.range,!0,_.clipSpaceMinZ,_.clipSpaceSignY,0),S=ji.clone(),g=ji.clone().invert(),o.multiply(ji,ji,ki),o.toArray(this._shadowUBO,ki,G.MAT_LIGHT_VIEW_OFFSET),o.toArray(this._shadowUBO,ji,G.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c.range,this._shadowUBO[G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[G.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=O.shadowPcf,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=O.shadowBias,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=L.SPOT,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=O.shadowNormalBias,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=S.m10,this._shadowUBO[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=S.m14,this._shadowUBO[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=S.m11,this._shadowUBO[G.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=S.m15,this._shadowUBO[G.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=g.m10,this._shadowUBO[G.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=g.m14,this._shadowUBO[G.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=g.m11,this._shadowUBO[G.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=g.m15,this._shadowUBO[G.SHADOW_PROJ_INFO_OFFSET+0]=S.m00,this._shadowUBO[G.SHADOW_PROJ_INFO_OFFSET+1]=S.m05,this._shadowUBO[G.SHADOW_PROJ_INFO_OFFSET+2]=1/S.m00,this._shadowUBO[G.SHADOW_PROJ_INFO_OFFSET+3]=1/S.m05,d.toArray(this._shadowUBO,a.shadowColor,G.SHADOW_COLOR_OFFSET),s.has(c)){var A,T=null==(A=s.get(c))?void 0:A.colorTextures[0];T&&l.bindTexture(ee,T)}break;case L.POINT:n&&Rt.updatePlanarNormalAndDistance(a,this._shadowUBO),this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[G.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=L.POINT,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[G.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,d.toArray(this._shadowUBO,a.shadowColor,G.SHADOW_COLOR_OFFSET)}l.update(),t.updateBuffer(f.getBuffer(Q.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var r=e.exposure,a=this._pipeline.pipelineSceneData,s=a.isHDR,n=a.shadows,o=a.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=S(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView=Ie.gfxDevice.createBuffer(new et(this._lightBuffer,0,ae.SIZE)));for(var h=0,d=0;h<o.length;h++,d+=this._lightBufferElementCount){var l=o[h];switch(l.type){case L.SPHERE:if(i.toArray(Vi,l.position),Vi[3]=L.SPHERE,this._lightBufferData.set(Vi,d+ae.LIGHT_POS_OFFSET),Vi[0]=l.size,Vi[1]=l.range,Vi[2]=0,Vi[3]=0,this._lightBufferData.set(Vi,d+ae.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(Vi,l.color),l.useColorTemperature){var u=l.finalColor;Vi[0]=u.x,Vi[1]=u.y,Vi[2]=u.z}Vi[3]=s?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(Vi,d+ae.LIGHT_COLOR_OFFSET);break;case L.SPOT:if(i.toArray(Vi,l.position),Vi[3]=L.SPOT,this._lightBufferData.set(Vi,d+ae.LIGHT_POS_OFFSET),Vi[0]=l.size,Vi[1]=l.range,Vi[2]=l.spotAngle,Vi[3]=n.enabled&&l.shadowEnabled&&n.type===_e.ShadowMap?1:0,this._lightBufferData.set(Vi,d+ae.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(Vi,l.direction),this._lightBufferData.set(Vi,d+ae.LIGHT_DIR_OFFSET),i.toArray(Vi,l.color),l.useColorTemperature){var _=l.finalColor;Vi[0]=_.x,Vi[1]=_.y,Vi[2]=_.z}Vi[3]=s?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(Vi,d+ae.LIGHT_COLOR_OFFSET),Vi[0]=0,Vi[1]=0,Vi[2]=0,Vi[3]=l.angleAttenuationStrength,this._lightBufferData.set(Vi,d+ae.LIGHT_BOUNDING_SIZE_VS_OFFSET);break;case L.POINT:if(i.toArray(Vi,l.position),Vi[3]=L.POINT,this._lightBufferData.set(Vi,d+ae.LIGHT_POS_OFFSET),Vi[0]=0,Vi[1]=l.range,Vi[2]=0,Vi[3]=0,this._lightBufferData.set(Vi,d+ae.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(Vi,l.color),l.useColorTemperature){var p=l.finalColor;Vi[0]=p.x,Vi[1]=p.y,Vi[2]=p.z}Vi[3]=s?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(Vi,d+ae.LIGHT_COLOR_OFFSET);break;case L.RANGED_DIRECTIONAL:i.toArray(Vi,l.position),Vi[3]=L.RANGED_DIRECTIONAL,this._lightBufferData.set(Vi,d+ae.LIGHT_POS_OFFSET),i.toArray(Vi,l.right),Vi[3]=0,this._lightBufferData.set(Vi,d+ae.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(Vi,l.direction),Vi[3]=0,this._lightBufferData.set(Vi,d+ae.LIGHT_DIR_OFFSET);var c=l.scale;if(Qi.set(.5*c.x,.5*c.y,.5*c.z),i.toArray(Vi,Qi),Vi[3]=0,this._lightBufferData.set(Vi,d+ae.LIGHT_BOUNDING_SIZE_VS_OFFSET),i.toArray(Vi,l.color),l.useColorTemperature){var f=l.finalColor;Vi[0]=f.x,Vi[1]=f.y,Vi[2]=f.z}Vi[3]=s?l.illuminance*r:l.illuminance,this._lightBufferData.set(Vi,d+ae.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),sa=new s,na=Oe("planar-shadow");function oa(e){var r=e.passes,i=t.rendering;J()&&(na=i.getPhaseID(i.getPassID("default"),"planar-shadow"));for(var a=0;a<r.length;a++)if((!i||!i.enableEffectImport)&&r[a].phase===na||J()&&r[a].phaseID===na)return a;return-1}var ha,da,la,ua,_a,pa,ca,fa,Sa=function(){function e(e){this._subModelArray=[],this._shaderArray=[],this._passArray=[],this._castModels=[],this._instancedQueue=new Gi,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.clear=function(){this._subModelArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._castModels.length=0},t.gatherShadowPasses=function(e,t){this.clear();var r=this._pipeline.pipelineSceneData.shadows;if(r.enabled&&r.type===_e.Planar&&!(r.normal.length()<1e-6)){var i=e.scene,a=e.frustum,o=!!(e.visibility&ne.BitMask.DEFAULT);if(i.mainLight&&o){for(var h=i.models,d=e.visibility,l=0;l<h.length;l++){var u=h[l];i.isCulledByLod(e,u)||u.enabled&&u.node&&u.castShadow&&u.node&&(d&u.node.layer)===u.node.layer&&this._castModels.push(u)}for(var _=0;_<this._castModels.length;_++){var p=this._castModels[_];if(!p.worldBounds||(s.transform(sa,p.worldBounds,r.matLight),n.aabbFrustum(sa,a)))for(var c=p.subModels,f=0;f<c.length;f++){var S=c[f],g=oa(S);if(g<0){this._subModelArray.push(S);var O=r.getPlanarShader(S.patches);if(!O)continue;this._shaderArray.push(O),this._passArray.push(r.material.passes[0])}else{var A=S.passes[g];if(A.batchingScheme===Ae.INSTANCING){var T=A.getInstancedBuffer();T.merge(S,g),this._instancedQueue.queue.add(T)}else{var E=S.shaders[g];this._subModelArray.push(S),E&&this._shaderArray.push(E),this._passArray.push(A)}}}}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,r){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===_e.Planar){this._instancedQueue.recordCommandBuffer(e,t,r);for(var a=0;a<this._subModelArray.length;++a){var s=this._subModelArray[a],n=this._shaderArray[a],o=this._passArray[a],h=s.inputAssembler,d=re.getOrCreatePipelineState(e,o,n,t,h),l=o.descriptorSet;r.bindPipelineState(d),r.bindDescriptorSet(ie.MATERIAL,l),r.bindDescriptorSet(ie.LOCAL,s.descriptorSet),r.bindInputAssembler(h),r.draw(h)}}},e}(),ga=function(){function e(){this._phaseID=Oe("default");var e=t.rendering;J()&&(this._phaseID=e.getPhaseID(e.getPassID("default"),"default"))}var r=e.prototype;return r.activate=function(e){this._pipeline=e},r.render=function(e,t){for(var r=this._pipeline,i=r.device,a=r.commandBuffers[0],s=e.scene.batches,n=0;n<s.length;n++){var o=s[n],h=!1;if(e.visibility&o.visFlags&&(h=!0),h)for(var d=o.shaders.length,l=0;l<d;l++){var u=o.passes[l];if(u.phase===this._phaseID){var _=o.shaders[l],p=o.inputAssembler,c=re.getOrCreatePipelineState(i,u,_,t,p);a.bindPipelineState(c),a.bindDescriptorSet(ie.MATERIAL,u.descriptorSet);var f=o.descriptorSet;a.bindDescriptorSet(ie.LOCAL,f),a.bindInputAssembler(p),a.draw(p)}}}},e}(),Oa=[new tt(0,0,0,1)],Aa=e("ForwardStage",(ha=u("ForwardStage"),da=c([Ni]),ha((pa=function(e){function t(){var t;return(t=e.call(this)||this).renderQueues=_a&&_a(),t._renderQueues=[],t._renderArea=new Ke,t._instancedQueue=new Gi,t._phaseID=Oe("default"),t._clearFlag=4294967295,t._uiPhase=new ga,t.additiveInstanceQueues=[],t}E(t,e);var r=t.prototype;return r.addRenderInstancedQueue=function(e){this.additiveInstanceQueues.includes(e)||this.additiveInstanceQueues.push(e)},r.removeRenderInstancedQueue=function(e){var t=this.additiveInstanceQueues.indexOf(e);t>-1&&this.additiveInstanceQueues.splice(t,1)},r.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},r.activate=function(t,r){e.prototype.activate.call(this,t,r);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=Hi(this.renderQueues[i]);this._additiveLightQueue=new aa(this._pipeline),this._planarQueue=new Sa(this._pipeline),this._uiPhase.activate(t)},r.destroy=function(){},r.render=function(e){var t,r=this._pipeline,i=r.device;this._instancedQueue.clear(),this._renderQueues.forEach(xi);for(var a=r.pipelineSceneData.renderObjects,s=0,n=0,o=0,h=0;h<a.length;++h){var d=a[h],l=d.model.subModels;for(s=0;s<l.length;++s){var u=l[s],_=u.passes;for(n=0;n<_.length;++n){var p=_[n];if(p.phase===this._phaseID&&4294967295===p.passID)if(p.batchingScheme===Ae.INSTANCING){var c=p.getInstancedBuffer();c.merge(u,n),this._instancedQueue.queue.add(c)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(d,s,n)}}}this._instancedQueue.sort(),this._renderQueues.forEach(Ui);var f=r.commandBuffers[0];r.pipelineUBO.updateShadowUBO(e);for(var S=0;S<this.additiveInstanceQueues.length;S++)this.additiveInstanceQueues[S].uploadBuffers(f);this._instancedQueue.uploadBuffers(f),this._additiveLightQueue.gatherLightPasses(e,f),this._planarQueue.gatherShadowPasses(e,f),e.clearFlag&Me.COLOR&&(Oa[0].x=e.clearColor.x,Oa[0].y=e.clearColor.y,Oa[0].z=e.clearColor.z,Oa[0].w=e.clearColor.w),r.generateRenderArea(e,this._renderArea);var g=e.window.framebuffer,O=r.getRenderPass(e.clearFlag&this._clearFlag,g);f.beginRenderPass(O,g,this._renderArea,Oa,e.clearDepth,e.clearStencil),f.bindDescriptorSet(ie.GLOBAL,r.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,O,f);for(var A=0;A<this.additiveInstanceQueues.length;A++)this.additiveInstanceQueues[A].recordCommandBuffer(i,O,f);this._instancedQueue.recordCommandBuffer(i,O,f),this._additiveLightQueue.recordCommandBuffer(i,O,f),f.bindDescriptorSet(ie.GLOBAL,r.descriptorSet),this._planarQueue.recordCommandBuffer(i,O,f),this._renderQueues[1].recordCommandBuffer(i,O,f),null==(t=e.geometryRenderer)||t.render(O,f,r.pipelineSceneData),this._uiPhase.render(e,O),Te(i,O,f,r.profiler,e),f.endRenderPass()},t}(Gt),pa.initInfo={name:"ForwardStage",priority:$t.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:yi.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:yi.BACK_TO_FRONT,stages:["default","planarShadow"]}]},_a=_((ua=pa).prototype,"renderQueues",[da,p],(function(){return[]})),la=ua))||la)),Ta=e("ForwardFlow",u("ForwardFlow")((fa=function(e){function t(){return e.apply(this,arguments)||this}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var r=new Aa;r.initialize(Aa.initInfo),this._stages.push(r)}return!0},r.activate=function(t){e.prototype.activate.call(this,t)},r.render=function(t){e.prototype.render.call(this,t)},r.destroy=function(){e.prototype.destroy.call(this)},t}(jt),fa.initInfo={name:oe,priority:er.FORWARD,stages:[]},ca=fa))||ca),Ea=Oe("shadow-caster");function ma(e){var r=e.passes,i=t.rendering;J()&&(Ea=i.getPhaseID(i.getPassID("default"),"shadow-caster"));for(var a=0;a<r.length;a++)if((!i||!i.enableEffectImport)&&r[a].phase===Ea||J()&&r[a].phaseID===Ea)return a;return-1}var Fa,Ia,va,wa,Da=function(){function e(e){this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=new Gi,this._pipeline=e}var t=e.prototype;return t.gatherLightPasses=function(e,t,r,i){void 0===i&&(i=0),this.clear();var a=this._pipeline.pipelineSceneData,s=a.shadows;if(t&&s.enabled&&s.type===_e.ShadowMap){switch(t.type){case L.DIRECTIONAL:var o=t;if(o.shadowEnabled){var h,d=a.csmLayers;_t(e,a,h=o.shadowFixedArea?d.specialLayer:d.layers[i]);for(var l=h.shadowObjects,u=0;u<l.length;u++){var _=l[u].model;this.add(_,i)}}break;case L.SPOT:var p=t;if(p.shadowEnabled)for(var c=p.visibility,f=a.csmLayers.castShadowObjects,S=0;S<f.length;S++){var g=f[S].model;(!g.worldBounds||(c&g.node.layer)===g.node.layer&&n.aabbFrustum(g.worldBounds,p.frustum))&&this.add(g,i)}}this._instancedQueue.uploadBuffers(r)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear()},t.add=function(e,t){for(var r=e.subModels,i=0;i<r.length;i++){var a=r[i],s=ma(a);if(!(s<0)){var n=a.passes[s];if(n.batchingScheme===Ae.INSTANCING){var o=n.getInstancedBuffer(t);o.merge(a,s),this._instancedQueue.queue.add(o)}else{var h=a.shaders[s];this._subModelsArray.push(a),h&&this._shaderArray.push(h),this._passArray.push(n)}}}},t.recordCommandBuffer=function(e,t,r){this._instancedQueue.recordCommandBuffer(e,t,r);for(var i=0;i<this._subModelsArray.length;++i){var a=this._subModelsArray[i],s=this._shaderArray[i],n=this._passArray[i],o=a.inputAssembler,h=re.getOrCreatePipelineState(e,n,s,t,o),d=n.descriptorSet;r.bindPipelineState(h),r.bindDescriptorSet(ie.MATERIAL,d),r.bindDescriptorSet(ie.LOCAL,a.descriptorSet),r.bindInputAssembler(o),r.draw(o)}},e}(),ba=[new tt(1,1,1,1)],Ba=e("ShadowStage",u("ShadowStage")((Ia=function(e){function t(){var t;return(t=e.call(this)||this)._additiveShadowQueue=void 0,t._shadowFrameBuffer=null,t._renderArea=new Ke,t._light=null,t._globalDS=null,t._level=0,t._isShadowMapCleared=!1,t}E(t,e);var r=t.prototype;return r.setUsage=function(e,t,r,i){void 0===i&&(i=0),this._globalDS=e,this._light=t,this._shadowFrameBuffer=r,this._level=i},r.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null==(e=this._additiveShadowQueue)||e.clear()},r.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer&&!this._isShadowMapCleared){ba[0].w=e.clearColor.w;var t=this._pipeline,r=t.pipelineSceneData,i=r.shadingScale,a=r.shadows,s=e.viewport,n=a.size;this._renderArea.x=s.x*n.x,this._renderArea.y=s.y*n.y,this._renderArea.width=s.width*n.x*i,this._renderArea.height=s.height*n.y*i;var o=t.commandBuffers[0],h=this._shadowFrameBuffer.renderPass;o.beginRenderPass(h,this._shadowFrameBuffer,this._renderArea,ba,e.clearDepth,e.clearStencil),o.endRenderPass(),this._isShadowMapCleared=!0}},r.render=function(e){var t=this._pipeline,r=t.pipelineSceneData,i=r.shadows,a=this._globalDS,s=t.commandBuffers[0],n=this._level,o=t.device;if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(a,this._light,n),this._additiveShadowQueue.gatherLightPasses(e,this._light,s,n);var h=i.size;switch(this._light.type){case L.DIRECTIONAL:var d=this._light;if(d.shadowFixedArea||d.csmLevel===fe.LEVEL_1||!r.csmSupported)this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=h.x,this._renderArea.height=h.y;else{var l=o.capabilities.screenSpaceSignY;this._renderArea.x=n%2*.5*h.x,this._renderArea.y=l>0?.5*(1-Math.floor(n/2))*h.y:.5*Math.floor(n/2)*h.y,this._renderArea.width=.5*h.x,this._renderArea.height=.5*h.y}break;case L.SPOT:this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=h.x,this._renderArea.height=h.y}var u=this._shadowFrameBuffer.renderPass;s.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,ba,e.clearDepth,e.clearStencil),s.bindDescriptorSet(ie.GLOBAL,a),this._additiveShadowQueue.recordCommandBuffer(o,u,s),s.endRenderPass(),this._isShadowMapCleared=!1}},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._additiveShadowQueue=new Da(t),this._isShadowMapCleared=!1},t}(Gt),Ia.initInfo={name:"ShadowStage",priority:$t.FORWARD,tag:0},Fa=Ia))||Fa),ya=[],Ra=e("ShadowFlow",u("ShadowFlow")((wa=function(e){function t(){var t;return(t=e.call(this)||this)._shadowRenderPass=null,t}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var r=new Ba;r.initialize(Ba.initInfo),this._stages.push(r)}return!0},r.activate=function(t){e.prototype.activate.call(this,t);var r=j(t.device)?0:1;t.macros.CC_SHADOWMAP_FORMAT=r;var i=t.device.gfxAPI===rt.WEBGL?1:0;t.macros.CC_SHADOWMAP_USE_LINEAR_DEPTH=i,t.pipelineSceneData.csmSupported=t.device.capabilities.maxFragmentUniformVectors>=(z.COUNT+q.COUNT+G.COUNT+k.COUNT)/4,t.macros.CC_SUPPORT_CASCADED_SHADOW_MAP=t.pipelineSceneData.csmSupported,t.macros.CC_SHADOW_TYPE=0,t.macros.CC_DIR_SHADOW_PCF_TYPE=ce.HARD,t.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,t.macros.CC_CASCADED_LAYERS_TRANSITION=0,t.onGlobalPipelineStateChanged()},r.render=function(e){var t=this._pipeline,r=t.pipelineSceneData.shadows,i=t.pipelineSceneData.csmLayers,a=t.pipelineSceneData.shadowFrameBufferMap,s=i.castShadowObjects,n=this._pipeline.pipelineSceneData.validPunctualLights;if(r.enabled&&r.type===_e.ShadowMap){for(var o=0,h=0;o<r.maxReceived&&h<n.length;){var d=n[h];d.type===L.SPOT&&d.shadowEnabled&&(ya.push(d),o++),h++}if(0!==s.length){r.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l&&l.shadowEnabled){var u=t.descriptorSet;a.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);var _=a.get(l);if(l.shadowFixedArea)this._renderStage(e,l,_,u);else for(var p=t.pipelineSceneData.csmSupported?l.csmLevel:1,c=0;c<p;c++)this._renderStage(e,l,_,u,c)}for(var f=0;f<ya.length;f++){var S=ya[f],g=t.globalDSManager.getOrCreateDescriptorSet(S);a.has(S)||this._initShadowFrameBuffer(t,S,e.window.swapchain);var O=a.get(S);this._renderStage(e,S,O,g)}ya.length=0}else this.clearShadowMap(ya,e)}},r.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,r=Array.from(t.values()),i=0;i<r.length;i++){var a=r[i];if(a){for(var s=a.colorTextures,n=0;n<s.length;n++){var o=s[n];o&&o.destroy()}s.length=0;var h=a.depthStencilTexture;h&&h.destroy(),a.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},r._initShadowFrameBuffer=function(e,t){var r=e.device,i=e.pipelineSceneData.shadows.size,a=e.pipelineSceneData.shadowFrameBufferMap,s=j(r)?qe.R32F:qe.RGBA8;if(!this._shadowRenderPass){var n=new Ne;n.format=s,n.loadOp=He.CLEAR,n.storeOp=Le.STORE,n.sampleCount=1;var o=new Ce;o.format=qe.DEPTH_STENCIL,o.depthLoadOp=He.CLEAR,o.depthStoreOp=Le.DISCARD,o.stencilLoadOp=He.CLEAR,o.stencilStoreOp=Le.DISCARD,o.sampleCount=1;var h=new Ge([n],o);this._shadowRenderPass=r.createRenderPass(h)}var d=[];d.push(r.createTexture(new Ze(Xe.TEX2D,Ye.COLOR_ATTACHMENT|Ye.SAMPLED,s,i.x,i.y)));var l=r.createTexture(new Ze(Xe.TEX2D,Ye.DEPTH_STENCIL_ATTACHMENT,qe.DEPTH_STENCIL,i.x,i.y)),u=r.createFramebuffer(new Qe(this._shadowRenderPass,d,l));a.set(t,u)},r._renderStage=function(e,t,r,i,a){void 0===a&&(a=0);for(var s=0;s<this._stages.length;s++){var n=this._stages[s];n.setUsage(i,t,r,a),n.render(e)}},r.clearShadowMap=function(e,t){var r=this._pipeline,i=r.pipelineSceneData,a=t.scene.mainLight;if(a){var s=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(a)||this._initShadowFrameBuffer(this._pipeline,a,t.window.swapchain);for(var n=i.shadowFrameBufferMap.get(a),o=0;o<this._stages.length;o++){var h=this._stages[o];h.setUsage(s,a,n),h.clearFramebuffer(t)}}for(var d=0;d<e.length;d++){var l=e[d],u=r.globalDSManager.getOrCreateDescriptorSet(l);i.shadowFrameBufferMap.has(l)||this._initShadowFrameBuffer(this._pipeline,l,t.window.swapchain);for(var _=i.shadowFrameBufferMap.get(l),p=0;p<this._stages.length;p++){var c=this._stages[p];c.setUsage(u,l,_),c.clearFramebuffer(t)}}},r.resizeShadowMap=function(){for(var e,t=this._pipeline.pipelineSceneData.shadows,r=t.size,i=this._pipeline,a=i.device,s=i.pipelineSceneData.shadowFrameBufferMap,n=j(a)?qe.R32F:qe.RGBA8,o=v(s.keys());!(e=o()).done;){var h=e.value,d=s.get(h);if(d){var l=[];l.push(i.device.createTexture(new Ze(Xe.TEX2D,Ye.COLOR_ATTACHMENT|Ye.SAMPLED,n,r.x,r.y)));var u=d.depthStencilTexture;u&&u.resize(r.x,r.y);var _=d.renderPass;d.destroy();var p=a.createFramebuffer(new Qe(_,l,u));s.set(h,p)}}t.shadowMapDirty=!1},t}(jt),wa.initInfo={name:he,priority:er.SHADOW,tag:Di.SCENE,stages:[]},va=wa))||va),Pa="CC_USE_RGBE_OUTPUT",Na=Oe("default"),Ca=Oe("reflect-map");function La(e){var r=e.passes,i=t.rendering;J()&&(Na=i.getPhaseID(i.getPassID("default"),"default"));for(var a=0;a<r.length;a++)if((!i||!i.enableEffectImport)&&r[a].phase===Na||J()&&r[a].phaseID===Na)return a;return-1}function Ma(e){var r=e.passes,i=t.rendering;J()&&(Ca=i.getPhaseID(i.getPassID("default"),"reflect-map"));for(var a=0;a<r.length;a++)if((!i||!i.enableEffectImport)&&r[a].phase===Ca||J()&&r[a].phaseID===Ca)return a;return-1}var Ha,xa,Ua,Ga,Wa,Qa,Va,za,qa,ka=function(){function e(e){this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._rgbeSubModelsArray=[],this._instancedQueue=new Gi,this._patches=[],this._pipeline=e}var t=e.prototype;return t.gatherRenderObjects=function(e,t,r){this.clear();var i=t.scene,a=this._pipeline.pipelineSceneData.skybox;a.enabled&&a.model&&e.camera.clearFlag&R.VALUE&&this.add(a.model);for(var s=i.models,o=e.visibility,h=0;h<s.length;h++){var d=s[h];d.node&&!i.isCulledByLod(t,d)&&((o&d.node.layer)===d.node.layer||o&d.visFlags)&&d.enabled&&d.worldBounds&&d.bakeToReflectionProbe&&(e.probeType===U.CUBE?n.aabbWithAABB(d.worldBounds,e.boundingBox)&&this.add(d):n.aabbFrustum(d.worldBounds,e.camera.frustum)&&this.add(d))}this._instancedQueue.uploadBuffers(r)},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._rgbeSubModelsArray.length=0},t.add=function(e){for(var t=e.subModels,r=0;r<t.length;r++){var i=t[r];if(!i.passes[0].blendState.targets[0].blend){var a=Ma(i),s=!0;if(a<0&&(a=La(i),s=!1),!(a<0)){var n=i.passes[a],o=n.batchingScheme;if(!s){this._patches=[],this._patches=this._patches.concat(i.patches);var h=[{name:Pa,value:!0}];this._patches=this._patches.concat(h),i.onMacroPatchesStateChanged(this._patches),this._rgbeSubModelsArray.push(i)}if(o===Ae.INSTANCING){var d=n.getInstancedBuffer();d.merge(i,a),this._instancedQueue.queue.add(d)}else{var l=i.shaders[a];this._subModelsArray.push(i),l&&this._shaderArray.push(l),this._passArray.push(n)}}}}},t.recordCommandBuffer=function(e,t,r){this._instancedQueue.recordCommandBuffer(e,t,r);for(var i=0;i<this._subModelsArray.length;++i){var a=this._subModelsArray[i],s=this._shaderArray[i],n=this._passArray[i],o=a.inputAssembler,h=re.getOrCreatePipelineState(e,n,s,t,o),d=n.descriptorSet;r.bindPipelineState(h),r.bindDescriptorSet(ie.MATERIAL,d),r.bindDescriptorSet(ie.LOCAL,a.descriptorSet),r.bindInputAssembler(o),r.draw(o)}this.resetRGBEMacro(),this._instancedQueue.clear()},t.resetRGBEMacro=function(){for(var e=0;e<this._rgbeSubModelsArray.length;e++){this._patches=[];var t=this._rgbeSubModelsArray[e];if(this._patches=this._patches.concat(t.patches),this._patches){for(var r=0;r<this._patches.length;r++)if(this._patches[r].name===Pa){this._patches.splice(r,1);break}t.onMacroPatchesStateChanged(this._patches)}}},e}(),ja=[new tt(1,1,1,1)],Ja=e("ReflectionProbeStage",u("ReflectionProbeStage")((xa=function(e){function t(){var t;return(t=e.call(this)||this)._frameBuffer=null,t._renderArea=new Ke,t._probe=null,t._probeRenderQueue=void 0,t._rgbeColor=new i,t}E(t,e);var r=t.prototype;return r.setUsageInfo=function(e,t){this._probe=e,this._frameBuffer=t},r.destroy=function(){var e;this._frameBuffer=null,null==(e=this._probeRenderQueue)||e.clear()},r.clearFramebuffer=function(e){if(this._frameBuffer){ja[0].w=e.clearColor.w;var t=this._pipeline,r=t.pipelineSceneData.shadingScale,i=e.viewport,a=this._probe.resolution;this._renderArea.x=i.x*a,this._renderArea.y=i.y*a,this._renderArea.width=i.width*a*r,this._renderArea.height=i.height*a*r;var s=t.commandBuffers[0],n=this._frameBuffer.renderPass;s.beginRenderPass(n,this._frameBuffer,this._renderArea,ja,e.clearDepth,e.clearStencil),s.endRenderPass()}},r.render=function(e){var t=this._pipeline,r=t.commandBuffers[0];this._probeRenderQueue.gatherRenderObjects(this._probe,e,r),t.pipelineUBO.updateCameraUBO(this._probe.camera),this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=this._probe.renderArea().x,this._renderArea.height=this._probe.renderArea().y;var i=this._frameBuffer.renderPass;if(this._probe.camera.clearFlag&Me.COLOR){this._rgbeColor.x=this._probe.camera.clearColor.x,this._rgbeColor.y=this._probe.camera.clearColor.y,this._rgbeColor.z=this._probe.camera.clearColor.z;var a=g(this._rgbeColor);ja[0].x=a.x,ja[0].y=a.y,ja[0].z=a.z,ja[0].w=a.w}var s=t.device;r.beginRenderPass(i,this._frameBuffer,this._renderArea,ja,this._probe.camera.clearDepth,this._probe.camera.clearStencil),r.bindDescriptorSet(ie.GLOBAL,t.descriptorSet),this._probeRenderQueue.recordCommandBuffer(s,i,r),r.endRenderPass(),t.pipelineUBO.updateCameraUBO(e)},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._probeRenderQueue=new ka(t)},t}(Gt),xa.initInfo={name:"ReflectionProbeStage",priority:$t.FORWARD,tag:0},Ha=xa))||Ha),Za=e("ReflectionProbeFlow",u("ReflectionProbeFlow")((Ga=function(e){function r(){return e.apply(this,arguments)||this}E(r,e);var i=r.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var r=new Ja;r.initialize(Ja.initInfo),this._stages.push(r)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(e){if(t.internal.reflectionProbeManager)for(var r=t.internal.reflectionProbeManager.getProbes(),i=0;i<r.length;i++)r[i].needRender&&r[i].probeType===U.PLANAR&&this._renderStage(e,r[i])},i.destroy=function(){e.prototype.destroy.call(this)},i._renderStage=function(e,r){for(var i=0;i<this._stages.length;i++){var a=this._stages[i];if(r.probeType===U.PLANAR)t.internal.reflectionProbeManager.updatePlanarMap(r,null),a.setUsageInfo(r,r.realtimePlanarTexture.window.framebuffer),a.render(e),t.internal.reflectionProbeManager.updatePlanarMap(r,r.realtimePlanarTexture.getGFXTexture());else{for(var s=0;s<6;s++){var n=r.bakedCubeTextures[s];if(!n)return;r.updateCameraDir(s),a.setUsageInfo(r,n.window.framebuffer),a.render(e)}r.needRender=!1}}},r}(jt),Ga.initInfo={name:"PIPELINE_FLOW_RELECTION_PROBE",priority:0,tag:Di.SCENE,stages:[]},Ua=Ga))||Ua);function Xa(){var e=new Ts;return e.initialize({flows:[]}),e}var Ya,Ka,$a,es,ts,rs,is,as,ss,ns,os,hs,ds,ls,us,_s,ps,cs,fs,Ss,gs,Os,As,Ts=e("ForwardPipeline",(Wa=u("ForwardPipeline"),Qa=c([Bi]),Wa((za=function(e){function t(){var t;return(t=e.call(this)||this).renderTextures=qa&&qa(),t._postRenderPass=null,t}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var r=new Ra;r.initialize(Ra.initInfo),this._flows.push(r);var i=new Za;i.initialize(Za.initInfo),this._flows.push(i);var a=new Ta;a.initialize(Ta.initInfo),this._flows.push(a)}return!0},r.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new at,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(y(2402),1))},r._ensureEnoughSize=function(e){for(var t=this._width,r=this._height,i=0;i<e.length;++i){var a=e[i].window;t=Math.max(a.width,t),r=Math.max(a.height,r)}t===this._width&&r===this._height||(this._width=t,this._height=r)},r.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),r=t.next();!r.done;)r.value.destroy(),r=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},r._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this._descriptorSet,r=this.globalDSManager.pointSampler;return t.bindSampler(K,r),t.bindTexture(K,$(this.device)),t.bindSampler(ee,r),t.bindTexture(ee,$(this.device)),t.update(),!0},r._destroyUBOs=function(){var e=this._descriptorSet;e&&(e.getBuffer(Z.BINDING).destroy(),e.getBuffer(Q.BINDING).destroy(),e.getBuffer(X.BINDING).destroy(),e.getTexture(K).destroy(),e.getTexture(ee).destroy())},T(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(bi),qa=_(za.prototype,"renderTextures",[Qa,p],(function(){return[]})),Va=za))||Va)),Es=[new tt(0,0,0,0),new tt(0,0,0,0),new tt(0,0,0,0)],ms=e("GbufferStage",(Ya=u("GbufferStage"),Ka=c([Ni]),Ya((rs=function(e){function t(){var t;return(t=e.call(this)||this).renderQueues=ts&&ts(),t._renderQueues=[],t._renderArea=new Ke,t._instancedQueue=new Gi,t._phaseID=Oe("default"),t}E(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},r.activate=function(t,r){e.prototype.activate.call(this,t,r);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=Hi(this.renderQueues[i])},r.destroy=function(){},r.render=function(e){this._instancedQueue.clear();var t=this._pipeline,r=t.device;this._renderQueues.forEach(xi),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,a=0,s=0,n=0,o=0;o<i.length;++o){var h=i[o],d=h.model.subModels;for(a=0;a<d.length;++a){var l=d[a],u=l.passes;for(s=0;s<u.length;++s){var _=u[s];if(_.phase===this._phaseID)if(_.batchingScheme===Ae.INSTANCING){var p=_.getInstancedBuffer();p.merge(l,s),this._instancedQueue.queue.add(p)}else for(n=0;n<this._renderQueues.length;n++)this._renderQueues[n].insertRenderPass(h,a,s)}}}this._renderQueues.forEach(Ui);var c=t.commandBuffers[0];this._instancedQueue.uploadBuffers(c),e.clearFlag&Me.COLOR&&(t.pipelineSceneData.isHDR?Ee(Es[0],e.clearColor):(Es[0].x=e.clearColor.x,Es[0].y=e.clearColor.y,Es[0].z=e.clearColor.z)),Es[0].w=e.clearColor.w;var f=t.getPipelineRenderData().gbufferFrameBuffer,S=f.renderPass;c.beginRenderPass(S,f,this._renderArea,Es,e.clearDepth,e.clearStencil),c.setScissor(t.generateScissor(e)),c.setViewport(t.generateViewport(e)),c.bindDescriptorSet(ie.GLOBAL,t.descriptorSet);for(var g=0;g<this.renderQueues.length;g++)this._renderQueues[g].recordCommandBuffer(r,S,c);this._instancedQueue.recordCommandBuffer(r,S,c),c.endRenderPass()},t}(Gt),rs.initInfo={name:"GbufferStage",priority:tr.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:yi.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:yi.BACK_TO_FRONT,stages:["default"]}]},ts=_((es=rs).prototype,"renderQueues",[Ka,p],(function(){return[]})),$a=es))||$a)),Fs=new i,Is=new s(0,0,0,.5,.5,.5),vs=new s,ws=[new tt(0,0,0,1)],Ds=e("LightingStage",(is=u("LightingStage"),as=c(ge),ss=c([Ni]),is((ls=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=le.LIGHTS_PER_PASS,t._lightBufferData=null,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new Ke,t._planarQueue=null,t._uiPhase=new ga,t._deferredMaterial=hs&&hs(),t.renderQueues=ds&&ds(),t._phaseID=Oe("default"),t._renderQueues=[],t}E(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.gatherLights=function(e){for(var t=this._pipeline,r=t.pipelineSceneData.isHDR,o=t.commandBuffers[0],d=e.scene.sphereLights,l=e.scene.spotLights,u=e.scene.pointLights,_=e.scene.rangedDirLights,p=a.create(0,0,0,1),c=new Float32Array(4),f=e.exposure,S=0,g=h.length,O=g*this._maxDeferredLights,A=0;A<d.length&&S<this._maxDeferredLights;A++,++S){var T=d[A];if(a.set(p,T.position.x,T.position.y,T.position.z,T.range),n.sphereFrustum(p,e.frustum)){if(i.toArray(c,T.position),c[3]=L.SPHERE,this._lightBufferData.set(c,S*g),i.toArray(c,T.color),T.useColorTemperature){var E=T.finalColor;c[0]=E.x,c[1]=E.y,c[2]=E.z}c[3]=r?T.luminance*f*this._lightMeterScale:T.luminance,this._lightBufferData.set(c,S*g+1*O),c[0]=T.size,c[1]=T.range,c[2]=0,this._lightBufferData.set(c,S*g+2*O)}}for(var m=0;m<l.length&&S<this._maxDeferredLights;m++,++S){var F=l[m];if(a.set(p,F.position.x,F.position.y,F.position.z,F.range),n.sphereFrustum(p,e.frustum)){if(i.toArray(c,F.position),c[3]=L.SPOT,this._lightBufferData.set(c,S*g+0*O),i.toArray(c,F.color),F.useColorTemperature){var I=F.finalColor;c[0]=I.x,c[1]=I.y,c[2]=I.z}c[3]=r?F.luminance*f*this._lightMeterScale:F.luminance,this._lightBufferData.set(c,S*g+1*O),c[0]=F.size,c[1]=F.range,c[2]=F.spotAngle,this._lightBufferData.set(c,S*g+2*O),i.toArray(c,F.direction),this._lightBufferData.set(c,S*g+3*O)}}for(var v=0;v<u.length&&S<this._maxDeferredLights;v++,++S){var w=u[v];if(a.set(p,w.position.x,w.position.y,w.position.z,w.range),n.sphereFrustum(p,e.frustum)){if(i.toArray(c,w.position),c[3]=L.POINT,this._lightBufferData.set(c,S*g),i.toArray(c,w.color),w.useColorTemperature){var D=w.finalColor;c[0]=D.x,c[1]=D.y,c[2]=D.z}c[3]=r?w.luminance*f*this._lightMeterScale:w.luminance,this._lightBufferData.set(c,S*g+1*O),c[0]=0,c[1]=w.range,c[2]=0,this._lightBufferData.set(c,S*g+2*O)}}for(var b=0;b<_.length&&S<this._maxDeferredLights;b++,++S){var B=_[b];if(s.transform(vs,Is,B.node.getWorldMatrix()),n.aabbFrustum(vs,e.frustum)){if(i.toArray(c,B.position),c[3]=L.RANGED_DIRECTIONAL,this._lightBufferData.set(c,S*g),i.toArray(c,B.color),B.useColorTemperature){var y=B.finalColor;c[0]=y.x,c[1]=y.y,c[2]=y.z}c[3]=r?B.illuminance*f:B.illuminance,this._lightBufferData.set(c,S*g+1*O),i.toArray(c,B.right),c[3]=0,this._lightBufferData.set(c,S*g+2*O),i.toArray(c,B.direction),c[3]=0,this._lightBufferData.set(c,S*g+3*O);var R=B.scale;Fs.set(.5*R.x,.5*R.y,.5*R.z),i.toArray(c,Fs),c[3]=0,this._lightBufferData.set(c,S*g+4*O)}}var P=3*O+3;this._lightBufferData.set([S],P),o.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},r._createStageDescriptor=function(e){var t=this._pipeline.device,r=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;r=Math.ceil(r/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.HOST|Re.DEVICE,r,t.capabilities.uboOffsetAlignment));var i=t.createBuffer(new et(this._deferredLitsBufs,0,r));this._lightBufferData=new Float32Array(r/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new be(e.localSetLayout)),this._descriptorSet.bindBuffer(se.BINDING,i);var a=t.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.DEVICE,de.SIZE,de.SIZE));this._descriptorSet.bindBuffer(de.BINDING,a)},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._uiPhase.activate(t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=Hi(this.renderQueues[i]);this._planarQueue=new Sa(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},r.destroy=function(){var e;null==(e=this._deferredLitsBufs)||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},r.render=function(e){var t,r=this._pipeline,i=r.device,a=r.commandBuffers[0],s=r.pipelineSceneData,n=s.renderObjects;this._planarQueue.gatherShadowPasses(e,a),r.generateRenderArea(e,this._renderArea);for(var o=r.getPipelineRenderData(),h=s.deferredLightingMaterial.passes[0],d=h.getShaderVariant(),l=0;l<3;++l)h.descriptorSet.bindTexture(l,o.gbufferRenderTargets[l]),h.descriptorSet.bindSampler(l,o.sampler);h.descriptorSet.bindTexture(3,o.outputDepth),h.descriptorSet.bindSampler(3,o.sampler),h.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(h),this.gatherLights(e),e.clearFlag&Me.COLOR&&(ws[0].x=e.clearColor.x,ws[0].y=e.clearColor.y,ws[0].z=e.clearColor.z),ws[0].w=0;var u=o.outputFrameBuffer,_=u.renderPass;r.pipelineUBO.updateShadowUBO(e),a.beginRenderPass(_,u,this._renderArea,ws,e.clearDepth,e.clearStencil),a.setScissor(r.generateScissor(e)),a.setViewport(r.generateViewport(e)),a.bindDescriptorSet(ie.GLOBAL,r.descriptorSet);var p=r.quadIAOffscreen,c=null;null!=h&&null!=d&&null!=p&&(c=re.getOrCreatePipelineState(i,h,d,_,p)),null!=c&&(this._descriptorSet.update(),a.bindPipelineState(c),a.bindDescriptorSet(ie.MATERIAL,h.descriptorSet),a.bindDescriptorSet(ie.LOCAL,this._descriptorSet),a.bindInputAssembler(p),a.draw(p)),this._renderQueues.forEach(xi);for(var f=0,S=0,g=0,O=0;O<n.length;++O){var A=n[O],T=A.model.subModels;for(f=0;f<T.length;++f){var E=T[f].passes;for(S=0;S<E.length;++S)if(E[S].phase===this._phaseID)for(g=0;g<this._renderQueues.length;g++)this._renderQueues[g].insertRenderPass(A,f,S)}}if(n.length>0){this._renderQueues.forEach(Ui);for(var m=0;m<this._renderQueues.length;m++)this._renderQueues[m].recordCommandBuffer(i,_,a);this._planarQueue.recordCommandBuffer(i,_,a)}null==(t=e.geometryRenderer)||t.render(_,a,r.pipelineSceneData),this._uiPhase.render(e,_),a.endRenderPass()},t}(Gt),ls.initInfo={name:"LightingStage",priority:tr.LIGHTING,tag:0},hs=_((os=ls).prototype,"_deferredMaterial",[as,p],(function(){return null})),ds=_(os.prototype,"renderQueues",[ss,p],(function(){return[]})),ns=os))||ns)),bs=[new tt(0,0,0,1)],Bs=e("PostProcessStage",(us=u("PostProcessStage"),_s=c(ge),ps=c([Ni]),us((Os=function(e){function t(){var t;return(t=e.call(this)||this)._postProcessMaterial=Ss&&Ss(),t.renderQueues=gs&&gs(),t._renderArea=new Ke,t._stageDesc=null,t._localUBO=null,t._uiPhase=new ga,t}E(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},r.destroy=function(){},r.render=function(e){var t=this._pipeline,r=t.device,i=t.pipelineSceneData,a=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var s=e.viewport;this._renderArea.x=s.x*e.window.width,this._renderArea.y=s.y*e.window.height,this._renderArea.width=s.width*e.window.width,this._renderArea.height=s.height*e.window.height;var n=t.getPipelineRenderData(),o=e.window.framebuffer,h=t.getRenderPass(e.clearFlag,o);e.clearFlag&Me.COLOR&&(bs[0].x=e.clearColor.x,bs[0].y=e.clearColor.y,bs[0].z=e.clearColor.z),bs[0].w=e.clearColor.w,a.beginRenderPass(h,o,this._renderArea,bs,e.clearDepth,e.clearStencil),a.bindDescriptorSet(ie.GLOBAL,t.descriptorSet);var d=i.postprocessMaterial.passes[0],l=d.getShaderVariant();t.bloomEnabled?d.descriptorSet.bindTexture(0,n.bloom.combineTex):d.descriptorSet.bindTexture(0,n.outputRenderTargets[0]),d.descriptorSet.bindSampler(0,n.sampler),d.descriptorSet.update();var u=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=d&&null!=l&&null!=u&&(_=re.getOrCreatePipelineState(r,d,l,h,u));var p=t.pipelineSceneData.renderObjects;null!=_&&p.length>0&&(this._stageDesc||(this._stageDesc=r.createDescriptorSet(new be(d.localSetLayout)),this._localUBO=r.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.DEVICE,de.SIZE,de.SIZE)),this._stageDesc.bindBuffer(de.BINDING,this._localUBO)),this._stageDesc.update(),a.bindPipelineState(_),a.bindDescriptorSet(ie.MATERIAL,d.descriptorSet),a.bindDescriptorSet(ie.LOCAL,this._stageDesc),a.bindInputAssembler(u),a.draw(u)),this._uiPhase.render(e,h),Te(r,h,a,t.profiler,e),a.endRenderPass()},t}(Gt),Os.initInfo={name:"PostProcessStage",priority:Kt.POST_PROCESS,tag:0},Ss=_((fs=Os).prototype,"_postProcessMaterial",[_s,p],(function(){return null})),gs=_(fs.prototype,"renderQueues",[ps,p],(function(){return[]})),cs=fs))||cs));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(As||(As={}));var ys,Rs,Ps,Ns,Cs,Ls,Ms,Hs=function(e){function t(){var t;return(t=e.call(this)||this)._antiAliasing=As.NONE,t}E(t,e);var i=t.prototype;return i.updatePipelineSceneData=function(){this.updatePipelinePassInfo()},i.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var r=this._bloomMaterial.passes[1+t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var i=this._bloomMaterial.passes[7+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},i.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},i.initPipelinePassInfo=function(){var e=new ge;e._uuid="builtin-deferred-material",e.initialize({effectName:"pipeline/deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var r=new ge;r._uuid="builtin-bloom-material",r.initialize({effectName:"pipeline/bloom"});for(var i=0;i<r.passes.length;++i)r.passes[i].tryCompile();this._bloomMaterial=r;var a=new ge;a._uuid="builtin-post-process-material",a.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var s=0;s<a.passes.length;++s)a.passes[s].tryCompile();this._postprocessMaterial=a,this.updatePipelinePassInfo()},i.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},i.activate=function(t){return e.prototype.activate.call(this,t),this.initPipelinePassInfo(),!0},i.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},i.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){r.director.root.pipeline.macros.CC_RECEIVE_SHADOW=1;var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},T(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var r=new ge;r.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<r.passes.length;++i)r.passes[i].tryCompile();this._postprocessMaterial=r}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(at),xs=[new tt(0,0,0,1)],Us=function(){};ys=Us,Us.TEXTURE_SIZE_OFFSET=0,Us.COUNT=ys.TEXTURE_SIZE_OFFSET+4,Us.SIZE=4*ys.COUNT;var Gs,Ws,Qs,Vs,zs,qs,ks,js=e("BloomStage",(Rs=u("BloomStage"),Ps=c(ge),Rs((Ms=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,t._bloomMaterial=Ls&&Ls(),t._renderArea=new Ke,t._bloomUBO=[],t}E(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.activate=function(t,r){e.prototype.activate.call(this,t,r),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},r.destroy=function(){},r.render=function(e){var t,r=this._pipeline;if(r.generateBloomRenderData(),(null!=(t=e.window)&&t.swapchain||r.macros.CC_PIPELINE_TYPE)&&r.bloomEnabled&&0!==r.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=r.device.createBuffer(new Be(ye.UNIFORM|ye.TRANSFER_DST,Re.HOST|Re.DEVICE,Us.SIZE,Us.SIZE));e.clearFlag&Me.COLOR&&(xs[0].x=e.clearColor.x,xs[0].y=e.clearColor.y,xs[0].z=e.clearColor.z),xs[0].w=e.clearColor.w,this._prefilterPass(e,r),this._downsamplePass(e,r),this._upsamplePass(e,r),this._combinePass(e,r)}},r._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var r=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],a=t.getPipelineRenderData(),s=a.bloom,n=new Float32Array(Us.COUNT);n[Us.TEXTURE_SIZE_OFFSET+2]=this.threshold,r.updateBuffer(this._bloomUBO[0],n),r.beginRenderPass(s.renderPass,s.prefilterFramebuffer,this._renderArea,xs,0,0),r.bindDescriptorSet(ie.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,a.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,s.sampler),i.descriptorSet.update(),r.bindDescriptorSet(ie.MATERIAL,i.descriptorSet);var o=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null,d=i.getShaderVariant();null!=i&&null!=d&&null!=o&&(h=re.getOrCreatePipelineState(t.device,i,d,s.renderPass,o)),null!=h&&(r.bindPipelineState(h),r.bindInputAssembler(o),r.draw(o)),r.endRenderPass()},r._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var r=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,a=t.getPipelineRenderData().bloom,s=new Float32Array(Us.COUNT),n=0;n<this.iterations;++n){s[Us.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[Us.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,r.updateBuffer(this._bloomUBO[n+1],s),this._renderArea.width>>=1,this._renderArea.height>>=1,r.beginRenderPass(a.renderPass,a.downsampleFramebuffers[n],this._renderArea,xs,0,0);var o=i.passes[1+n],h=o.getShaderVariant();o.descriptorSet.bindBuffer(0,this._bloomUBO[n+1]),0===n?o.descriptorSet.bindTexture(1,a.prefiterTex):o.descriptorSet.bindTexture(1,a.downsampleTexs[n-1]),o.descriptorSet.bindSampler(1,a.sampler),o.descriptorSet.update(),r.bindDescriptorSet(ie.MATERIAL,o.descriptorSet);var d=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null;null!=o&&null!=h&&null!=d&&(l=re.getOrCreatePipelineState(t.device,o,h,a.renderPass,d)),null!=l&&(r.bindPipelineState(l),r.bindInputAssembler(d),r.draw(d)),r.endRenderPass()}},r._upsamplePass=function(e,t){var r=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],a=t.pipelineSceneData.bloomMaterial,s=new Float32Array(Us.COUNT),n=0;n<this.iterations;++n){var o=n+6+1;s[Us.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[Us.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[o],s),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(r.renderPass,r.upsampleFramebuffers[this.iterations-1-n],this._renderArea,xs,0,0);var h=a.passes[7+n],d=h.getShaderVariant();h.descriptorSet.bindBuffer(0,this._bloomUBO[o]),0===n?h.descriptorSet.bindTexture(1,r.downsampleTexs[this.iterations-1]):h.descriptorSet.bindTexture(1,r.upsampleTexs[this.iterations-n]),h.descriptorSet.bindSampler(1,r.sampler),h.descriptorSet.update(),i.bindDescriptorSet(ie.MATERIAL,h.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=h&&null!=d&&null!=l&&(u=re.getOrCreatePipelineState(t.device,h,d,r.renderPass,l)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(l),i.draw(l)),i.endRenderPass()}},r._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var r=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,a=t.getPipelineRenderData(),s=a.bloom,n=new Float32Array(Us.COUNT);n[Us.TEXTURE_SIZE_OFFSET+3]=this.intensity,r.updateBuffer(this._bloomUBO[13],n),r.beginRenderPass(s.renderPass,s.combineFramebuffer,this._renderArea,xs,0,0),r.bindDescriptorSet(ie.GLOBAL,t.descriptorSet);var o=i.passes[13];o.descriptorSet.bindBuffer(0,this._bloomUBO[13]),o.descriptorSet.bindTexture(1,a.outputRenderTargets[0]),o.descriptorSet.bindTexture(2,s.upsampleTexs[0]),o.descriptorSet.bindSampler(1,s.sampler),o.descriptorSet.bindSampler(2,s.sampler),o.descriptorSet.update(),r.bindDescriptorSet(ie.MATERIAL,o.descriptorSet);var h=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,d=null,l=o.getShaderVariant();null!=o&&null!=l&&null!=h&&(d=re.getOrCreatePipelineState(t.device,o,l,s.renderPass,h)),null!=d&&(r.bindPipelineState(d),r.bindInputAssembler(h),r.draw(h)),r.endRenderPass()},t}(Gt),Ms.initInfo={name:"BloomStage",priority:Kt.BLOOM,tag:0},Ls=_((Cs=Ms).prototype,"_bloomMaterial",[Ps,p],(function(){return null})),Ns=Cs))||Ns)),Js=e("MainFlow",u("MainFlow")((Ws=function(e){function t(){return e.apply(this,arguments)||this}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var r=new ms;r.initialize(ms.initInfo),this._stages.push(r);var i=new Ds;i.initialize(Ds.initInfo),this._stages.push(i);var a=new js;a.initialize(js.initInfo),this._stages.push(a);var s=new Bs;s.initialize(Bs.initInfo),this._stages.push(s)}return!0},r.activate=function(t){e.prototype.activate.call(this,t)},r.render=function(t){e.prototype.render.call(this,t)},r.destroy=function(){e.prototype.destroy.call(this)},t}(jt),Ws.initInfo={name:ue,priority:rr.MAIN,stages:[]},Gs=Ws))||Gs),Zs=function(e){function t(){var t;return(t=e.call(this)||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return E(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),Xs=e("DeferredPipeline",(Qs=u("DeferredPipeline"),Vs=c([Bi]),Qs((qs=function(e){function t(){var t;return(t=e.call(this)||this)._gbufferRenderPass=null,t._lightingRenderPass=null,t.renderTextures=ks&&ks(),t}E(t,e);var r=t.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var r=new Ra;r.initialize(Ra.initInfo),this._flows.push(r);var i=new Js;i.initialize(Js.initInfo),this._flows.push(i)}return!0},r.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new Hs,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(y(2402),1))},r.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),r=t.next();!r.done;)r.value.destroy(),r=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},r.onGlobalPipelineStateChanged=function(){this.pipelineSceneData.updatePipelineSceneData()},r.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},r._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var r=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(K,r),this._descriptorSet.bindTexture(K,me.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(ee,r),this._descriptorSet.bindTexture(ee,me.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new it;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var a=this._createQuadInputAssembler();if(!a.quadIB||!a.quadVB||!a.quadIA)return!1;if(this._quadVBOnscreen=a.quadVB,this._quadIAOnscreen=a.quadIA,!this._gbufferRenderPass){var s=new Ne;s.format=qe.RGBA16F,s.loadOp=He.CLEAR,s.storeOp=Le.STORE;var n=new Ne;n.format=qe.RGBA16F,n.loadOp=He.CLEAR,n.storeOp=Le.STORE;var o=new Ne;o.format=qe.RGBA16F,o.loadOp=He.CLEAR,o.storeOp=Le.STORE;var h=new Ce;h.format=qe.DEPTH_STENCIL,h.depthLoadOp=He.CLEAR,h.depthStoreOp=Le.STORE,h.stencilLoadOp=He.CLEAR,h.stencilStoreOp=Le.STORE;var d=new Ge([s,n,o],h);this._gbufferRenderPass=t.createRenderPass(d)}if(!this._lightingRenderPass){var l=new Ne;l.format=qe.RGBA8,l.loadOp=He.CLEAR,l.storeOp=Le.STORE,l.barrier=t.getGeneralBarrier(new xe(Ue.NONE,Ue.COLOR_ATTACHMENT_WRITE));var u=new Ce;u.format=qe.DEPTH_STENCIL,u.depthLoadOp=He.LOAD,u.depthStoreOp=Le.DISCARD,u.stencilLoadOp=He.LOAD,u.stencilStoreOp=Le.DISCARD,l.barrier=t.getGeneralBarrier(new xe(Ue.DEPTH_STENCIL_ATTACHMENT_WRITE,Ue.DEPTH_STENCIL_ATTACHMENT_WRITE));var _=new Ge([l],u);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},r._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Z.BINDING).destroy(),this._descriptorSet.getBuffer(Q.BINDING).destroy(),this._descriptorSet.getBuffer(X.BINDING).destroy(),this._descriptorSet.getTexture(K).destroy(),this._descriptorSet.getTexture(ee).destroy())},r._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var r=0;r<e.outputRenderTargets.length;r++)e.outputRenderTargets[r].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},r._ensureEnoughSize=function(e){for(var t=this._width,r=this._height,i=0;i<e.length;++i){var a=e[i].window;t=Math.max(a.width,t),r=Math.max(a.height,r)}t===this._width&&r===this._height||(this._width=t,this._height=r,this._destroyDeferredData(),this._generateDeferredRenderData())},r._generateDeferredRenderData=function(){for(var e=this,t=this.device,r=this._pipelineRenderData=new Zs,i=this.pipelineSceneData,a=0;a<3;++a)r.gbufferRenderTargets.push(t.createTexture(new Ze(Xe.TEX2D,Ye.COLOR_ATTACHMENT|Ye.SAMPLED,qe.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));r.outputDepth=t.createTexture(new Ze(Xe.TEX2D,Ye.DEPTH_STENCIL_ATTACHMENT|Ye.SAMPLED,qe.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),r.gbufferFrameBuffer=t.createFramebuffer(new Qe(this._gbufferRenderPass,r.gbufferRenderTargets,r.outputDepth)),r.outputRenderTargets.push(t.createTexture(new Ze(Xe.TEX2D,Ye.COLOR_ATTACHMENT|Ye.SAMPLED,qe.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),r.outputFrameBuffer=t.createFramebuffer(new Qe(this._lightingRenderPass,r.outputRenderTargets,null)),r.sampler=this.globalDSManager.pointSampler,this.on(M.ATTACHMENT_SCALE_CAHNGED,(function(t){r.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,r.gbufferFrameBuffer=e.newFramebufferByRatio(r.gbufferFrameBuffer),r.gbufferFrameBuffer=e.newFramebufferByRatio(r.outputFrameBuffer)}))},t}(bi),ks=_(qs.prototype,"renderTextures",[Vs,p],(function(){return[]})),zs=qs))||zs)),Ys=Object.freeze({__proto__:null,BloomStage:js,DeferredPipeline:Xs,ForwardFlow:Ta,ForwardPipeline:Ts,ForwardStage:Aa,GbufferStage:ms,LightingStage:Ds,MainFlow:Js,PostProcessStage:Bs,ReflectionProbeFlow:Za,ReflectionProbeStage:Ja,RenderFlow:jt,RenderPipeline:bi,RenderStage:Gt,ShadowFlow:Ra,ShadowStage:Ba,createDefaultPipeline:Xa});r.legacy_rendering=Ys}}}));
