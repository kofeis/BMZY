System.register(["./physics-2d-framework-C8mp61c-.js","./gc-object-CKHc4SnS.js","./_commonjsHelpers-gZMueHPa.js","./global-exports-CR3GRnjt.js","./index-C5lmLqDW.js","./prefab-DH0xadMc.js","./scene-7MDSMR3j.js","./pipeline-state-manager-Cdpe3is6.js","./node-event-DTNosVQv.js","./component-BaGvu7EF.js","./deprecated-T2yM9nsJ.js","./director-DIlqD2Nd.js","./collision-matrix-B7MK4XMK.js","./touch-DB0AR-Sc.js","./device-manager-BvjvoelW.js","./buffer-barrier-CuX_5NUR.js","./factory-D9_8ZCqM.js","./deprecated-Ca3AjUwj.js","./debug-view-CKetkq9d.js"],(function(){"use strict";var t,e,i,n,s,o,r,a,_,m,h,l,u,c,f,d,p,y,v,x,S,B,b,A,g,C,V,w,M,P,I,G,D,F,T;return{setters:[function(m){t=m.a,e=m.b,i=m.P,n=m.c,s=m.C,o=m.d,r=m.R,a=m.e,_=m.s},function(t){m=t.a,h=t._,l=t.j,u=t.aE,c=t.aw,f=t.d,d=t.h,p=t.R},function(t){t.c,y=t.g},null,function(t){v=t.V,x=t.C,S=t.b,B=t.U,b=t.Q,A=t.aa,g=t.a9,C=t.f,V=t.k},function(t){w=t.f},function(t){M=t.N},function(t){P=t.L},function(t){I=t.N},null,function(t){G=t.g,D=t.G},function(t){F=t.d},function(t){T=t.P},null,null,null,null,null,null],execute:function(){var L={};!function(t){function e(t,e){return void 0!==t?t:e}var i=1e37,n=1e-5,s=n*n,o=3.14159265359,r=.1,a=.008,_=2/180*o,c=.016,f=.2,d=8/180*o,p=.5*o,y=2.4674011002726646,v=-1,x=.75,S=.25,B=256,b=.01,A=2/180*o;var g=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}return t.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},t}(),C=new g(2,3,2);function V(t,e){for(var i=new Array(t),n=0;n<t;++n)i[n]=e(n);return i}function w(t,e){void 0===e&&(e=0);for(var i=new Array(t),n=0;n<t;++n)i[n]=e;return i}var M=o/180,P=180/o,I=2*o,G=Math.abs;function D(t,e){return t<e?t:e}function F(t,e){return t>e?t:e}function T(t,e,i){return t<e?e:t>i?i:t}var L=isFinite;function R(t){return t*t}function k(t){return 1/Math.sqrt(t)}var q=Math.sqrt,z=Math.pow;var j=Math.cos,J=Math.sin,E=Math.acos,N=Math.asin,O=Math.atan2;var X=function(){function t(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(e[0]instanceof Float32Array){if(2!==e[0].length)throw new Error;this.data=e[0]}else{var n="number"==typeof e[0]?e[0]:0,s="number"==typeof e[1]?e[1]:0;this.data=new Float32Array([n,s])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y)},e.SetZero=function(){return this.x=0,this.y=0,this},e.Set=function(t,e){return this.x=t,this.y=e,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},e.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},e.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this},e.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},e.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},e.Dot=function(t){return this.x*t.x+this.y*t.y},e.Cross=function(t){return this.x*t.y-this.y*t.x},e.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},e.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},e.Normalize=function(){var t=this.Length();if(t>=n){var e=1/t;this.x*=e,this.y*=e}return t},e.SelfNormalize=function(){var t=this.Length();if(t>=n){var e=1/t;this.x*=e,this.y*=e}return this},e.SelfRotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=this.x;return this.x=e*n-i*this.y,this.y=i*n+e*this.y,this},e.SelfRotateCosSin=function(t,e){var i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this},e.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},e.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},e.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},e.SelfMinV=function(t){return this.x=D(this.x,t.x),this.y=D(this.y,t.y),this},e.SelfMaxV=function(t){return this.x=F(this.x,t.x),this.y=F(this.y,t.y),this},e.SelfAbs=function(){return this.x=G(this.x),this.y=G(this.y),this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},e.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},t.MakeArray=function(e){return V(e,(function(){return new t}))},t.AbsV=function(t,e){return e.x=G(t.x),e.y=G(t.y),e},t.MinV=function(t,e,i){return i.x=D(t.x,e.x),i.y=D(t.y,e.y),i},t.MaxV=function(t,e,i){return i.x=F(t.x,e.x),i.y=F(t.y,e.y),i},t.ClampV=function(t,e,i,n){return n.x=T(t.x,e.x,i.x),n.y=T(t.y,e.y,i.y),n},t.RotateV=function(t,e,i){var n=t.x,s=t.y,o=Math.cos(e),r=Math.sin(e);return i.x=o*n-r*s,i.y=r*n+o*s,i},t.DotVV=function(t,e){return t.x*e.x+t.y*e.y},t.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},t.CrossVS=function(t,e,i){var n=t.x;return i.x=e*t.y,i.y=-e*n,i},t.CrossVOne=function(t,e){var i=t.x;return e.x=t.y,e.y=-i,e},t.CrossSV=function(t,e,i){var n=e.x;return i.x=-t*e.y,i.y=t*n,i},t.CrossOneV=function(t,e){var i=t.x;return e.x=-t.y,e.y=i,e},t.AddVV=function(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i},t.SubVV=function(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i},t.MulSV=function(t,e,i){return i.x=e.x*t,i.y=e.y*t,i},t.MulVS=function(t,e,i){return i.x=t.x*e,i.y=t.y*e,i},t.AddVMulSV=function(t,e,i,n){return n.x=t.x+e*i.x,n.y=t.y+e*i.y,n},t.SubVMulSV=function(t,e,i,n){return n.x=t.x-e*i.x,n.y=t.y-e*i.y,n},t.AddVCrossSV=function(t,e,i,n){var s=i.x;return n.x=t.x-e*i.y,n.y=t.y+e*s,n},t.MidVV=function(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i},t.ExtVV=function(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i},t.IsEqualToV=function(t,e){return t.x===e.x&&t.y===e.y},t.DistanceVV=function(t,e){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)},t.DistanceSquaredVV=function(t,e){var i=t.x-e.x,n=t.y-e.y;return i*i+n*n},t.NegV=function(t,e){return e.x=-t.x,e.y=-t.y,e},m(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}}]),t}();X.ZERO=new X(0,0),X.UNITX=new X(1,0),X.UNITY=new X(0,1),X.s_t0=new X,X.s_t1=new X,X.s_t2=new X,X.s_t3=new X;var U=new X(0,0),W=function(){function t(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(e[0]instanceof Float32Array){if(3!==e[0].length)throw new Error;this.data=e[0]}else{var n="number"==typeof e[0]?e[0]:0,s="number"==typeof e[1]?e[1]:0,o="number"==typeof e[2]?e[2]:0;this.data=new Float32Array([n,s,o])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y,this.z)},e.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},e.SetXYZ=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.SelfAddXYZ=function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.SelfSubXYZ=function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.DotV3V3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.CrossV3V3=function(t,e,i){var n=t.x,s=t.y,o=t.z,r=e.x,a=e.y,_=e.z;return i.x=s*_-o*a,i.y=o*r-n*_,i.z=n*a-s*r,i},m(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"z",get:function(){return this.data[2]},set:function(t){this.data[2]=t}}]),t}();W.ZERO=new W(0,0,0),W.s_t0=new W;var Z=function(){function t(){this.data=new Float32Array([1,0,0,1]),this.ex=new X(this.data.subarray(0,2)),this.ey=new X(this.data.subarray(2,4))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},t.FromVV=function(e,i){return(new t).SetVV(e,i)},t.FromSSSS=function(e,i,n,s){return(new t).SetSSSS(e,i,n,s)},t.FromAngle=function(e){return(new t).SetAngle(e)},e.SetSSSS=function(t,e,i,n){return this.ex.Set(t,i),this.ey.Set(e,n),this},e.SetVV=function(t,e){return this.ex.Copy(t),this.ey.Copy(e),this},e.SetAngle=function(t){var e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this},e.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},e.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},e.GetInverse=function(t){var e=this.ex.x,i=this.ey.x,n=this.ex.y,s=this.ey.y,o=e*s-i*n;return 0!==o&&(o=1/o),t.ex.x=o*s,t.ey.x=-o*i,t.ex.y=-o*n,t.ey.y=o*e,t},e.Solve=function(t,e,i){var n=this.ex.x,s=this.ey.x,o=this.ex.y,r=this.ey.y,a=n*r-s*o;return 0!==a&&(a=1/a),i.x=a*(r*t-s*e),i.y=a*(n*e-o*t),i},e.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},e.SelfInv=function(){return this.GetInverse(this),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this},e.SelfSubM=function(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this},t.AbsM=function(t,e){var i=t.ex,n=t.ey;return e.ex.x=G(i.x),e.ex.y=G(i.y),e.ey.x=G(n.x),e.ey.y=G(n.y),e},t.MulMV=function(t,e,i){var n=t.ex,s=t.ey,o=e.x,r=e.y;return i.x=n.x*o+s.x*r,i.y=n.y*o+s.y*r,i},t.MulTMV=function(t,e,i){var n=t.ex,s=t.ey,o=e.x,r=e.y;return i.x=n.x*o+n.y*r,i.y=s.x*o+s.y*r,i},t.AddMM=function(t,e,i){var n=t.ex,s=t.ey,o=e.ex,r=e.ey;return i.ex.x=n.x+o.x,i.ex.y=n.y+o.y,i.ey.x=s.x+r.x,i.ey.y=s.y+r.y,i},t.MulMM=function(t,e,i){var n=t.ex.x,s=t.ex.y,o=t.ey.x,r=t.ey.y,a=e.ex.x,_=e.ex.y,m=e.ey.x,h=e.ey.y;return i.ex.x=n*a+o*_,i.ex.y=s*a+r*_,i.ey.x=n*m+o*h,i.ey.y=s*m+r*h,i},t.MulTMM=function(t,e,i){var n=t.ex.x,s=t.ex.y,o=t.ey.x,r=t.ey.y,a=e.ex.x,_=e.ex.y,m=e.ey.x,h=e.ey.y;return i.ex.x=n*a+s*_,i.ex.y=o*a+r*_,i.ey.x=n*m+s*h,i.ey.y=o*m+r*h,i},t}();Z.IDENTITY=new Z;var H=function(){function t(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new W(this.data.subarray(0,3)),this.ey=new W(this.data.subarray(3,6)),this.ez=new W(this.data.subarray(6,9))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.SetVVV=function(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this},e.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this},e.Solve33=function(t,e,i,n){var s=this.ex.x,o=this.ex.y,r=this.ex.z,a=this.ey.x,_=this.ey.y,m=this.ey.z,h=this.ez.x,l=this.ez.y,u=this.ez.z,c=s*(_*u-m*l)+o*(m*h-a*u)+r*(a*l-_*h);return 0!==c&&(c=1/c),n.x=c*(t*(_*u-m*l)+e*(m*h-a*u)+i*(a*l-_*h)),n.y=c*(s*(e*u-i*l)+o*(i*h-t*u)+r*(t*l-e*h)),n.z=c*(s*(_*i-m*e)+o*(m*t-a*i)+r*(a*e-_*t)),n},e.Solve22=function(t,e,i){var n=this.ex.x,s=this.ey.x,o=this.ex.y,r=this.ey.y,a=n*r-s*o;return 0!==a&&(a=1/a),i.x=a*(r*t-s*e),i.y=a*(n*e-o*t),i},e.GetInverse22=function(t){var e=this.ex.x,i=this.ey.x,n=this.ex.y,s=this.ey.y,o=e*s-i*n;0!==o&&(o=1/o),t.ex.x=o*s,t.ey.x=-o*i,t.ex.z=0,t.ex.y=-o*n,t.ey.y=o*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},e.GetSymInverse33=function(t){var e=W.DotV3V3(this.ex,W.CrossV3V3(this.ey,this.ez,W.s_t0));0!==e&&(e=1/e);var i=this.ex.x,n=this.ey.x,s=this.ez.x,o=this.ey.y,r=this.ez.y,a=this.ez.z;t.ex.x=e*(o*a-r*r),t.ex.y=e*(s*r-n*a),t.ex.z=e*(n*r-s*o),t.ey.x=t.ex.y,t.ey.y=e*(i*a-s*s),t.ey.z=e*(s*n-i*r),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*o-n*n)},t.MulM33V3=function(t,e,i){var n=e.x,s=e.y,o=e.z;return i.x=t.ex.x*n+t.ey.x*s+t.ez.x*o,i.y=t.ex.y*n+t.ey.y*s+t.ez.y*o,i.z=t.ex.z*n+t.ey.z*s+t.ez.z*o,i},t.MulM33XYZ=function(t,e,i,n,s){return s.x=t.ex.x*e+t.ey.x*i+t.ez.x*n,s.y=t.ex.y*e+t.ey.y*i+t.ez.y*n,s.z=t.ex.z*e+t.ey.z*i+t.ez.z*n,s},t.MulM33V2=function(t,e,i){var n=e.x,s=e.y;return i.x=t.ex.x*n+t.ey.x*s,i.y=t.ex.y*n+t.ey.y*s,i},t.MulM33XY=function(t,e,i,n){return n.x=t.ex.x*e+t.ey.x*i,n.y=t.ex.y*e+t.ey.y*i,n},t}();H.IDENTITY=new H;var Q=function(){function t(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.s=t.s,this.c=t.c,this},e.SetAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},e.SetIdentity=function(){return this.s=0,this.c=1,this},e.GetAngle=function(){return Math.atan2(this.s,this.c)},e.GetXAxis=function(t){return t.x=this.c,t.y=this.s,t},e.GetYAxis=function(t){return t.x=-this.s,t.y=this.c,t},t.MulRR=function(t,e,i){var n=t.c,s=t.s,o=e.c,r=e.s;return i.s=s*o+n*r,i.c=n*o-s*r,i},t.MulTRR=function(t,e,i){var n=t.c,s=t.s,o=e.c,r=e.s;return i.s=n*r-s*o,i.c=n*o+s*r,i},t.MulRV=function(t,e,i){var n=t.c,s=t.s,o=e.x,r=e.y;return i.x=n*o-s*r,i.y=s*o+n*r,i},t.MulTRV=function(t,e,i){var n=t.c,s=t.s,o=e.x,r=e.y;return i.x=n*o+s*r,i.y=-s*o+n*r,i},t}();Q.IDENTITY=new Q;var Y=function(){function t(){this.p=new X,this.q=new Q}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.p.Copy(t.p),this.q.Copy(t.q),this},e.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},e.SetPositionRotation=function(t,e){return this.p.Copy(t),this.q.Copy(e),this},e.SetPositionAngle=function(t,e){return this.p.Copy(t),this.q.SetAngle(e),this},e.SetPosition=function(t){return this.p.Copy(t),this},e.SetPositionXY=function(t,e){return this.p.Set(t,e),this},e.SetRotation=function(t){return this.q.Copy(t),this},e.SetRotationAngle=function(t){return this.q.SetAngle(t),this},e.GetPosition=function(){return this.p},e.GetRotation=function(){return this.q},e.GetRotationAngle=function(){return this.q.GetAngle()},e.GetAngle=function(){return this.q.GetAngle()},t.MulXV=function(t,e,i){var n=t.q.c,s=t.q.s,o=e.x,r=e.y;return i.x=n*o-s*r+t.p.x,i.y=s*o+n*r+t.p.y,i},t.MulTXV=function(t,e,i){var n=t.q.c,s=t.q.s,o=e.x-t.p.x,r=e.y-t.p.y;return i.x=n*o+s*r,i.y=-s*o+n*r,i},t.MulXX=function(t,e,i){return Q.MulRR(t.q,e.q,i.q),X.AddVV(Q.MulRV(t.q,e.p,i.p),t.p,i.p),i},t.MulTXX=function(t,e,i){return Q.MulTRR(t.q,e.q,i.q),Q.MulTRV(t.q,X.SubVV(e.p,t.p,i.p),i.p),i},t}();Y.IDENTITY=new Y;var K,$=function(){function t(){this.localCenter=new X,this.c0=new X,this.c=new X,this.a0=0,this.a=0,this.alpha0=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},e.GetTransform=function(t,e){var i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;var n=i*this.a0+e*this.a;return t.q.SetAngle(n),t.p.SelfSub(Q.MulRV(t.q,this.localCenter,X.s_t0)),t},e.Advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t},e.Normalize=function(){var t=I*Math.floor(this.a0/I);this.a0-=t,this.a-=t},t}(),tt=function(){function t(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(e[0]instanceof Float32Array){if(4!==e[0].length)throw new Error;this.data=e[0]}else{var n="number"==typeof e[0]?e[0]:.5,s="number"==typeof e[1]?e[1]:.5,o="number"==typeof e[2]?e[2]:.5,r="number"==typeof e[3]?e[3]:1;this.data=new Float32Array([n,s,o,r])}}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},e.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},e.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},e.Set=function(t,e,i,n){void 0===n&&(n=this.a),this.SetRGBA(t,e,i,n)},e.SetByteRGB=function(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this},e.SetByteRGBA=function(t,e,i,n){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=n/255,this},e.SetRGB=function(t,e,i){return this.r=t,this.g=e,this.b=i,this},e.SetRGBA=function(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this},e.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},e.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},e.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},e.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},e.SelfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},e.Mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},e.Mix=function(e,i){t.MixColors(this,e,i)},t.MixColors=function(t,e,i){var n=i*(e.r-t.r),s=i*(e.g-t.g),o=i*(e.b-t.b),r=i*(e.a-t.a);t.r+=n,t.g+=s,t.b+=o,t.a+=r,e.r-=n,e.g-=s,e.b-=o,e.a-=r},e.MakeStyleString=function(e){return void 0===e&&(e=this.a),t.MakeStyleString(this.r,this.g,this.b,e)},t.MakeStyleString=function(t,e,i,n){return void 0===n&&(n=1),t*=255,e*=255,i*=255,n<1?"rgba("+t+","+e+","+i+","+n+")":"rgb("+t+","+e+","+i+")"},m(t,[{key:"r",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"g",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"b",get:function(){return this.data[2]},set:function(t){this.data[2]=t}},{key:"a",get:function(){return this.data[3]},set:function(t){this.data[3]=t}}]),t}();tt.ZERO=new tt(0,0,0,0),tt.RED=new tt(1,0,0),tt.GREEN=new tt(0,1,0),tt.BLUE=new tt(0,0,1),(K=t.b2DrawFlags||(t.b2DrawFlags={}))[K.e_none=0]="e_none",K[K.e_shapeBit=1]="e_shapeBit",K[K.e_jointBit=2]="e_jointBit",K[K.e_aabbBit=4]="e_aabbBit",K[K.e_pairBit=8]="e_pairBit",K[K.e_centerOfMassBit=16]="e_centerOfMassBit",K[K.e_particleBit=32]="e_particleBit",K[K.e_controllerBit=64]="e_controllerBit",K[K.e_all=63]="e_all";var et=function(){function t(){this.m_drawFlags=0}var e=t.prototype;return e.SetFlags=function(t){this.m_drawFlags=t},e.GetFlags=function(){return this.m_drawFlags},e.AppendFlags=function(t){this.m_drawFlags|=t},e.ClearFlags=function(t){this.m_drawFlags&=~t},t}(),it=function(){function t(){this.m_start=Date.now()}var e=t.prototype;return e.Reset=function(){return this.m_start=Date.now(),this},e.GetMilliseconds=function(){return Date.now()-this.m_start},t}(),nt=function(){function t(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}var e=t.prototype;return e.GetCount=function(){return this.m_count},e.GetMinCount=function(){return this.m_min_count},e.GetMaxCount=function(){return this.m_max_count},e.ResetCount=function(){var t=this.m_count;return this.m_count=0,t},e.ResetMinCount=function(){this.m_min_count=0},e.ResetMaxCount=function(){this.m_max_count=0},e.Increment=function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)},e.Decrement=function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)},t}(),st=function(){function t(t){this.m_stack=[],this.m_count=0,this.m_stack=V(t,(function(){return null})),this.m_count=0}var e=t.prototype;return e.Reset=function(){return this.m_count=0,this},e.Push=function(t){this.m_stack[this.m_count]=t,this.m_count++},e.Pop=function(){this.m_count--;var t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t},e.GetCount=function(){return this.m_count},t}(),ot=function(){function t(){this.m_buffer=X.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}var e=t.prototype;return e.Copy=function(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this},e.Reset=function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this},e.SetShape=function(t,e){t.SetupDistanceProxy(this,e)},e.SetVerticesRadius=function(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i},e.GetSupport=function(t){for(var e=0,i=X.DotVV(this.m_vertices[0],t),n=1;n<this.m_count;++n){var s=X.DotVV(this.m_vertices[n],t);s>i&&(e=n,i=s)}return e},e.GetSupportVertex=function(t){for(var e=0,i=X.DotVV(this.m_vertices[0],t),n=1;n<this.m_count;++n){var s=X.DotVV(this.m_vertices[n],t);s>i&&(e=n,i=s)}return this.m_vertices[e]},e.GetVertexCount=function(){return this.m_count},e.GetVertex=function(t){return this.m_vertices[t]},t}(),rt=function(){function t(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return t.prototype.Reset=function(){return this.metric=0,this.count=0,this},t}(),at=function(){function t(){this.proxyA=new ot,this.proxyB=new ot,this.transformA=new Y,this.transformB=new Y,this.useRadii=!1}return t.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},t}(),_t=function(){function t(){this.pointA=new X,this.pointB=new X,this.distance=0,this.iterations=0}return t.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},t}();t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;var mt=function(){function t(){this.wA=new X,this.wB=new X,this.w=new X,this.a=0,this.indexA=0,this.indexB=0}return t.prototype.Copy=function(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},t}(),ht=function(){function t(){this.m_v1=new mt,this.m_v2=new mt,this.m_v3=new mt,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}var e=t.prototype;return e.ReadCache=function(t,e,i,s,o){this.m_count=t.count;for(var r=this.m_vertices,a=0;a<this.m_count;++a){var _=r[a];_.indexA=t.indexA[a],_.indexB=t.indexB[a];var m=e.GetVertex(_.indexA),h=s.GetVertex(_.indexB);Y.MulXV(i,m,_.wA),Y.MulXV(o,h,_.wB),X.SubVV(_.wB,_.wA,_.w),_.a=0}if(this.m_count>1){var l=t.metric,u=this.GetMetric();(u<.5*l||2*l<u||u<n)&&(this.m_count=0)}if(0===this.m_count){var c=r[0];c.indexA=0,c.indexB=0;var f=e.GetVertex(0),d=s.GetVertex(0);Y.MulXV(i,f,c.wA),Y.MulXV(o,d,c.wB),X.SubVV(c.wB,c.wA,c.w),c.a=1,this.m_count=1}},e.WriteCache=function(t){t.metric=this.GetMetric(),t.count=this.m_count;for(var e=this.m_vertices,i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB},e.GetSearchDirection=function(t){switch(this.m_count){case 1:return X.NegV(this.m_v1.w,t);case 2:var e=X.SubVV(this.m_v2.w,this.m_v1.w,t);return X.CrossVV(e,X.NegV(this.m_v1.w,X.s_t0))>0?X.CrossOneV(e,t):X.CrossVOne(e,t);default:return t.SetZero()}},e.GetClosestPoint=function(t){switch(this.m_count){case 0:case 3:default:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y)}},e.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},e.GetMetric=function(){switch(this.m_count){case 0:case 1:default:return 0;case 2:return X.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return X.CrossVV(X.SubVV(this.m_v2.w,this.m_v1.w,X.s_t0),X.SubVV(this.m_v3.w,this.m_v1.w,X.s_t1))}},e.Solve2=function(){var e=this.m_v1.w,i=this.m_v2.w,n=X.SubVV(i,e,t.s_e12),s=-X.DotVV(e,n);if(s<=0)return this.m_v1.a=1,void(this.m_count=1);var o=X.DotVV(i,n);if(o<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var r=1/(o+s);this.m_v1.a=o*r,this.m_v2.a=s*r,this.m_count=2},e.Solve3=function(){var e=this.m_v1.w,i=this.m_v2.w,n=this.m_v3.w,s=X.SubVV(i,e,t.s_e12),o=X.DotVV(e,s),r=X.DotVV(i,s),a=-o,_=X.SubVV(n,e,t.s_e13),m=X.DotVV(e,_),h=X.DotVV(n,_),l=-m,u=X.SubVV(n,i,t.s_e23),c=X.DotVV(i,u),f=X.DotVV(n,u),d=-c,p=X.CrossVV(s,_),y=p*X.CrossVV(i,n),v=p*X.CrossVV(n,e),x=p*X.CrossVV(e,i);if(a<=0&&l<=0)return this.m_v1.a=1,void(this.m_count=1);if(r>0&&a>0&&x<=0){var S=1/(r+a);return this.m_v1.a=r*S,this.m_v2.a=a*S,void(this.m_count=2)}if(h>0&&l>0&&v<=0){var B=1/(h+l);return this.m_v1.a=h*B,this.m_v3.a=l*B,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(r<=0&&d<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(h<=0&&f<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(f>0&&d>0&&y<=0){var b=1/(f+d);return this.m_v2.a=f*b,this.m_v3.a=d*b,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var A=1/(y+v+x);this.m_v1.a=y*A,this.m_v2.a=v*A,this.m_v3.a=x*A,this.m_count=3},t}();ht.s_e12=new X,ht.s_e13=new X,ht.s_e23=new X;var lt=new ht,ut=[0,0,0],ct=[0,0,0],ft=new X,dt=new X,pt=new X,yt=new X,vt=new X;function xt(e,i,o){++t.b2_gjkCalls;var r=o.proxyA,a=o.proxyB,_=o.transformA,m=o.transformB,h=lt;h.ReadCache(i,r,_,a,m);for(var l=h.m_vertices,u=ut,c=ct,f=0,d=0;d<20;){f=h.m_count;for(var p=0;p<f;++p)u[p]=l[p].indexA,c[p]=l[p].indexB;switch(h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)break;var y=h.GetSearchDirection(dt);if(y.LengthSquared()<s)break;var v=l[h.m_count];v.indexA=r.GetSupport(Q.MulTRV(_.q,X.NegV(y,X.s_t0),yt)),Y.MulXV(_,r.GetVertex(v.indexA),v.wA),v.indexB=a.GetSupport(Q.MulTRV(m.q,y,vt)),Y.MulXV(m,a.GetVertex(v.indexB),v.wB),X.SubVV(v.wB,v.wA,v.w),++d,++t.b2_gjkIters;for(var x=!1,S=0;S<f;++S)if(v.indexA===u[S]&&v.indexB===c[S]){x=!0;break}if(x)break;++h.m_count}if(t.b2_gjkMaxIters=F(t.b2_gjkMaxIters,d),h.GetWitnessPoints(e.pointA,e.pointB),e.distance=X.DistanceVV(e.pointA,e.pointB),e.iterations=d,h.WriteCache(i),o.useRadii){var B=r.m_radius,b=a.m_radius;if(e.distance>B+b&&e.distance>n){e.distance-=B+b;var A=X.SubVV(e.pointB,e.pointA,pt);A.Normalize(),e.pointA.SelfMulAdd(B,A),e.pointB.SelfMulSub(b,A)}else{var g=X.MidVV(e.pointA,e.pointB,ft);e.pointA.Copy(g),e.pointB.Copy(g),e.distance=0}}}var St,Bt=new X,bt=new ht,At=new X,gt=new X,Ct=new X,Vt=new X,wt=new X,Mt=new X;(St=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[St.e_vertex=0]="e_vertex",St[St.e_face=1]="e_face";var Pt,It=function(){function t(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return m(t,[{key:"key",get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}},{key:"indexA",get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0}},{key:"indexB",get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0}},{key:"typeA",get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0}},{key:"typeB",get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0}}]),t}(),Gt=function(){function t(){this.cf=new It}var e=t.prototype;return e.Copy=function(t){return this.key=t.key,this},e.Clone=function(){return(new t).Copy(this)},m(t,[{key:"key",get:function(){return this.cf.key},set:function(t){this.cf.key=t}}]),t}(),Dt=function(){function t(){this.localPoint=new X,this.normalImpulse=0,this.tangentImpulse=0,this.id=new Gt}t.MakeArray=function(e){return V(e,(function(){return new t}))};var e=t.prototype;return e.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},e.Copy=function(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this},t}();(Pt=t.b2ManifoldType||(t.b2ManifoldType={}))[Pt.e_unknown=-1]="e_unknown",Pt[Pt.e_circles=0]="e_circles",Pt[Pt.e_faceA=1]="e_faceA",Pt[Pt.e_faceB=2]="e_faceB";var Ft,Tt=function(){function e(){this.points=Dt.MakeArray(2),this.localNormal=new X,this.localPoint=new X,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}var i=e.prototype;return i.Reset=function(){for(var e=0;e<2;++e)this.points[e].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0},i.Copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<2;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this},i.Clone=function(){return(new e).Copy(this)},e}(),Lt=function(){function e(){this.normal=new X,this.points=X.MakeArray(2),this.separations=w(2)}return e.prototype.Initialize=function(i,n,o,r,a){if(0!==i.pointCount)switch(i.type){case t.b2ManifoldType.e_circles:this.normal.Set(1,0);var _=Y.MulXV(n,i.localPoint,e.Initialize_s_pointA),m=Y.MulXV(r,i.points[0].localPoint,e.Initialize_s_pointB);X.DistanceSquaredVV(_,m)>s&&X.SubVV(m,_,this.normal).SelfNormalize();var h=X.AddVMulSV(_,o,this.normal,e.Initialize_s_cA),l=X.SubVMulSV(m,a,this.normal,e.Initialize_s_cB);X.MidVV(h,l,this.points[0]),this.separations[0]=X.DotVV(X.SubVV(l,h,X.s_t0),this.normal);break;case t.b2ManifoldType.e_faceA:Q.MulRV(n.q,i.localNormal,this.normal);for(var u=Y.MulXV(n,i.localPoint,e.Initialize_s_planePoint),c=0;c<i.pointCount;++c){var f=Y.MulXV(r,i.points[c].localPoint,e.Initialize_s_clipPoint),d=o-X.DotVV(X.SubVV(f,u,X.s_t0),this.normal),p=X.AddVMulSV(f,d,this.normal,e.Initialize_s_cA),y=X.SubVMulSV(f,a,this.normal,e.Initialize_s_cB);X.MidVV(p,y,this.points[c]),this.separations[c]=X.DotVV(X.SubVV(y,p,X.s_t0),this.normal)}break;case t.b2ManifoldType.e_faceB:Q.MulRV(r.q,i.localNormal,this.normal);for(var v=Y.MulXV(r,i.localPoint,e.Initialize_s_planePoint),x=0;x<i.pointCount;++x){var S=Y.MulXV(n,i.points[x].localPoint,e.Initialize_s_clipPoint),B=a-X.DotVV(X.SubVV(S,v,X.s_t0),this.normal),b=X.AddVMulSV(S,B,this.normal,e.Initialize_s_cB),A=X.SubVMulSV(S,o,this.normal,e.Initialize_s_cA);X.MidVV(A,b,this.points[x]),this.separations[x]=X.DotVV(X.SubVV(A,b,X.s_t0),this.normal)}this.normal.SelfNeg()}},e}();Lt.Initialize_s_pointA=new X,Lt.Initialize_s_pointB=new X,Lt.Initialize_s_cA=new X,Lt.Initialize_s_cB=new X,Lt.Initialize_s_planePoint=new X,Lt.Initialize_s_clipPoint=new X,(Ft=t.b2PointState||(t.b2PointState={}))[Ft.b2_nullState=0]="b2_nullState",Ft[Ft.b2_addState=1]="b2_addState",Ft[Ft.b2_persistState=2]="b2_persistState",Ft[Ft.b2_removeState=3]="b2_removeState";var Rt=function(){function t(){this.v=new X,this.id=new Gt}return t.MakeArray=function(e){return V(e,(function(){return new t}))},t.prototype.Copy=function(t){return this.v.Copy(t.v),this.id.Copy(t.id),this},t}(),kt=function(){function t(){this.p1=new X,this.p2=new X,this.maxFraction=1}return t.prototype.Copy=function(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this},t}(),qt=function(){function t(){this.normal=new X,this.fraction=0}return t.prototype.Copy=function(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this},t}(),zt=function(){function t(){this.lowerBound=new X,this.upperBound=new X,this.m_cache_center=new X,this.m_cache_extent=new X}var e=t.prototype;return e.Copy=function(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this},e.IsValid=function(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)},e.GetCenter=function(){return X.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)},e.GetExtents=function(){return X.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)},e.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},e.Combine1=function(t){return this.lowerBound.x=D(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=D(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=F(this.upperBound.x,t.upperBound.x),this.upperBound.y=F(this.upperBound.y,t.upperBound.y),this},e.Combine2=function(t,e){return this.lowerBound.x=D(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=D(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=F(t.upperBound.x,e.upperBound.x),this.upperBound.y=F(t.upperBound.y,e.upperBound.y),this},t.Combine=function(t,e,i){return i.Combine2(t,e),i},e.Contains=function(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)},e.RayCast=function(t,e){var s=-1e37,o=i,r=e.p1.x,a=e.p1.y,_=e.p2.x-e.p1.x,m=e.p2.y-e.p1.y,h=G(_),l=G(m),u=t.normal;if(h<n){if(r<this.lowerBound.x||this.upperBound.x<r)return!1}else{var c=1/_,f=(this.lowerBound.x-r)*c,d=(this.upperBound.x-r)*c,p=-1;if(f>d){var y=f;f=d,d=y,p=1}if(f>s&&(u.x=p,u.y=0,s=f),s>(o=D(o,d)))return!1}if(l<n){if(a<this.lowerBound.y||this.upperBound.y<a)return!1}else{var v=1/m,x=(this.lowerBound.y-a)*v,S=(this.upperBound.y-a)*v,B=-1;if(x>S){var b=x;x=S,S=b,B=1}if(x>s&&(u.x=0,u.y=B,s=x),s>(o=D(o,S)))return!1}return!(s<0||e.maxFraction<s||(t.fraction=s,0))},e.TestContain=function(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)},e.TestOverlap=function(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)},t}();function jt(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function Jt(e,i,n,s,o){var r=0,a=i[0],_=i[1],m=X.DotVV(n,a.v)-s,h=X.DotVV(n,_.v)-s;if(m<=0&&e[r++].Copy(a),h<=0&&e[r++].Copy(_),m*h<0){var l=m/(m-h),u=e[r].v;u.x=a.v.x+l*(_.v.x-a.v.x),u.y=a.v.y+l*(_.v.y-a.v.y);var c=e[r].id;c.cf.indexA=o,c.cf.indexB=a.id.cf.indexB,c.cf.typeA=t.b2ContactFeatureType.e_vertex,c.cf.typeB=t.b2ContactFeatureType.e_face,++r}return r}var Et=new at,Nt=new rt,Ot=new _t;function Xt(t,e,i,n,s,o){var r=Et.Reset();r.proxyA.SetShape(t,e),r.proxyB.SetShape(i,n),r.transformA.Copy(s),r.transformB.Copy(o),r.useRadii=!0;var a=Nt.Reset();a.count=0;var _=Ot.Reset();return xt(_,a,r),_.distance<1e-4}function Ut(t){if(null===t)throw new Error;return t}var Wt=function(){function t(t){void 0===t&&(t=0),this.m_id=0,this.aabb=new zt,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}var e=t.prototype;return e.Reset=function(){this._userData=null},e.IsLeaf=function(){return null===this.child1},m(t,[{key:"userData",get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(t){if(null!==this._userData)throw new Error;this._userData=t}}]),t}(),Zt=function(){function t(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new st(256)}var e=t.prototype;return e.Query=function(t,e){var i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){var n=i.Pop();if(null!==n&&n.aabb.TestOverlap(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}},e.QueryPoint=function(t,e){var i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){var n=i.Pop();if(null!==n&&n.aabb.TestContain(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}},e.RayCast=function(e,i){var n=e.p1,s=e.p2,o=X.SubVV(s,n,t.s_r);o.Normalize();var r=X.CrossOneV(o,t.s_v),a=X.AbsV(r,t.s_abs_v),_=e.maxFraction,m=t.s_segmentAABB,h=n.x+_*(s.x-n.x),l=n.y+_*(s.y-n.y);m.lowerBound.x=D(n.x,h),m.lowerBound.y=D(n.y,l),m.upperBound.x=F(n.x,h),m.upperBound.y=F(n.y,l);var u=this.m_stack.Reset();for(u.Push(this.m_root);u.GetCount()>0;){var c=u.Pop();if(null!==c&&jt(c.aabb,m)){var f=c.aabb.GetCenter(),d=c.aabb.GetExtents();if(!(G(X.DotVV(r,X.SubVV(n,f,X.s_t0)))-X.DotVV(a,d)>0))if(c.IsLeaf()){var p=t.s_subInput;p.p1.Copy(e.p1),p.p2.Copy(e.p2),p.maxFraction=_;var y=i(p,c);if(0===y)return;y>0&&(_=y,h=n.x+_*(s.x-n.x),l=n.y+_*(s.y-n.y),m.lowerBound.x=D(n.x,h),m.lowerBound.y=D(n.y,l),m.upperBound.x=F(n.x,h),m.upperBound.y=F(n.y,l))}else u.Push(c.child1),u.Push(c.child2)}}},e.AllocateNode=function(){if(null!==this.m_freeList){var e=this.m_freeList;return this.m_freeList=e.parent,e.parent=null,e.child1=null,e.child2=null,e.height=0,e}return new Wt(t.s_node_id++)},e.FreeNode=function(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t},e.CreateProxy=function(t,e){var i=this.AllocateNode();return i.aabb.lowerBound.x=t.lowerBound.x-.1,i.aabb.lowerBound.y=t.lowerBound.y-.1,i.aabb.upperBound.x=t.upperBound.x+.1,i.aabb.upperBound.y=t.upperBound.y+.1,i.userData=e,i.height=0,this.InsertLeaf(i),i},e.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},e.MoveProxy=function(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);t.aabb.lowerBound.x=e.lowerBound.x-.1,t.aabb.lowerBound.y=e.lowerBound.y-.1,t.aabb.upperBound.x=e.upperBound.x+.1,t.aabb.upperBound.y=e.upperBound.y+.1;var n=2*i.x,s=2*i.y;return n<0?t.aabb.lowerBound.x+=n:t.aabb.upperBound.x+=n,s<0?t.aabb.lowerBound.y+=s:t.aabb.upperBound.y+=s,this.InsertLeaf(t),!0},e.InsertLeaf=function(e){if(++this.m_insertionCount,null===this.m_root)return this.m_root=e,void(this.m_root.parent=null);for(var i=e.aabb,n=this.m_root;!n.IsLeaf();){var s=Ut(n.child1),o=Ut(n.child2),r=n.aabb.GetPerimeter(),a=t.s_combinedAABB;a.Combine2(n.aabb,i);var _=a.GetPerimeter(),m=2*_,h=2*(_-r),l=void 0,u=t.s_aabb,c=void 0;s.IsLeaf()?(u.Combine2(i,s.aabb),l=u.GetPerimeter()+h):(u.Combine2(i,s.aabb),c=s.aabb.GetPerimeter(),l=u.GetPerimeter()-c+h);var f=void 0;if(o.IsLeaf()?(u.Combine2(i,o.aabb),f=u.GetPerimeter()+h):(u.Combine2(i,o.aabb),c=o.aabb.GetPerimeter(),f=u.GetPerimeter()-c+h),m<l&&m<f)break;n=l<f?s:o}var d=n.parent,p=this.AllocateNode();p.parent=d,p.aabb.Combine2(i,n.aabb),p.height=n.height+1,null!==d?(d.child1===n?d.child1=p:d.child2=p,p.child1=n,p.child2=e,n.parent=p,e.parent=p):(p.child1=n,p.child2=e,n.parent=p,e.parent=p,this.m_root=p);for(var y=e.parent;null!==y;){var v=Ut((y=this.Balance(y)).child1),x=Ut(y.child2);y.height=1+F(v.height,x.height),y.aabb.Combine2(v.aabb,x.aabb),y=y.parent}},e.RemoveLeaf=function(t){if(t!==this.m_root){var e=Ut(t.parent),i=e&&e.parent,n=Ut(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=n:i.child2=n,n.parent=i,this.FreeNode(e);for(var s=i;null!==s;){var o=Ut((s=this.Balance(s)).child1),r=Ut(s.child2);s.aabb.Combine2(o.aabb,r.aabb),s.height=1+F(o.height,r.height),s=s.parent}}else this.m_root=n,n.parent=null,this.FreeNode(e)}else this.m_root=null},e.Balance=function(t){if(t.IsLeaf()||t.height<2)return t;var e=Ut(t.child1),i=Ut(t.child2),n=i.height-e.height;if(n>1){var s=Ut(i.child1),o=Ut(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,s.height>o.height?(i.child2=s,t.child2=o,o.parent=t,t.aabb.Combine2(e.aabb,o.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+F(e.height,o.height),i.height=1+F(t.height,s.height)):(i.child2=o,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,o.aabb),t.height=1+F(e.height,s.height),i.height=1+F(t.height,o.height)),i}if(n<-1){var r=Ut(e.child1),a=Ut(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,r.height>a.height?(e.child2=r,t.child1=a,a.parent=t,t.aabb.Combine2(i.aabb,a.aabb),e.aabb.Combine2(t.aabb,r.aabb),t.height=1+F(i.height,a.height),e.height=1+F(t.height,r.height)):(e.child2=a,t.child1=r,r.parent=t,t.aabb.Combine2(i.aabb,r.aabb),e.aabb.Combine2(t.aabb,a.aabb),t.height=1+F(i.height,r.height),e.height=1+F(t.height,a.height)),e}return t},e.GetHeight=function(){return null===this.m_root?0:this.m_root.height},t.GetAreaNode=function(e){if(null===e)return 0;if(e.IsLeaf())return 0;var i=e.aabb.GetPerimeter();return(i+=t.GetAreaNode(e.child1))+t.GetAreaNode(e.child2)},e.GetAreaRatio=function(){if(null===this.m_root)return 0;var e=this.m_root.aabb.GetPerimeter();return t.GetAreaNode(this.m_root)/e},t.ComputeHeightNode=function(e){return null===e||e.IsLeaf()?0:1+F(t.ComputeHeightNode(e.child1),t.ComputeHeightNode(e.child2))},e.ComputeHeight=function(){return t.ComputeHeightNode(this.m_root)},e.ValidateStructure=function(t){if(null!==t&&(this.m_root,!t.IsLeaf())){var e=Ut(t.child1),i=Ut(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}},e.ValidateMetrics=function(e){if(null!==e&&!e.IsLeaf()){var i=Ut(e.child1),n=Ut(e.child2);t.s_aabb.Combine2(i.aabb,n.aabb),this.ValidateMetrics(i),this.ValidateMetrics(n)}},e.Validate=function(){},t.GetMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var i=Ut(t.child1),n=Ut(t.child2);return F(e,G(n.height-i.height))},e.GetMaxBalance=function(){return t.GetMaxBalanceNode(this.m_root,0)},e.RebuildBottomUp=function(){this.Validate()},t.ShiftOriginNode=function(e,i){if(null!==e&&!(e.height<=1)){var n=e.child1,s=e.child2;t.ShiftOriginNode(n,i),t.ShiftOriginNode(s,i),e.aabb.lowerBound.SelfSub(i),e.aabb.upperBound.SelfSub(i)}},e.ShiftOrigin=function(e){t.ShiftOriginNode(this.m_root,e)},t}();function Ht(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function Qt(t,e){return t<e}function Yt(t,e,i,n){void 0===i&&(i=t.length-e),void 0===n&&(n=Qt);for(var s=e,o=[],r=0;;){for(;s+1<i;i++){var a=t[s+Math.floor(Math.random()*(i-s))];o[r++]=i;for(var _=s-1;;){for(;n(t[++_],a););for(;n(a,t[--i]););if(_>=i)break;Ht(t,_,i)}}if(0===r)break;s=i,i=o[--r]}return t}Zt.s_r=new X,Zt.s_v=new X,Zt.s_abs_v=new X,Zt.s_segmentAABB=new zt,Zt.s_subInput=new kt,Zt.s_combinedAABB=new zt,Zt.s_aabb=new zt,Zt.s_node_id=0;var Kt=function(t,e){this.proxyA=t,this.proxyB=e},$t=function(){function t(){this.m_tree=new Zt,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}var e=t.prototype;return e.CreateProxy=function(t,e){var i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i},e.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},e.MoveProxy=function(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)},e.TouchProxy=function(t){this.BufferMove(t)},e.GetProxyCount=function(){return this.m_proxyCount},e.UpdatePairs=function(t){var e=this;this.m_pairCount=0;for(var i=function(){var t=e.m_moveBuffer[n];if(null===t)return 1;var i=t.aabb;e.m_tree.Query(i,(function(i){if(i.m_id===t.m_id)return!0;var n,s;if(i.m_id<t.m_id?(n=i,s=t):(n=t,s=i),e.m_pairCount===e.m_pairBuffer.length)e.m_pairBuffer[e.m_pairCount]=new Kt(n,s);else{var o=e.m_pairBuffer[e.m_pairCount];o.proxyA=n,o.proxyB=s}return++e.m_pairCount,!0}))},n=0;n<this.m_moveCount;++n)i();this.m_moveCount=0,Yt(this.m_pairBuffer,0,this.m_pairCount,te);for(var s=0;s<this.m_pairCount;){var o=this.m_pairBuffer[s];for(t(o.proxyA.userData,o.proxyB.userData),++s;s<this.m_pairCount;){var r=this.m_pairBuffer[s];if(r.proxyA.m_id!==o.proxyA.m_id||r.proxyB.m_id!==o.proxyB.m_id)break;++s}}},e.Query=function(t,e){this.m_tree.Query(t,e)},e.QueryPoint=function(t,e){this.m_tree.QueryPoint(t,e)},e.RayCast=function(t,e){this.m_tree.RayCast(t,e)},e.GetTreeHeight=function(){return this.m_tree.GetHeight()},e.GetTreeBalance=function(){return this.m_tree.GetMaxBalance()},e.GetTreeQuality=function(){return this.m_tree.GetAreaRatio()},e.ShiftOrigin=function(t){this.m_tree.ShiftOrigin(t)},e.BufferMove=function(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount},e.UnBufferMove=function(t){var e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null},t}();function te(t,e){return t.proxyA.m_id<e.proxyA.m_id||t.proxyA.m_id===e.proxyA.m_id&&t.proxyB.m_id<e.proxyB.m_id}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;var ee,ie=new Y,ne=new Y,se=new X,oe=new X,re=new X,ae=new X,_e=new X,me=function(){this.proxyA=new ot,this.proxyB=new ot,this.sweepA=new $,this.sweepB=new $,this.tMax=0};(ee=t.b2TOIOutputState||(t.b2TOIOutputState={}))[ee.e_unknown=0]="e_unknown",ee[ee.e_failed=1]="e_failed",ee[ee.e_overlapped=2]="e_overlapped",ee[ee.e_touching=3]="e_touching",ee[ee.e_separated=4]="e_separated";var he,le=function(){this.state=t.b2TOIOutputState.e_unknown,this.t=0};(he=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[he.e_unknown=-1]="e_unknown",he[he.e_points=0]="e_points",he[he.e_faceA=1]="e_faceA",he[he.e_faceB=2]="e_faceB";var ue=function(){function e(){this.m_sweepA=new $,this.m_sweepB=new $,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new X,this.m_axis=new X}var i=e.prototype;return i.Initialize=function(e,i,n,s,o,r){this.m_proxyA=i,this.m_proxyB=s;var a=e.count;this.m_sweepA.Copy(n),this.m_sweepB.Copy(o);var _=ie,m=ne;if(this.m_sweepA.GetTransform(_,r),this.m_sweepB.GetTransform(m,r),1===a){this.m_type=t.b2SeparationFunctionType.e_points;var h=this.m_proxyA.GetVertex(e.indexA[0]),l=this.m_proxyB.GetVertex(e.indexB[0]),u=Y.MulXV(_,h,se),c=Y.MulXV(m,l,oe);X.SubVV(c,u,this.m_axis);var f=this.m_axis.Normalize();return this.m_localPoint.SetZero(),f}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;var d=this.m_proxyB.GetVertex(e.indexB[0]),p=this.m_proxyB.GetVertex(e.indexB[1]);X.CrossVOne(X.SubVV(p,d,X.s_t0),this.m_axis).SelfNormalize();var y=Q.MulRV(m.q,this.m_axis,re);X.MidVV(d,p,this.m_localPoint);var v=Y.MulXV(m,this.m_localPoint,oe),x=this.m_proxyA.GetVertex(e.indexA[0]),S=Y.MulXV(_,x,se),B=X.DotVV(X.SubVV(S,v,X.s_t0),y);return B<0&&(this.m_axis.SelfNeg(),B=-B),B}this.m_type=t.b2SeparationFunctionType.e_faceA;var b=this.m_proxyA.GetVertex(e.indexA[0]),A=this.m_proxyA.GetVertex(e.indexA[1]);X.CrossVOne(X.SubVV(A,b,X.s_t0),this.m_axis).SelfNormalize();var g=Q.MulRV(_.q,this.m_axis,re);X.MidVV(b,A,this.m_localPoint);var C=Y.MulXV(_,this.m_localPoint,se),V=this.m_proxyB.GetVertex(e.indexB[0]),w=Y.MulXV(m,V,oe),M=X.DotVV(X.SubVV(w,C,X.s_t0),g);return M<0&&(this.m_axis.SelfNeg(),M=-M),M},i.FindMinSeparation=function(e,i,n){var s=ie,o=ne;switch(this.m_sweepA.GetTransform(s,n),this.m_sweepB.GetTransform(o,n),this.m_type){case t.b2SeparationFunctionType.e_points:var r=Q.MulTRV(s.q,this.m_axis,ae),a=Q.MulTRV(o.q,X.NegV(this.m_axis,X.s_t0),_e);e[0]=this.m_proxyA.GetSupport(r),i[0]=this.m_proxyB.GetSupport(a);var _=this.m_proxyA.GetVertex(e[0]),m=this.m_proxyB.GetVertex(i[0]),h=Y.MulXV(s,_,se),l=Y.MulXV(o,m,oe);return X.DotVV(X.SubVV(l,h,X.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var u=Q.MulRV(s.q,this.m_axis,re),c=Y.MulXV(s,this.m_localPoint,se),f=Q.MulTRV(o.q,X.NegV(u,X.s_t0),_e);e[0]=-1,i[0]=this.m_proxyB.GetSupport(f);var d=this.m_proxyB.GetVertex(i[0]),p=Y.MulXV(o,d,oe);return X.DotVV(X.SubVV(p,c,X.s_t0),u);case t.b2SeparationFunctionType.e_faceB:var y=Q.MulRV(o.q,this.m_axis,re),v=Y.MulXV(o,this.m_localPoint,oe),x=Q.MulTRV(s.q,X.NegV(y,X.s_t0),ae);i[0]=-1,e[0]=this.m_proxyA.GetSupport(x);var S=this.m_proxyA.GetVertex(e[0]),B=Y.MulXV(s,S,se);return X.DotVV(X.SubVV(B,v,X.s_t0),y);default:return e[0]=-1,i[0]=-1,0}},i.Evaluate=function(e,i,n){var s=ie,o=ne;switch(this.m_sweepA.GetTransform(s,n),this.m_sweepB.GetTransform(o,n),this.m_type){case t.b2SeparationFunctionType.e_points:var r=this.m_proxyA.GetVertex(e),a=this.m_proxyB.GetVertex(i),_=Y.MulXV(s,r,se),m=Y.MulXV(o,a,oe);return X.DotVV(X.SubVV(m,_,X.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var h=Q.MulRV(s.q,this.m_axis,re),l=Y.MulXV(s,this.m_localPoint,se),u=this.m_proxyB.GetVertex(i),c=Y.MulXV(o,u,oe);return X.DotVV(X.SubVV(c,l,X.s_t0),h);case t.b2SeparationFunctionType.e_faceB:var f=Q.MulRV(o.q,this.m_axis,re),d=Y.MulXV(o,this.m_localPoint,oe),p=this.m_proxyA.GetVertex(e),y=Y.MulXV(s,p,se);return X.DotVV(X.SubVV(y,d,X.s_t0),f);default:return 0}},e}(),ce=new it,fe=new rt,de=new at,pe=new _t,ye=new ue,ve=[0],xe=[0],Se=new $,Be=new $;function be(e,i){var n=ce.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=i.tMax;var s=i.proxyA,o=i.proxyB,r=F(8,F(s.m_count,o.m_count)),_=Se.Copy(i.sweepA),m=Be.Copy(i.sweepB);_.Normalize(),m.Normalize();var h=i.tMax,l=s.m_radius+o.m_radius,u=F(a,l-.024),c=.002,f=0,d=0,p=fe;p.count=0;var y=de;for(y.proxyA.Copy(i.proxyA),y.proxyB.Copy(i.proxyB),y.useRadii=!1;;){var v=ie,x=ne;_.GetTransform(v,f),m.GetTransform(x,f),y.transformA.Copy(v),y.transformB.Copy(x);var S=pe;if(xt(S,p,y),S.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(S.distance<u+c){e.state=t.b2TOIOutputState.e_touching,e.t=f;break}var B=ye;B.Initialize(p,s,_,o,m,f);for(var b=!1,A=h,g=0;;){var C=ve,V=xe,w=B.FindMinSeparation(C,V,A);if(w>u+c){e.state=t.b2TOIOutputState.e_separated,e.t=h,b=!0;break}if(w>u-c){f=A;break}var M=B.Evaluate(C[0],V[0],f);if(M<u-c){e.state=t.b2TOIOutputState.e_failed,e.t=f,b=!0;break}if(M<=u+c){e.state=t.b2TOIOutputState.e_touching,e.t=f,b=!0;break}for(var P=0,I=f,D=A;;){var T;T=1&P?I+(u-M)*(D-I)/(w-M):.5*(I+D),++P,++t.b2_toiRootIters;var L=B.Evaluate(C[0],V[0],T);if(G(L-u)<c){A=T;break}if(L>u?(I=T,M=L):(D=T,w=L),50===P)break}if(t.b2_toiMaxRootIters=F(t.b2_toiMaxRootIters,P),++g===r)break}if(++d,++t.b2_toiIters,b)break;if(20===d){e.state=t.b2TOIOutputState.e_failed,e.t=f;break}}t.b2_toiMaxIters=F(t.b2_toiMaxIters,d);var R=n.GetMilliseconds();t.b2_toiMaxTime=F(t.b2_toiMaxTime,R),t.b2_toiTime+=R}var Ae=new X,ge=new X;function Ce(e,i,n,s,o){e.pointCount=0;var r=Y.MulXV(n,i.m_p,Ae),a=Y.MulXV(o,s.m_p,ge),_=X.DistanceSquaredVV(r,a),m=i.m_radius+s.m_radius;_>m*m||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(i.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(s.m_p),e.points[0].id.key=0)}var Ve=new X,we=new X,Me=new X;function Pe(e,i,s,o,r){e.pointCount=0;for(var a=Y.MulXV(r,o.m_p,Ve),_=Y.MulTXV(s,a,we),m=0,h=-1e37,l=i.m_radius+o.m_radius,u=i.m_count,c=i.m_vertices,f=i.m_normals,d=0;d<u;++d){var p=X.DotVV(f[d],X.SubVV(_,c[d],X.s_t0));if(p>l)return;p>h&&(h=p,m=d)}var y=m,v=(y+1)%u,x=c[y],S=c[v];if(h<n)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(f[m]),X.MidVV(x,S,e.localPoint),e.points[0].localPoint.Copy(o.m_p),void(e.points[0].id.key=0);var B=X.DotVV(X.SubVV(_,x,X.s_t0),X.SubVV(S,x,X.s_t1)),b=X.DotVV(X.SubVV(_,S,X.s_t0),X.SubVV(x,S,X.s_t1));if(B<=0){if(X.DistanceSquaredVV(_,x)>l*l)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,X.SubVV(_,x,e.localNormal).SelfNormalize(),e.localPoint.Copy(x),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}else if(b<=0){if(X.DistanceSquaredVV(_,S)>l*l)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,X.SubVV(_,S,e.localNormal).SelfNormalize(),e.localPoint.Copy(S),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}else{var A=X.MidVV(x,S,Me);if(X.DotVV(X.SubVV(_,A,X.s_t1),f[y])>l)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(f[y]).SelfNormalize(),e.localPoint.Copy(A),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}}var Ie=new X,Ge=new X,De=new X,Fe=new X;function Te(t,e,n,s,o){for(var r=t.m_vertices,a=t.m_normals,_=s.m_count,m=s.m_vertices,h=Q.MulRV(e.q,a[n],Ie),l=Q.MulTRV(o.q,h,Ge),u=0,c=i,f=0;f<_;++f){var d=X.DotVV(m[f],l);d<c&&(c=d,u=f)}var p=Y.MulXV(e,r[n],De),y=Y.MulXV(o,m[u],Fe);return X.DotVV(X.SubVV(y,p,X.s_t0),h)}var Le=new X,Re=new X;function ke(t,e,i,n,s){for(var o=e.m_count,r=e.m_normals,a=X.SubVV(Y.MulXV(s,n.m_centroid,X.s_t0),Y.MulXV(i,e.m_centroid,X.s_t1),Le),_=Q.MulTRV(i.q,a,Re),m=0,h=-1e37,l=0;l<o;++l){var u=X.DotVV(r[l],_);u>h&&(h=u,m=l)}var c=Te(e,i,m,n,s),f=(m+o-1)%o,d=Te(e,i,f,n,s),p=(m+1)%o,y=Te(e,i,p,n,s),v=0,x=0,S=0;if(d>c&&d>y)S=-1,v=f,x=d;else{if(!(y>c))return t[0]=m,c;S=1,v=p,x=y}for(;(c=Te(e,i,m=-1===S?(v+o-1)%o:(v+1)%o,n,s))>x;)v=m,x=c;return t[0]=v,x}var qe=new X;function ze(e,n,s,o,r,a){for(var _=n.m_normals,m=r.m_count,h=r.m_vertices,l=r.m_normals,u=Q.MulTRV(a.q,Q.MulRV(s.q,_[o],X.s_t0),qe),c=0,f=i,d=0;d<m;++d){var p=X.DotVV(u,l[d]);p<f&&(f=p,c=d)}var y=c,v=(y+1)%m,x=e[0];Y.MulXV(a,h[y],x.v);var S=x.id.cf;S.indexA=o,S.indexB=y,S.typeA=t.b2ContactFeatureType.e_face,S.typeB=t.b2ContactFeatureType.e_vertex;var B=e[1];Y.MulXV(a,h[v],B.v);var b=B.id.cf;b.indexA=o,b.indexB=v,b.typeA=t.b2ContactFeatureType.e_face,b.typeB=t.b2ContactFeatureType.e_vertex}var je=Rt.MakeArray(2),Je=Rt.MakeArray(2),Ee=Rt.MakeArray(2),Ne=[0],Oe=[0],Xe=new X,Ue=new X,We=new X,Ze=new X,He=new X,Qe=new X,Ye=new X,Ke=new X;function $e(e,i,n,s,o){e.pointCount=0;var r=i.m_radius+s.m_radius,a=Ne;a[0]=0;var _=ke(a,i,n,s,o);if(!(_>r)){var m=Oe;m[0]=0;var h=ke(m,s,o,i,n);if(!(h>r)){var l,u,c,f,d=0,p=0;h>.98*_+.001?(l=s,u=i,c=o,f=n,d=m[0],e.type=t.b2ManifoldType.e_faceB,p=1):(l=i,u=s,c=n,f=o,d=a[0],e.type=t.b2ManifoldType.e_faceA,p=0);var y=je;ze(y,l,c,d,u,f);var v=l.m_count,x=l.m_vertices,S=d,B=(d+1)%v,b=x[S],A=x[B],g=X.SubVV(A,b,Xe);g.Normalize();var C=X.CrossVOne(g,Ue),V=X.MidVV(b,A,We),w=Q.MulRV(c.q,g,He),M=X.CrossVOne(w,Ze),P=Y.MulXV(c,b,Ye),I=Y.MulXV(c,A,Ke),G=X.DotVV(M,P),D=-X.DotVV(w,P)+r,F=X.DotVV(w,I)+r,T=Je,L=Ee;if(!(Jt(T,y,X.NegV(w,Qe),D,S)<2||Jt(L,T,w,F,B)<2)){e.localNormal.Copy(C),e.localPoint.Copy(V);for(var R=0,k=0;k<2;++k){var q=L[k];if(X.DotVV(M,q.v)-G<=r){var z=e.points[R];if(Y.MulTXV(f,q.v,z.localPoint),z.id.Copy(q.id),p){var j=z.id.cf;z.id.cf.indexA=j.indexB,z.id.cf.indexB=j.indexA,z.id.cf.typeA=j.typeB,z.id.cf.typeB=j.typeA}++R}}e.pointCount=R}}}}var ti,ei=new X,ii=new X,ni=new X,si=new X,oi=new X,ri=new X,ai=new X,_i=new Gt;function mi(e,i,n,s,o){e.pointCount=0;var r=Y.MulTXV(n,Y.MulXV(o,s.m_p,X.s_t0),ei),a=i.m_vertex1,_=i.m_vertex2,m=X.SubVV(_,a,ii),h=X.DotVV(m,X.SubVV(_,r,X.s_t0)),l=X.DotVV(m,X.SubVV(r,a,X.s_t0)),u=i.m_radius+s.m_radius,c=_i;if(c.cf.indexB=0,c.cf.typeB=t.b2ContactFeatureType.e_vertex,l<=0){var f=a,d=X.SubVV(r,f,ni);if(X.DotVV(d,d)>u*u)return;if(i.m_hasVertex0){var p=i.m_vertex0,y=a,v=X.SubVV(y,p,si);if(X.DotVV(v,X.SubVV(y,r,X.s_t0))>0)return}return c.cf.indexA=0,c.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(f),e.points[0].id.Copy(c),void e.points[0].localPoint.Copy(s.m_p)}if(h<=0){var x=_,S=X.SubVV(r,x,ni);if(X.DotVV(S,S)>u*u)return;if(i.m_hasVertex3){var B=i.m_vertex3,b=_,A=X.SubVV(B,b,oi);if(X.DotVV(A,X.SubVV(r,b,X.s_t0))>0)return}return c.cf.indexA=1,c.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(x),e.points[0].id.Copy(c),void e.points[0].localPoint.Copy(s.m_p)}var g=X.DotVV(m,m),C=ri;C.x=1/g*(h*a.x+l*_.x),C.y=1/g*(h*a.y+l*_.y);var V=X.SubVV(r,C,ni);if(!(X.DotVV(V,V)>u*u)){var w=ai.Set(-m.y,m.x);X.DotVV(w,X.SubVV(r,a,X.s_t0))<0&&w.Set(-w.x,-w.y),w.Normalize(),c.cf.indexA=0,c.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(w),e.localPoint.Copy(a),e.points[0].id.Copy(c),e.points[0].localPoint.Copy(s.m_p)}}!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(ti||(ti={}));var hi,li=function(){this.type=ti.e_unknown,this.index=0,this.separation=0},ui=function(){this.vertices=[],this.normals=[],this.count=0};!function(t){t[t.e_isolated=0]="e_isolated",t[t.e_concave=1]="e_concave",t[t.e_convex=2]="e_convex"}(hi||(hi={}));var ci=function(){function e(){this.m_polygonB=new ui,this.m_xf=new Y,this.m_centroidB=new X,this.m_v0=new X,this.m_v1=new X,this.m_v2=new X,this.m_v3=new X,this.m_normal0=new X,this.m_normal1=new X,this.m_normal2=new X,this.m_normal=new X,this.m_type1=hi.e_isolated,this.m_type2=hi.e_isolated,this.m_lowerLimit=new X,this.m_upperLimit=new X,this.m_radius=0,this.m_front=!1}var n=e.prototype;return n.Collide=function(i,n,s,o,r){Y.MulTXX(s,r,this.m_xf),Y.MulXV(this.m_xf,o.m_centroid,this.m_centroidB),this.m_v0.Copy(n.m_vertex0),this.m_v1.Copy(n.m_vertex1),this.m_v2.Copy(n.m_vertex2),this.m_v3.Copy(n.m_vertex3);var a=n.m_hasVertex0,_=n.m_hasVertex3,m=X.SubVV(this.m_v2,this.m_v1,e.s_edge1);m.Normalize(),this.m_normal1.Set(m.y,-m.x);var h=X.DotVV(this.m_normal1,X.SubVV(this.m_centroidB,this.m_v1,X.s_t0)),l=0,u=0,c=!1,f=!1;if(a){var d=X.SubVV(this.m_v1,this.m_v0,e.s_edge0);d.Normalize(),this.m_normal0.Set(d.y,-d.x),c=X.CrossVV(d,m)>=0,l=X.DotVV(this.m_normal0,X.SubVV(this.m_centroidB,this.m_v0,X.s_t0))}if(_){var p=X.SubVV(this.m_v3,this.m_v2,e.s_edge2);p.Normalize(),this.m_normal2.Set(p.y,-p.x),f=X.CrossVV(m,p)>0,u=X.DotVV(this.m_normal2,X.SubVV(this.m_centroidB,this.m_v2,X.s_t0))}a&&_?c&&f?(this.m_front=l>=0||h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):c?(this.m_front=l>=0||h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):f?(this.m_front=u>=0||l>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=l>=0&&h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):a?c?(this.m_front=l>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=l>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):_?f?(this.m_front=h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=o.m_count;for(var y=0;y<o.m_count;++y)this.m_polygonB.vertices.length<=y&&this.m_polygonB.vertices.push(new X),this.m_polygonB.normals.length<=y&&this.m_polygonB.normals.push(new X),Y.MulXV(this.m_xf,o.m_vertices[y],this.m_polygonB.vertices[y]),Q.MulRV(this.m_xf.q,o.m_normals[y],this.m_polygonB.normals[y]);this.m_radius=o.m_radius+n.m_radius,i.pointCount=0;var v=this.ComputeEdgeSeparation(e.s_edgeAxis);if(v.type!==ti.e_unknown&&!(v.separation>this.m_radius)){var x=this.ComputePolygonSeparation(e.s_polygonAxis);if(!(x.type!==ti.e_unknown&&x.separation>this.m_radius)){var S;S=x.type===ti.e_unknown?v:x.separation>.98*v.separation+.001?x:v;var B=e.s_ie,b=e.s_rf;if(S.type===ti.e_edgeA){i.type=t.b2ManifoldType.e_faceA;for(var A=0,g=X.DotVV(this.m_normal,this.m_polygonB.normals[0]),C=1;C<this.m_polygonB.count;++C){var V=X.DotVV(this.m_normal,this.m_polygonB.normals[C]);V<g&&(g=V,A=C)}var w=A,M=(w+1)%this.m_polygonB.count,P=B[0];P.v.Copy(this.m_polygonB.vertices[w]),P.id.cf.indexA=0,P.id.cf.indexB=w,P.id.cf.typeA=t.b2ContactFeatureType.e_face,P.id.cf.typeB=t.b2ContactFeatureType.e_vertex;var I=B[1];I.v.Copy(this.m_polygonB.vertices[M]),I.id.cf.indexA=0,I.id.cf.indexB=M,I.id.cf.typeA=t.b2ContactFeatureType.e_face,I.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(b.i1=0,b.i2=1,b.v1.Copy(this.m_v1),b.v2.Copy(this.m_v2),b.normal.Copy(this.m_normal1)):(b.i1=1,b.i2=0,b.v1.Copy(this.m_v2),b.v2.Copy(this.m_v1),b.normal.Copy(this.m_normal1).SelfNeg())}else{i.type=t.b2ManifoldType.e_faceB;var G=B[0];G.v.Copy(this.m_v1),G.id.cf.indexA=0,G.id.cf.indexB=S.index,G.id.cf.typeA=t.b2ContactFeatureType.e_vertex,G.id.cf.typeB=t.b2ContactFeatureType.e_face;var D=B[1];D.v.Copy(this.m_v2),D.id.cf.indexA=0,D.id.cf.indexB=S.index,D.id.cf.typeA=t.b2ContactFeatureType.e_vertex,D.id.cf.typeB=t.b2ContactFeatureType.e_face,b.i1=S.index,b.i2=(b.i1+1)%this.m_polygonB.count,b.v1.Copy(this.m_polygonB.vertices[b.i1]),b.v2.Copy(this.m_polygonB.vertices[b.i2]),b.normal.Copy(this.m_polygonB.normals[b.i1])}b.sideNormal1.Set(b.normal.y,-b.normal.x),b.sideNormal2.Copy(b.sideNormal1).SelfNeg(),b.sideOffset1=X.DotVV(b.sideNormal1,b.v1),b.sideOffset2=X.DotVV(b.sideNormal2,b.v2);var F=e.s_clipPoints1,T=e.s_clipPoints2;if(!(Jt(F,B,b.sideNormal1,b.sideOffset1,b.i1)<2||Jt(T,F,b.sideNormal2,b.sideOffset2,b.i2)<2)){S.type===ti.e_edgeA?(i.localNormal.Copy(b.normal),i.localPoint.Copy(b.v1)):(i.localNormal.Copy(o.m_normals[b.i1]),i.localPoint.Copy(o.m_vertices[b.i1]));for(var L=0,R=0;R<2;++R)if(X.DotVV(b.normal,X.SubVV(T[R].v,b.v1,X.s_t0))<=this.m_radius){var k=i.points[L];S.type===ti.e_edgeA?(Y.MulTXV(this.m_xf,T[R].v,k.localPoint),k.id.Copy(T[R].id)):(k.localPoint.Copy(T[R].v),k.id.cf.typeA=T[R].id.cf.typeB,k.id.cf.typeB=T[R].id.cf.typeA,k.id.cf.indexA=T[R].id.cf.indexB,k.id.cf.indexB=T[R].id.cf.indexA),++L}i.pointCount=L}}}},n.ComputeEdgeSeparation=function(t){var e=t;e.type=ti.e_edgeA,e.index=this.m_front?0:1,e.separation=i;for(var n=0;n<this.m_polygonB.count;++n){var s=X.DotVV(this.m_normal,X.SubVV(this.m_polygonB.vertices[n],this.m_v1,X.s_t0));s<e.separation&&(e.separation=s)}return e},n.ComputePolygonSeparation=function(t){var i=t;i.type=ti.e_unknown,i.index=-1,i.separation=-1e37;for(var n=e.s_perp.Set(-this.m_normal.y,this.m_normal.x),s=0;s<this.m_polygonB.count;++s){var o=X.NegV(this.m_polygonB.normals[s],e.s_n),r=D(X.DotVV(o,X.SubVV(this.m_polygonB.vertices[s],this.m_v1,X.s_t0)),X.DotVV(o,X.SubVV(this.m_polygonB.vertices[s],this.m_v2,X.s_t0)));if(r>this.m_radius)return i.type=ti.e_edgeB,i.index=s,i.separation=r,i;if(X.DotVV(o,n)>=0){if(X.DotVV(X.SubVV(o,this.m_upperLimit,X.s_t0),this.m_normal)<-.03490658503988889)continue}else if(X.DotVV(X.SubVV(o,this.m_lowerLimit,X.s_t0),this.m_normal)<-.03490658503988889)continue;r>i.separation&&(i.type=ti.e_edgeB,i.index=s,i.separation=r)}return i},e}();ci.s_edge1=new X,ci.s_edge0=new X,ci.s_edge2=new X,ci.s_ie=Rt.MakeArray(2),ci.s_rf=new function(){this.i1=0,this.i2=0,this.v1=new X,this.v2=new X,this.normal=new X,this.sideNormal1=new X,this.sideOffset1=0,this.sideNormal2=new X,this.sideOffset2=0},ci.s_clipPoints1=Rt.MakeArray(2),ci.s_clipPoints2=Rt.MakeArray(2),ci.s_edgeAxis=new li,ci.s_polygonAxis=new li,ci.s_n=new X,ci.s_perp=new X;var fi=new ci;function di(t,e,i,n,s){fi.Collide(t,e,i,n,s)}var pi,yi=function(){this.mass=0,this.center=new X(0,0),this.I=0};(pi=t.b2ShapeType||(t.b2ShapeType={}))[pi.e_unknown=-1]="e_unknown",pi[pi.e_circleShape=0]="e_circleShape",pi[pi.e_edgeShape=1]="e_edgeShape",pi[pi.e_polygonShape=2]="e_polygonShape",pi[pi.e_chainShape=3]="e_chainShape",pi[pi.e_shapeTypeCount=4]="e_shapeTypeCount";var vi=function(){function e(e,i){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=i}var i=e.prototype;return i.Copy=function(t){return this.m_radius=t.m_radius,this},i.GetType=function(){return this.m_type},e}(),xi=function(e){function i(i){var n;return void 0===i&&(i=0),(n=e.call(this,t.b2ShapeType.e_circleShape,i)||this).m_p=new X,n}h(i,e);var s=i.prototype;return s.Set=function(t,e){return void 0===e&&(e=this.m_radius),this.m_p.Copy(t),this.m_radius=e,this},s.Clone=function(){return(new i).Copy(this)},s.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_p.Copy(t.m_p),this},s.GetChildCount=function(){return 1},s.TestPoint=function(t,e){var n=Y.MulXV(t,this.m_p,i.TestPoint_s_center),s=X.SubVV(e,n,i.TestPoint_s_d);return X.DotVV(s,s)<=R(this.m_radius)},s.ComputeDistance=function(t,e,n){var s=Y.MulXV(t,this.m_p,i.ComputeDistance_s_center);return X.SubVV(e,s,n),n.Normalize()-this.m_radius},s.RayCast=function(t,e,s){var o=Y.MulXV(s,this.m_p,i.RayCast_s_position),r=X.SubVV(e.p1,o,i.RayCast_s_s),a=X.DotVV(r,r)-R(this.m_radius),_=X.SubVV(e.p2,e.p1,i.RayCast_s_r),m=X.DotVV(r,_),h=X.DotVV(_,_),l=m*m-h*a;if(l<0||h<n)return!1;var u=-(m+q(l));return 0<=u&&u<=e.maxFraction*h&&(u/=h,t.fraction=u,X.AddVMulSV(r,u,_,t.normal).SelfNormalize(),!0)},s.ComputeAABB=function(t,e){var n=Y.MulXV(e,this.m_p,i.ComputeAABB_s_p);t.lowerBound.Set(n.x-this.m_radius,n.y-this.m_radius),t.upperBound.Set(n.x+this.m_radius,n.y+this.m_radius)},s.ComputeMass=function(t,e){var i=R(this.m_radius);t.mass=e*o*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+X.DotVV(this.m_p,this.m_p))},s.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius},s.ComputeSubmergedArea=function(t,e,i,s){var r=Y.MulXV(i,this.m_p,new X),a=-(X.DotVV(t,r)-e);if(a<-this.m_radius+n)return 0;if(a>this.m_radius)return s.Copy(r),o*this.m_radius*this.m_radius;var _=this.m_radius*this.m_radius,m=a*a,h=_*(N(a/this.m_radius)+o/2)+a*q(_-m),l=-2/3*z(_-m,1.5)/h;return s.x=r.x+t.x*l,s.y=r.y+t.y*l,h},s.Dump=function(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)},i}(vi);xi.TestPoint_s_center=new X,xi.TestPoint_s_d=new X,xi.ComputeDistance_s_center=new X,xi.RayCast_s_position=new X,xi.RayCast_s_s=new X,xi.RayCast_s_r=new X,xi.ComputeAABB_s_p=new X;var Si=function(e){function i(){var i;return(i=e.call(this,t.b2ShapeType.e_polygonShape,c)||this).m_centroid=new X(0,0),i.m_vertices=[],i.m_normals=[],i.m_count=0,i}h(i,e);var n=i.prototype;return n.Clone=function(){return(new i).Copy(this)},n.Copy=function(t){e.prototype.Copy.call(this,t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=X.MakeArray(this.m_count),this.m_normals=X.MakeArray(this.m_count);for(var i=0;i<this.m_count;++i)this.m_vertices[i].Copy(t.m_vertices[i]),this.m_normals[i].Copy(t.m_normals[i]);return this},n.GetChildCount=function(){return 1},n.Set=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if("number"==typeof e[0][0]){var n=e[0];if(n.length%2!=0)throw new Error;return this._Set((function(t){return{x:n[2*t],y:n[2*t+1]}}),n.length/2)}var s=e[0],o=e[1]||s.length;return this._Set((function(t){return s[t]}),o)},n._Set=function(t,e){if(e<3)return this.SetAsBox(1,1);for(var n=e,s=[],o=0;o<n;++o){for(var r=t(o),a=!0,_=0;_<s.length;++_)if(X.DistanceSquaredVV(r,s[_])<16e-6){a=!1;break}a&&s.push(r)}if((n=s.length)<3)return this.SetAsBox(1,1);for(var m=0,h=s[0].x,l=1;l<n;++l){var u=s[l].x;(u>h||u===h&&s[l].y<s[m].y)&&(m=l,h=u)}for(var c=[],f=0,d=m;;){c[f]=d;for(var p=0,y=1;y<n;++y)if(p!==d){var v=X.SubVV(s[p],s[c[f]],i.Set_s_r),x=X.SubVV(s[y],s[c[f]],i.Set_s_v),S=X.CrossVV(v,x);S<0&&(p=y),0===S&&x.LengthSquared()>v.LengthSquared()&&(p=y)}else p=y;if(++f,d=p,p===m)break}this.m_count=f,this.m_vertices=X.MakeArray(this.m_count),this.m_normals=X.MakeArray(this.m_count);for(var B=0;B<f;++B)this.m_vertices[B].Copy(s[c[B]]);for(var b=0;b<f;++b){var A=this.m_vertices[b],g=this.m_vertices[(b+1)%f],C=X.SubVV(g,A,X.s_t0);X.CrossVOne(C,this.m_normals[b]).SelfNormalize()}return i.ComputeCentroid(this.m_vertices,f,this.m_centroid),this},n.SetAsBox=function(t,e,i,n){if(void 0===n&&(n=0),this.m_count=4,this.m_vertices=X.MakeArray(this.m_count),this.m_normals=X.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);var s=new Y;s.SetPosition(i),s.SetRotationAngle(n);for(var o=0;o<this.m_count;++o)Y.MulXV(s,this.m_vertices[o],this.m_vertices[o]),Q.MulRV(s.q,this.m_normals[o],this.m_normals[o])}return this},n.TestPoint=function(t,e){for(var n=Y.MulTXV(t,e,i.TestPoint_s_pLocal),s=0;s<this.m_count;++s)if(X.DotVV(this.m_normals[s],X.SubVV(n,this.m_vertices[s],X.s_t0))>0)return!1;return!0},n.ComputeDistance=function(t,e,n){for(var s=Y.MulTXV(t,e,i.ComputeDistance_s_pLocal),o=-1e37,r=i.ComputeDistance_s_normalForMaxDistance.Copy(s),a=0;a<this.m_count;++a){var _=X.DotVV(this.m_normals[a],X.SubVV(s,this.m_vertices[a],X.s_t0));_>o&&(o=_,r.Copy(this.m_normals[a]))}if(o>0){for(var m=i.ComputeDistance_s_minDistance.Copy(r),h=o*o,l=0;l<this.m_count;++l){var u=X.SubVV(s,this.m_vertices[l],i.ComputeDistance_s_distance),c=u.LengthSquared();h>c&&(m.Copy(u),h=c)}return Q.MulRV(t.q,m,n),n.Normalize(),Math.sqrt(h)}return Q.MulRV(t.q,r,n),o},n.RayCast=function(t,e,n){for(var s=Y.MulTXV(n,e.p1,i.RayCast_s_p1),o=Y.MulTXV(n,e.p2,i.RayCast_s_p2),r=X.SubVV(o,s,i.RayCast_s_d),a=0,_=e.maxFraction,m=-1,h=0;h<this.m_count;++h){var l=X.DotVV(this.m_normals[h],X.SubVV(this.m_vertices[h],s,X.s_t0)),u=X.DotVV(this.m_normals[h],r);if(0===u){if(l<0)return!1}else u<0&&l<a*u?(a=l/u,m=h):u>0&&l<_*u&&(_=l/u);if(_<a)return!1}return m>=0&&(t.fraction=a,Q.MulRV(n.q,this.m_normals[m],t.normal),!0)},n.ComputeAABB=function(t,e){for(var n=Y.MulXV(e,this.m_vertices[0],t.lowerBound),s=t.upperBound.Copy(n),o=0;o<this.m_count;++o){var r=Y.MulXV(e,this.m_vertices[o],i.ComputeAABB_s_v);X.MinV(r,n,n),X.MaxV(r,s,s)}var a=this.m_radius;n.SelfSubXY(a,a),s.SelfAddXY(a,a)},n.ComputeMass=function(t,e){for(var n=i.ComputeMass_s_center.SetZero(),s=0,o=0,r=i.ComputeMass_s_s.SetZero(),a=0;a<this.m_count;++a)r.SelfAdd(this.m_vertices[a]);r.SelfMul(1/this.m_count);for(var _=1/3,m=0;m<this.m_count;++m){var h=X.SubVV(this.m_vertices[m],r,i.ComputeMass_s_e1),l=X.SubVV(this.m_vertices[(m+1)%this.m_count],r,i.ComputeMass_s_e2),u=X.CrossVV(h,l),c=.5*u;s+=c,n.SelfAdd(X.MulSV(c*_,X.AddVV(h,l,X.s_t0),X.s_t1));var f=h.x,d=h.y,p=l.x,y=l.y;o+=.25*_*u*(f*f+p*f+p*p+d*d+y*d+y*y)}t.mass=e*s,n.SelfMul(1/s),X.AddVV(n,r,t.center),t.I=e*o,t.I+=t.mass*(X.DotVV(t.center,t.center)-X.DotVV(n,n))},n.Validate=function(){for(var t=0;t<this.m_count;++t)for(var e=t,n=(t+1)%this.m_count,s=this.m_vertices[e],o=X.SubVV(this.m_vertices[n],s,i.Validate_s_e),r=0;r<this.m_count;++r)if(r!==e&&r!==n){var a=X.SubVV(this.m_vertices[r],s,i.Validate_s_v);if(X.CrossVV(o,a)<0)return!1}return!0},n.SetupDistanceProxy=function(t){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius},n.ComputeSubmergedArea=function(t,e,n,s){for(var o=Q.MulTRV(n.q,t,i.ComputeSubmergedArea_s_normalL),r=e-X.DotVV(t,n.p),a=[],_=0,m=-1,h=-1,l=!1,u=0;u<this.m_count;++u){a[u]=X.DotVV(o,this.m_vertices[u])-r;var c=a[u]<-1e-5;u>0&&(c?l||(m=u-1,_++):l&&(h=u-1,_++)),l=c}switch(_){case 0:if(l){var f=i.ComputeSubmergedArea_s_md;return this.ComputeMass(f,1),Y.MulXV(n,f.center,s),f.mass}return 0;case 1:-1===m?m=this.m_count-1:h=this.m_count-1}for(var d,p=(m+1)%this.m_count,y=(h+1)%this.m_count,v=(0-a[m])/(a[p]-a[m]),x=(0-a[h])/(a[y]-a[h]),S=i.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[m].x*(1-v)+this.m_vertices[p].x*v,this.m_vertices[m].y*(1-v)+this.m_vertices[p].y*v),B=i.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-x)+this.m_vertices[y].x*x,this.m_vertices[h].y*(1-x)+this.m_vertices[y].y*x),b=0,A=i.ComputeSubmergedArea_s_center.SetZero(),g=this.m_vertices[p],C=p;C!==y;){d=(C=(C+1)%this.m_count)===y?B:this.m_vertices[C];var V=.5*((g.x-S.x)*(d.y-S.y)-(g.y-S.y)*(d.x-S.x));b+=V,A.x+=V*(S.x+g.x+d.x)/3,A.y+=V*(S.y+g.y+d.y)/3,g=d}return A.SelfMul(1/b),Y.MulXV(n,A,s),b},n.Dump=function(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)},i.ComputeCentroid=function(t,e,n){var s=n;s.SetZero();for(var o=0,r=i.ComputeCentroid_s_pRef.SetZero(),a=1/3,_=0;_<e;++_){var m=r,h=t[_],l=t[(_+1)%e],u=X.SubVV(h,m,i.ComputeCentroid_s_e1),c=X.SubVV(l,m,i.ComputeCentroid_s_e2),f=.5*X.CrossVV(u,c);o+=f,s.x+=f*a*(m.x+h.x+l.x),s.y+=f*a*(m.y+h.y+l.y)}return s.SelfMul(1/o),s},i}(vi);Si.Set_s_r=new X,Si.Set_s_v=new X,Si.TestPoint_s_pLocal=new X,Si.ComputeDistance_s_pLocal=new X,Si.ComputeDistance_s_normalForMaxDistance=new X,Si.ComputeDistance_s_minDistance=new X,Si.ComputeDistance_s_distance=new X,Si.RayCast_s_p1=new X,Si.RayCast_s_p2=new X,Si.RayCast_s_d=new X,Si.ComputeAABB_s_v=new X,Si.ComputeMass_s_center=new X,Si.ComputeMass_s_s=new X,Si.ComputeMass_s_e1=new X,Si.ComputeMass_s_e2=new X,Si.Validate_s_e=new X,Si.Validate_s_v=new X,Si.ComputeSubmergedArea_s_normalL=new X,Si.ComputeSubmergedArea_s_md=new yi,Si.ComputeSubmergedArea_s_intoVec=new X,Si.ComputeSubmergedArea_s_outoVec=new X,Si.ComputeSubmergedArea_s_center=new X,Si.ComputeCentroid_s_pRef=new X,Si.ComputeCentroid_s_e1=new X,Si.ComputeCentroid_s_e2=new X;var Bi=function(e){function i(){var i;return(i=e.call(this,t.b2ShapeType.e_edgeShape,c)||this).m_vertex1=new X,i.m_vertex2=new X,i.m_vertex0=new X,i.m_vertex3=new X,i.m_hasVertex0=!1,i.m_hasVertex3=!1,i}h(i,e);var n=i.prototype;return n.Set=function(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},n.Clone=function(){return(new i).Copy(this)},n.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this},n.GetChildCount=function(){return 1},n.TestPoint=function(){return!1},n.ComputeDistance=function(t,e,n){var s=Y.MulXV(t,this.m_vertex1,i.ComputeDistance_s_v1),o=Y.MulXV(t,this.m_vertex2,i.ComputeDistance_s_v2),r=X.SubVV(e,s,i.ComputeDistance_s_d),a=X.SubVV(o,s,i.ComputeDistance_s_s),_=X.DotVV(r,a);if(_>0){var m=X.DotVV(a,a);_>m?X.SubVV(e,o,r):r.SelfMulSub(_/m,a)}return n.Copy(r),n.Normalize()},n.RayCast=function(t,e,n){var s=Y.MulTXV(n,e.p1,i.RayCast_s_p1),o=Y.MulTXV(n,e.p2,i.RayCast_s_p2),r=X.SubVV(o,s,i.RayCast_s_d),a=this.m_vertex1,_=this.m_vertex2,m=X.SubVV(_,a,i.RayCast_s_e),h=t.normal.Set(m.y,-m.x).SelfNormalize(),l=X.DotVV(h,X.SubVV(a,s,X.s_t0)),u=X.DotVV(h,r);if(0===u)return!1;var c=l/u;if(c<0||e.maxFraction<c)return!1;var f=X.AddVMulSV(s,c,r,i.RayCast_s_q),d=X.SubVV(_,a,i.RayCast_s_r),p=X.DotVV(d,d);if(0===p)return!1;var y=X.DotVV(X.SubVV(f,a,X.s_t0),d)/p;return!(y<0||1<y||(t.fraction=c,Q.MulRV(n.q,t.normal,t.normal),l>0&&t.normal.SelfNeg(),0))},n.ComputeAABB=function(t,e){var n=Y.MulXV(e,this.m_vertex1,i.ComputeAABB_s_v1),s=Y.MulXV(e,this.m_vertex2,i.ComputeAABB_s_v2);X.MinV(n,s,t.lowerBound),X.MaxV(n,s,t.upperBound);var o=this.m_radius;t.lowerBound.SelfSubXY(o,o),t.upperBound.SelfAddXY(o,o)},n.ComputeMass=function(t){t.mass=0,X.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0},n.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius},n.ComputeSubmergedArea=function(t,e,i,n){return n.SetZero(),0},n.Dump=function(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)},i}(vi);Bi.ComputeDistance_s_v1=new X,Bi.ComputeDistance_s_v2=new X,Bi.ComputeDistance_s_d=new X,Bi.ComputeDistance_s_s=new X,Bi.RayCast_s_p1=new X,Bi.RayCast_s_p2=new X,Bi.RayCast_s_d=new X,Bi.RayCast_s_e=new X,Bi.RayCast_s_q=new X,Bi.RayCast_s_r=new X,Bi.ComputeAABB_s_v1=new X,Bi.ComputeAABB_s_v2=new X;var bi=function(e){function i(){var i;return(i=e.call(this,t.b2ShapeType.e_chainShape,c)||this).m_vertices=[],i.m_count=0,i.m_prevVertex=new X,i.m_nextVertex=new X,i.m_hasPrevVertex=!1,i.m_hasNextVertex=!1,i}h(i,e);var n=i.prototype;return n.CreateLoop=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if("number"==typeof e[0][0]){var n=e[0];if(n.length%2!=0)throw new Error;return this._CreateLoop((function(t){return{x:n[2*t],y:n[2*t+1]}}),n.length/2)}var s=e[0],o=e[1]||s.length;return this._CreateLoop((function(t){return s[t]}),o)},n._CreateLoop=function(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=X.MakeArray(this.m_count);for(var i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this},n.CreateChain=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if("number"==typeof e[0][0]){var n=e[0];if(n.length%2!=0)throw new Error;return this._CreateChain((function(t){return{x:n[2*t],y:n[2*t+1]}}),n.length/2)}var s=e[0],o=e[1]||s.length;return this._CreateChain((function(t){return s[t]}),o)},n._CreateChain=function(t,e){this.m_count=e,this.m_vertices=X.MakeArray(e);for(var i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this},n.SetPrevVertex=function(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this},n.SetNextVertex=function(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this},n.Clone=function(){return(new i).Copy(this)},n.Copy=function(t){return e.prototype.Copy.call(this,t),this._CreateChain((function(e){return t.m_vertices[e]}),t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this},n.GetChildCount=function(){return this.m_count-1},n.GetChildEdge=function(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)},n.TestPoint=function(){return!1},n.ComputeDistance=function(t,e,n,s){var o=i.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,s),o.ComputeDistance(t,e,n,0)},n.RayCast=function(t,e,n,s){var o=i.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[s]),o.m_vertex2.Copy(this.m_vertices[(s+1)%this.m_count]),o.RayCast(t,e,n,0)},n.ComputeAABB=function(t,e,n){var s=this.m_vertices[n],o=this.m_vertices[(n+1)%this.m_count],r=Y.MulXV(e,s,i.ComputeAABB_s_v1),a=Y.MulXV(e,o,i.ComputeAABB_s_v2);X.MinV(r,a,t.lowerBound),X.MaxV(r,a,t.upperBound)},n.ComputeMass=function(t){t.mass=0,t.center.SetZero(),t.I=0},n.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius},n.ComputeSubmergedArea=function(t,e,i,n){return n.SetZero(),0},n.Dump=function(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")},i}(vi);bi.ComputeDistance_s_edgeShape=new Bi,bi.RayCast_s_edgeShape=new Bi,bi.ComputeAABB_s_v1=new X,bi.ComputeAABB_s_v2=new X;var Ai=function(){function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this},t}();Ai.DEFAULT=new Ai;var gi=function(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new Ai},Ci=function(){function t(t,e){this.aabb=new zt,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}var e=t.prototype;return e.Reset=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)},e.Touch=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)},e.Synchronize=function(e,i,n){if(e===i)this.fixture.m_shape.ComputeAABB(this.aabb,e,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,n);else{var s=t.Synchronize_s_aabb1,o=t.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(s,e,this.childIndex),this.fixture.m_shape.ComputeAABB(o,i,this.childIndex),this.aabb.Combine2(s,o),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,n)}},t}();Ci.Synchronize_s_aabb1=new zt,Ci.Synchronize_s_aabb2=new zt;var Vi,wi=function(){function t(t,i){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new Ai,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=i.shape.Clone(),this.m_userData=e(i.userData,null),this.m_friction=e(i.friction,.2),this.m_restitution=e(i.restitution,0),this.m_filter.Copy(e(i.filter,Ai.DEFAULT)),this.m_isSensor=e(i.isSensor,!1),this.m_density=e(i.density,0)}var i=t.prototype;return i.Reset=function(){},i.GetType=function(){return this.m_shape.GetType()},i.GetShape=function(){return this.m_shape},i.SetSensor=function(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)},i.IsSensor=function(){return this.m_isSensor},i.SetFilterData=function(t){this.m_filter.Copy(t),this.Refilter()},i.GetFilterData=function(){return this.m_filter},i.Refilter=function(){for(var t=this.m_body.GetContactList();t;){var e=t.contact,i=e.GetFixtureA(),n=e.GetFixtureB();i!==this&&n!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()},i.GetBody=function(){return this.m_body},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},i.ComputeDistance=function(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)},i.RayCast=function(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)},i.GetMassData=function(t){return void 0===t&&(t=new yi),this.m_shape.ComputeMass(t,this.m_density),t},i.SetDensity=function(t){this.m_density=t},i.GetDensity=function(){return this.m_density},i.GetFriction=function(){return this.m_friction},i.SetFriction=function(t){this.m_friction=t},i.GetRestitution=function(){return this.m_restitution},i.SetRestitution=function(t){this.m_restitution=t},i.GetAABB=function(t){return this.m_proxies[t].aabb},i.Dump=function(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},i.CreateProxies=function(){if(0!==this.m_proxies.length)throw new Error;for(var t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new Ci(this,t)},i.DestroyProxies=function(){for(var t,e=l(this.m_proxies);!(t=e()).done;)t.value.Reset();this.m_proxies.length=0},i.TouchProxies=function(){for(var t,e=l(this.m_proxies);!(t=e()).done;)t.value.Touch()},i.SynchronizeProxies=function(t,e,i){for(var n,s=l(this.m_proxies);!(n=s()).done;)n.value.Synchronize(t,e,i)},m(t,[{key:"m_proxyCount",get:function(){return this.m_proxies.length}}]),t}();(Vi=t.b2BodyType||(t.b2BodyType={}))[Vi.b2_unknown=-1]="b2_unknown",Vi[Vi.b2_staticBody=0]="b2_staticBody",Vi[Vi.b2_kinematicBody=1]="b2_kinematicBody",Vi[Vi.b2_dynamicBody=2]="b2_dynamicBody";var Mi,Pi,Ii=function(){function i(i,n){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new Y,this.m_xf0=new Y,this.m_sweep=new $,this.m_linearVelocity=new X,this.m_angularVelocity=0,this.m_force=new X,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=e(i.bullet,!1),this.m_fixedRotationFlag=e(i.fixedRotation,!1),this.m_autoSleepFlag=e(i.allowSleep,!0),this.m_awakeFlag=e(i.awake,!0),this.m_activeFlag=e(i.active,!0),this.m_world=n,this.m_xf.p.Copy(e(i.position,X.ZERO)),this.m_xf.q.SetAngle(e(i.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(e(i.linearVelocity,X.ZERO)),this.m_angularVelocity=e(i.angularVelocity,0),this.m_linearDamping=e(i.linearDamping,0),this.m_angularDamping=e(i.angularDamping,0),this.m_gravityScale=e(i.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=e(i.type,t.b2BodyType.b2_staticBody),i.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=i.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}var n=i.prototype;return n.CreateFixture=function(t,e){return void 0===e&&(e=0),t instanceof vi?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)},n.CreateFixtureDef=function(t){if(this.m_world.IsLocked())throw new Error;var e=new wi(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e},n.CreateFixtureShapeDensity=function(t,e){void 0===e&&(e=0);var n=i.CreateFixtureShapeDensity_s_def;return n.shape=t,n.density=e,this.CreateFixtureDef(n)},n.DestroyFixture=function(t){if(this.m_world.IsLocked())throw new Error;for(var e=this.m_fixtureList,i=null;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}for(var n=this.m_contactList;n;){var s=n.contact;n=n.next;var o=s.GetFixtureA(),r=s.GetFixtureB();t!==o&&t!==r||this.m_world.m_contactManager.Destroy(s)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()},n.SetTransformVec=function(t,e){this.SetTransformXY(t.x,t.y,e)},n.SetTransformXY=function(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),Y.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(var n=this.m_fixtureList;n;n=n.m_next)n.SynchronizeProxies(this.m_xf,this.m_xf,X.ZERO);this.m_world.m_contactManager.FindNewContacts()},n.SetTransform=function(t){this.SetTransformVec(t.p,t.GetAngle())},n.GetTransform=function(){return this.m_xf},n.GetPosition=function(){return this.m_xf.p},n.SetPosition=function(t){this.SetTransformVec(t,this.GetAngle())},n.SetPositionXY=function(t,e){this.SetTransformXY(t,e,this.GetAngle())},n.GetAngle=function(){return this.m_sweep.a},n.SetAngle=function(t){this.SetTransformVec(this.GetPosition(),t)},n.GetWorldCenter=function(){return this.m_sweep.c},n.GetLocalCenter=function(){return this.m_sweep.localCenter},n.SetLinearVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(X.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))},n.GetLinearVelocity=function(){return this.m_linearVelocity},n.SetAngularVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)},n.GetAngularVelocity=function(){return this.m_angularVelocity},n.GetDefinition=function(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t},n.ApplyForce=function(e,i,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x))},n.ApplyForceToCenter=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))},n.ApplyTorque=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))},n.ApplyLinearImpulse=function(e,i,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x)))},n.ApplyLinearImpulseToCenter=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))},n.ApplyAngularImpulse=function(e,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))},n.GetMass=function(){return this.m_mass},n.GetInertia=function(){return this.m_I+this.m_mass*X.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)},n.GetMassData=function(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*X.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t},n.SetMassData=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t.b2BodyType.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!this.m_fixedRotationFlag&&(this.m_I=e.I-this.m_mass*X.DotVV(e.center,e.center),this.m_invI=1/this.m_I);var n=i.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e.center),Y.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),X.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,X.SubVV(this.m_sweep.c,n,X.s_t0),this.m_linearVelocity)}},n.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var e=i.ResetMassData_s_localCenter.SetZero(),n=this.m_fixtureList;n;n=n.m_next)if(0!==n.m_density){var s=n.GetMassData(i.ResetMassData_s_massData);this.m_mass+=s.mass,e.x+=s.center.x*s.mass,e.y+=s.center.y*s.mass,this.m_I+=s.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*X.DotVV(e,e),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var o=i.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e),Y.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),X.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,X.SubVV(this.m_sweep.c,o,X.s_t0),this.m_linearVelocity)},n.GetWorldPoint=function(t,e){return Y.MulXV(this.m_xf,t,e)},n.GetWorldVector=function(t,e){return Q.MulRV(this.m_xf.q,t,e)},n.GetLocalPoint=function(t,e){return Y.MulTXV(this.m_xf,t,e)},n.GetLocalVector=function(t,e){return Q.MulTRV(this.m_xf.q,t,e)},n.GetLinearVelocityFromWorldPoint=function(t,e){return X.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,X.SubVV(t,this.m_sweep.c,X.s_t0),e)},n.GetLinearVelocityFromLocalPoint=function(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)},n.GetLinearDamping=function(){return this.m_linearDamping},n.SetLinearDamping=function(t){this.m_linearDamping=t},n.GetAngularDamping=function(){return this.m_angularDamping},n.SetAngularDamping=function(t){this.m_angularDamping=t},n.GetGravityScale=function(){return this.m_gravityScale},n.SetGravityScale=function(t){this.m_gravityScale=t},n.SetType=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==e){this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var i=this.m_contactList;i;){var n=i;i=i.next,this.m_world.m_contactManager.Destroy(n.contact)}this.m_contactList=null;for(var s=this.m_fixtureList;s;s=s.m_next)s.TouchProxies()}},n.GetType=function(){return this.m_type},n.SetBullet=function(t){this.m_bulletFlag=t},n.IsBullet=function(){return this.m_bulletFlag},n.SetSleepingAllowed=function(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)},n.IsSleepingAllowed=function(){return this.m_autoSleepFlag},n.SetAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},n.IsAwake=function(){return this.m_awakeFlag},n.SetActive=function(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(var e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies();else{for(var i=this.m_fixtureList;i;i=i.m_next)i.DestroyProxies();for(var n=this.m_contactList;n;){var s=n;n=n.next,this.m_world.m_contactManager.Destroy(s.contact)}this.m_contactList=null}},n.IsActive=function(){return this.m_activeFlag},n.SetFixedRotation=function(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())},n.IsFixedRotation=function(){return this.m_fixedRotationFlag},n.GetFixtureList=function(){return this.m_fixtureList},n.GetJointList=function(){return this.m_jointList},n.GetContactList=function(){return this.m_contactList},n.GetNext=function(){return this.m_next},n.GetUserData=function(){return this.m_userData},n.SetUserData=function(t){this.m_userData=t},n.GetWorld=function(){return this.m_world},n.Dump=function(e){var i=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");var n="";switch(this.m_type){case t.b2BodyType.b2_staticBody:n="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:n="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:n="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",n),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(var s=this.m_fixtureList;s;s=s.m_next)e("  {\n"),s.Dump(e,i),e("  }\n");e("}\n")},n.SynchronizeFixtures=function(){var t=i.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),Q.MulRV(t.q,this.m_sweep.localCenter,t.p),X.SubVV(this.m_sweep.c0,t.p,t.p);for(var e=X.SubVV(this.m_sweep.c,this.m_sweep.c0,i.SynchronizeFixtures_s_displacement),n=this.m_fixtureList;n;n=n.m_next)n.SynchronizeProxies(t,this.m_xf,e)},n.SynchronizeTransform=function(){this.m_xf.q.SetAngle(this.m_sweep.a),Q.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),X.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},n.ShouldCollide=function(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)},n.ShouldCollideConnected=function(t){for(var e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0},n.Advance=function(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),Q.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),X.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},n.GetControllerList=function(){return this.m_controllerList},n.GetControllerCount=function(){return this.m_controllerCount},i}();Ii.CreateFixtureShapeDensity_s_def=new gi,Ii.SetMassData_s_oldCenter=new X,Ii.ResetMassData_s_localCenter=new X,Ii.ResetMassData_s_oldCenter=new X,Ii.ResetMassData_s_massData=new yi,Ii.SynchronizeFixtures_s_xf1=new Y,Ii.SynchronizeFixtures_s_displacement=new X,(Pi=t.b2JointType||(t.b2JointType={}))[Pi.e_unknownJoint=0]="e_unknownJoint",Pi[Pi.e_revoluteJoint=1]="e_revoluteJoint",Pi[Pi.e_prismaticJoint=2]="e_prismaticJoint",Pi[Pi.e_distanceJoint=3]="e_distanceJoint",Pi[Pi.e_pulleyJoint=4]="e_pulleyJoint",Pi[Pi.e_mouseJoint=5]="e_mouseJoint",Pi[Pi.e_gearJoint=6]="e_gearJoint",Pi[Pi.e_wheelJoint=7]="e_wheelJoint",Pi[Pi.e_weldJoint=8]="e_weldJoint",Pi[Pi.e_frictionJoint=9]="e_frictionJoint",Pi[Pi.e_ropeJoint=10]="e_ropeJoint",Pi[Pi.e_motorJoint=11]="e_motorJoint",Pi[Pi.e_areaJoint=12]="e_areaJoint",(Mi=t.b2LimitState||(t.b2LimitState={}))[Mi.e_inactiveLimit=0]="e_inactiveLimit",Mi[Mi.e_atLowerLimit=1]="e_atLowerLimit",Mi[Mi.e_atUpperLimit=2]="e_atUpperLimit",Mi[Mi.e_equalLimits=3]="e_equalLimits";var Gi=function(){function t(){this.linear=new X,this.angularA=0,this.angularB=0}var e=t.prototype;return e.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},e.Set=function(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this},t}(),Di=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.joint=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},m(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),Fi=function(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e},Ti=function(){function i(i){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new Di(this),this.m_edgeB=new Di(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=i.type,this.m_edgeA.other=i.bodyB,this.m_edgeB.other=i.bodyA,this.m_bodyA=i.bodyA,this.m_bodyB=i.bodyB,this.m_collideConnected=e(i.collideConnected,!1),this.m_userData=e(i.userData,null)}var n=i.prototype;return n.GetType=function(){return this.m_type},n.GetBodyA=function(){return this.m_bodyA},n.GetBodyB=function(){return this.m_bodyB},n.GetNext=function(){return this.m_next},n.GetUserData=function(){return this.m_userData},n.SetUserData=function(t){this.m_userData=t},n.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},n.GetCollideConnected=function(){return this.m_collideConnected},n.Dump=function(t){t("// Dump is not supported for this joint type.\n")},n.ShiftOrigin=function(){},i}(),Li=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_distanceJoint)||this).localAnchorA=new X,i.localAnchorB=new X,i.length=1,i.frequencyHz=0,i.dampingRatio=0,i}return h(i,e),i.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.length=X.DistanceVV(i,n),this.frequencyHz=0,this.dampingRatio=0},i}(Fi),Ri=function(t){function i(i){var n;return(n=t.call(this,i)||this).m_frequencyHz=0,n.m_dampingRatio=0,n.m_bias=0,n.m_localAnchorA=new X,n.m_localAnchorB=new X,n.m_gamma=0,n.m_impulse=0,n.m_length=0,n.m_indexA=0,n.m_indexB=0,n.m_u=new X,n.m_rA=new X,n.m_rB=new X,n.m_localCenterA=new X,n.m_localCenterB=new X,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_mass=0,n.m_qA=new Q,n.m_qB=new Q,n.m_lalcA=new X,n.m_lalcB=new X,n.m_frequencyHz=e(i.frequencyHz,0),n.m_dampingRatio=e(i.dampingRatio,0),n.m_localAnchorA.Copy(i.localAnchorA),n.m_localAnchorB.Copy(i.localAnchorB),n.m_length=i.length,n}h(i,t);var n=i.prototype;return n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e},n.GetReactionTorque=function(){return 0},n.GetLocalAnchorA=function(){return this.m_localAnchorA},n.GetLocalAnchorB=function(){return this.m_localAnchorB},n.SetLength=function(t){this.m_length=t},n.Length=function(){return this.m_length},n.SetFrequency=function(t){this.m_frequencyHz=t},n.GetFrequency=function(){return this.m_frequencyHz},n.SetDampingRatio=function(t){this.m_dampingRatio=t},n.GetDampingRatio=function(){return this.m_dampingRatio},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,_=t.positions[this.m_indexB].c,m=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(n),c=this.m_qB.SetAngle(m);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Q.MulRV(u,this.m_lalcA,this.m_rA),X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Q.MulRV(c,this.m_lalcB,this.m_rB),this.m_u.x=_.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=_.y+this.m_rB.y-e.y-this.m_rA.y;var f=this.m_u.Length();f>a?this.m_u.SelfMul(1/f):this.m_u.SetZero();var d=X.CrossVV(this.m_rA,this.m_u),p=X.CrossVV(this.m_rB,this.m_u),y=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=0!==y?1/y:0,this.m_frequencyHz>0){var v=f-this.m_length,x=2*o*this.m_frequencyHz,S=2*this.m_mass*this.m_dampingRatio*x,B=this.m_mass*x*x,b=t.step.dt;this.m_gamma=b*(S+b*B),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=v*b*B*this.m_gamma,y+=this.m_gamma,this.m_mass=0!==y?1/y:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var A=X.MulSV(this.m_impulse,this.m_u,i.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,A),r-=this.m_invIA*X.CrossVV(this.m_rA,A),h.SelfMulAdd(this.m_invMassB,A),l+=this.m_invIB*X.CrossVV(this.m_rB,A)}else this.m_impulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=l},n.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,r=X.AddVCrossSV(e,n,this.m_rA,i.SolveVelocityConstraints_s_vpA),a=X.AddVCrossSV(s,o,this.m_rB,i.SolveVelocityConstraints_s_vpB),_=X.DotVV(this.m_u,X.SubVV(a,r,X.s_t0)),m=-this.m_mass*(_+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=m;var h=X.MulSV(m,this.m_u,i.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,h),n-=this.m_invIA*X.CrossVV(this.m_rA,h),s.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*X.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(t){if(this.m_frequencyHz>0)return!0;var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,r=this.m_qA.SetAngle(n),_=this.m_qB.SetAngle(o),m=Q.MulRV(r,this.m_lalcA,this.m_rA),h=Q.MulRV(_,this.m_lalcB,this.m_rB),l=this.m_u;l.x=s.x+h.x-e.x-m.x,l.y=s.y+h.y-e.y-m.y;var u=this.m_u.Normalize()-this.m_length;u=T(u,-.2,f);var c=-this.m_mass*u,d=X.MulSV(c,l,i.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,d),n-=this.m_invIA*X.CrossVV(m,d),s.SelfMulAdd(this.m_invMassB,d),o+=this.m_invIB*X.CrossVV(h,d),t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,G(u)<a},i}(Ti);Ri.InitVelocityConstraints_s_P=new X,Ri.SolveVelocityConstraints_s_vpA=new X,Ri.SolveVelocityConstraints_s_vpB=new X,Ri.SolveVelocityConstraints_s_P=new X,Ri.SolvePositionConstraints_s_P=new X;var ki=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_areaJoint)||this).bodies=[],i.frequencyHz=0,i.dampingRatio=0,i}return h(i,e),i.prototype.AddBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},i}(Fi),qi=function(t){function i(i){var n;(n=t.call(this,i)||this).m_frequencyHz=0,n.m_dampingRatio=0,n.m_impulse=0,n.m_targetArea=0,n.m_delta=new X,n.m_bodies=i.bodies,n.m_frequencyHz=e(i.frequencyHz,0),n.m_dampingRatio=e(i.dampingRatio,0),n.m_targetLengths=w(i.bodies.length),n.m_normals=X.MakeArray(i.bodies.length),n.m_joints=[],n.m_deltas=X.MakeArray(i.bodies.length);var s=new Li;s.frequencyHz=n.m_frequencyHz,s.dampingRatio=n.m_dampingRatio,n.m_targetArea=0;for(var o=0;o<n.m_bodies.length;++o){var r=n.m_bodies[o],a=n.m_bodies[(o+1)%n.m_bodies.length],_=r.GetWorldCenter(),m=a.GetWorldCenter();n.m_targetLengths[o]=X.DistanceVV(_,m),n.m_targetArea+=X.CrossVV(_,m),s.Initialize(r,a,_,m),n.m_joints[o]=r.GetWorld().CreateJoint(s)}return n.m_targetArea*=.5,n}h(i,t);var s=i.prototype;return s.GetAnchorA=function(t){return t},s.GetAnchorB=function(t){return t},s.GetReactionForce=function(t,e){return e},s.GetReactionTorque=function(){return 0},s.SetFrequency=function(t){this.m_frequencyHz=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)},s.GetFrequency=function(){return this.m_frequencyHz},s.SetDampingRatio=function(t){this.m_dampingRatio=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)},s.GetDampingRatio=function(){return this.m_dampingRatio},s.Dump=function(t){t("Area joint dumping is not supported.\n")},s.InitVelocityConstraints=function(t){for(var e=0;e<this.m_bodies.length;++e){var i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],n=this.m_bodies[(e+1)%this.m_bodies.length],s=t.positions[i.m_islandIndex].c,o=t.positions[n.m_islandIndex].c,r=this.m_deltas[e];X.SubVV(o,s,r)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(var a=0;a<this.m_bodies.length;++a){var _=this.m_bodies[a],m=t.velocities[_.m_islandIndex].v,h=this.m_deltas[a];m.x+=_.m_invMass*h.y*.5*this.m_impulse,m.y+=_.m_invMass*-h.x*.5*this.m_impulse}}else this.m_impulse=0},s.SolveVelocityConstraints=function(t){for(var e=0,i=0,n=0;n<this.m_bodies.length;++n){var s=this.m_bodies[n],o=t.velocities[s.m_islandIndex].v,r=this.m_deltas[n];e+=r.LengthSquared()/s.GetMass(),i+=X.CrossVV(o,r)}var a=-2*i/e;this.m_impulse+=a;for(var _=0;_<this.m_bodies.length;++_){var m=this.m_bodies[_],h=t.velocities[m.m_islandIndex].v,l=this.m_deltas[_];h.x+=m.m_invMass*l.y*.5*a,h.y+=m.m_invMass*-l.x*.5*a}},s.SolvePositionConstraints=function(t){for(var e=0,i=0,s=0;s<this.m_bodies.length;++s){var o=this.m_bodies[s],r=this.m_bodies[(s+1)%this.m_bodies.length],_=t.positions[o.m_islandIndex].c,m=t.positions[r.m_islandIndex].c,h=X.SubVV(m,_,this.m_delta),l=h.Length();l<n&&(l=1),this.m_normals[s].x=h.y/l,this.m_normals[s].y=-h.x/l,e+=l,i+=X.CrossVV(_,m)}i*=.5;for(var u=.5*(this.m_targetArea-i)/e,c=!0,d=0;d<this.m_bodies.length;++d){var p=this.m_bodies[d],y=t.positions[p.m_islandIndex].c,v=(d+1)%this.m_bodies.length,x=X.AddVV(this.m_normals[d],this.m_normals[v],this.m_delta);x.SelfMul(u);var S=x.LengthSquared();S>R(f)&&x.SelfMul(f/q(S)),S>R(a)&&(c=!1),y.x+=x.x,y.y+=x.y}return c},i}(Ti),zi=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_frictionJoint)||this).localAnchorA=new X,i.localAnchorB=new X,i.maxForce=0,i.maxTorque=0,i}return h(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)},i}(Fi),ji=function(t){function i(i){var n;return(n=t.call(this,i)||this).m_localAnchorA=new X,n.m_localAnchorB=new X,n.m_linearImpulse=new X,n.m_angularImpulse=0,n.m_maxForce=0,n.m_maxTorque=0,n.m_indexA=0,n.m_indexB=0,n.m_rA=new X,n.m_rB=new X,n.m_localCenterA=new X,n.m_localCenterB=new X,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_linearMass=new Z,n.m_angularMass=0,n.m_qA=new Q,n.m_qB=new Q,n.m_lalcA=new X,n.m_lalcB=new X,n.m_K=new Z,n.m_localAnchorA.Copy(i.localAnchorA),n.m_localAnchorB.Copy(i.localAnchorB),n.m_linearImpulse.SetZero(),n.m_maxForce=e(i.maxForce,0),n.m_maxTorque=e(i.maxTorque,0),n.m_linearMass.SetZero(),n}h(i,t);var n=i.prototype;return n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,a=this.m_qA.SetAngle(e),_=this.m_qB.SetAngle(s);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var m=Q.MulRV(a,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h=Q.MulRV(_,this.m_lalcB,this.m_rB),l=this.m_invMassA,u=this.m_invMassB,c=this.m_invIA,f=this.m_invIB,d=this.m_K;if(d.ex.x=l+u+c*m.y*m.y+f*h.y*h.y,d.ex.y=-c*m.x*m.y-f*h.x*h.y,d.ey.x=d.ex.y,d.ey.y=l+u+c*m.x*m.x+f*h.x*h.x,d.GetInverse(this.m_linearMass),this.m_angularMass=c+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var p=this.m_linearImpulse;i.SelfMulSub(l,p),n-=c*(X.CrossVV(this.m_rA,p)+this.m_angularImpulse),o.SelfMulAdd(u,p),r+=f*(X.CrossVV(this.m_rB,p)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=r},n.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,r=this.m_invMassA,a=this.m_invMassB,_=this.m_invIA,m=this.m_invIB,h=t.step.dt,l=o-n,u=-this.m_angularMass*l,c=this.m_angularImpulse,f=h*this.m_maxTorque;this.m_angularImpulse=T(this.m_angularImpulse+u,-f,f),n-=_*(u=this.m_angularImpulse-c),o+=m*u;var d=X.SubVV(X.AddVCrossSV(s,o,this.m_rB,X.s_t0),X.AddVCrossSV(e,n,this.m_rA,X.s_t1),i.SolveVelocityConstraints_s_Cdot_v2),p=Z.MulMV(this.m_linearMass,d,i.SolveVelocityConstraints_s_impulseV).SelfNeg(),y=i.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(p);var v=h*this.m_maxForce;this.m_linearImpulse.LengthSquared()>v*v&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(v)),X.SubVV(this.m_linearImpulse,y,p),e.SelfMulSub(r,p),n-=_*X.CrossVV(this.m_rA,p),s.SelfMulAdd(a,p),o+=m*X.CrossVV(this.m_rB,p),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(){return!0},n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e},n.GetReactionTorque=function(t){return t*this.m_angularImpulse},n.GetLocalAnchorA=function(){return this.m_localAnchorA},n.GetLocalAnchorB=function(){return this.m_localAnchorB},n.SetMaxForce=function(t){this.m_maxForce=t},n.GetMaxForce=function(){return this.m_maxForce},n.SetMaxTorque=function(t){this.m_maxTorque=t},n.GetMaxTorque=function(){return this.m_maxTorque},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(Ti);ji.SolveVelocityConstraints_s_Cdot_v2=new X,ji.SolveVelocityConstraints_s_impulseV=new X,ji.SolveVelocityConstraints_s_oldImpulseV=new X;var Ji=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_gearJoint)||this).ratio=1,i}return h(i,e),i}(Fi),Ei=function(i){function n(n){var s,o,r;(s=i.call(this,n)||this).m_typeA=t.b2JointType.e_unknownJoint,s.m_typeB=t.b2JointType.e_unknownJoint,s.m_localAnchorA=new X,s.m_localAnchorB=new X,s.m_localAnchorC=new X,s.m_localAnchorD=new X,s.m_localAxisC=new X,s.m_localAxisD=new X,s.m_referenceAngleA=0,s.m_referenceAngleB=0,s.m_constant=0,s.m_ratio=0,s.m_impulse=0,s.m_indexA=0,s.m_indexB=0,s.m_indexC=0,s.m_indexD=0,s.m_lcA=new X,s.m_lcB=new X,s.m_lcC=new X,s.m_lcD=new X,s.m_mA=0,s.m_mB=0,s.m_mC=0,s.m_mD=0,s.m_iA=0,s.m_iB=0,s.m_iC=0,s.m_iD=0,s.m_JvAC=new X,s.m_JvBD=new X,s.m_JwA=0,s.m_JwB=0,s.m_JwC=0,s.m_JwD=0,s.m_mass=0,s.m_qA=new Q,s.m_qB=new Q,s.m_qC=new Q,s.m_qD=new Q,s.m_lalcA=new X,s.m_lalcB=new X,s.m_lalcC=new X,s.m_lalcD=new X,s.m_joint1=n.joint1,s.m_joint2=n.joint2,s.m_typeA=s.m_joint1.GetType(),s.m_typeB=s.m_joint2.GetType(),s.m_bodyC=s.m_joint1.GetBodyA(),s.m_bodyA=s.m_joint1.GetBodyB();var a=s.m_bodyA.m_xf,_=s.m_bodyA.m_sweep.a,m=s.m_bodyC.m_xf,h=s.m_bodyC.m_sweep.a;if(s.m_typeA===t.b2JointType.e_revoluteJoint){var l=n.joint1;s.m_localAnchorC.Copy(l.m_localAnchorA),s.m_localAnchorA.Copy(l.m_localAnchorB),s.m_referenceAngleA=l.m_referenceAngle,s.m_localAxisC.SetZero(),o=_-h-s.m_referenceAngleA}else{var u=n.joint1;s.m_localAnchorC.Copy(u.m_localAnchorA),s.m_localAnchorA.Copy(u.m_localAnchorB),s.m_referenceAngleA=u.m_referenceAngle,s.m_localAxisC.Copy(u.m_localXAxisA);var c=s.m_localAnchorC,f=Q.MulTRV(m.q,X.AddVV(Q.MulRV(a.q,s.m_localAnchorA,X.s_t0),X.SubVV(a.p,m.p,X.s_t1),X.s_t0),X.s_t0);o=X.DotVV(X.SubVV(f,c,X.s_t0),s.m_localAxisC)}s.m_bodyD=s.m_joint2.GetBodyA(),s.m_bodyB=s.m_joint2.GetBodyB();var d=s.m_bodyB.m_xf,p=s.m_bodyB.m_sweep.a,y=s.m_bodyD.m_xf,v=s.m_bodyD.m_sweep.a;if(s.m_typeB===t.b2JointType.e_revoluteJoint){var x=n.joint2;s.m_localAnchorD.Copy(x.m_localAnchorA),s.m_localAnchorB.Copy(x.m_localAnchorB),s.m_referenceAngleB=x.m_referenceAngle,s.m_localAxisD.SetZero(),r=p-v-s.m_referenceAngleB}else{var S=n.joint2;s.m_localAnchorD.Copy(S.m_localAnchorA),s.m_localAnchorB.Copy(S.m_localAnchorB),s.m_referenceAngleB=S.m_referenceAngle,s.m_localAxisD.Copy(S.m_localXAxisA);var B=s.m_localAnchorD,b=Q.MulTRV(y.q,X.AddVV(Q.MulRV(d.q,s.m_localAnchorB,X.s_t0),X.SubVV(d.p,y.p,X.s_t1),X.s_t0),X.s_t0);r=X.DotVV(X.SubVV(b,B,X.s_t0),s.m_localAxisD)}return s.m_ratio=e(n.ratio,1),s.m_constant=o+s.m_ratio*r,s.m_impulse=0,s}h(n,i);var s=n.prototype;return s.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var i=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,r=e.positions[this.m_indexB].a,a=e.velocities[this.m_indexB].v,_=e.velocities[this.m_indexB].w,m=e.positions[this.m_indexC].a,h=e.velocities[this.m_indexC].v,l=e.velocities[this.m_indexC].w,u=e.positions[this.m_indexD].a,c=e.velocities[this.m_indexD].v,f=e.velocities[this.m_indexD].w,d=this.m_qA.SetAngle(i),p=this.m_qB.SetAngle(r),y=this.m_qC.SetAngle(m),v=this.m_qD.SetAngle(u);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var x=Q.MulRV(y,this.m_localAxisC,n.InitVelocityConstraints_s_u);X.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var S=Q.MulRV(y,this.m_lalcC,n.InitVelocityConstraints_s_rC);X.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var B=Q.MulRV(d,this.m_lalcA,n.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(x),this.m_JwC=X.CrossVV(S,x),this.m_JwA=X.CrossVV(B,x),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var b=Q.MulRV(v,this.m_localAxisD,n.InitVelocityConstraints_s_u);X.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var A=Q.MulRV(v,this.m_lalcD,n.InitVelocityConstraints_s_rD);X.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var g=Q.MulRV(p,this.m_lalcB,n.InitVelocityConstraints_s_rB);X.MulSV(this.m_ratio,b,this.m_JvBD),this.m_JwD=this.m_ratio*X.CrossVV(A,b),this.m_JwB=this.m_ratio*X.CrossVV(g,b),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(s.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,a.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),_+=this.m_iB*this.m_impulse*this.m_JwB,h.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),l-=this.m_iC*this.m_impulse*this.m_JwC,c.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),f-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=_,e.velocities[this.m_indexC].w=l,e.velocities[this.m_indexD].w=f},s.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,n=t.velocities[this.m_indexB].v,s=t.velocities[this.m_indexB].w,o=t.velocities[this.m_indexC].v,r=t.velocities[this.m_indexC].w,a=t.velocities[this.m_indexD].v,_=t.velocities[this.m_indexD].w,m=X.DotVV(this.m_JvAC,X.SubVV(e,o,X.s_t0))+X.DotVV(this.m_JvBD,X.SubVV(n,a,X.s_t0));m+=this.m_JwA*i-this.m_JwC*r+(this.m_JwB*s-this.m_JwD*_);var h=-this.m_mass*m;this.m_impulse+=h,e.SelfMulAdd(this.m_mA*h,this.m_JvAC),i+=this.m_iA*h*this.m_JwA,n.SelfMulAdd(this.m_mB*h,this.m_JvBD),s+=this.m_iB*h*this.m_JwB,o.SelfMulSub(this.m_mC*h,this.m_JvAC),r-=this.m_iC*h*this.m_JwC,a.SelfMulSub(this.m_mD*h,this.m_JvBD),_-=this.m_iD*h*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s,t.velocities[this.m_indexC].w=r,t.velocities[this.m_indexD].w=_},s.SolvePositionConstraints=function(e){var i,s,o,r,a,_,m=e.positions[this.m_indexA].c,h=e.positions[this.m_indexA].a,l=e.positions[this.m_indexB].c,u=e.positions[this.m_indexB].a,c=e.positions[this.m_indexC].c,f=e.positions[this.m_indexC].a,d=e.positions[this.m_indexD].c,p=e.positions[this.m_indexD].a,y=this.m_qA.SetAngle(h),v=this.m_qB.SetAngle(u),x=this.m_qC.SetAngle(f),S=this.m_qD.SetAngle(p),B=this.m_JvAC,b=this.m_JvBD,A=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)B.SetZero(),o=1,a=1,A+=this.m_iA+this.m_iC,i=h-f-this.m_referenceAngleA;else{var g=Q.MulRV(x,this.m_localAxisC,n.SolvePositionConstraints_s_u),C=Q.MulRV(x,this.m_lalcC,n.SolvePositionConstraints_s_rC),V=Q.MulRV(y,this.m_lalcA,n.SolvePositionConstraints_s_rA);B.Copy(g),a=X.CrossVV(C,g),o=X.CrossVV(V,g),A+=this.m_mC+this.m_mA+this.m_iC*a*a+this.m_iA*o*o;var w=this.m_lalcC,M=Q.MulTRV(x,X.AddVV(V,X.SubVV(m,c,X.s_t0),X.s_t0),X.s_t0);i=X.DotVV(X.SubVV(M,w,X.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)b.SetZero(),r=this.m_ratio,_=this.m_ratio,A+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),s=u-p-this.m_referenceAngleB;else{var P=Q.MulRV(S,this.m_localAxisD,n.SolvePositionConstraints_s_u),I=Q.MulRV(S,this.m_lalcD,n.SolvePositionConstraints_s_rD),G=Q.MulRV(v,this.m_lalcB,n.SolvePositionConstraints_s_rB);X.MulSV(this.m_ratio,P,b),_=this.m_ratio*X.CrossVV(I,P),r=this.m_ratio*X.CrossVV(G,P),A+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*_*_+this.m_iB*r*r;var D=this.m_lalcD,F=Q.MulTRV(S,X.AddVV(G,X.SubVV(l,d,X.s_t0),X.s_t0),X.s_t0);s=X.DotVV(X.SubVV(F,D,X.s_t0),this.m_localAxisD)}var T=i+this.m_ratio*s-this.m_constant,L=0;return A>0&&(L=-T/A),m.SelfMulAdd(this.m_mA*L,B),h+=this.m_iA*L*o,l.SelfMulAdd(this.m_mB*L,b),u+=this.m_iB*L*r,c.SelfMulSub(this.m_mC*L,B),f-=this.m_iC*L*a,d.SelfMulSub(this.m_mD*L,b),p-=this.m_iD*L*_,e.positions[this.m_indexA].a=h,e.positions[this.m_indexB].a=u,e.positions[this.m_indexC].a=f,e.positions[this.m_indexD].a=p,!0},s.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},s.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},s.GetReactionForce=function(t,e){return X.MulSV(t*this.m_impulse,this.m_JvAC,e)},s.GetReactionTorque=function(t){return t*this.m_impulse*this.m_JwA},s.GetJoint1=function(){return this.m_joint1},s.GetJoint2=function(){return this.m_joint2},s.GetRatio=function(){return this.m_ratio},s.SetRatio=function(t){this.m_ratio=t},s.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,n=this.m_joint1.m_index,s=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",n),t("  jd.joint2 = joints[%d];\n",s),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n}(Ti);Ei.InitVelocityConstraints_s_u=new X,Ei.InitVelocityConstraints_s_rA=new X,Ei.InitVelocityConstraints_s_rB=new X,Ei.InitVelocityConstraints_s_rC=new X,Ei.InitVelocityConstraints_s_rD=new X,Ei.SolvePositionConstraints_s_u=new X,Ei.SolvePositionConstraints_s_rA=new X,Ei.SolvePositionConstraints_s_rB=new X,Ei.SolvePositionConstraints_s_rC=new X,Ei.SolvePositionConstraints_s_rD=new X;var Ni=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_motorJoint)||this).linearOffset=new X(0,0),i.angularOffset=0,i.maxForce=1,i.maxTorque=1,i.correctionFactor=.3,i}return h(i,e),i.prototype.Initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var i=this.bodyA.GetAngle(),n=this.bodyB.GetAngle();this.angularOffset=n-i},i}(Fi),Oi=function(t){function i(i){var n;return(n=t.call(this,i)||this).m_linearOffset=new X,n.m_angularOffset=0,n.m_linearImpulse=new X,n.m_angularImpulse=0,n.m_maxForce=0,n.m_maxTorque=0,n.m_correctionFactor=.3,n.m_indexA=0,n.m_indexB=0,n.m_rA=new X,n.m_rB=new X,n.m_localCenterA=new X,n.m_localCenterB=new X,n.m_linearError=new X,n.m_angularError=0,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_linearMass=new Z,n.m_angularMass=0,n.m_qA=new Q,n.m_qB=new Q,n.m_K=new Z,n.m_linearOffset.Copy(e(i.linearOffset,X.ZERO)),n.m_linearImpulse.SetZero(),n.m_maxForce=e(i.maxForce,0),n.m_maxTorque=e(i.maxTorque,0),n.m_correctionFactor=e(i.correctionFactor,.3),n}h(i,t);var n=i.prototype;return n.GetAnchorA=function(t){var e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t},n.GetAnchorB=function(t){var e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t},n.GetReactionForce=function(t,e){return X.MulSV(t,this.m_linearImpulse,e)},n.GetReactionTorque=function(t){return t*this.m_angularImpulse},n.SetLinearOffset=function(t){X.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))},n.GetLinearOffset=function(){return this.m_linearOffset},n.SetAngularOffset=function(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)},n.GetAngularOffset=function(){return this.m_angularOffset},n.SetMaxForce=function(t){this.m_maxForce=t},n.GetMaxForce=function(){return this.m_maxForce},n.SetMaxTorque=function(t){this.m_maxTorque=t},n.GetMaxTorque=function(){return this.m_maxTorque},n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].c,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,_=t.velocities[this.m_indexB].w,m=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(r),l=Q.MulRV(m,X.SubVV(this.m_linearOffset,this.m_localCenterA,X.s_t0),this.m_rA),u=Q.MulRV(h,X.NegV(this.m_localCenterB,X.s_t0),this.m_rB),c=this.m_invMassA,f=this.m_invMassB,d=this.m_invIA,p=this.m_invIB,y=this.m_K;if(y.ex.x=c+f+d*l.y*l.y+p*u.y*u.y,y.ex.y=-d*l.x*l.y-p*u.x*u.y,y.ey.x=y.ex.y,y.ey.y=c+f+d*l.x*l.x+p*u.x*u.x,y.GetInverse(this.m_linearMass),this.m_angularMass=d+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),X.SubVV(X.AddVV(o,u,X.s_t0),X.AddVV(e,l,X.s_t1),this.m_linearError),this.m_angularError=r-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var v=this.m_linearImpulse;n.SelfMulSub(c,v),s-=d*(X.CrossVV(l,v)+this.m_angularImpulse),a.SelfMulAdd(f,v),_+=p*(X.CrossVV(u,v)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=_},n.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,r=this.m_invMassA,a=this.m_invMassB,_=this.m_invIA,m=this.m_invIB,h=t.step.dt,l=t.step.inv_dt,u=o-n+l*this.m_correctionFactor*this.m_angularError,c=-this.m_angularMass*u,f=this.m_angularImpulse,d=h*this.m_maxTorque;this.m_angularImpulse=T(this.m_angularImpulse+c,-d,d),n-=_*(c=this.m_angularImpulse-f),o+=m*c;var p=this.m_rA,y=this.m_rB,v=X.AddVV(X.SubVV(X.AddVV(s,X.CrossSV(o,y,X.s_t0),X.s_t0),X.AddVV(e,X.CrossSV(n,p,X.s_t1),X.s_t1),X.s_t2),X.MulSV(l*this.m_correctionFactor,this.m_linearError,X.s_t3),i.SolveVelocityConstraints_s_Cdot_v2),x=Z.MulMV(this.m_linearMass,v,i.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),S=i.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(x);var B=h*this.m_maxForce;this.m_linearImpulse.LengthSquared()>B*B&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(B)),X.SubVV(this.m_linearImpulse,S,x),e.SelfMulSub(r,x),n-=_*X.CrossVV(p,x),s.SelfMulAdd(a,x),o+=m*X.CrossVV(y,x),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(){return!0},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(Ti);Oi.SolveVelocityConstraints_s_Cdot_v2=new X,Oi.SolveVelocityConstraints_s_impulse_v2=new X,Oi.SolveVelocityConstraints_s_oldImpulse_v2=new X;var Xi=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_mouseJoint)||this).target=new X,i.maxForce=0,i.frequencyHz=5,i.dampingRatio=.7,i}return h(i,e),i}(Fi),Ui=function(t){function i(i){var n;return(n=t.call(this,i)||this).m_localAnchorB=new X,n.m_targetA=new X,n.m_frequencyHz=0,n.m_dampingRatio=0,n.m_beta=0,n.m_impulse=new X,n.m_maxForce=0,n.m_gamma=0,n.m_indexA=0,n.m_indexB=0,n.m_rB=new X,n.m_localCenterB=new X,n.m_invMassB=0,n.m_invIB=0,n.m_mass=new Z,n.m_C=new X,n.m_qB=new Q,n.m_lalcB=new X,n.m_K=new Z,n.m_targetA.Copy(e(i.target,X.ZERO)),Y.MulTXV(n.m_bodyB.GetTransform(),n.m_targetA,n.m_localAnchorB),n.m_maxForce=e(i.maxForce,0),n.m_impulse.SetZero(),n.m_frequencyHz=e(i.frequencyHz,0),n.m_dampingRatio=e(i.dampingRatio,0),n.m_beta=0,n.m_gamma=0,n}h(i,t);var n=i.prototype;return n.SetTarget=function(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)},n.GetTarget=function(){return this.m_targetA},n.SetMaxForce=function(t){this.m_maxForce=t},n.GetMaxForce=function(){return this.m_maxForce},n.SetFrequency=function(t){this.m_frequencyHz=t},n.GetFrequency=function(){return this.m_frequencyHz},n.SetDampingRatio=function(t){this.m_dampingRatio=t},n.GetDampingRatio=function(){return this.m_dampingRatio},n.InitVelocityConstraints=function(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v,s=t.velocities[this.m_indexB].w,r=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),_=2*o*this.m_frequencyHz,m=2*a*this.m_dampingRatio*_,h=a*_*_,l=t.step.dt;this.m_gamma=l*(m+l*h),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=l*h*this.m_gamma,X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Q.MulRV(r,this.m_lalcB,this.m_rB);var u=this.m_K;u.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,u.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,u.ey.x=u.ex.y,u.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,u.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),s*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),n.x+=this.m_invMassB*this.m_impulse.x,n.y+=this.m_invMassB*this.m_impulse.y,s+=this.m_invIB*X.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=s},n.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexB].v,n=t.velocities[this.m_indexB].w,s=X.AddVCrossSV(e,n,this.m_rB,i.SolveVelocityConstraints_s_Cdot),o=Z.MulMV(this.m_mass,X.AddVV(s,X.AddVV(this.m_C,X.MulSV(this.m_gamma,this.m_impulse,X.s_t0),X.s_t0),X.s_t0).SelfNeg(),i.SolveVelocityConstraints_s_impulse),r=i.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);var a=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>a*a&&this.m_impulse.SelfMul(a/this.m_impulse.Length()),X.SubVV(this.m_impulse,r,o),e.SelfMulAdd(this.m_invMassB,o),n+=this.m_invIB*X.CrossVV(this.m_rB,o),t.velocities[this.m_indexB].w=n},n.SolvePositionConstraints=function(){return!0},n.GetAnchorA=function(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return X.MulSV(t,this.m_impulse,e)},n.GetReactionTorque=function(){return 0},n.Dump=function(t){t("Mouse joint dumping is not supported.\n")},n.ShiftOrigin=function(t){this.m_targetA.SelfSub(t)},i}(Ti);Ui.SolveVelocityConstraints_s_Cdot=new X,Ui.SolveVelocityConstraints_s_impulse=new X,Ui.SolveVelocityConstraints_s_oldImpulse=new X;var Wi=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_prismaticJoint)||this).localAnchorA=new X,i.localAnchorB=new X,i.localAxisA=new X(1,0),i.referenceAngle=0,i.enableLimit=!1,i.lowerTranslation=0,i.upperTranslation=0,i.enableMotor=!1,i.maxMotorForce=0,i.motorSpeed=0,i}return h(i,e),i.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Fi),Zi=function(i){function n(n){var s;return(s=i.call(this,n)||this).m_localAnchorA=new X,s.m_localAnchorB=new X,s.m_localXAxisA=new X,s.m_localYAxisA=new X,s.m_referenceAngle=0,s.m_impulse=new W(0,0,0),s.m_motorImpulse=0,s.m_lowerTranslation=0,s.m_upperTranslation=0,s.m_maxMotorForce=0,s.m_motorSpeed=0,s.m_enableLimit=!1,s.m_enableMotor=!1,s.m_limitState=t.b2LimitState.e_inactiveLimit,s.m_indexA=0,s.m_indexB=0,s.m_localCenterA=new X,s.m_localCenterB=new X,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_axis=new X(0,0),s.m_perp=new X(0,0),s.m_s1=0,s.m_s2=0,s.m_a1=0,s.m_a2=0,s.m_K=new H,s.m_K3=new H,s.m_K2=new Z,s.m_motorMass=0,s.m_qA=new Q,s.m_qB=new Q,s.m_lalcA=new X,s.m_lalcB=new X,s.m_rA=new X,s.m_rB=new X,s.m_localAnchorA.Copy(e(n.localAnchorA,X.ZERO)),s.m_localAnchorB.Copy(e(n.localAnchorB,X.ZERO)),s.m_localXAxisA.Copy(e(n.localAxisA,new X(1,0))).SelfNormalize(),X.CrossOneV(s.m_localXAxisA,s.m_localYAxisA),s.m_referenceAngle=e(n.referenceAngle,0),s.m_lowerTranslation=e(n.lowerTranslation,0),s.m_upperTranslation=e(n.upperTranslation,0),s.m_maxMotorForce=e(n.maxMotorForce,0),s.m_motorSpeed=e(n.motorSpeed,0),s.m_enableLimit=e(n.enableLimit,!1),s.m_enableMotor=e(n.enableMotor,!1),s}h(n,i);var s=n.prototype;return s.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].c,s=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].c,_=e.positions[this.m_indexB].a,m=e.velocities[this.m_indexB].v,h=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(s),u=this.m_qB.SetAngle(_);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=Q.MulRV(l,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var f=Q.MulRV(u,this.m_lalcB,this.m_rB),d=X.AddVV(X.SubVV(a,i,X.s_t0),X.SubVV(f,c,X.s_t1),n.InitVelocityConstraints_s_d),p=this.m_invMassA,y=this.m_invMassB,v=this.m_invIA,x=this.m_invIB;if(Q.MulRV(l,this.m_localXAxisA,this.m_axis),this.m_a1=X.CrossVV(X.AddVV(d,c,X.s_t0),this.m_axis),this.m_a2=X.CrossVV(f,this.m_axis),this.m_motorMass=p+y+v*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),Q.MulRV(l,this.m_localYAxisA,this.m_perp),this.m_s1=X.CrossVV(X.AddVV(d,c,X.s_t0),this.m_perp),this.m_s2=X.CrossVV(f,this.m_perp),this.m_K.ex.x=p+y+v*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=v*this.m_s1+x*this.m_s2,this.m_K.ex.z=v*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=v+x,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=v*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=p+y+v*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){var S=X.DotVV(this.m_axis,d);G(this.m_upperTranslation-this.m_lowerTranslation)<.016?this.m_limitState=t.b2LimitState.e_equalLimits:S<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):S>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var B=X.AddVV(X.MulSV(this.m_impulse.x,this.m_perp,X.s_t0),X.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,X.s_t1),n.InitVelocityConstraints_s_P),b=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,A=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.SelfMulSub(p,B),r-=v*b,m.SelfMulAdd(y,B),h+=x*A}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=h},s.SolveVelocityConstraints=function(e){var i=e.velocities[this.m_indexA].v,s=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,r=e.velocities[this.m_indexB].w,a=this.m_invMassA,_=this.m_invMassB,m=this.m_invIA,h=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){var l=X.DotVV(this.m_axis,X.SubVV(o,i,X.s_t0))+this.m_a2*r-this.m_a1*s,u=this.m_motorMass*(this.m_motorSpeed-l),c=this.m_motorImpulse,f=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=T(this.m_motorImpulse+u,-f,f),u=this.m_motorImpulse-c;var d=X.MulSV(u,this.m_axis,n.SolveVelocityConstraints_s_P),p=u*this.m_a1,y=u*this.m_a2;i.SelfMulSub(a,d),s-=m*p,o.SelfMulAdd(_,d),r+=h*y}var v=X.DotVV(this.m_perp,X.SubVV(o,i,X.s_t0))+this.m_s2*r-this.m_s1*s,x=r-s;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){var S=X.DotVV(this.m_axis,X.SubVV(o,i,X.s_t0))+this.m_a2*r-this.m_a1*s,B=n.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),b=this.m_K.Solve33(-v,-x,-S,n.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(b),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=F(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=D(this.m_impulse.z,0));var A=-v-(this.m_impulse.z-B.z)*this.m_K.ez.x,g=-x-(this.m_impulse.z-B.z)*this.m_K.ez.y,C=this.m_K.Solve22(A,g,n.SolveVelocityConstraints_s_f2r);C.x+=B.x,C.y+=B.y,this.m_impulse.x=C.x,this.m_impulse.y=C.y,b.x=this.m_impulse.x-B.x,b.y=this.m_impulse.y-B.y,b.z=this.m_impulse.z-B.z;var V=X.AddVV(X.MulSV(b.x,this.m_perp,X.s_t0),X.MulSV(b.z,this.m_axis,X.s_t1),n.SolveVelocityConstraints_s_P),w=b.x*this.m_s1+b.y+b.z*this.m_a1,M=b.x*this.m_s2+b.y+b.z*this.m_a2;i.SelfMulSub(a,V),s-=m*w,o.SelfMulAdd(_,V),r+=h*M}else{var P=this.m_K.Solve22(-v,-x,n.SolveVelocityConstraints_s_df2);this.m_impulse.x+=P.x,this.m_impulse.y+=P.y;var I=X.MulSV(P.x,this.m_perp,n.SolveVelocityConstraints_s_P),G=P.x*this.m_s1+P.y,L=P.x*this.m_s2+P.y;i.SelfMulSub(a,I),s-=m*G,o.SelfMulAdd(_,I),r+=h*L}e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=r},s.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,r=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(o),h=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,c=this.m_invIB,d=Q.MulRV(r,this.m_lalcA,this.m_rA),p=Q.MulRV(m,this.m_lalcB,this.m_rB),y=X.SubVV(X.AddVV(s,p,X.s_t0),X.AddVV(e,d,X.s_t1),n.SolvePositionConstraints_s_d),v=Q.MulRV(r,this.m_localXAxisA,this.m_axis),x=X.CrossVV(X.AddVV(y,d,X.s_t0),v),S=X.CrossVV(p,v),B=Q.MulRV(r,this.m_localYAxisA,this.m_perp),b=X.CrossVV(X.AddVV(y,d,X.s_t0),B),A=X.CrossVV(p,B),g=n.SolvePositionConstraints_s_impulse,C=X.DotVV(B,y),V=o-i-this.m_referenceAngle,w=G(C),M=G(V),P=!1,I=0;if(this.m_enableLimit){var D=X.DotVV(v,y);G(this.m_upperTranslation-this.m_lowerTranslation)<.016?(I=T(D,-.2,f),w=F(w,G(D)),P=!0):D<=this.m_lowerTranslation?(I=T(D-this.m_lowerTranslation+a,-.2,0),w=F(w,this.m_lowerTranslation-D),P=!0):D>=this.m_upperTranslation&&(I=T(D-this.m_upperTranslation-a,0,f),w=F(w,D-this.m_upperTranslation),P=!0)}if(P){var L=h+l+u*b*b+c*A*A,R=u*b+c*A,k=u*b*x+c*A*S,q=u+c;0===q&&(q=1);var z=u*x+c*S,j=h+l+u*x*x+c*S*S,J=this.m_K3;J.ex.SetXYZ(L,R,k),J.ey.SetXYZ(R,q,z),J.ez.SetXYZ(k,z,j),g=J.Solve33(-C,-V,-I,g)}else{var E=h+l+u*b*b+c*A*A,N=u*b+c*A,O=u+c;0===O&&(O=1);var U=this.m_K2;U.ex.Set(E,N),U.ey.Set(N,O);var W=U.Solve(-C,-V,n.SolvePositionConstraints_s_impulse1);g.x=W.x,g.y=W.y,g.z=0}var Z=X.AddVV(X.MulSV(g.x,B,X.s_t0),X.MulSV(g.z,v,X.s_t1),n.SolvePositionConstraints_s_P),H=g.x*b+g.y+g.z*x,Y=g.x*A+g.y+g.z*S;return e.SelfMulSub(h,Z),i-=u*H,s.SelfMulAdd(l,Z),o+=c*Y,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,w<=a&&M<=_},s.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},s.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},s.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e},s.GetReactionTorque=function(t){return t*this.m_impulse.y},s.GetLocalAnchorA=function(){return this.m_localAnchorA},s.GetLocalAnchorB=function(){return this.m_localAnchorB},s.GetLocalAxisA=function(){return this.m_localXAxisA},s.GetReferenceAngle=function(){return this.m_referenceAngle},s.GetJointTranslation=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,n.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,n.GetJointTranslation_s_pB),i=X.SubVV(e,t,n.GetJointTranslation_s_d),s=this.m_bodyA.GetWorldVector(this.m_localXAxisA,n.GetJointTranslation_s_axis);return X.DotVV(i,s)},s.GetJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;X.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var i=Q.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var n=Q.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=X.AddVV(t.m_sweep.c,i,X.s_t0),o=X.AddVV(e.m_sweep.c,n,X.s_t1),r=X.SubVV(o,s,X.s_t2),a=t.GetWorldVector(this.m_localXAxisA,this.m_axis),_=t.m_linearVelocity,m=e.m_linearVelocity,h=t.m_angularVelocity,l=e.m_angularVelocity;return X.DotVV(r,X.CrossSV(h,a,X.s_t0))+X.DotVV(a,X.SubVV(X.AddVCrossSV(m,l,n,X.s_t0),X.AddVCrossSV(_,h,i,X.s_t1),X.s_t0))},s.IsLimitEnabled=function(){return this.m_enableLimit},s.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},s.GetLowerLimit=function(){return this.m_lowerTranslation},s.GetUpperLimit=function(){return this.m_upperTranslation},s.SetLimits=function(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)},s.IsMotorEnabled=function(){return this.m_enableMotor},s.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},s.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},s.GetMotorSpeed=function(){return this.m_motorSpeed},s.SetMaxMotorForce=function(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)},s.GetMaxMotorForce=function(){return this.m_maxMotorForce},s.GetMotorForce=function(t){return t*this.m_motorImpulse},s.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n}(Ti);Zi.InitVelocityConstraints_s_d=new X,Zi.InitVelocityConstraints_s_P=new X,Zi.SolveVelocityConstraints_s_P=new X,Zi.SolveVelocityConstraints_s_f2r=new X,Zi.SolveVelocityConstraints_s_f1=new W,Zi.SolveVelocityConstraints_s_df3=new W,Zi.SolveVelocityConstraints_s_df2=new X,Zi.SolvePositionConstraints_s_d=new X,Zi.SolvePositionConstraints_s_impulse=new W,Zi.SolvePositionConstraints_s_impulse1=new X,Zi.SolvePositionConstraints_s_P=new X,Zi.GetJointTranslation_s_pA=new X,Zi.GetJointTranslation_s_pB=new X,Zi.GetJointTranslation_s_d=new X,Zi.GetJointTranslation_s_axis=new X;var Hi=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_pulleyJoint)||this).groundAnchorA=new X(-1,1),i.groundAnchorB=new X(1,1),i.localAnchorA=new X(-1,0),i.localAnchorB=new X(1,0),i.lengthA=0,i.lengthB=0,i.ratio=1,i.collideConnected=!0,i}return h(i,e),i.prototype.Initialize=function(t,e,i,n,s,o,r){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(n),this.bodyA.GetLocalPoint(s,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.lengthA=X.DistanceVV(s,i),this.lengthB=X.DistanceVV(o,n),this.ratio=r},i}(Fi),Qi=function(t){function i(i){var n;return(n=t.call(this,i)||this).m_groundAnchorA=new X,n.m_groundAnchorB=new X,n.m_lengthA=0,n.m_lengthB=0,n.m_localAnchorA=new X,n.m_localAnchorB=new X,n.m_constant=0,n.m_ratio=0,n.m_impulse=0,n.m_indexA=0,n.m_indexB=0,n.m_uA=new X,n.m_uB=new X,n.m_rA=new X,n.m_rB=new X,n.m_localCenterA=new X,n.m_localCenterB=new X,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_mass=0,n.m_qA=new Q,n.m_qB=new Q,n.m_lalcA=new X,n.m_lalcB=new X,n.m_groundAnchorA.Copy(e(i.groundAnchorA,new X(-1,1))),n.m_groundAnchorB.Copy(e(i.groundAnchorB,new X(1,0))),n.m_localAnchorA.Copy(e(i.localAnchorA,new X(-1,0))),n.m_localAnchorB.Copy(e(i.localAnchorB,new X(1,0))),n.m_lengthA=e(i.lengthA,0),n.m_lengthB=e(i.lengthB,0),n.m_ratio=e(i.ratio,1),n.m_constant=e(i.lengthA,0)+n.m_ratio*e(i.lengthB,0),n.m_impulse=0,n}h(i,t);var n=i.prototype;return n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,_=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,h=this.m_qA.SetAngle(n),l=this.m_qB.SetAngle(a);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Q.MulRV(h,this.m_lalcA,this.m_rA),X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Q.MulRV(l,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(r).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var u=this.m_uA.Length(),c=this.m_uB.Length();u>.08?this.m_uA.SelfMul(1/u):this.m_uA.SetZero(),c>.08?this.m_uB.SelfMul(1/c):this.m_uB.SetZero();var f=X.CrossVV(this.m_rA,this.m_uA),d=X.CrossVV(this.m_rB,this.m_uB),p=this.m_invMassA+this.m_invIA*f*f,y=this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=p+this.m_ratio*this.m_ratio*y,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var v=X.MulSV(-this.m_impulse,this.m_uA,i.InitVelocityConstraints_s_PA),x=X.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,i.InitVelocityConstraints_s_PB);s.SelfMulAdd(this.m_invMassA,v),o+=this.m_invIA*X.CrossVV(this.m_rA,v),_.SelfMulAdd(this.m_invMassB,x),m+=this.m_invIB*X.CrossVV(this.m_rB,x)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=m},n.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,r=X.AddVCrossSV(e,n,this.m_rA,i.SolveVelocityConstraints_s_vpA),a=X.AddVCrossSV(s,o,this.m_rB,i.SolveVelocityConstraints_s_vpB),_=-X.DotVV(this.m_uA,r)-this.m_ratio*X.DotVV(this.m_uB,a),m=-this.m_mass*_;this.m_impulse+=m;var h=X.MulSV(-m,this.m_uA,i.SolveVelocityConstraints_s_PA),l=X.MulSV(-this.m_ratio*m,this.m_uB,i.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,h),n+=this.m_invIA*X.CrossVV(this.m_rA,h),s.SelfMulAdd(this.m_invMassB,l),o+=this.m_invIB*X.CrossVV(this.m_rB,l),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,r=this.m_qA.SetAngle(n),_=this.m_qB.SetAngle(o);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var m=Q.MulRV(r,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h=Q.MulRV(_,this.m_lalcB,this.m_rB),l=this.m_uA.Copy(e).SelfAdd(m).SelfSub(this.m_groundAnchorA),u=this.m_uB.Copy(s).SelfAdd(h).SelfSub(this.m_groundAnchorB),c=l.Length(),f=u.Length();c>.08?l.SelfMul(1/c):l.SetZero(),f>.08?u.SelfMul(1/f):u.SetZero();var d=X.CrossVV(m,l),p=X.CrossVV(h,u),y=this.m_invMassA+this.m_invIA*d*d,v=this.m_invMassB+this.m_invIB*p*p,x=y+this.m_ratio*this.m_ratio*v;x>0&&(x=1/x);var S=this.m_constant-c-this.m_ratio*f,B=G(S),b=-x*S,A=X.MulSV(-b,l,i.SolvePositionConstraints_s_PA),g=X.MulSV(-this.m_ratio*b,u,i.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,A),n+=this.m_invIA*X.CrossVV(m,A),s.SelfMulAdd(this.m_invMassB,g),o+=this.m_invIB*X.CrossVV(h,g),t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,B<a},n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e},n.GetReactionTorque=function(){return 0},n.GetGroundAnchorA=function(){return this.m_groundAnchorA},n.GetGroundAnchorB=function(){return this.m_groundAnchorB},n.GetLengthA=function(){return this.m_lengthA},n.GetLengthB=function(){return this.m_lengthB},n.GetRatio=function(){return this.m_ratio},n.GetCurrentLengthA=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,i.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return X.DistanceVV(t,e)},n.GetCurrentLengthB=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,i.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return X.DistanceVV(t,e)},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n.ShiftOrigin=function(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)},i}(Ti);Qi.InitVelocityConstraints_s_PA=new X,Qi.InitVelocityConstraints_s_PB=new X,Qi.SolveVelocityConstraints_s_vpA=new X,Qi.SolveVelocityConstraints_s_vpB=new X,Qi.SolveVelocityConstraints_s_PA=new X,Qi.SolveVelocityConstraints_s_PB=new X,Qi.SolvePositionConstraints_s_PA=new X,Qi.SolvePositionConstraints_s_PB=new X,Qi.GetCurrentLengthA_s_p=new X,Qi.GetCurrentLengthB_s_p=new X;var Yi=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_revoluteJoint)||this).localAnchorA=new X(0,0),i.localAnchorB=new X(0,0),i.referenceAngle=0,i.enableLimit=!1,i.lowerAngle=0,i.upperAngle=0,i.enableMotor=!1,i.motorSpeed=0,i.maxMotorTorque=0,i}return h(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Fi),Ki=function(i){function n(n){var s;return(s=i.call(this,n)||this).m_localAnchorA=new X,s.m_localAnchorB=new X,s.m_impulse=new W,s.m_motorImpulse=0,s.m_enableMotor=!1,s.m_maxMotorTorque=0,s.m_motorSpeed=0,s.m_enableLimit=!1,s.m_referenceAngle=0,s.m_lowerAngle=0,s.m_upperAngle=0,s.m_indexA=0,s.m_indexB=0,s.m_rA=new X,s.m_rB=new X,s.m_localCenterA=new X,s.m_localCenterB=new X,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=new H,s.m_motorMass=0,s.m_limitState=t.b2LimitState.e_inactiveLimit,s.m_qA=new Q,s.m_qB=new Q,s.m_lalcA=new X,s.m_lalcB=new X,s.m_K=new Z,s.m_localAnchorA.Copy(e(n.localAnchorA,X.ZERO)),s.m_localAnchorB.Copy(e(n.localAnchorB,X.ZERO)),s.m_referenceAngle=e(n.referenceAngle,0),s.m_impulse.SetZero(),s.m_motorImpulse=0,s.m_lowerAngle=e(n.lowerAngle,0),s.m_upperAngle=e(n.upperAngle,0),s.m_maxMotorTorque=e(n.maxMotorTorque,0),s.m_motorSpeed=e(n.motorSpeed,0),s.m_enableLimit=e(n.enableLimit,!1),s.m_enableMotor=e(n.enableMotor,!1),s.m_limitState=t.b2LimitState.e_inactiveLimit,s}h(n,i);var s=n.prototype;return s.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,r=e.positions[this.m_indexB].a,a=e.velocities[this.m_indexB].v,m=e.velocities[this.m_indexB].w,h=this.m_qA.SetAngle(i),l=this.m_qB.SetAngle(r);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Q.MulRV(h,this.m_lalcA,this.m_rA),X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Q.MulRV(l,this.m_lalcB,this.m_rB);var u=this.m_invMassA,c=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,p=f+d===0;if(this.m_mass.ex.x=u+c+this.m_rA.y*this.m_rA.y*f+this.m_rB.y*this.m_rB.y*d,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*f-this.m_rB.y*this.m_rB.x*d,this.m_mass.ez.x=-this.m_rA.y*f-this.m_rB.y*d,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=u+c+this.m_rA.x*this.m_rA.x*f+this.m_rB.x*this.m_rB.x*d,this.m_mass.ez.y=this.m_rA.x*f+this.m_rB.x*d,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=f+d,this.m_motorMass=f+d,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!p||(this.m_motorImpulse=0),this.m_enableLimit&&!p){var y=r-i-this.m_referenceAngle;G(this.m_upperAngle-this.m_lowerAngle)<2*_?this.m_limitState=t.b2LimitState.e_equalLimits:y<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):y>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var v=n.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);s.SelfMulSub(u,v),o-=f*(X.CrossVV(this.m_rA,v)+this.m_motorImpulse+this.m_impulse.z),a.SelfMulAdd(c,v),m+=d*(X.CrossVV(this.m_rB,v)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=m},s.SolveVelocityConstraints=function(e){var i=e.velocities[this.m_indexA].v,s=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,r=e.velocities[this.m_indexB].w,a=this.m_invMassA,_=this.m_invMassB,m=this.m_invIA,h=this.m_invIB,l=m+h===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!l){var u=r-s-this.m_motorSpeed,c=-this.m_motorMass*u,f=this.m_motorImpulse,d=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=T(this.m_motorImpulse+c,-d,d),s-=m*(c=this.m_motorImpulse-f),r+=h*c}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!l){var p=X.SubVV(X.AddVCrossSV(o,r,this.m_rB,X.s_t0),X.AddVCrossSV(i,s,this.m_rA,X.s_t1),n.SolveVelocityConstraints_s_Cdot1),y=r-s,v=this.m_mass.Solve33(p.x,p.y,y,n.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(v);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+v.z<0){var x=-p.x+this.m_impulse.z*this.m_mass.ez.x,S=-p.y+this.m_impulse.z*this.m_mass.ez.y,B=this.m_mass.Solve22(x,S,n.SolveVelocityConstraints_s_reduced_v2);v.x=B.x,v.y=B.y,v.z=-this.m_impulse.z,this.m_impulse.x+=B.x,this.m_impulse.y+=B.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(v);else if(this.m_limitState===t.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+v.z>0){var b=-p.x+this.m_impulse.z*this.m_mass.ez.x,A=-p.y+this.m_impulse.z*this.m_mass.ez.y,g=this.m_mass.Solve22(b,A,n.SolveVelocityConstraints_s_reduced_v2);v.x=g.x,v.y=g.y,v.z=-this.m_impulse.z,this.m_impulse.x+=g.x,this.m_impulse.y+=g.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(v);var C=n.SolveVelocityConstraints_s_P.Set(v.x,v.y);i.SelfMulSub(a,C),s-=m*(X.CrossVV(this.m_rA,C)+v.z),o.SelfMulAdd(_,C),r+=h*(X.CrossVV(this.m_rB,C)+v.z)}else{var V=X.SubVV(X.AddVCrossSV(o,r,this.m_rB,X.s_t0),X.AddVCrossSV(i,s,this.m_rA,X.s_t1),n.SolveVelocityConstraints_s_Cdot_v2),w=this.m_mass.Solve22(-V.x,-V.y,n.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,i.SelfMulSub(a,w),s-=m*X.CrossVV(this.m_rA,w),o.SelfMulAdd(_,w),r+=h*X.CrossVV(this.m_rB,w)}e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=r},s.SolvePositionConstraints=function(e){var i,s=e.positions[this.m_indexA].c,o=e.positions[this.m_indexA].a,r=e.positions[this.m_indexB].c,m=e.positions[this.m_indexB].a,h=this.m_qA.SetAngle(o),l=this.m_qB.SetAngle(m),u=0,c=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!c){var f=m-o-this.m_referenceAngle,p=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){var y=T(f-this.m_lowerAngle,-.13962634015955555,d);p=-this.m_motorMass*y,u=G(y)}else if(this.m_limitState===t.b2LimitState.e_atLowerLimit){var v=f-this.m_lowerAngle;u=-v,v=T(v+_,-.13962634015955555,0),p=-this.m_motorMass*v}else if(this.m_limitState===t.b2LimitState.e_atUpperLimit){var x=f-this.m_upperAngle;u=x,x=T(x-_,0,d),p=-this.m_motorMass*x}o-=this.m_invIA*p,m+=this.m_invIB*p}h.SetAngle(o),l.SetAngle(m),X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var S=Q.MulRV(h,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var B=Q.MulRV(l,this.m_lalcB,this.m_rB),b=X.SubVV(X.AddVV(r,B,X.s_t0),X.AddVV(s,S,X.s_t1),n.SolvePositionConstraints_s_C_v2);i=b.Length();var A=this.m_invMassA,g=this.m_invMassB,C=this.m_invIA,V=this.m_invIB,w=this.m_K;w.ex.x=A+g+C*S.y*S.y+V*B.y*B.y,w.ex.y=-C*S.x*S.y-V*B.x*B.y,w.ey.x=w.ex.y,w.ey.y=A+g+C*S.x*S.x+V*B.x*B.x;var M=w.Solve(b.x,b.y,n.SolvePositionConstraints_s_impulse).SelfNeg();return s.SelfMulSub(A,M),o-=C*X.CrossVV(S,M),r.SelfMulAdd(g,M),m+=V*X.CrossVV(B,M),e.positions[this.m_indexA].a=o,e.positions[this.m_indexB].a=m,i<=a&&u<=_},s.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},s.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},s.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},s.GetReactionTorque=function(t){return t*this.m_impulse.z},s.GetLocalAnchorA=function(){return this.m_localAnchorA},s.GetLocalAnchorB=function(){return this.m_localAnchorB},s.GetReferenceAngle=function(){return this.m_referenceAngle},s.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},s.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},s.IsMotorEnabled=function(){return this.m_enableMotor},s.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},s.GetMotorTorque=function(t){return t*this.m_motorImpulse},s.GetMotorSpeed=function(){return this.m_motorSpeed},s.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},s.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},s.IsLimitEnabled=function(){return this.m_enableLimit},s.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},s.GetLowerLimit=function(){return this.m_lowerAngle},s.GetUpperLimit=function(){return this.m_upperAngle},s.SetLimits=function(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)},s.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},s.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n}(Ti);Ki.InitVelocityConstraints_s_P=new X,Ki.SolveVelocityConstraints_s_P=new X,Ki.SolveVelocityConstraints_s_Cdot_v2=new X,Ki.SolveVelocityConstraints_s_Cdot1=new X,Ki.SolveVelocityConstraints_s_impulse_v3=new W,Ki.SolveVelocityConstraints_s_reduced_v2=new X,Ki.SolveVelocityConstraints_s_impulse_v2=new X,Ki.SolvePositionConstraints_s_C_v2=new X,Ki.SolvePositionConstraints_s_impulse=new X;var $i=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_ropeJoint)||this).localAnchorA=new X(-1,0),i.localAnchorB=new X(1,0),i.maxLength=0,i}return h(i,e),i}(Fi),tn=function(i){function n(n){var s;return(s=i.call(this,n)||this).m_localAnchorA=new X,s.m_localAnchorB=new X,s.m_maxLength=0,s.m_length=0,s.m_impulse=0,s.m_indexA=0,s.m_indexB=0,s.m_u=new X,s.m_rA=new X,s.m_rB=new X,s.m_localCenterA=new X,s.m_localCenterB=new X,s.m_invMassA=0,s.m_invMassB=0,s.m_invIA=0,s.m_invIB=0,s.m_mass=0,s.m_state=t.b2LimitState.e_inactiveLimit,s.m_qA=new Q,s.m_qB=new Q,s.m_lalcA=new X,s.m_lalcB=new X,s.m_localAnchorA.Copy(e(n.localAnchorA,new X(-1,0))),s.m_localAnchorB.Copy(e(n.localAnchorB,new X(1,0))),s.m_maxLength=e(n.maxLength,0),s}h(n,i);var s=n.prototype;return s.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var i=e.positions[this.m_indexA].c,s=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,_=e.positions[this.m_indexB].c,m=e.positions[this.m_indexB].a,h=e.velocities[this.m_indexB].v,l=e.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(s),c=this.m_qB.SetAngle(m);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Q.MulRV(u,this.m_lalcA,this.m_rA),X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Q.MulRV(c,this.m_lalcB,this.m_rB),this.m_u.Copy(_).SelfAdd(this.m_rB).SelfSub(i).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var f=this.m_length-this.m_maxLength;if(this.m_state=f>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>a))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var d=X.CrossVV(this.m_rA,this.m_u),p=X.CrossVV(this.m_rB,this.m_u),y=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*p*p;if(this.m_mass=0!==y?1/y:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var v=X.MulSV(this.m_impulse,this.m_u,n.InitVelocityConstraints_s_P);o.SelfMulSub(this.m_invMassA,v),r-=this.m_invIA*X.CrossVV(this.m_rA,v),h.SelfMulAdd(this.m_invMassB,v),l+=this.m_invIB*X.CrossVV(this.m_rB,v)}else this.m_impulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=l},s.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,r=X.AddVCrossSV(e,i,this.m_rA,n.SolveVelocityConstraints_s_vpA),a=X.AddVCrossSV(s,o,this.m_rB,n.SolveVelocityConstraints_s_vpB),_=this.m_length-this.m_maxLength,m=X.DotVV(this.m_u,X.SubVV(a,r,X.s_t0));_<0&&(m+=t.step.inv_dt*_);var h=-this.m_mass*m,l=this.m_impulse;this.m_impulse=D(0,this.m_impulse+h),h=this.m_impulse-l;var u=X.MulSV(h,this.m_u,n.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*X.CrossVV(this.m_rA,u),s.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*X.CrossVV(this.m_rB,u),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},s.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,r=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(o);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var m=Q.MulRV(r,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h=Q.MulRV(_,this.m_lalcB,this.m_rB),l=this.m_u.Copy(s).SelfAdd(h).SelfSub(e).SelfSub(m),u=l.Normalize(),c=u-this.m_maxLength;c=T(c,0,f);var d=-this.m_mass*c,p=X.MulSV(d,l,n.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*X.CrossVV(m,p),s.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*X.CrossVV(h,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,u-this.m_maxLength<a},s.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},s.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},s.GetReactionForce=function(t,e){return X.MulSV(t*this.m_impulse,this.m_u,e)},s.GetReactionTorque=function(){return 0},s.GetLocalAnchorA=function(){return this.m_localAnchorA},s.GetLocalAnchorB=function(){return this.m_localAnchorB},s.SetMaxLength=function(t){this.m_maxLength=t},s.GetMaxLength=function(){return this.m_maxLength},s.GetLimitState=function(){return this.m_state},s.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},n}(Ti);tn.InitVelocityConstraints_s_P=new X,tn.SolveVelocityConstraints_s_vpA=new X,tn.SolveVelocityConstraints_s_vpB=new X,tn.SolveVelocityConstraints_s_P=new X,tn.SolvePositionConstraints_s_P=new X;var en=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_weldJoint)||this).localAnchorA=new X,i.localAnchorB=new X,i.referenceAngle=0,i.frequencyHz=0,i.dampingRatio=0,i}return h(i,e),i.prototype.Initialize=function(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},i}(Fi),nn=function(t){function i(i){var n;return(n=t.call(this,i)||this).m_frequencyHz=0,n.m_dampingRatio=0,n.m_bias=0,n.m_localAnchorA=new X,n.m_localAnchorB=new X,n.m_referenceAngle=0,n.m_gamma=0,n.m_impulse=new W(0,0,0),n.m_indexA=0,n.m_indexB=0,n.m_rA=new X,n.m_rB=new X,n.m_localCenterA=new X,n.m_localCenterB=new X,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_mass=new H,n.m_qA=new Q,n.m_qB=new Q,n.m_lalcA=new X,n.m_lalcB=new X,n.m_K=new H,n.m_frequencyHz=e(i.frequencyHz,0),n.m_dampingRatio=e(i.dampingRatio,0),n.m_localAnchorA.Copy(e(i.localAnchorA,X.ZERO)),n.m_localAnchorB.Copy(e(i.localAnchorB,X.ZERO)),n.m_referenceAngle=e(i.referenceAngle,0),n.m_impulse.SetZero(),n}h(i,t);var n=i.prototype;return n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,r=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v,_=t.velocities[this.m_indexB].w,m=this.m_qA.SetAngle(e),h=this.m_qB.SetAngle(r);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Q.MulRV(m,this.m_lalcA,this.m_rA),X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Q.MulRV(h,this.m_lalcB,this.m_rB);var l=this.m_invMassA,u=this.m_invMassB,c=this.m_invIA,f=this.m_invIB,d=this.m_K;if(d.ex.x=l+u+this.m_rA.y*this.m_rA.y*c+this.m_rB.y*this.m_rB.y*f,d.ey.x=-this.m_rA.y*this.m_rA.x*c-this.m_rB.y*this.m_rB.x*f,d.ez.x=-this.m_rA.y*c-this.m_rB.y*f,d.ex.y=d.ey.x,d.ey.y=l+u+this.m_rA.x*this.m_rA.x*c+this.m_rB.x*this.m_rB.x*f,d.ez.y=this.m_rA.x*c+this.m_rB.x*f,d.ex.z=d.ez.x,d.ey.z=d.ez.y,d.ez.z=c+f,this.m_frequencyHz>0){d.GetInverse22(this.m_mass);var p=c+f,y=p>0?1/p:0,v=r-e-this.m_referenceAngle,x=2*o*this.m_frequencyHz,S=2*y*this.m_dampingRatio*x,B=y*x*x,b=t.step.dt;this.m_gamma=b*(S+b*B),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=v*b*B*this.m_gamma,p+=this.m_gamma,this.m_mass.ez.z=0!==p?1/p:0}else d.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);var A=i.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);n.SelfMulSub(l,A),s-=c*(X.CrossVV(this.m_rA,A)+this.m_impulse.z),a.SelfMulAdd(u,A),_+=f*(X.CrossVV(this.m_rB,A)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=_},n.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,s=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,r=this.m_invMassA,a=this.m_invMassB,_=this.m_invIA,m=this.m_invIB;if(this.m_frequencyHz>0){var h=o-n,l=-this.m_mass.ez.z*(h+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=l,n-=_*l,o+=m*l;var u=X.SubVV(X.AddVCrossSV(s,o,this.m_rB,X.s_t0),X.AddVCrossSV(e,n,this.m_rA,X.s_t1),i.SolveVelocityConstraints_s_Cdot1),c=H.MulM33XY(this.m_mass,u.x,u.y,i.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=c.x,this.m_impulse.y+=c.y;var f=c;e.SelfMulSub(r,f),n-=_*X.CrossVV(this.m_rA,f),s.SelfMulAdd(a,f),o+=m*X.CrossVV(this.m_rB,f)}else{var d=X.SubVV(X.AddVCrossSV(s,o,this.m_rB,X.s_t0),X.AddVCrossSV(e,n,this.m_rA,X.s_t1),i.SolveVelocityConstraints_s_Cdot1),p=o-n,y=H.MulM33XYZ(this.m_mass,d.x,d.y,p,i.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(y);var v=i.SolveVelocityConstraints_s_P.Set(y.x,y.y);e.SelfMulSub(r,v),n-=_*(X.CrossVV(this.m_rA,v)+y.z),s.SelfMulAdd(a,v),o+=m*(X.CrossVV(this.m_rB,v)+y.z)}t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},n.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,r=this.m_qA.SetAngle(n),m=this.m_qB.SetAngle(o),h=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,c=this.m_invIB;X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var f=Q.MulRV(r,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d,p,y=Q.MulRV(m,this.m_lalcB,this.m_rB),v=this.m_K;if(v.ex.x=h+l+f.y*f.y*u+y.y*y.y*c,v.ey.x=-f.y*f.x*u-y.y*y.x*c,v.ez.x=-f.y*u-y.y*c,v.ex.y=v.ey.x,v.ey.y=h+l+f.x*f.x*u+y.x*y.x*c,v.ez.y=f.x*u+y.x*c,v.ex.z=v.ez.x,v.ey.z=v.ez.y,v.ez.z=u+c,this.m_frequencyHz>0){var x=X.SubVV(X.AddVV(s,y,X.s_t0),X.AddVV(e,f,X.s_t1),i.SolvePositionConstraints_s_C1);d=x.Length(),p=0;var S=v.Solve22(x.x,x.y,i.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(h,S),n-=u*X.CrossVV(f,S),s.SelfMulAdd(l,S),o+=c*X.CrossVV(y,S)}else{var B=X.SubVV(X.AddVV(s,y,X.s_t0),X.AddVV(e,f,X.s_t1),i.SolvePositionConstraints_s_C1),b=o-n-this.m_referenceAngle;d=B.Length(),p=G(b);var A=v.Solve33(B.x,B.y,b,i.SolvePositionConstraints_s_impulse).SelfNeg(),g=i.SolvePositionConstraints_s_P.Set(A.x,A.y);e.SelfMulSub(h,g),n-=u*(X.CrossVV(this.m_rA,g)+A.z),s.SelfMulAdd(l,g),o+=c*(X.CrossVV(this.m_rB,g)+A.z)}return t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,d<=a&&p<=_},n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},n.GetReactionTorque=function(t){return t*this.m_impulse.z},n.GetLocalAnchorA=function(){return this.m_localAnchorA},n.GetLocalAnchorB=function(){return this.m_localAnchorB},n.GetReferenceAngle=function(){return this.m_referenceAngle},n.SetFrequency=function(t){this.m_frequencyHz=t},n.GetFrequency=function(){return this.m_frequencyHz},n.SetDampingRatio=function(t){this.m_dampingRatio=t},n.GetDampingRatio=function(){return this.m_dampingRatio},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(Ti);nn.InitVelocityConstraints_s_P=new X,nn.SolveVelocityConstraints_s_Cdot1=new X,nn.SolveVelocityConstraints_s_impulse1=new X,nn.SolveVelocityConstraints_s_impulse=new W,nn.SolveVelocityConstraints_s_P=new X,nn.SolvePositionConstraints_s_C1=new X,nn.SolvePositionConstraints_s_P=new X,nn.SolvePositionConstraints_s_impulse=new W;var sn=function(e){function i(){var i;return(i=e.call(this,t.b2JointType.e_wheelJoint)||this).localAnchorA=new X(0,0),i.localAnchorB=new X(0,0),i.localAxisA=new X(1,0),i.enableMotor=!1,i.maxMotorTorque=0,i.motorSpeed=0,i.frequencyHz=2,i.dampingRatio=.7,i}return h(i,e),i.prototype.Initialize=function(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA)},i}(Fi),on=function(t){function i(i){var n;return(n=t.call(this,i)||this).m_frequencyHz=0,n.m_dampingRatio=0,n.m_localAnchorA=new X,n.m_localAnchorB=new X,n.m_localXAxisA=new X,n.m_localYAxisA=new X,n.m_impulse=0,n.m_motorImpulse=0,n.m_springImpulse=0,n.m_maxMotorTorque=0,n.m_motorSpeed=0,n.m_enableMotor=!1,n.m_indexA=0,n.m_indexB=0,n.m_localCenterA=new X,n.m_localCenterB=new X,n.m_invMassA=0,n.m_invMassB=0,n.m_invIA=0,n.m_invIB=0,n.m_ax=new X,n.m_ay=new X,n.m_sAx=0,n.m_sBx=0,n.m_sAy=0,n.m_sBy=0,n.m_mass=0,n.m_motorMass=0,n.m_springMass=0,n.m_bias=0,n.m_gamma=0,n.m_qA=new Q,n.m_qB=new Q,n.m_lalcA=new X,n.m_lalcB=new X,n.m_rA=new X,n.m_rB=new X,n.m_frequencyHz=e(i.frequencyHz,2),n.m_dampingRatio=e(i.dampingRatio,.7),n.m_localAnchorA.Copy(e(i.localAnchorA,X.ZERO)),n.m_localAnchorB.Copy(e(i.localAnchorB,X.ZERO)),n.m_localXAxisA.Copy(e(i.localAxisA,X.UNITX)),X.CrossOneV(n.m_localXAxisA,n.m_localYAxisA),n.m_maxMotorTorque=e(i.maxMotorTorque,0),n.m_motorSpeed=e(i.motorSpeed,0),n.m_enableMotor=e(i.enableMotor,!1),n.m_ax.SetZero(),n.m_ay.SetZero(),n}h(i,t);var n=i.prototype;return n.GetMotorSpeed=function(){return this.m_motorSpeed},n.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},n.SetSpringFrequencyHz=function(t){this.m_frequencyHz=t},n.GetSpringFrequencyHz=function(){return this.m_frequencyHz},n.SetSpringDampingRatio=function(t){this.m_dampingRatio=t},n.GetSpringDampingRatio=function(){return this.m_dampingRatio},n.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=this.m_invMassA,n=this.m_invMassB,s=this.m_invIA,r=this.m_invIB,a=t.positions[this.m_indexA].c,_=t.positions[this.m_indexA].a,m=t.velocities[this.m_indexA].v,h=t.velocities[this.m_indexA].w,l=t.positions[this.m_indexB].c,u=t.positions[this.m_indexB].a,c=t.velocities[this.m_indexB].v,f=t.velocities[this.m_indexB].w,d=this.m_qA.SetAngle(_),p=this.m_qB.SetAngle(u);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var y=Q.MulRV(d,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var v=Q.MulRV(p,this.m_lalcB,this.m_rB),x=X.SubVV(X.AddVV(l,v,X.s_t0),X.AddVV(a,y,X.s_t1),i.InitVelocityConstraints_s_d);if(Q.MulRV(d,this.m_localYAxisA,this.m_ay),this.m_sAy=X.CrossVV(X.AddVV(x,y,X.s_t0),this.m_ay),this.m_sBy=X.CrossVV(v,this.m_ay),this.m_mass=e+n+s*this.m_sAy*this.m_sAy+r*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){Q.MulRV(d,this.m_localXAxisA,this.m_ax),this.m_sAx=X.CrossVV(X.AddVV(x,y,X.s_t0),this.m_ax),this.m_sBx=X.CrossVV(v,this.m_ax);var S=e+n+s*this.m_sAx*this.m_sAx+r*this.m_sBx*this.m_sBx;if(S>0){this.m_springMass=1/S;var B=X.DotVV(x,this.m_ax),b=2*o*this.m_frequencyHz,A=2*this.m_springMass*this.m_dampingRatio*b,g=this.m_springMass*b*b,C=t.step.dt;this.m_gamma=C*(A+C*g),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=B*C*g*this.m_gamma,this.m_springMass=S+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=s+r,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;var V=X.AddVV(X.MulSV(this.m_impulse,this.m_ay,X.s_t0),X.MulSV(this.m_springImpulse,this.m_ax,X.s_t1),i.InitVelocityConstraints_s_P),w=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,M=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;m.SelfMulSub(this.m_invMassA,V),h-=this.m_invIA*w,c.SelfMulAdd(this.m_invMassB,V),f+=this.m_invIB*M}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=h,t.velocities[this.m_indexB].w=f},n.SolveVelocityConstraints=function(t){var e=this.m_invMassA,n=this.m_invMassB,s=this.m_invIA,o=this.m_invIB,r=t.velocities[this.m_indexA].v,a=t.velocities[this.m_indexA].w,_=t.velocities[this.m_indexB].v,m=t.velocities[this.m_indexB].w,h=X.DotVV(this.m_ax,X.SubVV(_,r,X.s_t0))+this.m_sBx*m-this.m_sAx*a,l=-this.m_springMass*(h+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=l;var u=X.MulSV(l,this.m_ax,i.SolveVelocityConstraints_s_P),c=l*this.m_sAx,f=l*this.m_sBx;r.SelfMulSub(e,u),a-=s*c,_.SelfMulAdd(n,u);var d=(m+=o*f)-a-this.m_motorSpeed,p=-this.m_motorMass*d,y=this.m_motorImpulse,v=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=T(this.m_motorImpulse+p,-v,v),a-=s*(p=this.m_motorImpulse-y),m+=o*p;var x=X.DotVV(this.m_ay,X.SubVV(_,r,X.s_t0))+this.m_sBy*m-this.m_sAy*a,S=-this.m_mass*x;this.m_impulse+=S;var B=X.MulSV(S,this.m_ay,i.SolveVelocityConstraints_s_P),b=S*this.m_sAy,A=S*this.m_sBy;r.SelfMulSub(e,B),a-=s*b,_.SelfMulAdd(n,B),m+=o*A,t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=m},n.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,s=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,r=this.m_qA.SetAngle(n),_=this.m_qB.SetAngle(o);X.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var m=Q.MulRV(r,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var h,l=Q.MulRV(_,this.m_lalcB,this.m_rB),u=X.AddVV(X.SubVV(s,e,X.s_t0),X.SubVV(l,m,X.s_t1),i.SolvePositionConstraints_s_d),c=Q.MulRV(r,this.m_localYAxisA,this.m_ay),f=X.CrossVV(X.AddVV(u,m,X.s_t0),c),d=X.CrossVV(l,c),p=X.DotVV(u,this.m_ay),y=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;h=0!==y?-p/y:0;var v=X.MulSV(h,c,i.SolvePositionConstraints_s_P),x=h*f,S=h*d;return e.SelfMulSub(this.m_invMassA,v),n-=this.m_invIA*x,s.SelfMulAdd(this.m_invMassB,v),o+=this.m_invIB*S,t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,G(p)<=a},n.GetDefinition=function(t){return t},n.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},n.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},n.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e},n.GetReactionTorque=function(t){return t*this.m_motorImpulse},n.GetLocalAnchorA=function(){return this.m_localAnchorA},n.GetLocalAnchorB=function(){return this.m_localAnchorB},n.GetLocalAxisA=function(){return this.m_localXAxisA},n.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},n.GetJointLinearSpeed=function(){return this.GetPrismaticJointSpeed()},n.GetJointAngle=function(){return this.GetRevoluteJointAngle()},n.GetJointAngularSpeed=function(){return this.GetRevoluteJointSpeed()},n.GetPrismaticJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new X),n=e.GetWorldPoint(this.m_localAnchorB,new X),s=X.SubVV(n,i,new X),o=t.GetWorldVector(this.m_localXAxisA,new X);return X.DotVV(s,o)},n.GetPrismaticJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;X.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var i=Q.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);X.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var n=Q.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=X.AddVV(t.m_sweep.c,i,X.s_t0),o=X.AddVV(e.m_sweep.c,n,X.s_t1),r=X.SubVV(o,s,X.s_t2),a=t.GetWorldVector(this.m_localXAxisA,new X),_=t.m_linearVelocity,m=e.m_linearVelocity,h=t.m_angularVelocity,l=e.m_angularVelocity;return X.DotVV(r,X.CrossSV(h,a,X.s_t0))+X.DotVV(a,X.SubVV(X.AddVCrossSV(m,l,n,X.s_t0),X.AddVCrossSV(_,h,i,X.s_t1),X.s_t0))},n.GetRevoluteJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a},n.GetRevoluteJointSpeed=function(){var t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t},n.IsMotorEnabled=function(){return this.m_enableMotor},n.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},n.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},n.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},n.GetMotorTorque=function(t){return t*this.m_motorImpulse},n.Dump=function(t){var e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(Ti);function rn(t,e){return q(t*e)}function an(t,e){return t>e?t:e}on.InitVelocityConstraints_s_d=new X,on.InitVelocityConstraints_s_P=new X,on.SolveVelocityConstraints_s_P=new X,on.SolvePositionConstraints_s_d=new X,on.SolvePositionConstraints_s_P=new X;var _n=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.contact=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},m(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),mn=function(){function t(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new _n(this),this.m_nodeB=new _n(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new Tt,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new Tt}var e=t.prototype;return e.GetManifold=function(){return this.m_manifold},e.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.GetShapeA(),s=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),s.m_radius)},e.IsTouching=function(){return this.m_touchingFlag},e.SetEnabled=function(t){this.m_enabledFlag=t},e.IsEnabled=function(){return this.m_enabledFlag},e.GetNext=function(){return this.m_next},e.GetFixtureA=function(){return this.m_fixtureA},e.GetChildIndexA=function(){return this.m_indexA},e.GetShapeA=function(){return this.m_fixtureA.GetShape()},e.GetFixtureB=function(){return this.m_fixtureB},e.GetChildIndexB=function(){return this.m_indexB},e.GetShapeB=function(){return this.m_fixtureB.GetShape()},e.FlagForFiltering=function(){this.m_filterFlag=!0},e.SetFriction=function(t){this.m_friction=t},e.GetFriction=function(){return this.m_friction},e.ResetFriction=function(){this.m_friction=rn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)},e.SetRestitution=function(t){this.m_restitution=t},e.GetRestitution=function(){return this.m_restitution},e.ResetRestitution=function(){this.m_restitution=an(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.SetTangentSpeed=function(t){this.m_tangentSpeed=t},e.GetTangentSpeed=function(){return this.m_tangentSpeed},e.Reset=function(t,e,i,n){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=n,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=rn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=an(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;var i=!1,n=this.m_touchingFlag,s=this.m_fixtureA.IsSensor(),o=this.m_fixtureB.IsSensor(),r=s||o,a=this.m_fixtureA.GetBody(),_=this.m_fixtureB.GetBody(),m=a.GetTransform(),h=_.GetTransform();if(r){var l=this.GetShapeA(),u=this.GetShapeB();i=Xt(l,this.m_indexA,u,this.m_indexB,m,h),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,m,h),i=this.m_manifold.pointCount>0;for(var c=0;c<this.m_manifold.pointCount;++c){var f=this.m_manifold.points[c];f.normalImpulse=0,f.tangentImpulse=0;for(var d=f.id,p=0;p<this.m_oldManifold.pointCount;++p){var y=this.m_oldManifold.points[p];if(y.id.key===d.key){f.normalImpulse=y.normalImpulse,f.tangentImpulse=y.tangentImpulse;break}}}i!==n&&(a.SetAwake(!0),_.SetAwake(!0))}this.m_touchingFlag=i,!n&&i&&t&&t.BeginContact(this),n&&!i&&t&&t.EndContact(this),!r&&i&&t&&t.PreSolve(this,this.m_oldManifold)},e.ComputeTOI=function(e,i){var n=t.ComputeTOI_s_input;n.proxyA.SetShape(this.GetShapeA(),this.m_indexA),n.proxyB.SetShape(this.GetShapeB(),this.m_indexB),n.sweepA.Copy(e),n.sweepB.Copy(i),n.tMax=a;var s=t.ComputeTOI_s_output;return be(s,n),s.t},t}();mn.ComputeTOI_s_input=new me,mn.ComputeTOI_s_output=new le;var hn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){Ce(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}(mn),ln=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){$e(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}(mn),un=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){Pe(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}(mn),cn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){mi(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}(mn),fn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,i){di(t,this.GetShapeA(),e,this.GetShapeB(),i)},e}(mn),dn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,i,n){var s=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.m_indexA),mi(t,s,i,this.GetShapeB(),n)},e}(mn);dn.Evaluate_s_edge=new Bi;var pn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,i,n){var s=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.m_indexA),di(t,s,i,this.GetShapeB(),n)},e}(mn);pn.Evaluate_s_edge=new Bi;var yn=function(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1},vn=function(){function e(){this.m_registers=[],this.InitializeRegisters()}var i=e.prototype;return i.AddType=function(t,e,i,n){var s=[];function o(){return s.pop()||t()}function r(t){s.push(t)}this.m_registers[i][n].pool=s,this.m_registers[i][n].createFcn=o,this.m_registers[i][n].destroyFcn=r,this.m_registers[i][n].primary=!0,i!==n&&(this.m_registers[n][i].pool=s,this.m_registers[n][i].createFcn=o,this.m_registers[n][i].destroyFcn=r,this.m_registers[n][i].primary=!1)},i.InitializeRegisters=function(){for(var e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(var i=0;i<t.b2ShapeType.e_shapeTypeCount;i++)this.m_registers[e][i]=new yn}this.AddType(hn.Create,hn.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(un.Create,un.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType(ln.Create,ln.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(cn.Create,cn.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(fn.Create,fn.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(dn.Create,dn.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(pn.Create,pn.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)},i.Create=function(t,e,i,n){var s=t.GetType(),o=i.GetType(),r=this.m_registers[s][o];if(r.createFcn){var a=r.createFcn();return r.primary?a.Reset(t,e,i,n):a.Reset(i,n,t,e),a}return null},i.Destroy=function(t){var e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),n=this.m_registers[e][i];n.destroyFcn&&n.destroyFcn(t)},e}(),xn=function(){function t(){}var e=t.prototype;return e.SayGoodbyeJoint=function(){},e.SayGoodbyeFixture=function(){},e.SayGoodbyeParticleGroup=function(){},e.SayGoodbyeParticle=function(){},t}(),Sn=function(){function e(){}var i=e.prototype;return i.ShouldCollide=function(e,i){var n=e.GetBody(),s=i.GetBody();if(s.GetType()===t.b2BodyType.b2_staticBody&&n.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!s.ShouldCollideConnected(n))return!1;var o=e.GetFilterData(),r=i.GetFilterData();return o.groupIndex===r.groupIndex&&0!==o.groupIndex?o.groupIndex>0:!!(o.maskBits&r.categoryBits)&&!!(o.categoryBits&r.maskBits)},i.ShouldCollideFixtureParticle=function(){return!0},i.ShouldCollideParticleParticle=function(){return!0},e}();Sn.b2_defaultFilter=new Sn;var Bn=function(){this.normalImpulses=w(2),this.tangentImpulses=w(2),this.count=0},bn=function(){function t(){}var e=t.prototype;return e.BeginContact=function(){},e.EndContact=function(){},e.BeginContactFixtureParticle=function(){},e.EndContactFixtureParticle=function(){},e.BeginContactParticleParticle=function(){},e.EndContactParticleParticle=function(){},e.PreSolve=function(){},e.PostSolve=function(){},t}();bn.b2_defaultListener=new bn;var An=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(){return!0},e.ReportParticle=function(){return!1},e.ShouldQueryParticleSystem=function(){return!0},t}(),gn=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(t,e,i,n){return n},e.ReportParticle=function(){return 0},e.ShouldQueryParticleSystem=function(){return!0},t}(),Cn=function(){function e(){this.m_broadPhase=new $t,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=Sn.b2_defaultFilter,this.m_contactListener=bn.b2_defaultListener,this.m_contactFactory=new vn}var i=e.prototype;return i.AddPair=function(t,e){var i=t.fixture,n=e.fixture,s=t.childIndex,o=e.childIndex,r=i.GetBody(),a=n.GetBody();if(r!==a){for(var _=a.GetContactList();_;){if(_.other===r){var m=_.contact.GetFixtureA(),h=_.contact.GetFixtureB(),l=_.contact.GetChildIndexA(),u=_.contact.GetChildIndexB();if(m===i&&h===n&&l===s&&u===o)return;if(m===n&&h===i&&l===o&&u===s)return}_=_.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(i,n)){var c=this.m_contactFactory.Create(i,s,n,o);null!==c&&(i=c.GetFixtureA(),n=c.GetFixtureB(),s=c.GetChildIndexA(),o=c.GetChildIndexB(),r=i.m_body,a=n.m_body,c.m_prev=null,c.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=c),this.m_contactList=c,c.m_nodeA.other=a,c.m_nodeA.prev=null,c.m_nodeA.next=r.m_contactList,null!==r.m_contactList&&(r.m_contactList.prev=c.m_nodeA),r.m_contactList=c.m_nodeA,c.m_nodeB.other=r,c.m_nodeB.prev=null,c.m_nodeB.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=c.m_nodeB),a.m_contactList=c.m_nodeB,i.IsSensor()||n.IsSensor()||(r.SetAwake(!0),a.SetAwake(!0)),++this.m_contactCount)}}},i.FindNewContacts=function(){var t=this;this.m_broadPhase.UpdatePairs((function(e,i){t.AddPair(e,i)}))},i.Destroy=function(t){var e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),s=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===s.m_contactList&&(s.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount},i.Collide=function(){for(var e=this.m_contactList;e;){var i=e.GetFixtureA(),n=e.GetFixtureB(),s=e.GetChildIndexA(),o=e.GetChildIndexB(),r=i.GetBody(),a=n.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n)){var _=e;e=_.m_next,this.Destroy(_);continue}e.m_filterFlag=!1}var m=r.IsAwake()&&r.m_type!==t.b2BodyType.b2_staticBody,h=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody;if(m||h){var l=i.m_proxies[s].treeNode,u=n.m_proxies[o].treeNode;if(jt(l.aabb,u.aabb))e.Update(this.m_contactListener),e=e.m_next;else{var c=e;e=c.m_next,this.Destroy(c)}}else e=e.m_next}},e}(),Vn=function(){function t(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return t.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},t}(),wn=function(){function t(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return t.prototype.Copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},t}(),Mn=function(){function t(){this.c=new X,this.a=0}return t.MakeArray=function(e){return V(e,(function(){return new t}))},t}(),Pn=function(){function t(){this.v=new X,this.w=0}return t.MakeArray=function(e){return V(e,(function(){return new t}))},t}(),In=function(){this.step=new wn},Gn=!1,Dn=function(){function t(){this.rA=new X,this.rB=new X,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return t.MakeArray=function(e){return V(e,(function(){return new t}))},t}(),Fn=function(){function t(){this.points=Dn.MakeArray(2),this.normal=new X,this.tangent=new X,this.normalMass=new Z,this.K=new Z,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return t.MakeArray=function(e){return V(e,(function(){return new t}))},t}(),Tn=function(){function e(){this.localPoints=X.MakeArray(2),this.localNormal=new X,this.localPoint=new X,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new X,this.localCenterB=new X,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}return e.MakeArray=function(t){return V(t,(function(){return new e}))},e}(),Ln=function(){this.step=new wn,this.count=0},Rn=function(){function e(){this.normal=new X,this.point=new X,this.separation=0}return e.prototype.Initialize=function(i,n,s,o){var r=e.Initialize_s_pointA,a=e.Initialize_s_pointB,_=e.Initialize_s_planePoint,m=e.Initialize_s_clipPoint;switch(i.type){case t.b2ManifoldType.e_circles:Y.MulXV(n,i.localPoint,r),Y.MulXV(s,i.localPoints[0],a),X.SubVV(a,r,this.normal).SelfNormalize(),X.MidVV(r,a,this.point),this.separation=X.DotVV(X.SubVV(a,r,X.s_t0),this.normal)-i.radiusA-i.radiusB;break;case t.b2ManifoldType.e_faceA:Q.MulRV(n.q,i.localNormal,this.normal),Y.MulXV(n,i.localPoint,_),Y.MulXV(s,i.localPoints[o],m),this.separation=X.DotVV(X.SubVV(m,_,X.s_t0),this.normal)-i.radiusA-i.radiusB,this.point.Copy(m);break;case t.b2ManifoldType.e_faceB:Q.MulRV(s.q,i.localNormal,this.normal),Y.MulXV(s,i.localPoint,_),Y.MulXV(n,i.localPoints[o],m),this.separation=X.DotVV(X.SubVV(m,_,X.s_t0),this.normal)-i.radiusA-i.radiusB,this.point.Copy(m),this.normal.SelfNeg()}},e}();Rn.Initialize_s_pointA=new X,Rn.Initialize_s_pointB=new X,Rn.Initialize_s_planePoint=new X,Rn.Initialize_s_clipPoint=new X;var kn=function(){function t(){this.m_step=new wn,this.m_positionConstraints=Tn.MakeArray(1024),this.m_velocityConstraints=Fn.MakeArray(1024),this.m_count=0}var e=t.prototype;return e.Initialize=function(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count)for(var e=F(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new Tn;if(this.m_velocityConstraints.length<this.m_count)for(var i=F(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<i;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Fn;this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(var n=0;n<this.m_count;++n){var s=this.m_contacts[n],o=s.m_fixtureA,r=s.m_fixtureB,a=o.GetShape(),_=r.GetShape(),m=a.m_radius,h=_.m_radius,l=o.GetBody(),u=r.GetBody(),c=s.GetManifold(),f=c.pointCount,d=this.m_velocityConstraints[n];d.friction=s.m_friction,d.restitution=s.m_restitution,d.tangentSpeed=s.m_tangentSpeed,d.indexA=l.m_islandIndex,d.indexB=u.m_islandIndex,d.invMassA=l.m_invMass,d.invMassB=u.m_invMass,d.invIA=l.m_invI,d.invIB=u.m_invI,d.contactIndex=n,d.pointCount=f,d.K.SetZero(),d.normalMass.SetZero();var p=this.m_positionConstraints[n];p.indexA=l.m_islandIndex,p.indexB=u.m_islandIndex,p.invMassA=l.m_invMass,p.invMassB=u.m_invMass,p.localCenterA.Copy(l.m_sweep.localCenter),p.localCenterB.Copy(u.m_sweep.localCenter),p.invIA=l.m_invI,p.invIB=u.m_invI,p.localNormal.Copy(c.localNormal),p.localPoint.Copy(c.localPoint),p.pointCount=f,p.radiusA=m,p.radiusB=h,p.type=c.type;for(var y=0;y<f;++y){var v=c.points[y],x=d.points[y];this.m_step.warmStarting?(x.normalImpulse=this.m_step.dtRatio*v.normalImpulse,x.tangentImpulse=this.m_step.dtRatio*v.tangentImpulse):(x.normalImpulse=0,x.tangentImpulse=0),x.rA.SetZero(),x.rB.SetZero(),x.normalMass=0,x.tangentMass=0,x.velocityBias=0,p.localPoints[y].Copy(v.localPoint)}}return this},e.InitializeVelocityConstraints=function(){for(var e=t.InitializeVelocityConstraints_s_xfA,i=t.InitializeVelocityConstraints_s_xfB,n=t.InitializeVelocityConstraints_s_worldManifold,s=0;s<this.m_count;++s){var o=this.m_velocityConstraints[s],r=this.m_positionConstraints[s],a=r.radiusA,_=r.radiusB,m=this.m_contacts[o.contactIndex].GetManifold(),h=o.indexA,l=o.indexB,u=o.invMassA,c=o.invMassB,f=o.invIA,d=o.invIB,p=r.localCenterA,y=r.localCenterB,v=this.m_positions[h].c,x=this.m_positions[h].a,S=this.m_velocities[h].v,B=this.m_velocities[h].w,b=this.m_positions[l].c,A=this.m_positions[l].a,g=this.m_velocities[l].v,C=this.m_velocities[l].w;e.q.SetAngle(x),i.q.SetAngle(A),X.SubVV(v,Q.MulRV(e.q,p,X.s_t0),e.p),X.SubVV(b,Q.MulRV(i.q,y,X.s_t0),i.p),n.Initialize(m,e,a,i,_),o.normal.Copy(n.normal),X.CrossVOne(o.normal,o.tangent);for(var V=o.pointCount,w=0;w<V;++w){var M=o.points[w];X.SubVV(n.points[w],v,M.rA),X.SubVV(n.points[w],b,M.rB);var P=X.CrossVV(M.rA,o.normal),I=X.CrossVV(M.rB,o.normal),G=u+c+f*P*P+d*I*I;M.normalMass=G>0?1/G:0;var D=o.tangent,F=X.CrossVV(M.rA,D),T=X.CrossVV(M.rB,D),L=u+c+f*F*F+d*T*T;M.tangentMass=L>0?1/L:0,M.velocityBias=0;var R=X.DotVV(o.normal,X.SubVV(X.AddVCrossSV(g,C,M.rB,X.s_t0),X.AddVCrossSV(S,B,M.rA,X.s_t1),X.s_t0));R<-1&&(M.velocityBias+=-o.restitution*R)}o.pointCount}},e.WarmStart=function(){for(var e=t.WarmStart_s_P,i=0;i<this.m_count;++i){for(var n=this.m_velocityConstraints[i],s=n.indexA,o=n.indexB,r=n.invMassA,a=n.invIA,_=n.invMassB,m=n.invIB,h=n.pointCount,l=this.m_velocities[s].v,u=this.m_velocities[s].w,c=this.m_velocities[o].v,f=this.m_velocities[o].w,d=n.normal,p=n.tangent,y=0;y<h;++y){var v=n.points[y];X.AddVV(X.MulSV(v.normalImpulse,d,X.s_t0),X.MulSV(v.tangentImpulse,p,X.s_t1),e),u-=a*X.CrossVV(v.rA,e),l.SelfMulSub(r,e),f+=m*X.CrossVV(v.rB,e),c.SelfMulAdd(_,e)}this.m_velocities[s].w=u,this.m_velocities[o].w=f}},e.SolveVelocityConstraints=function(){var e=t.SolveVelocityConstraints_s_dv;t.SolveVelocityConstraints_s_dv1,t.SolveVelocityConstraints_s_dv2;var i=t.SolveVelocityConstraints_s_P;t.SolveVelocityConstraints_s_a,t.SolveVelocityConstraints_s_b,t.SolveVelocityConstraints_s_x,t.SolveVelocityConstraints_s_d,t.SolveVelocityConstraints_s_P1,t.SolveVelocityConstraints_s_P2,t.SolveVelocityConstraints_s_P1P2;for(var n=0;n<this.m_count;++n){for(var s=this.m_velocityConstraints[n],o=s.indexA,r=s.indexB,a=s.invMassA,_=s.invIA,m=s.invMassB,h=s.invIB,l=s.pointCount,u=this.m_velocities[o].v,c=this.m_velocities[o].w,f=this.m_velocities[r].v,d=this.m_velocities[r].w,p=s.normal,y=s.tangent,v=s.friction,x=0;x<l;++x){var S=s.points[x];X.SubVV(X.AddVCrossSV(f,d,S.rB,X.s_t0),X.AddVCrossSV(u,c,S.rA,X.s_t1),e);var B=X.DotVV(e,y)-s.tangentSpeed,b=S.tangentMass*-B,A=v*S.normalImpulse,g=T(S.tangentImpulse+b,-A,A);b=g-S.tangentImpulse,S.tangentImpulse=g,X.MulSV(b,y,i),u.SelfMulSub(a,i),c-=_*X.CrossVV(S.rA,i),f.SelfMulAdd(m,i),d+=h*X.CrossVV(S.rB,i)}s.pointCount;for(var C=0;C<l;++C){var V=s.points[C];X.SubVV(X.AddVCrossSV(f,d,V.rB,X.s_t0),X.AddVCrossSV(u,c,V.rA,X.s_t1),e);var w=X.DotVV(e,p),M=-V.normalMass*(w-V.velocityBias),P=F(V.normalImpulse+M,0);M=P-V.normalImpulse,V.normalImpulse=P,X.MulSV(M,p,i),u.SelfMulSub(a,i),c-=_*X.CrossVV(V.rA,i),f.SelfMulAdd(m,i),d+=h*X.CrossVV(V.rB,i)}this.m_velocities[o].w=c,this.m_velocities[r].w=d}},e.StoreImpulses=function(){for(var t=0;t<this.m_count;++t)for(var e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold(),n=0;n<e.pointCount;++n)i.points[n].normalImpulse=e.points[n].normalImpulse,i.points[n].tangentImpulse=e.points[n].tangentImpulse},e.SolvePositionConstraints=function(){for(var e=t.SolvePositionConstraints_s_xfA,i=t.SolvePositionConstraints_s_xfB,n=t.SolvePositionConstraints_s_psm,s=t.SolvePositionConstraints_s_rA,o=t.SolvePositionConstraints_s_rB,r=t.SolvePositionConstraints_s_P,_=0,m=0;m<this.m_count;++m){for(var h=this.m_positionConstraints[m],l=h.indexA,u=h.indexB,c=h.localCenterA,f=h.invMassA,d=h.invIA,p=h.localCenterB,y=h.invMassB,v=h.invIB,x=h.pointCount,S=this.m_positions[l].c,B=this.m_positions[l].a,b=this.m_positions[u].c,A=this.m_positions[u].a,g=0;g<x;++g){e.q.SetAngle(B),i.q.SetAngle(A),X.SubVV(S,Q.MulRV(e.q,c,X.s_t0),e.p),X.SubVV(b,Q.MulRV(i.q,p,X.s_t0),i.p),n.Initialize(h,e,i,g);var C=n.normal,V=n.point,w=n.separation;X.SubVV(V,S,s),X.SubVV(V,b,o),_=D(_,w);var M=T(.2*(w+a),-.2,0),P=X.CrossVV(s,C),I=X.CrossVV(o,C),G=f+y+d*P*P+v*I*I,F=G>0?-M/G:0;X.MulSV(F,C,r),S.SelfMulSub(f,r),B-=d*X.CrossVV(s,r),b.SelfMulAdd(y,r),A+=v*X.CrossVV(o,r)}this.m_positions[l].a=B,this.m_positions[u].a=A}return _>-.024},e.SolveTOIPositionConstraints=function(e,i){for(var n=t.SolveTOIPositionConstraints_s_xfA,s=t.SolveTOIPositionConstraints_s_xfB,o=t.SolveTOIPositionConstraints_s_psm,r=t.SolveTOIPositionConstraints_s_rA,_=t.SolveTOIPositionConstraints_s_rB,m=t.SolveTOIPositionConstraints_s_P,h=0,l=0;l<this.m_count;++l){var u=this.m_positionConstraints[l],c=u.indexA,f=u.indexB,d=u.localCenterA,p=u.localCenterB,y=u.pointCount,v=0,x=0;c!==e&&c!==i||(v=u.invMassA,x=u.invIA);var S=0,B=0;f!==e&&f!==i||(S=u.invMassB,B=u.invIB);for(var b=this.m_positions[c].c,A=this.m_positions[c].a,g=this.m_positions[f].c,C=this.m_positions[f].a,V=0;V<y;++V){n.q.SetAngle(A),s.q.SetAngle(C),X.SubVV(b,Q.MulRV(n.q,d,X.s_t0),n.p),X.SubVV(g,Q.MulRV(s.q,p,X.s_t0),s.p),o.Initialize(u,n,s,V);var w=o.normal,M=o.point,P=o.separation;X.SubVV(M,b,r),X.SubVV(M,g,_),h=D(h,P);var I=T(.75*(P+a),-.2,0),G=X.CrossVV(r,w),F=X.CrossVV(_,w),L=v+S+x*G*G+B*F*F,R=L>0?-I/L:0;X.MulSV(R,w,m),b.SelfMulSub(v,m),A-=x*X.CrossVV(r,m),g.SelfMulAdd(S,m),C+=B*X.CrossVV(_,m)}this.m_positions[c].a=A,this.m_positions[f].a=C}return h>=-.012},t}();kn.InitializeVelocityConstraints_s_xfA=new Y,kn.InitializeVelocityConstraints_s_xfB=new Y,kn.InitializeVelocityConstraints_s_worldManifold=new Lt,kn.WarmStart_s_P=new X,kn.SolveVelocityConstraints_s_dv=new X,kn.SolveVelocityConstraints_s_dv1=new X,kn.SolveVelocityConstraints_s_dv2=new X,kn.SolveVelocityConstraints_s_P=new X,kn.SolveVelocityConstraints_s_a=new X,kn.SolveVelocityConstraints_s_b=new X,kn.SolveVelocityConstraints_s_x=new X,kn.SolveVelocityConstraints_s_d=new X,kn.SolveVelocityConstraints_s_P1=new X,kn.SolveVelocityConstraints_s_P2=new X,kn.SolveVelocityConstraints_s_P1P2=new X,kn.SolvePositionConstraints_s_xfA=new Y,kn.SolvePositionConstraints_s_xfB=new Y,kn.SolvePositionConstraints_s_psm=new Rn,kn.SolvePositionConstraints_s_rA=new X,kn.SolvePositionConstraints_s_rB=new X,kn.SolvePositionConstraints_s_P=new X,kn.SolveTOIPositionConstraints_s_xfA=new Y,kn.SolveTOIPositionConstraints_s_xfB=new Y,kn.SolveTOIPositionConstraints_s_psm=new Rn,kn.SolveTOIPositionConstraints_s_rA=new X,kn.SolveTOIPositionConstraints_s_rB=new X,kn.SolveTOIPositionConstraints_s_P=new X;var qn,zn=function(){function e(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=Mn.MakeArray(1024),this.m_velocities=Pn.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}var n=e.prototype;return n.Initialize=function(t,e,i,n){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=n,this.m_positions.length<t)for(var s=F(2*this.m_positions.length,t);this.m_positions.length<s;)this.m_positions[this.m_positions.length]=new Mn;if(this.m_velocities.length<t)for(var o=F(2*this.m_velocities.length,t);this.m_velocities.length<o;)this.m_velocities[this.m_velocities.length]=new Pn},n.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},n.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},n.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},n.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},n.Solve=function(n,s,o,r){for(var a=e.s_timer.Reset(),_=s.dt,m=0;m<this.m_bodyCount;++m){var h=this.m_bodies[m];this.m_positions[m].c.Copy(h.m_sweep.c);var l=h.m_sweep.a,u=this.m_velocities[m].v.Copy(h.m_linearVelocity),c=h.m_angularVelocity;h.m_sweep.c0.Copy(h.m_sweep.c),h.m_sweep.a0=h.m_sweep.a,h.m_type===t.b2BodyType.b2_dynamicBody&&(u.x+=_*(h.m_gravityScale*o.x+h.m_invMass*h.m_force.x),u.y+=_*(h.m_gravityScale*o.y+h.m_invMass*h.m_force.y),c+=_*h.m_invI*h.m_torque,u.SelfMul(1/(1+_*h.m_linearDamping)),c*=1/(1+_*h.m_angularDamping)),this.m_positions[m].a=l,this.m_velocities[m].w=c}a.Reset();var f=e.s_solverData;f.step.Copy(s),f.positions=this.m_positions,f.velocities=this.m_velocities;var d=e.s_contactSolverDef;d.step.Copy(s),d.contacts=this.m_contacts,d.count=this.m_contactCount,d.positions=this.m_positions,d.velocities=this.m_velocities;var v=e.s_contactSolver.Initialize(d);v.InitializeVelocityConstraints(),s.warmStarting&&v.WarmStart();for(var x=0;x<this.m_jointCount;++x)this.m_joints[x].InitVelocityConstraints(f);n.solveInit=a.GetMilliseconds(),a.Reset();for(var S=0;S<s.velocityIterations;++S){for(var B=0;B<this.m_jointCount;++B)this.m_joints[B].SolveVelocityConstraints(f);v.SolveVelocityConstraints()}v.StoreImpulses(),n.solveVelocity=a.GetMilliseconds();for(var b=0;b<this.m_bodyCount;++b){var A=this.m_positions[b].c,g=this.m_positions[b].a,C=this.m_velocities[b].v,V=this.m_velocities[b].w,w=X.MulSV(_,C,e.s_translation);if(X.DotVV(w,w)>4){var M=2/w.Length();C.SelfMul(M)}var P=_*V;P*P>y&&(V*=p/G(P)),A.x+=_*C.x,A.y+=_*C.y,g+=_*V,this.m_positions[b].a=g,this.m_velocities[b].w=V}a.Reset();for(var I=!1,F=0;F<s.positionIterations;++F){for(var T=v.SolvePositionConstraints(),L=!0,R=0;R<this.m_jointCount;++R){var k=this.m_joints[R].SolvePositionConstraints(f);L=L&&k}if(T&&L){I=!0;break}}for(var q=0;q<this.m_bodyCount;++q){var z=this.m_bodies[q];z.m_sweep.c.Copy(this.m_positions[q].c),z.m_sweep.a=this.m_positions[q].a,z.m_linearVelocity.Copy(this.m_velocities[q].v),z.m_angularVelocity=this.m_velocities[q].w,z.SynchronizeTransform()}if(n.solvePosition=a.GetMilliseconds(),this.Report(v.m_velocityConstraints),r){for(var j=i,J=0;J<this.m_bodyCount;++J){var E=this.m_bodies[J];E.GetType()!==t.b2BodyType.b2_staticBody&&(!E.m_autoSleepFlag||E.m_angularVelocity*E.m_angularVelocity>.0012184696791469947||X.DotVV(E.m_linearVelocity,E.m_linearVelocity)>1e-4?(E.m_sleepTime=0,j=0):(E.m_sleepTime+=_,j=D(j,E.m_sleepTime)))}if(j>=.5&&I)for(var N=0;N<this.m_bodyCount;++N)this.m_bodies[N].SetAwake(!1)}},n.SolveTOI=function(t,i,n){for(var s=0;s<this.m_bodyCount;++s){var o=this.m_bodies[s];this.m_positions[s].c.Copy(o.m_sweep.c),this.m_positions[s].a=o.m_sweep.a,this.m_velocities[s].v.Copy(o.m_linearVelocity),this.m_velocities[s].w=o.m_angularVelocity}var r=e.s_contactSolverDef;r.contacts=this.m_contacts,r.count=this.m_contactCount,r.step.Copy(t),r.positions=this.m_positions,r.velocities=this.m_velocities;for(var a=e.s_contactSolver.Initialize(r),_=0;_<t.positionIterations&&!a.SolveTOIPositionConstraints(i,n);++_);this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,this.m_bodies[n].m_sweep.c0.Copy(this.m_positions[n].c),this.m_bodies[n].m_sweep.a0=this.m_positions[n].a,a.InitializeVelocityConstraints();for(var m=0;m<t.velocityIterations;++m)a.SolveVelocityConstraints();for(var h=t.dt,l=0;l<this.m_bodyCount;++l){var u=this.m_positions[l].c,c=this.m_positions[l].a,f=this.m_velocities[l].v,d=this.m_velocities[l].w,v=X.MulSV(h,f,e.s_translation);if(X.DotVV(v,v)>4){var x=2/v.Length();f.SelfMul(x)}var S=h*d;S*S>y&&(d*=p/G(S)),u.SelfMulAdd(h,f),c+=h*d,this.m_positions[l].a=c,this.m_velocities[l].w=d;var B=this.m_bodies[l];B.m_sweep.c.Copy(u),B.m_sweep.a=c,B.m_linearVelocity.Copy(f),B.m_angularVelocity=d,B.SynchronizeTransform()}this.Report(a.m_velocityConstraints)},n.Report=function(t){if(null!==this.m_listener)for(var i=0;i<this.m_contactCount;++i){var n=this.m_contacts[i];if(n){var s=t[i],o=e.s_impulse;o.count=s.pointCount;for(var r=0;r<s.pointCount;++r)o.normalImpulses[r]=s.points[r].normalImpulse,o.tangentImpulses[r]=s.points[r].tangentImpulse;this.m_listener.PostSolve(n,o)}}},e}();zn.s_timer=new it,zn.s_solverData=new In,zn.s_contactSolverDef=new Ln,zn.s_contactSolver=new kn,zn.s_translation=new X,zn.s_impulse=new Bn,(qn=t.b2ParticleFlag||(t.b2ParticleFlag={}))[qn.b2_waterParticle=0]="b2_waterParticle",qn[qn.b2_zombieParticle=2]="b2_zombieParticle",qn[qn.b2_wallParticle=4]="b2_wallParticle",qn[qn.b2_springParticle=8]="b2_springParticle",qn[qn.b2_elasticParticle=16]="b2_elasticParticle",qn[qn.b2_viscousParticle=32]="b2_viscousParticle",qn[qn.b2_powderParticle=64]="b2_powderParticle",qn[qn.b2_tensileParticle=128]="b2_tensileParticle",qn[qn.b2_colorMixingParticle=256]="b2_colorMixingParticle",qn[qn.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",qn[qn.b2_barrierParticle=1024]="b2_barrierParticle",qn[qn.b2_staticPressureParticle=2048]="b2_staticPressureParticle",qn[qn.b2_reactiveParticle=4096]="b2_reactiveParticle",qn[qn.b2_repulsiveParticle=8192]="b2_repulsiveParticle",qn[qn.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",qn[qn.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",qn[qn.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",qn[qn.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";var jn=function(){this.flags=0,this.position=new X,this.velocity=new X,this.color=new tt(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null};function Jn(t,e,i){return T(Math.ceil(Math.sqrt(t/(.01*e))*i),1,8)}var En,Nn=function(){function t(){this.m_index=v}var e=t.prototype;return e.GetIndex=function(){return this.m_index},e.SetIndex=function(t){this.m_index=t},t}();(En=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[En.b2_solidParticleGroup=1]="b2_solidParticleGroup",En[En.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",En[En.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",En[En.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",En[En.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",En[En.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";var On=function(){this.flags=0,this.groupFlags=0,this.position=new X,this.angle=0,this.linearVelocity=new X,this.angularVelocity=0,this.color=new tt,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null},Xn=function(){function e(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new X,this.m_linearVelocity=new X,this.m_angularVelocity=0,this.m_transform=new Y,this.m_userData=null,this.m_system=t}var i=e.prototype;return i.GetNext=function(){return this.m_next},i.GetParticleSystem=function(){return this.m_system},i.GetParticleCount=function(){return this.m_lastIndex-this.m_firstIndex},i.GetBufferIndex=function(){return this.m_firstIndex},i.ContainsParticle=function(t){return this.m_firstIndex<=t&&t<this.m_lastIndex},i.GetAllParticleFlags=function(){if(!this.m_system.m_flagsBuffer.data)throw new Error;for(var t=0,e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t},i.GetGroupFlags=function(){return this.m_groupFlags},i.SetGroupFlags=function(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)},i.GetMass=function(){return this.UpdateStatistics(),this.m_mass},i.GetInertia=function(){return this.UpdateStatistics(),this.m_inertia},i.GetCenter=function(){return this.UpdateStatistics(),this.m_center},i.GetLinearVelocity=function(){return this.UpdateStatistics(),this.m_linearVelocity},i.GetAngularVelocity=function(){return this.UpdateStatistics(),this.m_angularVelocity},i.GetTransform=function(){return this.m_transform},i.GetPosition=function(){return this.m_transform.p},i.GetAngle=function(){return this.m_transform.q.GetAngle()},i.GetLinearVelocityFromWorldPoint=function(t,i){var n=e.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),X.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,X.SubVV(t,this.m_center,n),i)},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.ApplyForce=function(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)},i.ApplyLinearImpulse=function(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)},i.DestroyParticles=function(t){if(this.m_system.m_world.IsLocked())throw new Error;for(var e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)},i.UpdateStatistics=function(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var t=new X,e=new X;if(this.m_timestamp!==this.m_system.m_timestamp){var i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var n=this.m_firstIndex;n<this.m_lastIndex;n++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[n]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[n]);if(this.m_mass>0){var s=1/this.m_mass;this.m_center.SelfMul(s),this.m_linearVelocity.SelfMul(s)}this.m_inertia=0,this.m_angularVelocity=0;for(var o=this.m_firstIndex;o<this.m_lastIndex;o++)X.SubVV(this.m_system.m_positionBuffer.data[o],this.m_center,t),X.SubVV(this.m_system.m_velocityBuffer.data[o],this.m_linearVelocity,e),this.m_inertia+=i*X.DotVV(t,t),this.m_angularVelocity+=i*X.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}},e}();Xn.GetLinearVelocityFromWorldPoint_s_t0=new X;var Un=function(){function t(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}var e=t.prototype;return e.Push=function(t){if(this.m_back>=this.m_capacity){for(var e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++},e.Pop=function(){this.m_buffer[this.m_front]=null,this.m_front++},e.Empty=function(){return this.m_front===this.m_back},e.Front=function(){var t=this.m_buffer[this.m_front];if(!t)throw new Error;return t},m(t,[{key:"m_capacity",get:function(){return this.m_buffer.length}}]),t}(),Wn=function(){function t(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=V(t,(function(){return new Zn})),this.m_generatorCapacity=t}var e=t.prototype;return e.AddGenerator=function(t,e,i){var n=this.m_generatorBuffer[this.m_generatorCount++];n.center.Copy(t),n.tag=e,n.necessary=i},e.Generate=function(t,e){for(var i=1/t,n=new X(1e37,1e37),s=new X(-1e37,-1e37),o=0,r=0;r<this.m_generatorCount;r++){var a=this.m_generatorBuffer[r];a.necessary&&(X.MinV(n,a.center,n),X.MaxV(s,a.center,s),++o)}if(0===o)return this.m_countX=0,void(this.m_countY=0);n.x-=e,n.y-=e,s.x+=e,s.y+=e,this.m_countX=1+Math.floor(i*(s.x-n.x)),this.m_countY=1+Math.floor(i*(s.y-n.y)),this.m_diagram=[];for(var _=new Un(4*this.m_countX*this.m_countY),m=0;m<this.m_generatorCount;m++){var h=this.m_generatorBuffer[m];h.center.SelfSub(n).SelfMul(i);var l=Math.floor(h.center.x),u=Math.floor(h.center.y);l>=0&&u>=0&&l<this.m_countX&&u<this.m_countY&&_.Push(new Hn(l,u,l+u*this.m_countX,h))}for(;!_.Empty();){var c=_.Front(),f=c.m_x,d=c.m_y,p=c.m_i,y=c.m_generator;_.Pop(),this.m_diagram[p]||(this.m_diagram[p]=y,f>0&&_.Push(new Hn(f-1,d,p-1,y)),d>0&&_.Push(new Hn(f,d-1,p-this.m_countX,y)),f<this.m_countX-1&&_.Push(new Hn(f+1,d,p+1,y)),d<this.m_countY-1&&_.Push(new Hn(f,d+1,p+this.m_countX,y)))}for(var v=0;v<this.m_countY;v++)for(var x=0;x<this.m_countX-1;x++){var S=x+v*this.m_countX,B=this.m_diagram[S],b=this.m_diagram[S+1];B!==b&&(_.Push(new Hn(x,v,S,b)),_.Push(new Hn(x+1,v,S+1,B)))}for(var A=0;A<this.m_countY-1;A++)for(var g=0;g<this.m_countX;g++){var C=g+A*this.m_countX,V=this.m_diagram[C],w=this.m_diagram[C+this.m_countX];V!==w&&(_.Push(new Hn(g,A,C,w)),_.Push(new Hn(g,A+1,C+this.m_countX,V)))}for(;!_.Empty();){var M=_.Front(),P=M.m_x,I=M.m_y,G=M.m_i,D=M.m_generator;_.Pop();var F=this.m_diagram[G],T=D;if(F!==T){var L=F.center.x-P,R=F.center.y-I,k=T.center.x-P,q=T.center.y-I;L*L+R*R>k*k+q*q&&(this.m_diagram[G]=T,P>0&&_.Push(new Hn(P-1,I,G-1,T)),I>0&&_.Push(new Hn(P,I-1,G-this.m_countX,T)),P<this.m_countX-1&&_.Push(new Hn(P+1,I,G+1,T)),I<this.m_countY-1&&_.Push(new Hn(P,I+1,G+this.m_countX,T)))}}},e.GetNodes=function(t){for(var e=0;e<this.m_countY-1;e++)for(var i=0;i<this.m_countX-1;i++){var n=i+e*this.m_countX,s=this.m_diagram[n],o=this.m_diagram[n+1],r=this.m_diagram[n+this.m_countX],a=this.m_diagram[n+1+this.m_countX];o!==r&&(s!==o&&s!==r&&(s.necessary||o.necessary||r.necessary)&&t(s.tag,o.tag,r.tag),a!==o&&a!==r&&(s.necessary||o.necessary||r.necessary)&&t(o.tag,a.tag,r.tag))}},t}(),Zn=function(){this.center=new X,this.tag=0,this.necessary=!1},Hn=function(t,e,i,n){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=n};function Qn(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function Yn(t,e){return t<e}function Kn(t,e,i,n){void 0===i&&(i=t.length-e),void 0===n&&(n=Yn);for(var s=e,o=[],r=0;;){for(;s+1<i;i++){var a=t[s+Math.floor(Math.random()*(i-s))];o[r++]=i;for(var _=s-1;;){for(;n(t[++_],a););for(;n(a,t[--i]););if(_>=i)break;Qn(t,_,i)}}if(0===r)break;s=i,i=o[--r]}return t}function $n(t,e,i,n){return void 0===i&&(i=t.length-e),void 0===n&&(n=Yn),Kn(t,e,i,n)}function ts(t,e,i){void 0===i&&(i=t.length);for(var n=0,s=0;s<i;++s)e(t[s])||(s!==n?Qn(t,n++,s):++n);return n}function es(t,e,i,n,s){for(var o=i-e;o>0;){var r=Math.floor(o/2),a=e+r;s(t[a],n)?(e=++a,o-=r+1):o=r}return e}function is(t,e,i,n,s){for(var o=i-e;o>0;){var r=Math.floor(o/2),a=e+r;s(n,t[a])?o=r:(e=++a,o-=r+1)}return e}function ns(t,e,i,n){for(var s=i;e!==s;)Qn(t,e++,s++),s===n?s=i:e===i&&(i=s)}function ss(t,e,i,n){if(e===i)return i;for(var s=e;++e!==i;)n(t[s],t[e])||Qn(t,++s,e);return++s}var os=function(){function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}var e=t.prototype;return e.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},e.Reserve=function(t){if(!(this.capacity>=t)){for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},e.Grow=function(){var t=this.capacity?2*this.capacity:B;this.Reserve(t)},e.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},e.Shorten=function(){},e.Data=function(){return this.data},e.GetCount=function(){return this.count},e.SetCount=function(t){this.count=t},e.GetCapacity=function(){return this.capacity},e.RemoveIf=function(t){this.count=ts(this.data,t,this.count)},e.Unique=function(t){this.count=ss(this.data,0,this.count,t)},t}(),rs=function(t){function e(e){var i;return(i=t.call(this)||this).m_system=e,i}h(e,t);var i=e.prototype;return i.ShouldQueryParticleSystem=function(){return!1},i.ReportFixture=function(t){if(t.IsSensor())return!0;for(var e=t.GetShape().GetChildCount(),i=0;i<e;i++)for(var n=t.GetAABB(i),s=this.m_system.GetInsideBoundsEnumerator(n),o=void 0;(o=s.GetNext())>=0;)this.ReportFixtureAndParticle(t,i,o);return!0},i.ReportParticle=function(){return!1},i.ReportFixtureAndParticle=function(){},e}(An),as=function(){function t(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new X,this.flags=0}var e=t.prototype;return e.SetIndices=function(t,e){this.indexA=t,this.indexB=e},e.SetWeight=function(t){this.weight=t},e.SetNormal=function(t){this.normal.Copy(t)},e.SetFlags=function(t){this.flags=t},e.GetIndexA=function(){return this.indexA},e.GetIndexB=function(){return this.indexB},e.GetWeight=function(){return this.weight},e.GetNormal=function(){return this.normal},e.GetFlags=function(){return this.flags},e.IsEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},e.IsNotEqual=function(t){return!this.IsEqual(t)},e.ApproximatelyEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&G(this.weight-t.weight)<.01&&X.DistanceSquaredVV(this.normal,t.normal)<1e-4},t}(),_s=function(){this.index=0,this.weight=0,this.normal=new X,this.mass=0},ms=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0},hs=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new X(0,0),this.pb=new X(0,0),this.pc=new X(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0},ls=function(){function t(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}var e=t.prototype;return e.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},e.Clone=function(){return(new t).Copy(this)},t}(),us=function(){function n(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new cs,this.m_flagsBuffer=new cs,this.m_positionBuffer=new cs,this.m_velocityBuffer=new cs,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new cs,this.m_groupBuffer=[],this.m_userDataBuffer=new cs,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new cs,this.m_bodyContactCountBuffer=new cs,this.m_consecutiveContactStepsBuffer=new cs,this.m_stuckParticleBuffer=new os((function(){return 0})),this.m_proxyBuffer=new os((function(){return new fs})),this.m_contactBuffer=new os((function(){return new as})),this.m_bodyContactBuffer=new os((function(){return new _s})),this.m_pairBuffer=new os((function(){return new ms})),this.m_triadBuffer=new os((function(){return new hs})),this.m_expirationTimeBuffer=new cs,this.m_indexByExpirationTimeBuffer=new cs,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new ls,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}n.computeTag=function(t,e){return(e+n.yOffset>>>0<<n.yShift)+(n.xScale*t+n.xOffset>>>0)>>>0},n.computeRelativeTag=function(t,e,i){return t+(i<<n.yShift)+(e<<n.xShift)>>>0};var s=n.prototype;return s.Drop=function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)},s.CreateParticle=function(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){var i=this.m_count?2*this.m_count:B;this.ReallocateInternalAllocatedBuffers(i)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return v;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var n=this.m_count++;this.m_flagsBuffer.data[n]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=0),this.m_positionBuffer.data[n]=(this.m_positionBuffer.data[n]||new X).Copy(e(t.position,X.ZERO)),this.m_velocityBuffer.data[n]=(this.m_velocityBuffer.data[n]||new X).Copy(e(t.velocity,X.ZERO)),this.m_weightBuffer[n]=0,this.m_forceBuffer[n]=(this.m_forceBuffer[n]||new X).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=0),this.m_depthBuffer&&(this.m_depthBuffer[n]=0);var s=(new tt).Copy(e(t.color,tt.ZERO));!this.m_colorBuffer.data&&s.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[n]=(this.m_colorBuffer.data[n]||new tt).Copy(s)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[n]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[n]=null);var o=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],r=e(t.lifetime,0),a=r>0;(this.m_expirationTimeBuffer.data||a)&&(this.SetParticleLifetime(n,a?r:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[n]=n),o.index=n;var _=e(t.group,null);return this.m_groupBuffer[n]=_,_&&(_.m_firstIndex<_.m_lastIndex?(this.RotateBuffer(_.m_firstIndex,_.m_lastIndex,n),_.m_lastIndex=n+1):(_.m_firstIndex=n,_.m_lastIndex=n+1)),this.SetParticleFlags(n,e(t.flags,0)),n},s.GetParticleHandleFromIndex=function(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var e=this.m_handleIndexBuffer.data[t];return e||((e=new Nn).SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)},s.DestroyParticle=function(e,i){void 0===i&&(i=!1);var n=t.b2ParticleFlag.b2_zombieParticle;i&&(n|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|n)},s.DestroyOldestParticle=function(t,e){void 0===e&&(e=!1);var i=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],s=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[n]>0?n:s,e)},s.DestroyParticlesInShape=function(t,e,i){void 0===i&&(i=!1);var s=n.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;var o=new Bs(this,t,e,i),r=s;return t.ComputeAABB(r,e,0),this.m_world.QueryAABB(o,r),o.Destroyed()},s.CreateParticleGroup=function(t){var i=n.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;var s=i;s.SetPositionAngle(e(t.position,X.ZERO),e(t.angle,0));var o=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,s),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,e(t.shapeCount,t.shapes.length),t,s),t.positionData)for(var r=e(t.particleCount,t.positionData.length),a=0;a<r;a++){var _=t.positionData[a];this.CreateParticleForGroup(t,s,_)}var m=this.m_count,h=new Xn(this);h.m_firstIndex=o,h.m_lastIndex=m,h.m_strength=e(t.strength,1),h.m_userData=t.userData,h.m_transform.Copy(s),h.m_prev=null,h.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=h),this.m_groupList=h,++this.m_groupCount;for(var l=o;l<m;l++)this.m_groupBuffer[l]=h;this.SetGroupFlags(h,e(t.groupFlags,0));var u=new Ss;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(o,m,u),t.group&&(this.JoinParticleGroups(t.group,h),h=t.group),h},s.JoinParticleGroups=function(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);var i=new bs(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(var n=e.m_firstIndex;n<e.m_lastIndex;n++)this.m_groupBuffer[n]=t;var s=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,s),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)},s.SplitParticleGroup=function(t){this.UpdateContacts(!0);var e=V(t.GetParticleCount(),(function(){return new ps}));n.InitializeParticleLists(t,e),this.MergeParticleListsInContact(t,e);var i=n.FindLongestParticleList(t,e);this.MergeZombieParticleListNodes(t,e,i),this.CreateParticleGroupsFromParticleList(t,e,i),this.UpdatePairsAndTriadsWithParticleList(t,e)},s.GetParticleGroupList=function(){return this.m_groupList},s.GetParticleGroupCount=function(){return this.m_groupCount},s.GetParticleCount=function(){return this.m_count},s.GetMaxParticleCount=function(){return this.m_def.maxCount},s.SetMaxParticleCount=function(t){this.m_def.maxCount=t},s.GetAllParticleFlags=function(){return this.m_allParticleFlags},s.GetAllGroupFlags=function(){return this.m_allGroupFlags},s.SetPaused=function(t){this.m_paused=t},s.GetPaused=function(){return this.m_paused},s.SetDensity=function(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density},s.GetDensity=function(){return this.m_def.density},s.SetGravityScale=function(t){this.m_def.gravityScale=t},s.GetGravityScale=function(){return this.m_def.gravityScale},s.SetDamping=function(t){this.m_def.dampingStrength=t},s.GetDamping=function(){return this.m_def.dampingStrength},s.SetStaticPressureIterations=function(t){this.m_def.staticPressureIterations=t},s.GetStaticPressureIterations=function(){return this.m_def.staticPressureIterations},s.SetRadius=function(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter},s.GetRadius=function(){return this.m_particleDiameter/2},s.GetPositionBuffer=function(){return this.m_positionBuffer.data},s.GetVelocityBuffer=function(){return this.m_velocityBuffer.data},s.GetColorBuffer=function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data},s.GetGroupBuffer=function(){return this.m_groupBuffer},s.GetWeightBuffer=function(){return this.m_weightBuffer},s.GetUserDataBuffer=function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data},s.GetFlagsBuffer=function(){return this.m_flagsBuffer.data},s.SetParticleFlags=function(e,i){this.m_flagsBuffer.data[e]&~i&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&i&&(i&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),i&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=i),this.m_flagsBuffer.data[e]=i},s.GetParticleFlags=function(t){return this.m_flagsBuffer.data[t]},s.SetFlagsBuffer=function(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)},s.SetPositionBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,i=new Array(e),n=0;n<e;++n)i[n]=new X(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_positionBuffer,t)},s.SetVelocityBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,i=new Array(e),n=0;n<e;++n)i[n]=new X(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)},s.SetColorBuffer=function(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;for(var e=t.length/4,i=new Array(e),n=0;n<e;++n)i[n]=new tt(t.subarray(4*n,4*n+4));t=i}this.SetUserOverridableBuffer(this.m_colorBuffer,t)},s.SetUserDataBuffer=function(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)},s.GetContacts=function(){return this.m_contactBuffer.data},s.GetContactCount=function(){return this.m_contactBuffer.count},s.GetBodyContacts=function(){return this.m_bodyContactBuffer.data},s.GetBodyContactCount=function(){return this.m_bodyContactBuffer.count},s.GetPairs=function(){return this.m_pairBuffer.data},s.GetPairCount=function(){return this.m_pairBuffer.count},s.GetTriads=function(){return this.m_triadBuffer.data},s.GetTriadCount=function(){return this.m_triadBuffer.count},s.SetStuckThreshold=function(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))},s.GetStuckCandidates=function(){return this.m_stuckParticleBuffer.Data()},s.GetStuckCandidateCount=function(){return this.m_stuckParticleBuffer.GetCount()},s.ComputeCollisionEnergy=function(){for(var t=n.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data,i=0,s=0;s<this.m_contactBuffer.count;s++){var o=this.m_contactBuffer.data[s],r=o.indexA,a=o.indexB,_=o.normal,m=X.SubVV(e[a],e[r],t),h=X.DotVV(m,_);h<0&&(i+=h*h)}return.5*this.GetParticleMass()*i},s.SetStrictContactCheck=function(t){this.m_def.strictContactCheck=t},s.GetStrictContactCheck=function(){return this.m_def.strictContactCheck},s.SetParticleLifetime=function(t,e){var i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i)for(var n=this.GetParticleCount(),s=0;s<n;++s)this.m_indexByExpirationTimeBuffer.data[s]=s;var o=e/this.m_def.lifetimeGranularity,r=o>0?this.GetQuantizedTimeElapsed()+o:o;r!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=r,this.m_expirationTimeBufferRequiresSorting=!0)},s.GetParticleLifetime=function(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])},s.SetDestructionByAge=function(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t},s.GetDestructionByAge=function(){return this.m_def.destroyByAge},s.GetExpirationTimeBuffer=function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data},s.ExpirationTimeToLifetime=function(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity},s.GetIndexByExpirationTimeBuffer=function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data},s.ParticleApplyLinearImpulse=function(t,e){this.ApplyLinearImpulse(t,t+1,e)},s.ApplyLinearImpulse=function(t,e,i){for(var n=this.m_velocityBuffer.data,s=(e-t)*this.GetParticleMass(),o=(new X).Copy(i).SelfMul(1/s),r=t;r<e;r++)n[r].SelfAdd(o)},n.IsSignificantForce=function(t){return 0!==t.x||0!==t.y},s.ParticleApplyForce=function(t,e){n.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))},s.ApplyForce=function(t,e,i){var s=(new X).Copy(i).SelfMul(1/(e-t));if(n.IsSignificantForce(s)){this.PrepareForceBuffer();for(var o=t;o<e;o++)this.m_forceBuffer[o].SelfAdd(s)}},s.GetNext=function(){return this.m_next},s.QueryAABB=function(t,e){if(0!==this.m_proxyBuffer.count)for(var i=this.m_proxyBuffer.count,s=es(this.m_proxyBuffer.data,0,i,n.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),fs.CompareProxyTag),o=is(this.m_proxyBuffer.data,s,i,n.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),fs.CompareTagProxy),r=this.m_positionBuffer.data,a=s;a<o;++a){var _=this.m_proxyBuffer.data[a].index,m=r[_];if(e.lowerBound.x<m.x&&m.x<e.upperBound.x&&e.lowerBound.y<m.y&&m.y<e.upperBound.y&&!t.ReportParticle(this,_))break}},s.QueryShapeAABB=function(t,e,i,s){void 0===s&&(s=0);var o=n.QueryShapeAABB_s_aabb;e.ComputeAABB(o,i,s),this.QueryAABB(t,o)},s.QueryPointAABB=function(t,e,i){void 0===i&&(i=a);var s=n.QueryPointAABB_s_aabb;s.lowerBound.Set(e.x-i,e.y-i),s.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,s)},s.RayCast=function(t,e,i){var s=n.RayCast_s_aabb,o=n.RayCast_s_p,r=n.RayCast_s_v,a=n.RayCast_s_n,_=n.RayCast_s_point;if(0!==this.m_proxyBuffer.count){var m=this.m_positionBuffer.data,h=s;X.MinV(e,i,h.lowerBound),X.MaxV(e,i,h.upperBound);for(var l,u=1,c=X.SubVV(i,e,r),f=X.DotVV(c,c),d=this.GetInsideBoundsEnumerator(h);(l=d.GetNext())>=0;){var p=X.SubVV(e,m[l],o),y=X.DotVV(p,c),v=y*y-f*(X.DotVV(p,p)-this.m_squaredDiameter);if(v>=0){var x=q(v),S=(-y-x)/f;if(S>u)continue;if(S<0&&((S=(-y+x)/f)<0||S>u))continue;var B=X.AddVMulSV(p,S,c,a);if(B.Normalize(),(u=D(u,t.ReportParticle(this,l,X.AddVMulSV(e,S,c,_),B,S)))<=0)break}}}},s.ComputeAABB=function(t){var e=this.GetParticleCount();t.lowerBound.x=1e37,t.lowerBound.y=1e37,t.upperBound.x=-1e37,t.upperBound.y=-1e37;for(var i=this.m_positionBuffer.data,n=0;n<e;n++){var s=i[n];X.MinV(t.lowerBound,s,t.lowerBound),X.MaxV(t.upperBound,s,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter},s.FreeBuffer=function(t){null!==t&&(t.length=0)},s.FreeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)},s.ReallocateBuffer3=function(t,e,i){if(i<=e)throw new Error;var n=t?t.slice():[];return n.length=i,n},s.ReallocateBuffer5=function(t,e,i,n,s){if(n<=i)throw new Error;if(e&&!(n<=e))throw new Error;return s&&!t||e||(t=this.ReallocateBuffer3(t,i,n)),t},s.ReallocateBuffer4=function(t,e,i,n){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,n)},s.RequestBuffer=function(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(B),(t=[]).length=this.m_internalAllocatedCapacity),t},s.ReallocateHandleBuffers=function(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)},s.ReallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);var i=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,i),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,i),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,i),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}},s.CreateParticleForGroup=function(t,i,n){var s=new jn;s.flags=e(t.flags,0),Y.MulXV(i,n,s.position),X.AddVV(e(t.linearVelocity,X.ZERO),X.CrossSV(e(t.angularVelocity,0),X.SubVV(s.position,e(t.position,X.ZERO),X.s_t0),X.s_t0),s.velocity),s.color.Copy(e(t.color,tt.ZERO)),s.lifetime=e(t.lifetime,0),s.userData=t.userData,this.CreateParticle(s)},s.CreateParticlesStrokeShapeForGroup=function(i,s,o){var r=n.CreateParticlesStrokeShapeForGroup_s_edge,a=n.CreateParticlesStrokeShapeForGroup_s_d,_=n.CreateParticlesStrokeShapeForGroup_s_p,m=e(s.stride,0);0===m&&(m=this.GetParticleStride());for(var h=0,l=i.GetChildCount(),u=0;u<l;u++){var c=null;i.GetType()===t.b2ShapeType.e_edgeShape?c=i:(c=r,i.GetChildEdge(c,u));for(var f=X.SubVV(c.m_vertex2,c.m_vertex1,a),d=f.Length();h<d;){var p=X.AddVMulSV(c.m_vertex1,h/d,f,_);this.CreateParticleForGroup(s,o,p),h+=m}h-=d}},s.CreateParticlesFillShapeForGroup=function(t,i,s){var o=n.CreateParticlesFillShapeForGroup_s_aabb,r=n.CreateParticlesFillShapeForGroup_s_p,a=e(i.stride,0);0===a&&(a=this.GetParticleStride());var _=Y.IDENTITY,m=o;t.ComputeAABB(m,_,0);for(var h=Math.floor(m.lowerBound.y/a)*a;h<m.upperBound.y;h+=a)for(var l=Math.floor(m.lowerBound.x/a)*a;l<m.upperBound.x;l+=a){var u=r.Set(l,h);t.TestPoint(_,u)&&this.CreateParticleForGroup(i,s,u)}},s.CreateParticlesWithShapeForGroup=function(e,i,n){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,i,n);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,i,n)}},s.CreateParticlesWithShapesForGroup=function(t,e,i,n){var s=new As(t,e);this.CreateParticlesFillShapeForGroup(s,i,n)},s.CloneParticle=function(t,e){var i=new jn;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;var n=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){var s=this.m_handleIndexBuffer.data[t];s&&s.SetIndex(n),this.m_handleIndexBuffer.data[n]=s,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[n].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[n]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[n]=this.m_expirationTimeBuffer.data[t]),n},s.DestroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)},s.DestroyParticleGroup=function(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(var e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount},n.ParticleCanBeConnected=function(e,i){return!!(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==i&&!!(i.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},s.UpdatePairsAndTriads=function(e,i,s){for(var o=n.UpdatePairsAndTriads_s_dab,r=n.UpdatePairsAndTriads_s_dbc,a=n.UpdatePairsAndTriads_s_dca,_=this.m_positionBuffer.data,m=0,h=e;h<i;h++)m|=this.m_flagsBuffer.data[h];if(m&n.k_pairFlags)for(var l=0;l<this.m_contactBuffer.count;l++){var u=this.m_contactBuffer.data[l],c=u.indexA,f=u.indexB,d=this.m_flagsBuffer.data[c],p=this.m_flagsBuffer.data[f],y=this.m_groupBuffer[c],v=this.m_groupBuffer[f];if(c>=e&&c<i&&f>=e&&f<i&&!((d|p)&t.b2ParticleFlag.b2_zombieParticle)&&(d|p)&n.k_pairFlags&&(s.IsNecessary(c)||s.IsNecessary(f))&&n.ParticleCanBeConnected(d,y)&&n.ParticleCanBeConnected(p,v)&&s.ShouldCreatePair(c,f)){var x=this.m_pairBuffer.data[this.m_pairBuffer.Append()];x.indexA=c,x.indexB=f,x.flags=u.flags,x.strength=D(y?y.m_strength:1,v?v.m_strength:1),x.distance=X.DistanceVV(_[c],_[f])}$n(this.m_pairBuffer.data,0,this.m_pairBuffer.count,n.ComparePairIndices),this.m_pairBuffer.Unique(n.MatchPairIndices)}if(m&n.k_triadFlags){for(var S=new Wn(i-e),B=e;B<i;B++){var b=this.m_flagsBuffer.data[B],A=this.m_groupBuffer[B];b&t.b2ParticleFlag.b2_zombieParticle||!n.ParticleCanBeConnected(b,A)||S.AddGenerator(_[B],B,s.IsNecessary(B))}var g=this.GetParticleStride();S.Generate(g/2,2*g);var C=this;S.GetNodes((function(t,e,i){var m=C.m_flagsBuffer.data[t],h=C.m_flagsBuffer.data[e],l=C.m_flagsBuffer.data[i];if((m|h|l)&n.k_triadFlags&&s.ShouldCreateTriad(t,e,i)){var u=_[t],c=_[e],f=_[i],d=X.SubVV(u,c,o),p=X.SubVV(c,f,r),y=X.SubVV(f,u,a),v=4*C.m_squaredDiameter;if(X.DotVV(d,d)>v||X.DotVV(p,p)>v||X.DotVV(y,y)>v)return;var x=C.m_groupBuffer[t],S=C.m_groupBuffer[e],B=C.m_groupBuffer[i],b=C.m_triadBuffer.data[C.m_triadBuffer.Append()];b.indexA=t,b.indexB=e,b.indexC=i,b.flags=m|h|l,b.strength=D(D(x?x.m_strength:1,S?S.m_strength:1),B?B.m_strength:1);var A=(u.x+c.x+f.x)/3,g=(u.y+c.y+f.y)/3;b.pa.x=u.x-A,b.pa.y=u.y-g,b.pb.x=c.x-A,b.pb.y=c.y-g,b.pc.x=f.x-A,b.pc.y=f.y-g,b.ka=-X.DotVV(y,d),b.kb=-X.DotVV(d,p),b.kc=-X.DotVV(p,y),b.s=X.CrossVV(u,c)+X.CrossVV(c,f)+X.CrossVV(f,u)}})),$n(this.m_triadBuffer.data,0,this.m_triadBuffer.count,n.CompareTriadIndices),this.m_triadBuffer.Unique(n.MatchTriadIndices)}},s.UpdatePairsAndTriadsWithReactiveParticles=function(){var e=new gs(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,e);for(var i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle},n.ComparePairIndices=function(t,e){var i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB},n.MatchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},n.CompareTriadIndices=function(t,e){var i=t.indexA-e.indexA;if(0!==i)return i<0;var n=t.indexB-e.indexB;return 0!==n?n<0:t.indexC<e.indexC},n.MatchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},n.InitializeParticleLists=function(t,e){for(var i=t.GetBufferIndex(),n=t.GetParticleCount(),s=0;s<n;s++){var o=e[s];o.list=o,o.next=null,o.count=1,o.index=s+i}},s.MergeParticleListsInContact=function(t,e){for(var i=t.GetBufferIndex(),s=0;s<this.m_contactBuffer.count;s++){var o=this.m_contactBuffer.data[s],r=o.indexA,a=o.indexB;if(t.ContainsParticle(r)&&t.ContainsParticle(a)){var _=e[r-i].list,m=e[a-i].list;if(_!==m){if(_.count<m.count){var h=_;_=m,m=h}n.MergeParticleLists(_,m)}}}},n.MergeParticleLists=function(t,e){for(var i=e;;){i.list=t;var n=i.next;if(!n){i.next=t.next;break}i=n}t.next=e,t.count+=e.count,e.count=0},n.FindLongestParticleList=function(t,e){for(var i=t.GetParticleCount(),n=e[0],s=0;s<i;s++){var o=e[s];n.count<o.count&&(n=o)}return n},s.MergeZombieParticleListNodes=function(e,i,s){for(var o=e.GetParticleCount(),r=0;r<o;r++){var a=i[r];a!==s&&this.m_flagsBuffer.data[a.index]&t.b2ParticleFlag.b2_zombieParticle&&n.MergeParticleListAndNode(s,a)}},n.MergeParticleListAndNode=function(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},s.CreateParticleGroupsFromParticleList=function(e,i,n){var s=e.GetParticleCount(),o=new On;o.groupFlags=e.GetGroupFlags(),o.userData=e.GetUserData();for(var r=0;r<s;r++){var a=i[r];if(a.count&&a!==n)for(var _=this.CreateParticleGroup(o),m=a;m;m=m.next){var h=m.index,l=this.CloneParticle(h,_);this.m_flagsBuffer.data[h]|=t.b2ParticleFlag.b2_zombieParticle,m.index=l}}},s.UpdatePairsAndTriadsWithParticleList=function(t,e){for(var i=t.GetBufferIndex(),n=0;n<this.m_pairBuffer.count;n++){var s=this.m_pairBuffer.data[n],o=s.indexA,r=s.indexB;t.ContainsParticle(o)&&(s.indexA=e[o-i].index),t.ContainsParticle(r)&&(s.indexB=e[r-i].index)}for(var a=0;a<this.m_triadBuffer.count;a++){var _=this.m_triadBuffer.data[a],m=_.indexA,h=_.indexB,l=_.indexC;t.ContainsParticle(m)&&(_.indexA=e[m-i].index),t.ContainsParticle(h)&&(_.indexB=e[h-i].index),t.ContainsParticle(l)&&(_.indexC=e[l-i].index)}},s.ComputeDepth=function(){for(var e=[],n=0,s=0;s<this.m_contactBuffer.count;s++){var o=this.m_contactBuffer.data[s],r=o.indexA,a=o.indexB,_=this.m_groupBuffer[r],m=this.m_groupBuffer[a];_&&_===m&&_.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[n++]=o)}for(var h=[],l=0,u=this.m_groupList;u;u=u.GetNext())if(u.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){h[l++]=u,this.SetGroupFlags(u,u.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(var c=u.m_firstIndex;c<u.m_lastIndex;c++)this.m_accumulationBuffer[c]=0}for(var f=0;f<n;f++){var d=e[f],p=d.indexA,y=d.indexB,v=d.weight;this.m_accumulationBuffer[p]+=v,this.m_accumulationBuffer[y]+=v}for(var x=0;x<l;x++)for(var S=h[x],B=S.m_firstIndex;B<S.m_lastIndex;B++){var b=this.m_accumulationBuffer[B];this.m_depthBuffer[B]=b<.8?0:i}for(var A=0|q(this.m_count),g=0;g<A;g++){for(var C=!1,V=0;V<n;V++){var w=e[V],M=w.indexA,P=w.indexB,I=1-w.weight,G=this.m_depthBuffer[M],D=this.m_depthBuffer[P],F=D+I,T=G+I;G>F&&(this.m_depthBuffer[M]=F,C=!0),D>T&&(this.m_depthBuffer[P]=T,C=!0)}if(!C)break}for(var L=0;L<l;L++)for(var R=h[L],k=R.m_firstIndex;k<R.m_lastIndex;k++)this.m_depthBuffer[k]<i?this.m_depthBuffer[k]*=this.m_particleDiameter:this.m_depthBuffer[k]=0},s.GetInsideBoundsEnumerator=function(t){var e=n.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=n.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),s=this.m_proxyBuffer.count,o=es(this.m_proxyBuffer.data,0,s,e,fs.CompareProxyTag),r=is(this.m_proxyBuffer.data,0,s,i,fs.CompareTagProxy);return new ds(this,e,i,o,r)},s.UpdateAllParticleFlags=function(){this.m_allParticleFlags=0;for(var t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1},s.UpdateAllGroupFlags=function(){this.m_allGroupFlags=0;for(var t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1},s.AddContact=function(t,e){var i=this.m_flagsBuffer.data,s=this.m_positionBuffer.data,o=X.SubVV(s[e],s[t],n.AddContact_s_d),r=X.DotVV(o,o);if(0<r&&r<this.m_squaredDiameter){var a=k(r),_=this.m_contactBuffer.data[this.m_contactBuffer.Append()];_.indexA=t,_.indexB=e,_.flags=i[t]|i[e],_.weight=1-r*a*this.m_inverseDiameter,_.normal.x=a*o.x,_.normal.y=a*o.y}},s.FindContacts_Reference=function(){var t=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(var e=0,i=0;e<t;e++){for(var s=n.computeRelativeTag(this.m_proxyBuffer.data[e].tag,1,0),o=e+1;o<t&&!(s<this.m_proxyBuffer.data[o].tag);o++)this.AddContact(this.m_proxyBuffer.data[e].index,this.m_proxyBuffer.data[o].index,this.m_contactBuffer);for(var r=n.computeRelativeTag(this.m_proxyBuffer.data[e].tag,-1,1);i<t&&!(r<=this.m_proxyBuffer.data[i].tag);i++);for(var a=n.computeRelativeTag(this.m_proxyBuffer.data[e].tag,1,1),_=i;_<t&&!(a<this.m_proxyBuffer.data[_].tag);_++)this.AddContact(this.m_proxyBuffer.data[e].index,this.m_proxyBuffer.data[_].index,this.m_contactBuffer)}},s.FindContacts=function(t){this.FindContacts_Reference(t)},s.UpdateProxies_Reference=function(){for(var t=this.m_positionBuffer.data,e=this.m_inverseDiameter,i=0;i<this.m_proxyBuffer.count;++i){var s=this.m_proxyBuffer.data[i],o=t[s.index];s.tag=n.computeTag(e*o.x,e*o.y)}},s.UpdateProxies=function(t){this.UpdateProxies_Reference(t)},s.SortProxies=function(){Kn(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,fs.CompareProxyProxy)},s.FilterContacts=function(){var e=this.GetParticleContactFilter();if(null!==e){var i=this;this.m_contactBuffer.RemoveIf((function(n){return!!(n.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!e.ShouldCollideParticleParticle(i,n.indexA,n.indexB)}))}},s.NotifyContactListenerPreContact=function(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error},s.NotifyContactListenerPostContact=function(){var t=this.GetParticleContactListener();if(null!==t){for(var e=0;e<this.m_contactBuffer.count;++e){var i=this.m_contactBuffer.data[e];t.BeginContactParticleParticle(this,i)}throw new Error}},n.b2ParticleContactIsZombie=function(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle},s.UpdateContacts=function(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var e=new xs;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(n.b2ParticleContactIsZombie)},s.NotifyBodyContactListenerPreContact=function(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error},s.NotifyBodyContactListenerPostContact=function(){var t=this.GetFixtureContactListener();if(null!==t){for(var e=0;e<this.m_bodyContactBuffer.count;e++){var i=this.m_bodyContactBuffer.data[e];t.BeginContactFixtureParticle(this,i)}throw new Error}},s.UpdateBodyContacts=function(){var t=n.UpdateBodyContacts_s_aabb,e=new vs;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0)for(var i=this.GetParticleCount(),s=0;s<i;s++)this.m_bodyContactCountBuffer.data[s]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[s]+1&&(this.m_consecutiveContactStepsBuffer.data[s]=0);this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var o=t;this.ComputeAABB(o),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new Cs(this));var r=this.UpdateBodyContacts_callback;r.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(r,o),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)},s.Solve=function(e){var i=n.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(e),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<e.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var s=i.Copy(e);s.dt/=e.particleIterations,s.inv_dt*=e.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(s),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(s),this.SolvePressure(s),this.SolveDamping(s),this.m_allParticleFlags&n.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(s),this.LimitVelocity(s),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(s),this.SolveCollision(s),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(s),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(var o=0;o<this.m_count;o++)this.m_positionBuffer.data[o].SelfMulAdd(s.dt,this.m_velocityBuffer.data[o])}},s.SolveCollision=function(t){var e=n.SolveCollision_s_aabb,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,o=e;o.lowerBound.x=1e37,o.lowerBound.y=1e37,o.upperBound.x=-1e37,o.upperBound.y=-1e37;for(var r=0;r<this.m_count;r++){var a=s[r],_=i[r],m=_.x+t.dt*a.x,h=_.y+t.dt*a.y;o.lowerBound.x=D(o.lowerBound.x,D(_.x,m)),o.lowerBound.y=D(o.lowerBound.y,D(_.y,h)),o.upperBound.x=F(o.upperBound.x,F(_.x,m)),o.upperBound.y=F(o.upperBound.y,F(_.y,h))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new Vs(this,t));var l=this.SolveCollision_callback;l.m_step=t,this.m_world.QueryAABB(l,o)},s.LimitVelocity=function(t){for(var e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t),n=0;n<this.m_count;n++){var s=e[n],o=X.DotVV(s,s);o>i&&s.SelfMul(q(i/o))}},s.SolveGravity=function(t){for(var e=n.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,s=X.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e),o=0;o<this.m_count;o++)i[o].SelfAdd(s)},s.SolveBarrier=function(e){for(var i=n.SolveBarrier_s_aabb,s=n.SolveBarrier_s_va,o=n.SolveBarrier_s_vb,r=n.SolveBarrier_s_pba,a=n.SolveBarrier_s_vba,_=n.SolveBarrier_s_vc,m=n.SolveBarrier_s_pca,h=n.SolveBarrier_s_vca,l=n.SolveBarrier_s_qba,u=n.SolveBarrier_s_qca,c=n.SolveBarrier_s_dv,f=n.SolveBarrier_s_f,d=this.m_positionBuffer.data,p=this.m_velocityBuffer.data,y=0;y<this.m_count;y++)this.m_flagsBuffer.data[y]&n.k_barrierWallFlags&&p[y].SetZero();for(var v=2.5*e.dt,x=this.GetParticleMass(),S=0;S<this.m_pairBuffer.count;S++){var B=this.m_pairBuffer.data[S];if(B.flags&t.b2ParticleFlag.b2_barrierParticle){var b=B.indexA,A=B.indexB,g=d[b],C=d[A],V=i;X.MinV(g,C,V.lowerBound),X.MaxV(g,C,V.upperBound);for(var w=this.m_groupBuffer[b],M=this.m_groupBuffer[A],P=this.GetLinearVelocity(w,b,g,s),I=this.GetLinearVelocity(M,A,C,o),G=X.SubVV(C,g,r),D=X.SubVV(I,P,a),F=this.GetInsideBoundsEnumerator(V),T=void 0;(T=F.GetNext())>=0;){var L=d[T],R=this.m_groupBuffer[T];if(w!==R&&M!==R){var k=this.GetLinearVelocity(R,T,L,_),z=X.SubVV(L,g,m),j=X.SubVV(k,P,h),J=X.CrossVV(D,j),E=X.CrossVV(G,j)-X.CrossVV(z,D),N=X.CrossVV(G,z),O=void 0,U=void 0,W=l,Z=u;if(0===J){if(0===E)continue;if(!((U=-N/E)>=0&&U<v))continue;if(X.AddVMulSV(G,U,D,W),X.AddVMulSV(z,U,j,Z),!((O=X.DotVV(W,Z)/X.DotVV(W,W))>=0&&O<=1))continue}else{var H=E*E-4*N*J;if(H<0)continue;var Q=q(H),Y=(-E-Q)/(2*J),K=(-E+Q)/(2*J);if(Y>K){var $=Y;Y=K,K=$}if(U=Y,X.AddVMulSV(G,U,D,W),X.AddVMulSV(z,U,j,Z),O=X.DotVV(W,Z)/X.DotVV(W,W),!(U>=0&&U<v&&O>=0&&O<=1)){if(!((U=K)>=0&&U<v))continue;if(X.AddVMulSV(G,U,D,W),X.AddVMulSV(z,U,j,Z),!((O=X.DotVV(W,Z)/X.DotVV(W,W))>=0&&O<=1))continue}}var tt=c;tt.x=P.x+O*D.x-k.x,tt.y=P.y+O*D.y-k.y;var et=X.MulSV(x,tt,f);if(R&&this.IsRigidGroup(R)){var it=R.GetMass(),nt=R.GetInertia();it>0&&R.m_linearVelocity.SelfMulAdd(1/it,et),nt>0&&(R.m_angularVelocity+=X.CrossVV(X.SubVV(L,R.GetCenter(),X.s_t0),et)/nt)}else p[T].SelfAdd(tt);this.ParticleApplyForce(T,et.SelfMul(-e.inv_dt))}}}}},s.SolveStaticPressure=function(e){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var i=this.GetCriticalPressure(e),n=this.m_def.staticPressureStrength*i,s=S*i,o=this.m_def.staticPressureRelaxation,r=0;r<this.m_def.staticPressureIterations;r++){for(var a=0;a<this.m_count;a++)this.m_accumulationBuffer[a]=0;for(var _=0;_<this.m_contactBuffer.count;_++){var m=this.m_contactBuffer.data[_];if(m.flags&t.b2ParticleFlag.b2_staticPressureParticle){var h=m.indexA,l=m.indexB,u=m.weight;this.m_accumulationBuffer[h]+=u*this.m_staticPressureBuffer[l],this.m_accumulationBuffer[l]+=u*this.m_staticPressureBuffer[h]}}for(var c=0;c<this.m_count;c++){var f=this.m_weightBuffer[c];if(this.m_flagsBuffer.data[c]&t.b2ParticleFlag.b2_staticPressureParticle){var d=(this.m_accumulationBuffer[c]+n*(f-1))/(f+o);this.m_staticPressureBuffer[c]=T(d,0,s)}else this.m_staticPressureBuffer[c]=0}}},s.ComputeWeight=function(){for(var t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(var e=0;e<this.m_bodyContactBuffer.count;e++){var i=this.m_bodyContactBuffer.data[e],n=i.index,s=i.weight;this.m_weightBuffer[n]+=s}for(var o=0;o<this.m_contactBuffer.count;o++){var r=this.m_contactBuffer.data[o],a=r.indexA,_=r.indexB,m=r.weight;this.m_weightBuffer[a]+=m,this.m_weightBuffer[_]+=m}},s.SolvePressure=function(e){for(var i=n.SolvePressure_s_f,s=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,r=this.GetCriticalPressure(e),a=this.m_def.pressureStrength*r,_=S*r,m=0;m<this.m_count;m++){var h=a*F(0,this.m_weightBuffer[m]-1);this.m_accumulationBuffer[m]=D(h,_)}if(this.m_allParticleFlags&n.k_noPressureFlags)for(var l=0;l<this.m_count;l++)this.m_flagsBuffer.data[l]&n.k_noPressureFlags&&(this.m_accumulationBuffer[l]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(var u=0;u<this.m_count;u++)this.m_flagsBuffer.data[u]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[u]+=this.m_staticPressureBuffer[u]);for(var c=e.dt/(this.m_def.density*this.m_particleDiameter),f=this.GetParticleInvMass(),d=0;d<this.m_bodyContactBuffer.count;d++){var p=this.m_bodyContactBuffer.data[d],y=p.index,v=p.body,x=p.weight,B=p.mass,b=p.normal,A=s[y],g=this.m_accumulationBuffer[y]+a*x,C=X.MulSV(c*x*B*g,b,i);o[y].SelfMulSub(f,C),v.ApplyLinearImpulse(C,A,!0)}for(var V=0;V<this.m_contactBuffer.count;V++){var w=this.m_contactBuffer.data[V],M=w.indexA,P=w.indexB,I=w.weight,G=w.normal,T=this.m_accumulationBuffer[M]+this.m_accumulationBuffer[P],L=X.MulSV(c*I*T,G,i);o[M].SelfSub(L),o[P].SelfAdd(L)}},s.SolveDamping=function(t){for(var e=n.SolveDamping_s_v,i=n.SolveDamping_s_f,s=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,r=this.m_def.dampingStrength,a=1/this.GetCriticalVelocity(t),_=this.GetParticleInvMass(),m=0;m<this.m_bodyContactBuffer.count;m++){var h=this.m_bodyContactBuffer.data[m],l=h.index,u=h.body,c=h.weight,f=h.mass,d=h.normal,p=s[l],y=X.SubVV(u.GetLinearVelocityFromWorldPoint(p,X.s_t0),o[l],e),v=X.DotVV(y,d);if(v<0){var x=F(r*c,D(-a*v,.5)),S=X.MulSV(x*f*v,d,i);o[l].SelfMulAdd(_,S),u.ApplyLinearImpulse(S.SelfNeg(),p,!0)}}for(var B=0;B<this.m_contactBuffer.count;B++){var b=this.m_contactBuffer.data[B],A=b.indexA,g=b.indexB,C=b.weight,V=b.normal,w=X.SubVV(o[g],o[A],e),M=X.DotVV(w,V);if(M<0){var P=F(r*C,D(-a*M,.5)),I=X.MulSV(P*M,V,i);o[A].SelfAdd(I),o[g].SelfSub(I)}}},s.SolveRigidDamping=function(){for(var t=n.SolveRigidDamping_s_t0,e=n.SolveRigidDamping_s_t1,i=n.SolveRigidDamping_s_p,s=n.SolveRigidDamping_s_v,o=[0],r=[0],a=[0],_=[0],m=[0],h=[0],l=this.m_positionBuffer.data,u=this.m_def.dampingStrength,c=0;c<this.m_bodyContactBuffer.count;c++){var f=this.m_bodyContactBuffer.data[c],d=f.index,p=this.m_groupBuffer[d];if(p&&this.IsRigidGroup(p)){var y=f.body,v=f.normal,x=f.weight,S=l[d],B=X.SubVV(y.GetLinearVelocityFromWorldPoint(S,t),p.GetLinearVelocityFromWorldPoint(S,e),s),b=X.DotVV(B,v);if(b<0){this.InitDampingParameterWithRigidGroupOrParticle(o,r,a,!0,p,d,S,v),this.InitDampingParameter(_,m,h,y.GetMass(),y.GetInertia()-y.GetMass()*y.GetLocalCenter().LengthSquared(),y.GetWorldCenter(),S,v);var A=u*D(x,1)*this.ComputeDampingImpulse(o[0],r[0],a[0],_[0],m[0],h[0],b);this.ApplyDamping(o[0],r[0],a[0],!0,p,d,A,v),y.ApplyLinearImpulse(X.MulSV(-A,v,X.s_t0),S,!0)}}}for(var g=0;g<this.m_contactBuffer.count;g++){var C=this.m_contactBuffer.data[g],V=C.indexA,w=C.indexB,M=C.normal,P=C.weight,I=this.m_groupBuffer[V],G=this.m_groupBuffer[w],F=this.IsRigidGroup(I),T=this.IsRigidGroup(G);if(I!==G&&(F||T)){var L=X.MidVV(l[V],l[w],i),R=X.SubVV(this.GetLinearVelocity(G,w,L,t),this.GetLinearVelocity(I,V,L,e),s),k=X.DotVV(R,M);if(k<0){this.InitDampingParameterWithRigidGroupOrParticle(o,r,a,F,I,V,L,M),this.InitDampingParameterWithRigidGroupOrParticle(_,m,h,T,G,w,L,M);var q=u*P*this.ComputeDampingImpulse(o[0],r[0],a[0],_[0],m[0],h[0],k);this.ApplyDamping(o[0],r[0],a[0],F,I,V,q,M),this.ApplyDamping(_[0],m[0],h[0],T,G,w,-q,M)}}}},s.SolveExtraDamping=function(){for(var t=n.SolveExtraDamping_s_v,e=n.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,s=this.m_positionBuffer.data,o=this.GetParticleInvMass(),r=0;r<this.m_bodyContactBuffer.count;r++){var a=this.m_bodyContactBuffer.data[r],_=a.index;if(this.m_flagsBuffer.data[_]&n.k_extraDampingFlags){var m=a.body,h=a.mass,l=a.normal,u=s[_],c=X.SubVV(m.GetLinearVelocityFromWorldPoint(u,X.s_t0),i[_],t),f=X.DotVV(c,l);if(f<0){var d=X.MulSV(.5*h*f,l,e);i[_].SelfMulAdd(o,d),m.ApplyLinearImpulse(d.SelfNeg(),u,!0)}}}},s.SolveWall=function(){for(var e=this.m_velocityBuffer.data,i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&t.b2ParticleFlag.b2_wallParticle&&e[i].SetZero()},s.SolveRigid=function(e){for(var i=n.SolveRigid_s_position,s=n.SolveRigid_s_rotation,o=n.SolveRigid_s_transform,r=n.SolveRigid_s_velocityTransform,a=this.m_positionBuffer.data,_=this.m_velocityBuffer.data,m=this.m_groupList;m;m=m.GetNext())if(m.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){m.UpdateStatistics();var h=s;h.SetAngle(e.dt*m.m_angularVelocity);var l=X.AddVV(m.m_center,X.SubVV(X.MulSV(e.dt,m.m_linearVelocity,X.s_t0),Q.MulRV(h,m.m_center,X.s_t1),X.s_t0),i),u=o;u.SetPositionRotation(l,h),Y.MulXX(u,m.m_transform,m.m_transform);var c=r;c.p.x=e.inv_dt*u.p.x,c.p.y=e.inv_dt*u.p.y,c.q.s=e.inv_dt*u.q.s,c.q.c=e.inv_dt*(u.q.c-1);for(var f=m.m_firstIndex;f<m.m_lastIndex;f++)Y.MulXV(c,a[f],_[f])}},s.SolveElastic=function(e){for(var i=n.SolveElastic_s_pa,s=n.SolveElastic_s_pb,o=n.SolveElastic_s_pc,r=n.SolveElastic_s_r,a=n.SolveElastic_s_t0,_=this.m_positionBuffer.data,m=this.m_velocityBuffer.data,h=e.inv_dt*this.m_def.elasticStrength,l=0;l<this.m_triadBuffer.count;l++){var u=this.m_triadBuffer.data[l];if(u.flags&t.b2ParticleFlag.b2_elasticParticle){var c=u.indexA,f=u.indexB,d=u.indexC,p=u.pa,y=u.pb,v=u.pc,x=i.Copy(_[c]),S=s.Copy(_[f]),B=o.Copy(_[d]),b=m[c],A=m[f],g=m[d];x.SelfMulAdd(e.dt,b),S.SelfMulAdd(e.dt,A),B.SelfMulAdd(e.dt,g);var C=(x.x+S.x+B.x)/3,V=(x.y+S.y+B.y)/3;x.x-=C,x.y-=V,S.x-=C,S.y-=V,B.x-=C,B.y-=V;var w=r;w.s=X.CrossVV(p,x)+X.CrossVV(y,S)+X.CrossVV(v,B),w.c=X.DotVV(p,x)+X.DotVV(y,S)+X.DotVV(v,B);var M=k(w.s*w.s+w.c*w.c);isFinite(M)||(M=198177537e11),w.s*=M,w.c*=M;var P=h*u.strength;Q.MulRV(w,p,a),X.SubVV(a,x,a),X.MulSV(P,a,a),b.SelfAdd(a),Q.MulRV(w,y,a),X.SubVV(a,S,a),X.MulSV(P,a,a),A.SelfAdd(a),Q.MulRV(w,v,a),X.SubVV(a,B,a),X.MulSV(P,a,a),g.SelfAdd(a)}}},s.SolveSpring=function(e){for(var i=n.SolveSpring_s_pa,s=n.SolveSpring_s_pb,o=n.SolveSpring_s_d,r=n.SolveSpring_s_f,a=this.m_positionBuffer.data,_=this.m_velocityBuffer.data,m=e.inv_dt*this.m_def.springStrength,h=0;h<this.m_pairBuffer.count;h++){var l=this.m_pairBuffer.data[h];if(l.flags&t.b2ParticleFlag.b2_springParticle){var u=l.indexA,c=l.indexB,f=i.Copy(a[u]),d=s.Copy(a[c]),p=_[u],y=_[c];f.SelfMulAdd(e.dt,p),d.SelfMulAdd(e.dt,y);var v=X.SubVV(d,f,o),x=l.distance,S=v.Length(),B=m*l.strength,b=X.MulSV(B*(x-S)/S,v,r);p.SelfSub(b),y.SelfAdd(b)}}},s.SolveTensile=function(e){for(var i=n.SolveTensile_s_weightedNormal,s=n.SolveTensile_s_s,o=n.SolveTensile_s_f,r=this.m_velocityBuffer.data,a=0;a<this.m_count;a++)this.m_accumulation2Buffer[a]=new X,this.m_accumulation2Buffer[a].SetZero();for(var _=0;_<this.m_contactBuffer.count;_++){var m=this.m_contactBuffer.data[_];if(m.flags&t.b2ParticleFlag.b2_tensileParticle){var h=m.indexA,l=m.indexB,u=m.weight,c=m.normal,f=X.MulSV((1-u)*u,c,i);this.m_accumulation2Buffer[h].SelfSub(f),this.m_accumulation2Buffer[l].SelfAdd(f)}}for(var d=this.GetCriticalVelocity(e),p=this.m_def.surfaceTensionPressureStrength*d,y=this.m_def.surfaceTensionNormalStrength*d,v=.5*d,x=0;x<this.m_contactBuffer.count;x++){var S=this.m_contactBuffer.data[x];if(S.flags&t.b2ParticleFlag.b2_tensileParticle){var B=S.indexA,b=S.indexB,A=S.weight,g=S.normal,C=this.m_weightBuffer[B]+this.m_weightBuffer[b],V=X.SubVV(this.m_accumulation2Buffer[b],this.m_accumulation2Buffer[B],s),w=D(p*(C-2)+y*X.DotVV(V,g),v)*A,M=X.MulSV(w,g,o);r[B].SelfSub(M),r[b].SelfAdd(M)}}},s.SolveViscous=function(){for(var e=n.SolveViscous_s_v,i=n.SolveViscous_s_f,s=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,r=this.m_def.viscousStrength,a=this.GetParticleInvMass(),_=0;_<this.m_bodyContactBuffer.count;_++){var m=this.m_bodyContactBuffer.data[_],h=m.index;if(this.m_flagsBuffer.data[h]&t.b2ParticleFlag.b2_viscousParticle){var l=m.body,u=m.weight,c=m.mass,f=s[h],d=X.SubVV(l.GetLinearVelocityFromWorldPoint(f,X.s_t0),o[h],e),p=X.MulSV(r*c*u,d,i);o[h].SelfMulAdd(a,p),l.ApplyLinearImpulse(p.SelfNeg(),f,!0)}}for(var y=0;y<this.m_contactBuffer.count;y++){var v=this.m_contactBuffer.data[y];if(v.flags&t.b2ParticleFlag.b2_viscousParticle){var x=v.indexA,S=v.indexB,B=v.weight,b=X.SubVV(o[S],o[x],e),A=X.MulSV(r*B,b,i);o[x].SelfAdd(A),o[S].SelfSub(A)}}},s.SolveRepulsive=function(e){for(var i=n.SolveRepulsive_s_f,s=this.m_velocityBuffer.data,o=this.m_def.repulsiveStrength*this.GetCriticalVelocity(e),r=0;r<this.m_contactBuffer.count;r++){var a=this.m_contactBuffer.data[r];if(a.flags&t.b2ParticleFlag.b2_repulsiveParticle){var _=a.indexA,m=a.indexB;if(this.m_groupBuffer[_]!==this.m_groupBuffer[m]){var h=a.weight,l=a.normal,u=X.MulSV(o*h,l,i);s[_].SelfSub(u),s[m].SelfAdd(u)}}}},s.SolvePowder=function(e){for(var i=n.SolvePowder_s_f,s=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,r=this.m_def.powderStrength*this.GetCriticalVelocity(e),a=.25,_=this.GetParticleInvMass(),m=0;m<this.m_bodyContactBuffer.count;m++){var h=this.m_bodyContactBuffer.data[m],l=h.index;if(this.m_flagsBuffer.data[l]&t.b2ParticleFlag.b2_powderParticle){var u=h.weight;if(u>a){var c=h.body,f=h.mass,d=s[l],p=h.normal,y=X.MulSV(r*f*(u-a),p,i);o[l].SelfMulSub(_,y),c.ApplyLinearImpulse(y,d,!0)}}}for(var v=0;v<this.m_contactBuffer.count;v++){var x=this.m_contactBuffer.data[v];if(x.flags&t.b2ParticleFlag.b2_powderParticle){var S=x.weight;if(S>a){var B=x.indexA,b=x.indexB,A=x.normal,g=X.MulSV(r*(S-a),A,i);o[B].SelfSub(g),o[b].SelfAdd(g)}}}},s.SolveSolid=function(t){var e=n.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var s=t.inv_dt*this.m_def.ejectionStrength,o=0;o<this.m_contactBuffer.count;o++){var r=this.m_contactBuffer.data[o],a=r.indexA,_=r.indexB;if(this.m_groupBuffer[a]!==this.m_groupBuffer[_]){var m=r.weight,h=r.normal,l=this.m_depthBuffer[a]+this.m_depthBuffer[_],u=X.MulSV(s*l*m,h,e);i[a].SelfSub(u),i[_].SelfAdd(u)}}},s.SolveForce=function(t){for(var e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass(),n=0;n<this.m_count;n++)e[n].SelfMulAdd(i,this.m_forceBuffer[n]);this.m_hasForce=!1},s.SolveColorMixing=function(){var e=.5*this.m_def.colorMixingStrength;if(e)for(var i=0;i<this.m_contactBuffer.count;i++){var n=this.m_contactBuffer.data[i],s=n.indexA,o=n.indexB;if(this.m_flagsBuffer.data[s]&this.m_flagsBuffer.data[o]&t.b2ParticleFlag.b2_colorMixingParticle){var r=this.m_colorBuffer.data[s],a=this.m_colorBuffer.data[o];tt.MixColors(r,a,e)}}},s.SolveZombie=function(){for(var e=0,i=[],n=0;n<this.m_count;n++)i[n]=v;for(var s=0,o=0;o<this.m_count;o++){var r=this.m_flagsBuffer.data[o];if(r&t.b2ParticleFlag.b2_zombieParticle){var a=this.m_world.m_destructionListener;if(r&t.b2ParticleFlag.b2_destructionListenerParticle&&a&&a.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data){var _=this.m_handleIndexBuffer.data[o];_&&(_.SetIndex(v),this.m_handleIndexBuffer.data[o]=null)}i[o]=v}else{if(i[o]=e,o!==e){if(this.m_handleIndexBuffer.data){var m=this.m_handleIndexBuffer.data[o];m&&m.SetIndex(e),this.m_handleIndexBuffer.data[e]=m}this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[e]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[o])}e++,s|=r}}for(var h={IsProxyInvalid:function(t){return t.index<0},IsContactInvalid:function(t){return t.indexA<0||t.indexB<0},IsBodyContactInvalid:function(t){return t.index<0},IsPairInvalid:function(t){return t.indexA<0||t.indexB<0},IsTriadInvalid:function(t){return t.indexA<0||t.indexB<0||t.indexC<0}},l=0;l<this.m_proxyBuffer.count;l++){var u=this.m_proxyBuffer.data[l];u.index=i[u.index]}this.m_proxyBuffer.RemoveIf(h.IsProxyInvalid);for(var c=0;c<this.m_contactBuffer.count;c++){var f=this.m_contactBuffer.data[c];f.indexA=i[f.indexA],f.indexB=i[f.indexB]}this.m_contactBuffer.RemoveIf(h.IsContactInvalid);for(var d=0;d<this.m_bodyContactBuffer.count;d++){var p=this.m_bodyContactBuffer.data[d];p.index=i[p.index]}this.m_bodyContactBuffer.RemoveIf(h.IsBodyContactInvalid);for(var y=0;y<this.m_pairBuffer.count;y++){var x=this.m_pairBuffer.data[y];x.indexA=i[x.indexA],x.indexB=i[x.indexB]}this.m_pairBuffer.RemoveIf(h.IsPairInvalid);for(var S=0;S<this.m_triadBuffer.count;S++){var B=this.m_triadBuffer.data[S];B.indexA=i[B.indexA],B.indexB=i[B.indexB],B.indexC=i[B.indexC]}if(this.m_triadBuffer.RemoveIf(h.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data)for(var b=0,A=0;A<this.m_count;A++){var g=i[this.m_indexByExpirationTimeBuffer.data[A]];g!==v&&(this.m_indexByExpirationTimeBuffer.data[b++]=g)}for(var C=this.m_groupList;C;C=C.GetNext()){for(var V=e,w=0,M=!1,P=C.m_firstIndex;P<C.m_lastIndex;P++){var I=i[P];I>=0?(V=D(V,I),w=F(w,I+1)):M=!0}V<w?(C.m_firstIndex=V,C.m_lastIndex=w,M&&C.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(C,C.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(C.m_firstIndex=0,C.m_lastIndex=0,C.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(C,C.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=e,this.m_allParticleFlags=s,this.m_needsUpdateAllParticleFlags=!1;for(var G=this.m_groupList;G;){var T=G.GetNext();G.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(G),G=T}},s.SolveLifetimes=function(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);var e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,n=this.m_indexByExpirationTimeBuffer.data,s=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(Kn(n,0,s,(function(t,e){var n=i[t],s=i[e],o=n<=0;return o===s<=0?n>s:o})),this.m_expirationTimeBufferRequiresSorting=!1);for(var o=s-1;o>=0;--o){var r=n[o],a=i[r];if(e<a||a<=0)break;this.DestroyParticle(r)}},s.RotateBuffer=function(t,e,i){if(t!==e&&e!==i){if(ns(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&ns(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&ns(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&ns(this.m_consecutiveContactStepsBuffer.data,t,e,i),ns(this.m_positionBuffer.data,t,e,i),ns(this.m_velocityBuffer.data,t,e,i),ns(this.m_groupBuffer,t,e,i),this.m_hasForce&&ns(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&ns(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&ns(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&ns(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&ns(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){ns(this.m_handleIndexBuffer.data,t,e,i);for(var n=t;n<i;++n){var s=this.m_handleIndexBuffer.data[n];s&&s.SetIndex(x(s.GetIndex()))}}if(this.m_expirationTimeBuffer.data){ns(this.m_expirationTimeBuffer.data,t,e,i);for(var o=this.GetParticleCount(),r=this.m_indexByExpirationTimeBuffer.data,a=0;a<o;++a)r[a]=x(r[a])}for(var _=0;_<this.m_proxyBuffer.count;_++){var m=this.m_proxyBuffer.data[_];m.index=x(m.index)}for(var h=0;h<this.m_contactBuffer.count;h++){var l=this.m_contactBuffer.data[h];l.indexA=x(l.indexA),l.indexB=x(l.indexB)}for(var u=0;u<this.m_bodyContactBuffer.count;u++){var c=this.m_bodyContactBuffer.data[u];c.index=x(c.index)}for(var f=0;f<this.m_pairBuffer.count;f++){var d=this.m_pairBuffer.data[f];d.indexA=x(d.indexA),d.indexB=x(d.indexB)}for(var p=0;p<this.m_triadBuffer.count;p++){var y=this.m_triadBuffer.data[p];y.indexA=x(y.indexA),y.indexB=x(y.indexB),y.indexC=x(y.indexC)}for(var v=this.m_groupList;v;v=v.GetNext())v.m_firstIndex=x(v.m_firstIndex),v.m_lastIndex=x(v.m_lastIndex-1)+1}function x(n){return n<t?n:n<e?n+i-e:n<i?n+t-e:n}},s.GetCriticalVelocity=function(t){return this.m_particleDiameter*t.inv_dt},s.GetCriticalVelocitySquared=function(t){var e=this.GetCriticalVelocity(t);return e*e},s.GetCriticalPressure=function(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)},s.GetParticleStride=function(){return x*this.m_particleDiameter},s.GetParticleMass=function(){var t=this.GetParticleStride();return this.m_def.density*t*t},s.GetParticleInvMass=function(){var t=1.3333333333333333*this.m_inverseDiameter;return this.m_inverseDensity*t*t},s.GetFixtureContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},s.GetParticleContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},s.GetFixtureContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},s.GetParticleContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},s.SetUserOverridableBuffer=function(t,e){t.data=e,t.userSuppliedCapacity=e.length},s.SetGroupFlags=function(e,i){var n=e.m_groupFlags;(n^i)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(i|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),n&~i&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&i&&(i&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=i),e.m_groupFlags=i},n.BodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},s.RemoveSpuriousBodyContacts=function(){Kn(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,n.BodyContactCompare);var t=n.RemoveSpuriousBodyContacts_s_n,e=n.RemoveSpuriousBodyContacts_s_pos,i=n.RemoveSpuriousBodyContacts_s_normal,s=this,o=-1,r=0;this.m_bodyContactBuffer.count=ts(this.m_bodyContactBuffer.data,(function(n){if(n.index!==o&&(r=0,o=n.index),r++>3)return!0;var _=t.Copy(n.normal);_.SelfMul(s.m_particleDiameter*(1-n.weight));var m=X.AddVV(s.m_positionBuffer.data[n.index],_,e);if(!n.fixture.TestPoint(m)){for(var h=n.fixture.GetShape().GetChildCount(),l=0;l<h;l++){var u=i;if(n.fixture.ComputeDistance(m,u,l)<a)return!1}return!0}return!1}),this.m_bodyContactBuffer.count)},s.DetectStuckParticle=function(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)},s.ValidateParticleIndex=function(t){return t>=0&&t<this.GetParticleCount()&&t!==v},s.GetQuantizedTimeElapsed=function(){return Math.floor(this.m_timeElapsed/4294967296)},s.LifetimeToExpirationTime=function(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)},s.ForceCanBeApplied=function(e){return!(e&t.b2ParticleFlag.b2_wallParticle)},s.PrepareForceBuffer=function(){if(!this.m_hasForce){for(var t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}},s.IsRigidGroup=function(e){return null!==e&&!!(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},s.GetLinearVelocity=function(t,e,i,n){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,n):n.Copy(this.m_velocityBuffer.data[e])},s.InitDampingParameter=function(t,e,i,n,s,o,r,a){t[0]=n>0?1/n:0,e[0]=s>0?1/s:0,i[0]=X.CrossVV(X.SubVV(r,o,X.s_t0),a)},s.InitDampingParameterWithRigidGroupOrParticle=function(e,i,n,s,o,r,a,_){if(o&&s)this.InitDampingParameter(e,i,n,o.GetMass(),o.GetInertia(),o.GetCenter(),a,_);else{var m=this.m_flagsBuffer.data[r];this.InitDampingParameter(e,i,n,m&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,a,a,_)}},s.ComputeDampingImpulse=function(t,e,i,n,s,o,r){var a=t+e*i*i+n+s*o*o;return a>0?r/a:0},s.ApplyDamping=function(t,e,i,n,s,o,r,a){s&&n?(s.m_linearVelocity.SelfMulAdd(r*t,a),s.m_angularVelocity+=r*i*e):this.m_velocityBuffer.data[o].SelfMulAdd(r*t,a)},n}();us.xTruncBits=12,us.yTruncBits=12,us.tagBits=32,us.yOffset=1<<us.yTruncBits-1,us.yShift=us.tagBits-us.yTruncBits,us.xShift=us.tagBits-us.yTruncBits-us.xTruncBits,us.xScale=1<<us.xShift,us.xOffset=us.xScale*(1<<us.xTruncBits-1),us.yMask=(1<<us.yTruncBits)-1<<us.yShift,us.xMask=~us.yMask,us.DestroyParticlesInShape_s_aabb=new zt,us.CreateParticleGroup_s_transform=new Y,us.ComputeCollisionEnergy_s_v=new X,us.QueryShapeAABB_s_aabb=new zt,us.QueryPointAABB_s_aabb=new zt,us.RayCast_s_aabb=new zt,us.RayCast_s_p=new X,us.RayCast_s_v=new X,us.RayCast_s_n=new X,us.RayCast_s_point=new X,us.k_pairFlags=t.b2ParticleFlag.b2_springParticle,us.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,us.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,us.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,us.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,us.CreateParticlesStrokeShapeForGroup_s_edge=new Bi,us.CreateParticlesStrokeShapeForGroup_s_d=new X,us.CreateParticlesStrokeShapeForGroup_s_p=new X,us.CreateParticlesFillShapeForGroup_s_aabb=new zt,us.CreateParticlesFillShapeForGroup_s_p=new X,us.UpdatePairsAndTriads_s_dab=new X,us.UpdatePairsAndTriads_s_dbc=new X,us.UpdatePairsAndTriads_s_dca=new X,us.AddContact_s_d=new X,us.UpdateBodyContacts_s_aabb=new zt,us.Solve_s_subStep=new wn,us.SolveCollision_s_aabb=new zt,us.SolveGravity_s_gravity=new X,us.SolveBarrier_s_aabb=new zt,us.SolveBarrier_s_va=new X,us.SolveBarrier_s_vb=new X,us.SolveBarrier_s_pba=new X,us.SolveBarrier_s_vba=new X,us.SolveBarrier_s_vc=new X,us.SolveBarrier_s_pca=new X,us.SolveBarrier_s_vca=new X,us.SolveBarrier_s_qba=new X,us.SolveBarrier_s_qca=new X,us.SolveBarrier_s_dv=new X,us.SolveBarrier_s_f=new X,us.SolvePressure_s_f=new X,us.SolveDamping_s_v=new X,us.SolveDamping_s_f=new X,us.SolveRigidDamping_s_t0=new X,us.SolveRigidDamping_s_t1=new X,us.SolveRigidDamping_s_p=new X,us.SolveRigidDamping_s_v=new X,us.SolveExtraDamping_s_v=new X,us.SolveExtraDamping_s_f=new X,us.SolveRigid_s_position=new X,us.SolveRigid_s_rotation=new Q,us.SolveRigid_s_transform=new Y,us.SolveRigid_s_velocityTransform=new Y,us.SolveElastic_s_pa=new X,us.SolveElastic_s_pb=new X,us.SolveElastic_s_pc=new X,us.SolveElastic_s_r=new Q,us.SolveElastic_s_t0=new X,us.SolveSpring_s_pa=new X,us.SolveSpring_s_pb=new X,us.SolveSpring_s_d=new X,us.SolveSpring_s_f=new X,us.SolveTensile_s_weightedNormal=new X,us.SolveTensile_s_s=new X,us.SolveTensile_s_f=new X,us.SolveViscous_s_v=new X,us.SolveViscous_s_f=new X,us.SolveRepulsive_s_f=new X,us.SolvePowder_s_f=new X,us.SolveSolid_s_f=new X,us.RemoveSpuriousBodyContacts_s_n=new X,us.RemoveSpuriousBodyContacts_s_pos=new X,us.RemoveSpuriousBodyContacts_s_normal=new X;var cs=function(){function t(){this._data=null,this.userSuppliedCapacity=0}return m(t,[{key:"data",get:function(){return this._data},set:function(t){this._data=t}}]),t}(),fs=function(){function t(){this.index=v,this.tag=0}return t.CompareProxyProxy=function(t,e){return t.tag<e.tag},t.CompareTagProxy=function(t,e){return t<e.tag},t.CompareProxyTag=function(t,e){return t.tag<e},t}(),ds=function(){function t(t,e,i,n,s){this.m_system=t,this.m_xLower=(e&us.xMask)>>>0,this.m_xUpper=(i&us.xMask)>>>0,this.m_yLower=(e&us.yMask)>>>0,this.m_yUpper=(i&us.yMask)>>>0,this.m_first=n,this.m_last=s}return t.prototype.GetNext=function(){for(;this.m_first<this.m_last;){var t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&us.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return v},t}(),ps=function(){this.next=null,this.count=0,this.index=0},ys=function(){function t(){}var e=t.prototype;return e.Allocate=function(t,e){return e},e.Clear=function(){},e.GetCount=function(){return 0},e.Invalidate=function(){},e.GetValidBuffer=function(){return[]},e.GetBuffer=function(){return[]},e.SetCount=function(){},t}(),vs=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var i=e.prototype;return i.Initialize=function(){},i.Find=function(){return v},e}(ys),xs=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var i=e.prototype;return i.Initialize=function(){},i.Find=function(){return v},e}(ys),Ss=function(){function t(){}var e=t.prototype;return e.IsNecessary=function(){return!0},e.ShouldCreatePair=function(){return!0},e.ShouldCreateTriad=function(){return!0},t}(),Bs=function(t){function e(e,i,n,s){var o;return(o=t.call(this)||this).m_callDestructionListener=!1,o.m_destroyed=0,o.m_system=e,o.m_shape=i,o.m_xf=n,o.m_callDestructionListener=s,o.m_destroyed=0,o}h(e,t);var i=e.prototype;return i.ReportFixture=function(){return!1},i.ReportParticle=function(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)},i.Destroyed=function(){return this.m_destroyed},e}(An),bs=function(t){function e(e){var i;return(i=t.call(this)||this).m_threshold=0,i.m_threshold=e,i}h(e,t);var i=e.prototype;return i.ShouldCreatePair=function(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t},i.ShouldCreateTriad=function(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)},e}(Ss),As=function(e){function i(i,n){var s;return void 0===n&&(n=i.length),(s=e.call(this,t.b2ShapeType.e_unknown,0)||this).m_shapeCount=0,s.m_shapes=i,s.m_shapeCount=n,s}h(i,e);var n=i.prototype;return n.Clone=function(){throw new Error},n.GetChildCount=function(){return 1},n.TestPoint=function(t,e){for(var i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1},n.ComputeDistance=function(){return 0},n.RayCast=function(){return!1},n.ComputeAABB=function(t,e){var i=new zt;t.lowerBound.x=1e37,t.lowerBound.y=1e37,t.upperBound.x=-1e37,t.upperBound.y=-1e37;for(var n=0;n<this.m_shapeCount;n++)for(var s=this.m_shapes[n].GetChildCount(),o=0;o<s;o++){var r=i;this.m_shapes[n].ComputeAABB(r,e,o),t.Combine1(r)}},n.ComputeMass=function(){},n.SetupDistanceProxy=function(){},n.ComputeSubmergedArea=function(){return 0},n.Dump=function(){},i}(vi),gs=function(e){function i(t){var i;return(i=e.call(this)||this).m_flagsBuffer=t,i}return h(i,e),i.prototype.IsNecessary=function(e){return!!(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)},i}(Ss),Cs=function(e){function i(t,i){var n;return void 0===i&&(i=null),(n=e.call(this,t)||this).m_contactFilter=null,n.m_contactFilter=i,n}h(i,e);var n=i.prototype;return n.ShouldCollideFixtureParticle=function(e,i,n){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[n]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,n)},n.ReportFixtureAndParticle=function(e,n,s){var o=i.ReportFixtureAndParticle_s_n,r=i.ReportFixtureAndParticle_s_rp,a=this.m_system.m_positionBuffer.data[s],_=o,m=e.ComputeDistance(a,_,n);if(m<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,s)){var h=e.GetBody(),l=h.GetWorldCenter(),u=h.GetMass(),c=h.GetInertia()-u*h.GetLocalCenter().LengthSquared(),f=u>0?1/u:0,d=c>0?1/c:0,p=this.m_system.m_flagsBuffer.data[s]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),y=X.SubVV(a,l,r),v=X.CrossVV(y,_),x=p+f+d*v*v,S=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];S.index=s,S.body=h,S.fixture=e,S.weight=1-m*this.m_system.m_inverseDiameter,S.normal.Copy(_.SelfNeg()),S.mass=x>0?1/x:0,this.m_system.DetectStuckParticle(s)}},i}(rs);Cs.ReportFixtureAndParticle_s_n=new X,Cs.ReportFixtureAndParticle_s_rp=new X;var Vs=function(e){function i(t,i){var n;return(n=e.call(this,t)||this).m_step=i,n}h(i,e);var n=i.prototype;return n.ReportFixtureAndParticle=function(e,n,s){var o=i.ReportFixtureAndParticle_s_p1,r=i.ReportFixtureAndParticle_s_output,_=i.ReportFixtureAndParticle_s_input,m=i.ReportFixtureAndParticle_s_p,h=i.ReportFixtureAndParticle_s_v,l=i.ReportFixtureAndParticle_s_f,u=e.GetBody(),c=this.m_system.m_positionBuffer.data[s],f=this.m_system.m_velocityBuffer.data[s],d=r,p=_;if(0===this.m_system.m_iterationIndex){var y=Y.MulTXV(u.m_xf0,c,o);e.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(y.SelfSub(u.GetLocalCenter()),Q.MulRV(u.m_xf0.q,y,y),Q.MulTRV(u.m_xf.q,y,y),y.SelfAdd(u.GetLocalCenter())),Y.MulXV(u.m_xf,y,p.p1)}else p.p1.Copy(c);if(X.AddVMulSV(c,this.m_step.dt,f,p.p2),p.maxFraction=1,e.RayCast(d,p,n)){var v=d.normal,x=m;x.x=(1-d.fraction)*p.p1.x+d.fraction*p.p2.x+a*v.x,x.y=(1-d.fraction)*p.p1.y+d.fraction*p.p2.y+a*v.y;var S=h;S.x=this.m_step.inv_dt*(x.x-c.x),S.y=this.m_step.inv_dt*(x.y-c.y),this.m_system.m_velocityBuffer.data[s].Copy(S);var B=l;B.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(f.x-S.x),B.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(f.y-S.y),this.m_system.ParticleApplyForce(s,B)}},n.ReportParticle=function(){return!1},i}(rs);Vs.ReportFixtureAndParticle_s_p1=new X,Vs.ReportFixtureAndParticle_s_output=new qt,Vs.ReportFixtureAndParticle_s_input=new kt,Vs.ReportFixtureAndParticle_s_p=new X,Vs.ReportFixtureAndParticle_s_v=new X,Vs.ReportFixtureAndParticle_s_f=new X;var ws=function(){function e(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new Cn,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new X,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new Vn,this.m_island=new zn,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}var n=e.prototype;return n.SetDestructionListener=function(t){this.m_destructionListener=t},n.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},n.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},n.SetDebugDraw=function(t){this.m_debugDraw=t},n.CreateBody=function(t){if(void 0===t&&(t={}),this.IsLocked())throw new Error;var e=new Ii(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},n.DestroyBody=function(t){if(this.IsLocked())throw new Error;for(var e=t.m_jointList;e;){var i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;for(var n=t.m_controllerList;n;){var s=n;n=n.nextController,s.controller.RemoveBody(t)}for(var o=t.m_contactList;o;){var r=o;o=o.next,this.m_contactManager.Destroy(r.contact)}t.m_contactList=null;for(var a=t.m_fixtureList;a;){var _=a;a=a.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(_),_.DestroyProxies(),_.Reset(),t.m_fixtureList=a,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount},e._Joint_Create=function(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new Ri(e);case t.b2JointType.e_mouseJoint:return new Ui(e);case t.b2JointType.e_prismaticJoint:return new Zi(e);case t.b2JointType.e_revoluteJoint:return new Ki(e);case t.b2JointType.e_pulleyJoint:return new Qi(e);case t.b2JointType.e_gearJoint:return new Ei(e);case t.b2JointType.e_wheelJoint:return new on(e);case t.b2JointType.e_weldJoint:return new nn(e);case t.b2JointType.e_frictionJoint:return new ji(e);case t.b2JointType.e_ropeJoint:return new tn(e);case t.b2JointType.e_motorJoint:return new Oi(e);case t.b2JointType.e_areaJoint:return new qi(e)}throw new Error},e._Joint_Destroy=function(){},n.CreateJoint=function(t){if(this.IsLocked())throw new Error;var i=e._Joint_Create(t);i.m_prev=null,i.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=i),this.m_jointList=i,++this.m_jointCount,i.m_edgeA.prev=null,i.m_edgeA.next=i.m_bodyA.m_jointList,i.m_bodyA.m_jointList&&(i.m_bodyA.m_jointList.prev=i.m_edgeA),i.m_bodyA.m_jointList=i.m_edgeA,i.m_edgeB.prev=null,i.m_edgeB.next=i.m_bodyB.m_jointList,i.m_bodyB.m_jointList&&(i.m_bodyB.m_jointList.prev=i.m_edgeB),i.m_bodyB.m_jointList=i.m_edgeB;var n=i.m_bodyA,s=i.m_bodyB;if(!i.m_collideConnected)for(var o=s.GetContactList();o;)o.other===n&&o.contact.FlagForFiltering(),o=o.next;return i},n.DestroyJoint=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);var i=t.m_bodyA,n=t.m_bodyB,s=t.m_collideConnected;if(i.SetAwake(!0),n.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===i.m_jointList&&(i.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===n.m_jointList&&(n.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),e._Joint_Destroy(t),--this.m_jointCount,!s)for(var o=n.GetContactList();o;)o.other===i&&o.contact.FlagForFiltering(),o=o.next},n.CreateParticleSystem=function(t){if(this.IsLocked())throw new Error;var e=new us(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e},n.DestroyParticleSystem=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)},n.CalculateReasonableParticleIterations=function(t){if(null===this.m_particleSystemList)return 1;return Jn(this.m_gravity.Length(),function(t){for(var e=i,n=t.GetParticleSystemList();null!==n;n=n.m_next)e=D(e,n.GetRadius());return e}(this),t)},n.Step=function(t,i,n,s){void 0===s&&(s=this.CalculateReasonableParticleIterations(t));var o=e.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var r=e.Step_s_step;r.dt=t,r.velocityIterations=i,r.positionIterations=n,r.particleIterations=s,r.inv_dt=t>0?1/t:0,r.dtRatio=this.m_inv_dt0*t,r.warmStarting=this.m_warmStarting;var a=e.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=a.GetMilliseconds(),this.m_stepComplete&&r.dt>0){for(var _=e.Step_s_timer.Reset(),m=this.m_particleSystemList;m;m=m.m_next)m.Solve(r);this.Solve(r),this.m_profile.solve=_.GetMilliseconds()}if(this.m_continuousPhysics&&r.dt>0){var h=e.Step_s_timer.Reset();this.SolveTOI(r),this.m_profile.solveTOI=h.GetMilliseconds()}r.dt>0&&(this.m_inv_dt0=r.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=o.GetMilliseconds()},n.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},n.DrawParticleSystem=function(t){if(null!==this.m_debugDraw){var e=t.GetParticleCount();if(e){var i=t.GetRadius(),n=t.GetPositionBuffer();if(t.m_colorBuffer.data){var s=t.GetColorBuffer();this.m_debugDraw.DrawParticles(n,i,s,e)}else this.m_debugDraw.DrawParticles(n,i,null,e)}}},n.DrawDebugData=function(){if(null!==this.m_debugDraw){var i=this.m_debugDraw.GetFlags(),n=e.DrawDebugData_s_color.SetRGB(0,0,0);if(i&t.b2DrawFlags.e_shapeBit)for(var s=this.m_bodyList;s;s=s.m_next){var o=s.m_xf;this.m_debugDraw.PushTransform(o);for(var r=s.GetFixtureList();r;r=r.m_next)s.IsActive()?s.GetType()===t.b2BodyType.b2_staticBody?(n.SetRGB(.5,.9,.5),this.DrawShape(r,n)):s.GetType()===t.b2BodyType.b2_kinematicBody?(n.SetRGB(.5,.5,.9),this.DrawShape(r,n)):s.IsAwake()?(n.SetRGB(.9,.7,.7),this.DrawShape(r,n)):(n.SetRGB(.6,.6,.6),this.DrawShape(r,n)):(n.SetRGB(.5,.5,.3),this.DrawShape(r,n));this.m_debugDraw.PopTransform(o)}if(i&t.b2DrawFlags.e_particleBit)for(var a=this.m_particleSystemList;a;a=a.m_next)this.DrawParticleSystem(a);if(i&t.b2DrawFlags.e_jointBit)for(var _=this.m_jointList;_;_=_.m_next)this.DrawJoint(_);if(i&t.b2DrawFlags.e_aabbBit){n.SetRGB(.9,.3,.9);for(var m=e.DrawDebugData_s_vs,h=this.m_bodyList;h;h=h.m_next)if(h.IsActive())for(var l=h.GetFixtureList();l;l=l.m_next)for(var u=0;u<l.m_proxyCount;++u){var c=l.m_proxies[u].treeNode.aabb;m[0].Set(c.lowerBound.x,c.lowerBound.y),m[1].Set(c.upperBound.x,c.lowerBound.y),m[2].Set(c.upperBound.x,c.upperBound.y),m[3].Set(c.lowerBound.x,c.upperBound.y),this.m_debugDraw.DrawPolygon(m,4,n)}}if(i&t.b2DrawFlags.e_centerOfMassBit)for(var f=this.m_bodyList;f;f=f.m_next){var d=e.DrawDebugData_s_xf;d.q.Copy(f.m_xf.q),d.p.Copy(f.GetWorldCenter()),this.m_debugDraw.DrawTransform(d)}if(i&t.b2DrawFlags.e_controllerBit)for(var p=this.m_controllerList;p;p=p.m_next)p.Draw(this.m_debugDraw)}},n.QueryAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof An?this._QueryAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryAABB=function(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,(function(e){var n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof An)for(var n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryAABB(t,e)},n.QueryAllAABB=function(t,e){return void 0===e&&(e=[]),this.QueryAABB(t,(function(t){return e.push(t),!0})),e},n.QueryPointAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof An?this._QueryPointAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryPointAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryPointAABB=function(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(e){var n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof An)for(var n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(t,e)},n.QueryAllPointAABB=function(t,e){return void 0===e&&(e=[]),this.QueryPointAABB(t,(function(t){return e.push(t),!0})),e},n.QueryFixtureShape=function(){(arguments.length<=0?void 0:arguments[0])instanceof An?this._QueryFixtureShape(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3]):this._QueryFixtureShape(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3])},n._QueryFixtureShape=function(t,i,n,s,o){var r=e.QueryFixtureShape_s_aabb;if(i.ComputeAABB(r,s,n),this.m_contactManager.m_broadPhase.Query(r,(function(e){var r=e.userData,a=r.fixture;if(Xt(i,n,a.GetShape(),r.childIndex,s,a.GetBody().GetTransform())){if(t)return t.ReportFixture(a);if(o)return o(a)}return!0})),t instanceof An)for(var a=this.m_particleSystemList;a;a=a.m_next)t.ShouldQueryParticleSystem(a)&&a.QueryAABB(t,r)},n.QueryAllFixtureShape=function(t,e,i,n){return void 0===n&&(n=[]),this.QueryFixtureShape(t,e,i,(function(t){return n.push(t),!0})),n},n.QueryFixturePoint=function(){(arguments.length<=0?void 0:arguments[0])instanceof An?this._QueryFixturePoint(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryFixturePoint(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryFixturePoint=function(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(n){var s=n.userData.fixture;if(s.TestPoint(e)){if(t)return t.ReportFixture(s);if(i)return i(s)}return!0})),t)for(var n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.QueryPointAABB(t,e)},n.QueryAllFixturePoint=function(t,e){return void 0===e&&(e=[]),this.QueryFixturePoint(t,(function(t){return e.push(t),!0})),e},n.RayCast=function(){(arguments.length<=0?void 0:arguments[0])instanceof gn?this._RayCast(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2]):this._RayCast(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2])},n._RayCast=function(t,i,n,s){var o=e.RayCast_s_input;if(o.maxFraction=1,o.p1.Copy(i),o.p2.Copy(n),this.m_contactManager.m_broadPhase.RayCast(o,(function(o,r){var a=r.userData,_=a.fixture,m=a.childIndex,h=e.RayCast_s_output;if(_.RayCast(h,o,m)){var l=h.fraction,u=e.RayCast_s_point;if(u.Set((1-l)*i.x+l*n.x,(1-l)*i.y+l*n.y),t)return t.ReportFixture(_,u,h.normal,l);if(s)return s(_,u,h.normal,l)}return o.maxFraction})),t)for(var r=this.m_particleSystemList;r;r=r.m_next)t.ShouldQueryParticleSystem(r)&&r.RayCast(t,i,n)},n.RayCastOne=function(t,e){var i=null,n=1;return this.RayCast(t,e,(function(t,e,s,o){return o<n&&(n=o,i=t),n})),i},n.RayCastAll=function(t,e,i){return void 0===i&&(i=[]),this.RayCast(t,e,(function(t){return i.push(t),1})),i},n.GetBodyList=function(){return this.m_bodyList},n.GetJointList=function(){return this.m_jointList},n.GetParticleSystemList=function(){return this.m_particleSystemList},n.GetContactList=function(){return this.m_contactManager.m_contactList},n.SetAllowSleeping=function(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(var e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)},n.GetAllowSleeping=function(){return this.m_allowSleep},n.SetWarmStarting=function(t){this.m_warmStarting=t},n.GetWarmStarting=function(){return this.m_warmStarting},n.SetContinuousPhysics=function(t){this.m_continuousPhysics=t},n.GetContinuousPhysics=function(){return this.m_continuousPhysics},n.SetSubStepping=function(t){this.m_subStepping=t},n.GetSubStepping=function(){return this.m_subStepping},n.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},n.GetBodyCount=function(){return this.m_bodyCount},n.GetJointCount=function(){return this.m_jointCount},n.GetContactCount=function(){return this.m_contactManager.m_contactCount},n.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()},n.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()},n.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()},n.SetGravity=function(t,e){if(void 0===e&&(e=!0),!X.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(var i=this.m_bodyList;i;i=i.m_next)i.SetAwake(!0)},n.GetGravity=function(){return this.m_gravity},n.IsLocked=function(){return this.m_locked},n.SetAutoClearForces=function(t){this.m_clearForces=t},n.GetAutoClearForces=function(){return this.m_clearForces},n.ShiftOrigin=function(t){if(this.IsLocked())throw new Error;for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(var i=this.m_jointList;i;i=i.m_next)i.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)},n.GetContactManager=function(){return this.m_contactManager},n.GetProfile=function(){return this.m_profile},n.Dump=function(e){if(!this.m_locked){e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");for(var i=0,n=this.m_bodyList;n;n=n.m_next)n.m_islandIndex=i,n.Dump(e),++i;i=0;for(var s=this.m_jointList;s;s=s.m_next)s.m_index=i,++i;for(var o=this.m_jointList;o;o=o.m_next)o.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),o.Dump(e),e("}\n"));for(var r=this.m_jointList;r;r=r.m_next)r.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),r.Dump(e),e("}\n"))}},n.DrawJoint=function(i){if(null!==this.m_debugDraw){var n=i.GetBodyA(),s=i.GetBodyB(),o=n.m_xf,r=s.m_xf,a=o.p,_=r.p,m=i.GetAnchorA(e.DrawJoint_s_p1),h=i.GetAnchorB(e.DrawJoint_s_p2),l=e.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(i.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(m,h,l);break;case t.b2JointType.e_pulleyJoint:var u=i,c=u.GetGroundAnchorA(),f=u.GetGroundAnchorB();this.m_debugDraw.DrawSegment(c,m,l),this.m_debugDraw.DrawSegment(f,h,l),this.m_debugDraw.DrawSegment(c,f,l);break;case t.b2JointType.e_mouseJoint:var d=e.DrawJoint_s_c;d.Set(0,1,0),this.m_debugDraw.DrawPoint(m,4,d),this.m_debugDraw.DrawPoint(h,4,d),d.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(m,h,d);break;default:this.m_debugDraw.DrawSegment(a,m,l),this.m_debugDraw.DrawSegment(m,h,l),this.m_debugDraw.DrawSegment(_,h,l)}}},n.DrawShape=function(i,n){if(null!==this.m_debugDraw){var s=i.GetShape();switch(s.m_type){case t.b2ShapeType.e_circleShape:var o=s,r=o.m_p,a=o.m_radius,_=X.UNITX;this.m_debugDraw.DrawSolidCircle(r,a,_,n);break;case t.b2ShapeType.e_edgeShape:var m=s,h=m.m_vertex1,l=m.m_vertex2;this.m_debugDraw.DrawSegment(h,l,n);break;case t.b2ShapeType.e_chainShape:var u=s,c=u.m_count,f=u.m_vertices,d=e.DrawShape_s_ghostColor.SetRGBA(.75*n.r,.75*n.g,.75*n.b,n.a),p=f[0];if(this.m_debugDraw.DrawPoint(p,4,n),u.m_hasPrevVertex){var y=u.m_prevVertex;this.m_debugDraw.DrawSegment(y,p,d),this.m_debugDraw.DrawCircle(y,.1,d)}for(var v=1;v<c;++v){var x=f[v];this.m_debugDraw.DrawSegment(p,x,n),this.m_debugDraw.DrawPoint(x,4,n),p=x}if(u.m_hasNextVertex){var S=u.m_nextVertex;this.m_debugDraw.DrawSegment(S,p,d),this.m_debugDraw.DrawCircle(S,.1,d)}break;case t.b2ShapeType.e_polygonShape:var B=s,b=B.m_count,A=B.m_vertices;this.m_debugDraw.DrawSolidPolygon(A,b,n)}}},n.Solve=function(e){for(var i=this.m_bodyList;i;i=i.m_next)i.m_xf0.Copy(i.m_xf);for(var n=this.m_controllerList;n;n=n.m_next)n.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var s=this.m_island;s.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(var r=this.m_contactManager.m_contactList;r;r=r.m_next)r.m_islandFlag=!1;for(var a=this.m_jointList;a;a=a.m_next)a.m_islandFlag=!1;for(var _=this.s_stack,m=this.m_bodyList;m;m=m.m_next)if(!m.m_islandFlag&&m.IsAwake()&&m.IsActive()&&m.GetType()!==t.b2BodyType.b2_staticBody){s.Clear();var h=0;for(_[h++]=m,m.m_islandFlag=!0;h>0;){var l=_[--h];if(!l)throw new Error;if(s.AddBody(l),l.m_awakeFlag=!0,l.GetType()!==t.b2BodyType.b2_staticBody){for(var u=l.m_contactList;u;u=u.next){var c=u.contact;if(!c.m_islandFlag&&c.IsEnabled()&&c.IsTouching()){var f=c.m_fixtureA.m_isSensor,d=c.m_fixtureB.m_isSensor;if(!f&&!d){s.AddContact(c),c.m_islandFlag=!0;var p=u.other;p.m_islandFlag||(_[h++]=p,p.m_islandFlag=!0)}}}for(var y=l.m_jointList;y;y=y.next)if(!y.joint.m_islandFlag){var v=y.other;v.IsActive()&&(s.AddJoint(y.joint),y.joint.m_islandFlag=!0,v.m_islandFlag||(_[h++]=v,v.m_islandFlag=!0))}}}var x=new Vn;s.Solve(x,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=x.solveInit,this.m_profile.solveVelocity+=x.solveVelocity,this.m_profile.solvePosition+=x.solvePosition;for(var S=0;S<s.m_bodyCount;++S){var B=s.m_bodies[S];B.GetType()===t.b2BodyType.b2_staticBody&&(B.m_islandFlag=!1)}}for(var b=0;b<_.length&&_[b];++b)_[b]=null;for(var A=new it,g=this.m_bodyList;g;g=g.m_next)g.m_islandFlag&&g.GetType()!==t.b2BodyType.b2_staticBody&&g.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=A.GetMilliseconds()},n.SolveTOI=function(i){var n=this.m_island;if(n.Initialize(64,32,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var s=this.m_bodyList;s;s=s.m_next)s.m_islandFlag=!1,s.m_sweep.alpha0=0;for(var o=this.m_contactManager.m_contactList;o;o=o.m_next)o.m_toiFlag=!1,o.m_islandFlag=!1,o.m_toiCount=0,o.m_toi=1}for(;;){for(var r=null,a=1,_=this.m_contactManager.m_contactList;_;_=_.m_next)if(_.IsEnabled()&&!(_.m_toiCount>8)){var m=1;if(_.m_toiFlag)m=_.m_toi;else{var h=_.GetFixtureA(),l=_.GetFixtureB();if(h.IsSensor()||l.IsSensor())continue;var u=h.GetBody(),c=l.GetBody(),f=u.m_type,d=c.m_type,p=u.IsAwake()&&f!==t.b2BodyType.b2_staticBody,y=c.IsAwake()&&d!==t.b2BodyType.b2_staticBody;if(!p&&!y)continue;var v=u.IsBullet()||f!==t.b2BodyType.b2_dynamicBody,x=c.IsBullet()||d!==t.b2BodyType.b2_dynamicBody;if(!v&&!x)continue;var S=u.m_sweep.alpha0;u.m_sweep.alpha0<c.m_sweep.alpha0?(S=c.m_sweep.alpha0,u.m_sweep.Advance(S)):c.m_sweep.alpha0<u.m_sweep.alpha0&&(S=u.m_sweep.alpha0,c.m_sweep.Advance(S));var B=_.GetChildIndexA(),b=_.GetChildIndexB(),A=e.SolveTOI_s_toi_input;A.proxyA.SetShape(h.GetShape(),B),A.proxyB.SetShape(l.GetShape(),b),A.sweepA.Copy(u.m_sweep),A.sweepB.Copy(c.m_sweep),A.tMax=1;var g=e.SolveTOI_s_toi_output;be(g,A);var C=g.t;m=g.state===t.b2TOIOutputState.e_touching?D(S+(1-S)*C,1):1,_.m_toi=m,_.m_toiFlag=!0}m<a&&(r=_,a=m)}if(null===r||.9999<a){this.m_stepComplete=!0;break}var V=r.GetFixtureA(),w=r.GetFixtureB(),M=V.GetBody(),P=w.GetBody(),I=e.SolveTOI_s_backup1.Copy(M.m_sweep),G=e.SolveTOI_s_backup2.Copy(P.m_sweep);if(M.Advance(a),P.Advance(a),r.Update(this.m_contactManager.m_contactListener),r.m_toiFlag=!1,++r.m_toiCount,r.IsEnabled()&&r.IsTouching()){M.SetAwake(!0),P.SetAwake(!0),n.Clear(),n.AddBody(M),n.AddBody(P),n.AddContact(r),M.m_islandFlag=!0,P.m_islandFlag=!0,r.m_islandFlag=!0;for(var F=0;F<2;++F){var T=0===F?M:P;if(T.m_type===t.b2BodyType.b2_dynamicBody)for(var L=T.m_contactList;L&&n.m_bodyCount!==n.m_bodyCapacity&&n.m_contactCount!==n.m_contactCapacity;L=L.next){var R=L.contact;if(!R.m_islandFlag){var k=L.other;if(k.m_type!==t.b2BodyType.b2_dynamicBody||T.IsBullet()||k.IsBullet()){var q=R.m_fixtureA.m_isSensor,z=R.m_fixtureB.m_isSensor;if(!q&&!z){var j=e.SolveTOI_s_backup.Copy(k.m_sweep);k.m_islandFlag||k.Advance(a),R.Update(this.m_contactManager.m_contactListener),R.IsEnabled()&&R.IsTouching()?(R.m_islandFlag=!0,n.AddContact(R),k.m_islandFlag||(k.m_islandFlag=!0,k.m_type!==t.b2BodyType.b2_staticBody&&k.SetAwake(!0),n.AddBody(k))):(k.m_sweep.Copy(j),k.SynchronizeTransform())}}}}}var J=e.SolveTOI_s_subStep;J.dt=(1-a)*i.dt,J.inv_dt=1/J.dt,J.dtRatio=1,J.positionIterations=20,J.velocityIterations=i.velocityIterations,J.particleIterations=i.particleIterations,J.warmStarting=!1,n.SolveTOI(J,M.m_islandIndex,P.m_islandIndex);for(var E=0;E<n.m_bodyCount;++E){var N=n.m_bodies[E];if(N.m_islandFlag=!1,N.m_type===t.b2BodyType.b2_dynamicBody){N.SynchronizeFixtures();for(var O=N.m_contactList;O;O=O.next)O.contact.m_toiFlag=!1,O.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else r.SetEnabled(!1),M.m_sweep.Copy(I),P.m_sweep.Copy(G),M.SynchronizeTransform(),P.SynchronizeTransform()}},n.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t},n.RemoveController=function(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t},e}();ws.Step_s_step=new wn,ws.Step_s_stepTimer=new it,ws.Step_s_timer=new it,ws.DrawDebugData_s_color=new tt(0,0,0),ws.DrawDebugData_s_vs=X.MakeArray(4),ws.DrawDebugData_s_xf=new Y,ws.QueryFixtureShape_s_aabb=new zt,ws.RayCast_s_input=new kt,ws.RayCast_s_output=new qt,ws.RayCast_s_point=new X,ws.DrawJoint_s_p1=new X,ws.DrawJoint_s_p2=new X,ws.DrawJoint_s_color=new tt(.5,.8,.8),ws.DrawJoint_s_c=new tt,ws.DrawShape_s_ghostColor=new tt,ws.SolveTOI_s_subStep=new wn,ws.SolveTOI_s_backup=new $,ws.SolveTOI_s_backup1=new $,ws.SolveTOI_s_backup2=new $,ws.SolveTOI_s_toi_input=new me,ws.SolveTOI_s_toi_output=new le;var Ms=function(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e},Ps=function(){function t(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}var e=t.prototype;return e.GetNext=function(){return this.m_next},e.GetPrev=function(){return this.m_prev},e.GetBodyList=function(){return this.m_bodyList},e.AddBody=function(t){var e=new Ms(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount},e.RemoveBody=function(t){if(this.m_bodyCount<=0)throw new Error;for(var e=this.m_bodyList;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount},e.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0},t}(),Is=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).normal=new X(0,1),e.offset=0,e.density=0,e.velocity=new X(0,0),e.linearDrag=0,e.angularDrag=0,e.useDensity=!1,e.useWorldGravity=!0,e.gravity=new X(0,0),e}h(e,t);var i=e.prototype;return i.Step=function(){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;if(e.IsAwake()){for(var i=new X,s=new X,o=0,r=0,a=e.GetFixtureList();a;a=a.m_next){var _=new X,m=a.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),_);o+=m,i.x+=m*_.x,i.y+=m*_.y;var h;r+=m*(h=this.useDensity?a.GetDensity():1),s.x+=m*_.x*h,s.y+=m*_.y*h}if(i.x/=o,i.y/=o,s.x/=r,s.y/=r,!(o<n)){var l=this.gravity.Clone().SelfNeg();l.SelfMul(this.density*o),e.ApplyForce(l,s);var u=e.GetLinearVelocityFromWorldPoint(i,new X);u.SelfSub(this.velocity),u.SelfMul(-this.linearDrag*o),e.ApplyForce(u,i),e.ApplyTorque(-e.GetInertia()/e.GetMass()*o*e.GetAngularVelocity()*this.angularDrag)}}}}},i.Draw=function(t){var e=100,i=new X,n=new X;i.x=this.normal.x*this.offset+this.normal.y*e,i.y=this.normal.y*this.offset-this.normal.x*e,n.x=this.normal.x*this.offset-this.normal.y*e,n.y=this.normal.y*this.offset+this.normal.x*e;var s=new tt(0,0,.8);t.DrawSegment(i,n,s)},e}(Ps),Gs=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).A=new X(0,0),e}h(e,t);var i=e.prototype;return i.Step=function(t){for(var i=X.MulSV(t.dt,this.A,e.Step_s_dtA),n=this.m_bodyList;n;n=n.nextBody){var s=n.body;s.IsAwake()&&s.SetLinearVelocity(X.AddVV(s.GetLinearVelocity(),i,X.s_t0))}},i.Draw=function(){},e}(Ps);Gs.Step_s_dtA=new X;var Ds=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).F=new X(0,0),e}h(e,t);var i=e.prototype;return i.Step=function(){for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}},i.Draw=function(){},e}(Ps),Fs=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).G=1,e.invSqr=!0,e}h(e,t);var i=e.prototype;return i.Step=function(){if(this.invSqr)for(var t=this.m_bodyList;t;t=t.nextBody)for(var i=t.body,s=i.GetWorldCenter(),o=i.GetMass(),r=this.m_bodyList;r&&r!==t;r=r.nextBody){var a=r.body,_=a.GetWorldCenter(),m=a.GetMass(),h=_.x-s.x,l=_.y-s.y,u=h*h+l*l;if(!(u<n)){var c=e.Step_s_f.Set(h,l);c.SelfMul(this.G/u/q(u)*o*m),i.IsAwake()&&i.ApplyForce(c,s),a.IsAwake()&&a.ApplyForce(c.SelfMul(-1),_)}}else for(var f=this.m_bodyList;f;f=f.nextBody)for(var d=f.body,p=d.GetWorldCenter(),y=d.GetMass(),v=this.m_bodyList;v&&v!==f;v=v.nextBody){var x=v.body,S=x.GetWorldCenter(),B=x.GetMass(),b=S.x-p.x,A=S.y-p.y,g=b*b+A*A;if(!(g<n)){var C=e.Step_s_f.Set(b,A);C.SelfMul(this.G/g*y*B),d.IsAwake()&&d.ApplyForce(C,p),x.IsAwake()&&x.ApplyForce(C.SelfMul(-1),S)}}},i.Draw=function(){},e}(Ps);Fs.Step_s_f=new X;var Ts=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).T=new Z,e.maxTimestep=0,e}h(e,t);var i=e.prototype;return i.Step=function(t){var i=t.dt;if(!(i<=n)){i>this.maxTimestep&&this.maxTimestep>0&&(i=this.maxTimestep);for(var s=this.m_bodyList;s;s=s.nextBody){var o=s.body;if(o.IsAwake()){var r=o.GetWorldVector(Z.MulMV(this.T,o.GetLocalVector(o.GetLinearVelocity(),X.s_t0),X.s_t1),e.Step_s_damping);o.SetLinearVelocity(X.AddVV(o.GetLinearVelocity(),X.MulSV(i,r,X.s_t0),X.s_t1))}}}},i.Draw=function(){},i.SetAxisAligned=function(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/F(t,e):0},e}(Ps);Ts.Step_s_damping=new X;var Ls=function(){function t(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new X,this.m_damping=0,this.m_k2=1,this.m_k3=.1}var e=t.prototype;return e.GetVertexCount=function(){return this.m_count},e.GetVertices=function(){return this.m_ps},e.Initialize=function(t){this.m_count=t.count,this.m_ps=X.MakeArray(this.m_count),this.m_p0s=X.MakeArray(this.m_count),this.m_vs=X.MakeArray(this.m_count),this.m_ims=w(this.m_count);for(var e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();var i=t.masses[e];this.m_ims[e]=i>0?1/i:0}var n=this.m_count-1,s=this.m_count-2;this.m_Ls=w(n),this.m_as=w(s);for(var o=0;o<n;++o){var r=this.m_ps[o],a=this.m_ps[o+1];this.m_Ls[o]=X.DistanceVV(r,a)}for(var _=0;_<s;++_){var m=this.m_ps[_],h=this.m_ps[_+1],l=this.m_ps[_+2],u=X.SubVV(h,m,X.s_t0),c=X.SubVV(l,h,X.s_t1),f=X.CrossVV(u,c),d=X.DotVV(u,c);this.m_as[_]=O(f,d)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3},e.Step=function(t,e){if(0!==t){for(var i=Math.exp(-t*this.m_damping),n=0;n<this.m_count;++n)this.m_p0s[n].Copy(this.m_ps[n]),this.m_ims[n]>0&&this.m_vs[n].SelfMulAdd(t,this.m_gravity),this.m_vs[n].SelfMul(i),this.m_ps[n].SelfMulAdd(t,this.m_vs[n]);for(var s=0;s<e;++s)this.SolveC2(),this.SolveC3(),this.SolveC2();for(var o=1/t,r=0;r<this.m_count;++r)X.MulSV(o,X.SubVV(this.m_ps[r],this.m_p0s[r],X.s_t0),this.m_vs[r])}},e.SolveC2=function(){for(var e=this.m_count-1,i=0;i<e;++i){var n=this.m_ps[i],s=this.m_ps[i+1],o=X.SubVV(s,n,t.s_d),r=o.Normalize(),a=this.m_ims[i],_=this.m_ims[i+1];if(a+_!==0){var m=a/(a+_),h=_/(a+_);n.SelfMulSub(this.m_k2*m*(this.m_Ls[i]-r),o),s.SelfMulAdd(this.m_k2*h*(this.m_Ls[i]-r),o)}}},e.SetAngle=function(t){for(var e=this.m_count-2,i=0;i<e;++i)this.m_as[i]=t},e.SolveC3=function(){for(var e=this.m_count-2,i=0;i<e;++i){var n=this.m_ps[i],s=this.m_ps[i+1],r=this.m_ps[i+2],a=this.m_ims[i],_=this.m_ims[i+1],m=this.m_ims[i+2],h=X.SubVV(s,n,t.s_d1),l=X.SubVV(r,s,t.s_d2),u=h.LengthSquared(),c=l.LengthSquared();if(u*c!=0){var f=X.CrossVV(h,l),d=X.DotVV(h,l),p=O(f,d),y=X.MulSV(-1/u,h.SelfSkew(),t.s_Jd1),v=X.MulSV(1/c,l.SelfSkew(),t.s_Jd2),x=X.NegV(y,t.s_J1),S=X.SubVV(y,v,t.s_J2),B=v,b=a*X.DotVV(x,x)+_*X.DotVV(S,S)+m*X.DotVV(B,B);if(0!==b){b=1/b;for(var A=p-this.m_as[i];A>o;)A=(p-=2*o)-this.m_as[i];for(;A<-3.14159265359;)A=(p+=2*o)-this.m_as[i];var g=-this.m_k3*b*A;n.SelfMulAdd(a*g,x),s.SelfMulAdd(_*g,S),r.SelfMulAdd(m*g,B)}}}},e.Draw=function(t){for(var e=new tt(.4,.5,.7),i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)},t}();Ls.s_d=new X,Ls.s_d1=new X,Ls.s_d2=new X,Ls.s_Jd1=new X,Ls.s_Jd2=new X,Ls.s_J1=new X,Ls.s_J2=new X,t.b2AABB=zt,t.b2Abs=G,t.b2Acos=E,t.b2Alloc=function(){return null},t.b2AreaJoint=qi,t.b2AreaJointDef=ki,t.b2Asin=N,t.b2Assert=function(t){if(!t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];throw u(Error,i)}},t.b2Atan2=O,t.b2BlockAllocator=function(){},t.b2Body=Ii,t.b2BodyDef=function(){this.type=t.b2BodyType.b2_staticBody,this.position=new X(0,0),this.angle=0,this.linearVelocity=new X(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1},t.b2BroadPhase=$t,t.b2BuoyancyController=Is,t.b2CalculateParticleIterations=Jn,t.b2ChainAndCircleContact=dn,t.b2ChainAndPolygonContact=pn,t.b2ChainShape=bi,t.b2CircleContact=hn,t.b2CircleShape=xi,t.b2Clamp=T,t.b2ClipSegmentToLine=Jt,t.b2ClipVertex=Rt,t.b2CollideCircles=Ce,t.b2CollideEdgeAndCircle=mi,t.b2CollideEdgeAndPolygon=di,t.b2CollidePolygonAndCircle=Pe,t.b2CollidePolygons=$e,t.b2Color=tt,t.b2ConstantAccelController=Gs,t.b2ConstantForceController=Ds,t.b2Contact=mn,t.b2ContactEdge=_n,t.b2ContactFactory=vn,t.b2ContactFeature=It,t.b2ContactFilter=Sn,t.b2ContactID=Gt,t.b2ContactImpulse=Bn,t.b2ContactListener=bn,t.b2ContactManager=Cn,t.b2ContactPositionConstraint=Tn,t.b2ContactRegister=yn,t.b2ContactSolver=kn,t.b2ContactSolverDef=Ln,t.b2ContactVelocityConstraint=Fn,t.b2Controller=Ps,t.b2ControllerEdge=Ms,t.b2Cos=j,t.b2Counter=nt,t.b2DegToRad=function(t){return t*M},t.b2DestructionListener=xn,t.b2Distance=xt,t.b2DistanceInput=at,t.b2DistanceJoint=Ri,t.b2DistanceJointDef=Li,t.b2DistanceOutput=_t,t.b2DistanceProxy=ot,t.b2Draw=et,t.b2DynamicTree=Zt,t.b2EdgeAndCircleContact=cn,t.b2EdgeAndPolygonContact=fn,t.b2EdgeShape=Bi,t.b2Filter=Ai,t.b2Fixture=wi,t.b2FixtureDef=gi,t.b2FixtureParticleQueryCallback=rs,t.b2FixtureProxy=Ci,t.b2Free=function(){},t.b2FrictionJoint=ji,t.b2FrictionJointDef=zi,t.b2GearJoint=Ei,t.b2GearJointDef=Ji,t.b2GetPointStates=function(e,i,n,s){var o;for(o=0;o<n.pointCount;++o){var r=n.points[o].id.key;e[o]=t.b2PointState.b2_removeState;for(var a=0,_=s.pointCount;a<_;++a)if(s.points[a].id.key===r){e[o]=t.b2PointState.b2_persistState;break}}for(;o<2;++o)e[o]=t.b2PointState.b2_nullState;for(o=0;o<s.pointCount;++o){var m=s.points[o].id.key;i[o]=t.b2PointState.b2_addState;for(var h=0,l=n.pointCount;h<l;++h)if(n.points[h].id.key===m){i[o]=t.b2PointState.b2_persistState;break}}for(;o<2;++o)i[o]=t.b2PointState.b2_nullState},t.b2GravityController=Fs,t.b2GrowableBuffer=os,t.b2GrowableStack=st,t.b2InvSqrt=k,t.b2IsPowerOfTwo=function(t){return t>0&&!(t&t-1)},t.b2IsValid=L,t.b2Island=zn,t.b2Jacobian=Gi,t.b2Joint=Ti,t.b2JointDef=Fi,t.b2JointEdge=Di,t.b2Log=function(){},t.b2MakeArray=V,t.b2MakeNullArray=function(t){for(var e=new Array(t),i=0;i<t;++i)e[i]=null;return e},t.b2MakeNumberArray=w,t.b2Manifold=Tt,t.b2ManifoldPoint=Dt,t.b2MassData=yi,t.b2Mat22=Z,t.b2Mat33=H,t.b2Max=F,t.b2Maybe=e,t.b2Min=D,t.b2MixFriction=rn,t.b2MixRestitution=an,t.b2MotorJoint=Oi,t.b2MotorJointDef=Ni,t.b2MouseJoint=Ui,t.b2MouseJointDef=Xi,t.b2NextPowerOfTwo=function(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,1+((t|=t>>8&16777215)|t>>16&65535)},t.b2Pair=Kt,t.b2PairLessThan=te,t.b2ParseInt=function(t){return parseInt(t,10)},t.b2ParseUInt=function(t){return Math.abs(parseInt(t,10))},t.b2ParticleBodyContact=_s,t.b2ParticleContact=as,t.b2ParticleDef=jn,t.b2ParticleGroup=Xn,t.b2ParticleGroupDef=On,t.b2ParticleHandle=Nn,t.b2ParticlePair=ms,t.b2ParticlePairSet=xs,t.b2ParticleSystem=us,t.b2ParticleSystemDef=ls,t.b2ParticleSystem_CompositeShape=As,t.b2ParticleSystem_ConnectionFilter=Ss,t.b2ParticleSystem_DestroyParticlesInShapeCallback=Bs,t.b2ParticleSystem_FixedSetAllocator=ys,t.b2ParticleSystem_FixtureParticle=function(t,e){this.second=v,this.first=t,this.second=e},t.b2ParticleSystem_FixtureParticleSet=vs,t.b2ParticleSystem_InsideBoundsEnumerator=ds,t.b2ParticleSystem_JoinParticleGroupsFilter=bs,t.b2ParticleSystem_ParticleListNode=ps,t.b2ParticleSystem_ParticlePair=function(t,e){this.first=v,this.second=v,this.first=t,this.second=e},t.b2ParticleSystem_Proxy=fs,t.b2ParticleSystem_ReactiveFilter=gs,t.b2ParticleSystem_SolveCollisionCallback=Vs,t.b2ParticleSystem_UpdateBodyContactsCallback=Cs,t.b2ParticleSystem_UserOverridableBuffer=cs,t.b2ParticleTriad=hs,t.b2PolygonAndCircleContact=un,t.b2PolygonContact=ln,t.b2PolygonShape=Si,t.b2Position=Mn,t.b2PositionSolverManifold=Rn,t.b2Pow=z,t.b2PrismaticJoint=Zi,t.b2PrismaticJointDef=Wi,t.b2Profile=Vn,t.b2PulleyJoint=Qi,t.b2PulleyJointDef=Hi,t.b2QueryCallback=An,t.b2RadToDeg=function(t){return t*P},t.b2Random=function(){return 2*Math.random()-1},t.b2RandomRange=function(t,e){return(e-t)*Math.random()+t},t.b2RayCastCallback=gn,t.b2RayCastInput=kt,t.b2RayCastOutput=qt,t.b2RevoluteJoint=Ki,t.b2RevoluteJointDef=Yi,t.b2Rope=Ls,t.b2RopeDef=function(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new X(0,0),this.damping=.1,this.k2=.9,this.k3=.1},t.b2RopeJoint=tn,t.b2RopeJointDef=$i,t.b2Rot=Q,t.b2SeparationFunction=ue,t.b2Shape=vi,t.b2ShapeCast=function(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();var i=e.proxyA,n=e.proxyB,s=F(i.m_radius,c)+F(n.m_radius,c),o=e.transformA,r=e.transformB,a=e.translationB,_=Bt.Set(0,0),m=0,h=bt;h.m_count=0;for(var l=h.m_vertices,u=i.GetSupport(Q.MulTRV(o.q,X.NegV(a,X.s_t1),X.s_t0)),f=Y.MulXV(o,i.GetVertex(u),At),d=n.GetSupport(Q.MulTRV(r.q,a,X.s_t0)),p=Y.MulXV(r,n.GetVertex(d),gt),y=X.SubVV(f,p,Ct),v=F(c,s-c),x=0;x<20&&G(y.Length()-v)>.004;){t.iterations+=1,u=i.GetSupport(Q.MulTRV(o.q,X.NegV(y,X.s_t1),X.s_t0)),f=Y.MulXV(o,i.GetVertex(u),At),d=n.GetSupport(Q.MulTRV(r.q,y,X.s_t0)),p=Y.MulXV(r,n.GetVertex(d),gt);var S=X.SubVV(f,p,Vt);y.Normalize();var B=X.DotVV(y,S),b=X.DotVV(y,a);if(B-v>m*b){if(b<=0)return!1;if((m=(B-v)/b)>1)return!1;_.Copy(y).SelfNeg(),h.m_count=0}var A=l[h.m_count];switch(A.indexA=d,A.wA.Copy(p).SelfMulAdd(m,a),A.indexB=u,A.wB.Copy(f),A.w.Copy(A.wB).SelfSub(A.wA),A.a=1,h.m_count+=1,h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)return!1;h.GetClosestPoint(y),++x}var g=wt,C=Mt;return h.GetWitnessPoints(g,C),y.LengthSquared()>0&&(_.Copy(y).SelfNeg(),_.Normalize()),t.normal.Copy(_),t.lambda=m,t.iterations=x,!0},t.b2ShapeCastInput=function(){this.proxyA=new ot,this.proxyB=new ot,this.transformA=new Y,this.transformB=new Y,this.translationB=new X},t.b2ShapeCastOutput=function(){this.point=new X,this.normal=new X,this.lambda=0,this.iterations=0},t.b2Simplex=ht,t.b2SimplexCache=rt,t.b2SimplexVertex=mt,t.b2Sin=J,t.b2SolverData=In,t.b2Sq=R,t.b2Sqrt=q,t.b2StackAllocator=function(){},t.b2Swap=function(t,e){var i=t[0];t[0]=e[0],e[0]=i},t.b2Sweep=$,t.b2TOIInput=me,t.b2TOIOutput=le,t.b2TensorDampingController=Ts,t.b2TestOverlapAABB=jt,t.b2TestOverlapShape=Xt,t.b2TimeOfImpact=be,t.b2TimeStep=wn,t.b2Timer=it,t.b2Transform=Y,t.b2TreeNode=Wt,t.b2Vec2=X,t.b2Vec2_zero=U,t.b2Vec3=W,t.b2Velocity=Pn,t.b2VelocityConstraintPoint=Dn,t.b2Version=g,t.b2WeldJoint=nn,t.b2WeldJointDef=en,t.b2WheelJoint=on,t.b2WheelJointDef=sn,t.b2World=ws,t.b2WorldManifold=Lt,t.b2_180_over_pi=P,t.b2_aabbExtension=r,t.b2_aabbMultiplier=2,t.b2_angularSleepTolerance=A,t.b2_angularSlop=_,t.b2_barrierCollisionTime=2.5,t.b2_baumgarte=.2,t.b2_branch="master",t.b2_commit="fbf51801d80fc389d43dc46524520e89043b6faf",t.b2_epsilon=n,t.b2_epsilon_sq=s,t.b2_gjk_reset=function(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0},t.b2_invalidParticleIndex=v,t.b2_linearSleepTolerance=b,t.b2_linearSlop=a,t.b2_maxAngularCorrection=d,t.b2_maxFloat=i,t.b2_maxLinearCorrection=f,t.b2_maxManifoldPoints=2,t.b2_maxParticleForce=.5,t.b2_maxParticleIndex=2147483647,t.b2_maxParticlePressure=S,t.b2_maxPolygonVertices=8,t.b2_maxRotation=p,t.b2_maxRotationSquared=y,t.b2_maxSubSteps=8,t.b2_maxTOIContacts=32,t.b2_maxTranslation=2,t.b2_maxTranslationSquared=4,t.b2_maxTriadDistance=2,t.b2_maxTriadDistanceSquared=4,t.b2_minParticleSystemBufferCapacity=B,t.b2_minParticleWeight=1,t.b2_minPulleyLength=2,t.b2_particleStride=x,t.b2_pi=o,t.b2_pi_over_180=M,t.b2_polygonRadius=c,t.b2_timeToSleep=.5,t.b2_toiBaumgarte=.75,t.b2_toi_reset=function(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0},t.b2_two_pi=I,t.b2_velocityThreshold=1,t.b2_version=C,t.g_blockSolve=Gn,Object.defineProperty(t,"__esModule",{value:!0})}(L);var R=L;y(R);var k=R,q={};for(var z in k)-1===z.indexOf("b2_")&&(q[z.replace("b2","")]=k[z]);var j=y(q),J=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this)._contactFixtures=[],e._BeginContact=null,e._EndContact=null,e._PreSolve=null,e._PostSolve=null,e}h(e,t);var i=e.prototype;return i.setBeginContact=function(t){this._BeginContact=t},i.setEndContact=function(t){this._EndContact=t},i.setPreSolve=function(t){this._PreSolve=t},i.setPostSolve=function(t){this._PostSolve=t},i.BeginContact=function(t){if(this._BeginContact){var e=t.GetFixtureA(),i=t.GetFixtureB(),n=this._contactFixtures;t._shouldReport=!1,-1===n.indexOf(e)&&-1===n.indexOf(i)||(t._shouldReport=!0,this._BeginContact(t))}},i.EndContact=function(t){this._EndContact&&t._shouldReport&&(t._shouldReport=!1,this._EndContact(t))},i.PreSolve=function(t,e){this._PreSolve&&t._shouldReport&&this._PreSolve(t,e)},i.PostSolve=function(t,e){this._PostSolve&&t._shouldReport&&this._PostSolve(t,e)},i.registerContactFixture=function(t){this._contactFixtures.push(t)},i.unregisterContactFixture=function(t){c(this._contactFixtures,t)},e}(j.ContactListener),E=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this)._point=new j.Vec2,e._isPoint=!1,e._fixtures=[],e}h(e,t);var i=e.prototype;return i.init=function(t){t?(this._isPoint=!0,this._point.x=t.x,this._point.y=t.y):this._isPoint=!1,this._fixtures.length=0},i.ReportFixture=function(t){return this._isPoint?t.TestPoint(this._point)&&this._fixtures.push(t):this._fixtures.push(t),!0},i.getFixture=function(){return this._fixtures[0]},i.getFixtures=function(){return this._fixtures},e}(j.QueryCallback),N=function(e){function i(){for(var i,n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];return(i=e.call.apply(e,[this].concat(s))||this)._type=t.Closest,i._fixtures=[],i._points=[],i._normals=[],i._fractions=[],i._mask=4294967295,i}h(i,e);var n=i.prototype;return n.init=function(t,e){this._type=t,this._mask=e,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0},n.ReportFixture=function(e,i,n,s){return e.GetFilterData().categoryBits&this._mask?this._type===t.Closest?(this._fixtures[0]=e,this._points[0]=i,this._normals[0]=n,this._fractions[0]=s,s):(this._fixtures.push(e),this._points.push(new v(i.x,i.y)),this._normals.push(new v(n.x,n.y)),this._fractions.push(s),this._type===t.Any?0:this._type>=t.All?1:s):-1},n.getFixtures=function(){return this._fixtures},n.getPoints=function(){return this._points},n.getNormals=function(){return this._normals},n.getFractions=function(){return this._fractions},i}(j.RayCastCallback),O=[],X=[new v,new v],U=new j.WorldManifold,W={points:[],separations:[],normal:new v},Z=function(){this.localPoint=new v,this.normalImpulse=0,this.tangentImpulse=0},H=[new Z,new Z],Q={type:0,localPoint:new v,localNormal:new v,points:[]},Y={normalImpulses:[],tangentImpulses:[]},K=function(){function t(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}t.get=function(e){var i=O.pop();return i||(i=new t),i.init(e),i},t.put=function(t){var e=t.m_userData;e&&(O.push(e),e.reset())};var n=t.prototype;return n._setImpulse=function(t){this._impulse=t},n.init=function(t){this.colliderA=t.m_fixtureA.m_userData.collider,this.colliderB=t.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=t,t.m_userData=this},n.reset=function(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null},n.getWorldManifold=function(){var t=W.points,i=W.separations,n=W.normal;this._b2contact.GetWorldManifold(U);var s=U.points,o=U.separations,r=this._b2contact.GetManifold().pointCount;t.length=i.length=r;for(var a=0;a<r;a++){var _=X[a];_.x=s[a].x*e,_.y=s[a].y*e,t[a]=_,i[a]=o[a]*e}return n.x=U.normal.x,n.y=U.normal.y,this._inverted&&(n.x*=-1,n.y*=-1),W},n.getManifold=function(){for(var t=Q.points,i=Q.localNormal,n=Q.localPoint,s=this._b2contact.GetManifold(),o=s.points,r=t.length=s.pointCount,a=0;a<r;a++){var _=H[a],m=o[a];_.localPoint.x=m.localPoint.x*e,_.localPoint.y=m.localPoint.y*e,_.normalImpulse=m.normalImpulse*e,_.tangentImpulse=m.tangentImpulse,t[a]=_}return n.x=s.localPoint.x*e,n.y=s.localPoint.y*e,i.x=s.localNormal.x,i.y=s.localNormal.y,Q.type=s.type,this._inverted&&(i.x*=-1,i.y*=-1),Q},n.getImpulse=function(){var t=this._impulse;if(!t)return null;for(var i=Y.normalImpulses,n=Y.tangentImpulses,s=t.count,o=0;o<s;o++)i[o]=t.normalImpulses[o]*e,n[o]=t.tangentImpulses[o];return n.length=i.length=s,Y},n.emit=function(t){var e,n,s=this.colliderA,o=this.colliderB,r=null==s||null==(e=s.body)?void 0:e.enabledContactListener,a=null==o||null==(n=o.body)?void 0:n.enabledContactListener;r&&s.emit(t,s,o,this),a&&o.emit(t,o,s,this),(r||a)&&i.instance.emit(t,s,o,this),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)},n.setEnabled=function(t){this._b2contact.SetEnabled(t)},n.isTouching=function(){return this._b2contact.IsTouching()},n.setTangentSpeed=function(t){this._b2contact.SetTangentSpeed(t)},n.getTangentSpeed=function(){return this._b2contact.GetTangentSpeed()},n.setFriction=function(t){this._b2contact.SetFriction(t)},n.getFriction=function(){return this._b2contact.GetFriction()},n.resetFriction=function(){return this._b2contact.ResetFriction()},n.setRestitution=function(t){this._b2contact.SetRestitution(t)},n.getRestitution=function(){return this._b2contact.GetRestitution()},n.resetRestitution=function(){return this._b2contact.ResetRestitution()},t}(),$=new j.Vec2,tt=new x,et=x.GREEN,it=x.RED,nt=function(t){function i(e){var i;return(i=t.call(this)||this)._drawer=null,i._xf=new j.Transform,i._dxf=new j.Transform,i._drawer=e,i}h(i,t);var n=i.prototype;return n._DrawPolygon=function(t,i){for(var n=this._drawer,s=0;s<i;s++){j.Transform.MulXV(this._xf,t[s],$);var o=$.x*e,r=$.y*e;0===s?n.moveTo(o,r):n.lineTo(o,r)}n.close()},n.DrawPolygon=function(t,e,i){this._applyStrokeColor(i),this._DrawPolygon(t,e),this._drawer.stroke()},n.DrawSolidPolygon=function(t,e,i){this._applyFillColor(i),this._DrawPolygon(t,e),this._drawer.fill(),this._drawer.stroke()},n._DrawCircle=function(t,i){j.Transform.MulXV(this._xf,t,$),this._drawer.circle($.x*e,$.y*e,i*e)},n.DrawCircle=function(t,e,i){this._applyStrokeColor(i),this._DrawCircle(t,e),this._drawer.stroke()},n.DrawSolidCircle=function(t,e,i,n){this._applyFillColor(n),this._DrawCircle(t,e),this._drawer.fill()},n.DrawSegment=function(t,i,n){var s=this._drawer;if(t.x===i.x&&t.y===i.y)return this._applyFillColor(n),this._DrawCircle(t,2/e),void s.fill();this._applyStrokeColor(n),j.Transform.MulXV(this._xf,t,$),s.moveTo($.x*e,$.y*e),j.Transform.MulXV(this._xf,i,$),s.lineTo($.x*e,$.y*e),s.stroke()},n.DrawTransform=function(t){var i=this._drawer;i.strokeColor=it,$.x=$.y=0,j.Transform.MulXV(t,$,$),i.moveTo($.x*e,$.y*e),$.x=1,$.y=0,j.Transform.MulXV(t,$,$),i.lineTo($.x*e,$.y*e),i.stroke(),i.strokeColor=et,$.x=$.y=0,j.Transform.MulXV(t,$,$),i.moveTo($.x*e,$.y*e),$.x=0,$.y=1,j.Transform.MulXV(t,$,$),i.lineTo($.x*e,$.y*e),i.stroke()},n.DrawPoint=function(){},n.DrawParticles=function(){},n._applyStrokeColor=function(t){this._drawer.strokeColor=tt.set(255*t.r,255*t.g,255*t.b,150)},n._applyFillColor=function(t){this._drawer.fillColor=tt.set(255*t.r,255*t.g,255*t.b,150)},n.PushTransform=function(t){this._xf=t},n.PopTransform=function(){this._xf=this._dxf},i}(j.Draw),st=new S,ot=new v,rt=new v,at=new j.BodyDef,_t=new j.AABB,mt=[],ht=function(){function i(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new S,this._physicsGroundBody=void 0,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new j.World(new j.Vec2(0,-10));var t=new j.BodyDef;this._physicsGroundBody=this._world.CreateBody(t);var e=new J;e.setBeginContact(this._onBeginContact),e.setEndContact(this._onEndContact),e.setPreSolve(this._onPreSolve),e.setPostSolve(this._onPostSolve),this._world.SetContactListener(e),this._contactListener=e,this._aabbQueryCallback=new E,this._raycastQueryCallback=new N}var o=i.prototype;return o._checkDebugDrawValid=function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var t=w("Canvas");if(!t){var e=F.getScene();if(!e)return;(t=new M("Canvas")).addComponent("cc.Canvas"),t.parent=e}var i=new M("PHYSICS_2D_DEBUG_DRAW");i.hideFlags|=f.DontSave,i.parent=t,i.worldPosition=S.ZERO,i.layer=P.Enum.UI_2D;try{this._debugGraphics=i.addComponent("cc.Graphics"),this._debugGraphics.lineWidth=3;var n=new nt(this._debugGraphics);this._b2DebugDrawer=n,this._world.SetDebugDraw(n)}catch(t){d(4501,t.message),i.destroy(),i=null}}if(this._debugGraphics){var s=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(s.children.length-1)}this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)},o.setGravity=function(t){this._world.SetGravity(t)},o.setAllowSleep=function(){this._world.SetAllowSleeping(!0)},o.step=function(t,e,i){void 0===e&&(e=10),void 0===i&&(i=10);for(var n=this._animatedBodies,s=0,o=n.length;s<o;s++)n[s].animate(t);this._world.Step(t,e,i)},o.raycast=function(i,n,s,o){if(i.equals(n))return[];s=s||t.Closest,ot.x=i.x/e,ot.y=i.y/e,rt.x=n.x/e,rt.y=n.y/e;var r=this._raycastQueryCallback;r.init(s,o),this._world.RayCast(r,ot,rt);var a=r.getFixtures();if(a.length>0){for(var _=r.getPoints(),m=r.getNormals(),h=r.getFractions(),l=[],u=0,c=a.length;u<c;u++){var f=a[u],d=f.m_userData,p=d.collider;if(s===t.AllClosest){for(var y=void 0,x=0;x<l.length;x++)l[x].collider===p&&(y=l[x]);if(y){h[u]<y.fraction&&(y.fixtureIndex=d.getFixtureIndex(f),y.point.x=_[u].x*e,y.point.y=_[u].y*e,y.normal.x=m[u].x,y.normal.y=m[u].y,y.fraction=h[u]);continue}}l.push({collider:p,fixtureIndex:d.getFixtureIndex(f),point:new v(_[u].x*e,_[u].y*e),normal:new v(m[u].x,m[u].y),fraction:h[u]})}return l}return[]},o.syncPhysicsToScene=function(){for(var t=this._bodies,i=0,s=t.length;i<s;i++){var o=t[i],r=o.rigidBody;if(r.type!==n.Animated){var a=r.node,_=o.impl,m=_.GetPosition();st.x=m.x*e,st.y=m.y*e,st.z=0,a.worldPosition=st;var h=B(_.GetAngle());a.setWorldRotationFromEuler(0,0,h)}else o.resetVelocity()}},o.syncSceneToPhysics=function(){for(var t=this._bodies,e=0;e<t.length;e++)t[e].syncSceneToPhysics()},o.addBody=function(t){if(!this._bodies.includes(t)){var i=at,s=t.rigidBody;i.allowSleep=s.allowSleep,i.gravityScale=s.gravityScale,i.linearDamping=s.linearDamping,i.angularDamping=s.angularDamping,i.fixedRotation=s.fixedRotation,i.bullet=s.bullet;var o=s.node,r=o.worldPosition;i.position.Set(r.x/e,r.y/e),st.z=b.getAxisAngle(this._rotationAxis,o.worldRotation),this._rotationAxis.z<0&&(st.z=2*Math.PI-st.z),i.angle=st.z,i.awake=s.awakeOnLoad,s.type===n.Animated?(i.type=n.Kinematic,this._animatedBodies.push(t),t._animatedPos.set(i.position.x,i.position.y),t._animatedAngle=i.angle):i.type=s.type;var a=s,_=a._linearVelocity;i.linearVelocity.Set(_.x,_.y),i.angularVelocity=a._angularVelocity;var m=this._world.CreateBody(i);m.m_userData=t,t._imp=m,this._bodies.push(t)}},o.removeBody=function(t){this._bodies.includes(t)&&(t.impl&&(t.impl.m_userData=null,this._world.DestroyBody(t.impl),t._imp=null),c(this._bodies,t),t.rigidBody.type===n.Animated&&c(this._animatedBodies,t))},o._updateBodyType=function(t){var e=this._animatedBodies;if(t.rigidBody.type!==n.Animated)c(e,t);else{if(e.includes(t))return;e.push(t)}},o.registerContactFixture=function(t){this._contactListener.registerContactFixture(t)},o.unregisterContactFixture=function(t){this._contactListener.unregisterContactFixture(t)},o.testPoint=function(t){var i=ot.x=t.x/e,n=ot.y=t.y/e,s=.2/e;_t.lowerBound.x=i-s,_t.lowerBound.y=n-s,_t.upperBound.x=i+s,_t.upperBound.y=n+s;var o=this._aabbQueryCallback;o.init(ot),this._world.QueryAABB(o,_t);var r=o.getFixtures();mt.length=0;for(var a=0;a<r.length;a++){var _=r[a].m_userData.collider;mt.includes(_)||mt.push(_)}return mt},o.testAABB=function(t){_t.lowerBound.x=t.xMin/e,_t.lowerBound.y=t.yMin/e,_t.upperBound.x=t.xMax/e,_t.upperBound.y=t.yMax/e;var i=this._aabbQueryCallback;i.init(),this._world.QueryAABB(i,_t);var n=i.getFixtures();mt.length=0;for(var s=0;s<n.length;s++){var o=n[s].m_userData.collider;mt.includes(o)||mt.push(o)}return mt},o.drawDebug=function(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())},o._onBeginContact=function(t){K.get(t).emit(s.BEGIN_CONTACT)},o._onEndContact=function(t){var e=t.m_userData;e&&(e.emit(s.END_CONTACT),K.put(t))},o._onPreSolve=function(t){var e=t.m_userData;e&&e.emit(s.PRE_SOLVE)},o._onPostSolve=function(t,e){var i=t.m_userData;i&&(i._setImpulse(e),i.emit(s.POST_SOLVE),i._setImpulse(null))},m(i,[{key:"impl",get:function(){return this._world}},{key:"groundBodyImpl",get:function(){return this._physicsGroundBody}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(t){t||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=t}}]),i}(),lt=new S,ut=new j.Vec2,ct=function(){function t(){this._animatedPos=new v,this._animatedAngle=0,this._body=null,this._rigidBody=void 0,this._inited=!1}var s=t.prototype;return s.initialize=function(t){this._rigidBody=t,i.instance._callAfterStep(this,this._init)},s.onDestroy=function(){i.instance._callAfterStep(this,this._destroy)},s.onEnable=function(){this.setActive(!0)},s.onDisable=function(){this.setActive(!1)},s.nodeTransformChanged=function(t){if(!i.instance.stepping){if(t&M.TransformBit.SCALE)for(var e=this.rigidBody.getComponents(o),n=0;n<e.length;n++)e[n].apply();t&M.TransformBit.POSITION&&this.syncPositionToPhysics(!0),t&M.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}},s._init=function(){this._inited||(i.instance.physicsWorld.addBody(this),this.setActive(!1),this._inited=!0)},s._destroy=function(){this._inited&&(i.instance.physicsWorld.removeBody(this),this._inited=!1)},s.animate=function(t){var e=this._body;if(e){var i=e.GetPosition();e.SetAwake(!0);var n=1/t;ut.x=(this._animatedPos.x-i.x)*n,ut.y=(this._animatedPos.y-i.y)*n,e.SetLinearVelocity(ut);var s=e.GetAngle()%A;s>Math.PI&&(s-=A);var o=(this._animatedAngle-s)*n;this._animatedAngle<-g&&s>g&&(o=(this._animatedAngle+A-s)*n),this._animatedAngle>g&&s<-g&&(o=(this._animatedAngle-A-s)*n),e.SetAngularVelocity(o)}},s.syncSceneToPhysics=function(){var t=this._rigidBody.node.hasChangedFlags;t&&this.nodeTransformChanged(t)},s.syncPositionToPhysics=function(t){void 0===t&&(t=!1);var i=this._body;if(i){var s,o=this._rigidBody.node.worldPosition,r=this._rigidBody.type;(s=r===n.Animated?i.GetLinearVelocity():i.GetPosition()).x=o.x/e,s.y=o.y/e,r===n.Animated&&t?this._animatedPos.set(s.x,s.y):i.SetTransformVec(s,i.GetAngle())}},s.syncRotationToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var i=this._rigidBody.node.worldRotation,s=lt;b.toEulerInYXZOrder(s,i);var o=C(s.z);this._rigidBody.type===n.Animated&&t?this._animatedAngle=o:e.SetTransformVec(e.GetPosition(),o)}},s.resetVelocity=function(){var t=this._body;if(t){var e=t.m_linearVelocity;e.Set(0,0),t.SetLinearVelocity(e),t.SetAngularVelocity(0)}},s.setType=function(t){i.instance.physicsWorld._updateBodyType(this),this._body.SetType(t)},s.setLinearDamping=function(t){this._body.SetLinearDamping(t)},s.setAngularDamping=function(t){this._body.SetAngularDamping(t)},s.setGravityScale=function(t){this._body.SetGravityScale(t)},s.setFixedRotation=function(t){this._body.SetFixedRotation(t)},s.setAllowSleep=function(t){this._body.SetSleepingAllowed(t)},s.isActive=function(){return this._body.IsActive()},s.setActive=function(t){this._body.m_world.IsLocked()||this._body.SetActive(t)},s.wakeUp=function(){this._body.SetAwake(!0)},s.sleep=function(){this._body.SetAwake(!1)},s.getMass=function(){return this._body.GetMass()},s.setLinearVelocity=function(t){this._body.SetLinearVelocity(t)},s.getLinearVelocity=function(t){var e=this._body.GetLinearVelocity();return t.x=e.x,t.y=e.y,t},s.getLinearVelocityFromWorldPoint=function(t,i){return ut.Set(t.x/e,t.y/e),this._body.GetLinearVelocityFromWorldPoint(ut,i),i.x*=e,i.y*=e,i},s.setAngularVelocity=function(t){this._body.SetAngularVelocity(t)},s.getAngularVelocity=function(){return this._body.GetAngularVelocity()},s.getLocalVector=function(t,i){return i=i||new v,ut.Set(t.x/e,t.y/e),this._body.GetLocalVector(ut,i),i.x*=e,i.y*=e,i},s.getWorldVector=function(t,i){return ut.Set(t.x/e,t.y/e),this._body.GetWorldVector(ut,i),i.x*=e,i.y*=e,i},s.getLocalPoint=function(t,i){return i=i||new v,ut.Set(t.x/e,t.y/e),this._body.GetLocalPoint(ut,i),i.x*=e,i.y*=e,i},s.getWorldPoint=function(t,i){return i=i||new v,ut.Set(t.x/e,t.y/e),this._body.GetWorldPoint(ut,i),i.x*=e,i.y*=e,i},s.getLocalCenter=function(t){t=t||new v;var i=this._body.GetLocalCenter();return t.x=i.x*e,t.y=i.y*e,t},s.getWorldCenter=function(t){t=t||new v;var i=this._body.GetWorldCenter();return t.x=i.x*e,t.y=i.y*e,t},s.getInertia=function(){return this._body.GetInertia()},s.applyForce=function(t,i,n){this._body&&(ut.Set(i.x/e,i.y/e),this._body.ApplyForce(t,ut,n))},s.applyForceToCenter=function(t,e){this._body&&this._body.ApplyForceToCenter(t,e)},s.applyTorque=function(t,e){this._body&&this._body.ApplyTorque(t,e)},s.applyLinearImpulse=function(t,i,n){this._body&&(ut.Set(i.x/e,i.y/e),this._body.ApplyLinearImpulse(t,ut,n))},s.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.ApplyLinearImpulse(t,this._body.GetPosition(),e)},s.applyAngularImpulse=function(t,e){this._body&&this._body.ApplyAngularImpulse(t,e)},m(t,[{key:"impl",get:function(){return this._body}},{key:"_imp",set:function(t){this._body=t}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isAwake",get:function(){return this._body.IsAwake()}},{key:"isSleeping",get:function(){return!this._body.IsAwake()}}]),t}(),ft=new j.Filter,dt=new j.Vec2,pt=new j.Vec2;function yt(t){var e=t.collider;return e.body?ft.categoryBits=e.group===T.DEFAULT?e.body.group:e.group:ft.categoryBits=e.group,ft.maskBits=i.instance.collisionMatrix[ft.categoryBits],ft}var vt=function(){function t(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new V}var n=t.prototype;return n.initialize=function(t){this._collider=t},n.onLoad=function(){},n.onEnable=function(){i.instance._callAfterStep(this,this._init)},n.onDisable=function(){i.instance._callAfterStep(this,this._destroy)},n.start=function(){},n.onGroupChanged=function(){var t=yt(this);this._fixtures.forEach((function(e){e.SetFilterData(t)}))},n.apply=function(){this._destroy(),this.collider.enabledInHierarchy&&this._init()},n.getFixtureIndex=function(t){return this._fixtures.indexOf(t)},n._createShapes=function(){return[]},n._init=function(){if(!this._inited){var t=this.collider,e=t.node.worldScale,n=S.ZERO,s=t.getComponent(r);s&&s.impl&&s.impl.impl?this._body=s.impl.impl:(this._body=i.instance.physicsWorld.groundBodyImpl,n=t.node.worldPosition);for(var o=0===e.x&&0===e.y?[]:this._createShapes(e.x,e.y,n.x,n.y),a=yt(this),_=0;_<o.length;_++){var m=o[_],h={density:t.density,isSensor:t.sensor,friction:t.friction,restitution:t.restitution,shape:m,filter:a},l=this._body.CreateFixture(h);l.m_userData=this,null!=s&&s.enabledContactListener&&i.instance.physicsWorld.registerContactFixture(l),this._shapes.push(m),this._fixtures.push(l)}this._inited=!0}},n._destroy=function(){if(this._inited){for(var t=this._fixtures,e=this._body,n=t.length-1;n>=0;n--){var s=t[n];s.m_userData=null,i.instance.physicsWorld.unregisterContactFixture(s),e&&e.DestroyFixture(s)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}},m(t,[{key:"impl",get:function(){return this._shapes}},{key:"collider",get:function(){return this._collider}},{key:"worldAABB",get:function(){for(var t=1e7,i=t,n=t,s=-1e7,o=-1e7,r=this._fixtures,a=0;a<r.length;a++)for(var _=r[a],m=_.GetShape().GetChildCount(),h=0;h<m;h++){if(dt.Copy(_.GetAABB(h).lowerBound),pt.Copy(_.GetAABB(h).upperBound),2===_.GetShape().m_type){var l=_.GetShape().m_radius;dt.SelfAddXY(l,l),pt.SelfSubXY(l,l)}dt.x<i&&(i=dt.x),dt.y<n&&(n=dt.y),pt.x>s&&(s=pt.x),pt.y>o&&(o=pt.y)}i*=e,n*=e,s*=e,o*=e;var u=this._rect;return u.x=i,u.y=n,u.width=s-i,u.height=o-n,u}}]),t}(),xt=new V,St=function(t){function i(){for(var e,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this)._worldPoints=[new v,new v,new v,new v],e}return h(i,t),i.prototype._createShapes=function(t,i,n,s){t=Math.abs(t),i=Math.abs(i);var o=this.collider,r=o.size.width/2/e*t,a=o.size.height/2/e*i,_=(n+o.offset.x*t)/e,m=(s+o.offset.y*i)/e,h=new j.PolygonShape;return h.SetAsBox(r,a,new j.Vec2(_,m),0),[h]},m(i,[{key:"worldPoints",get:function(){var t=xt,e=this.collider,i=e.size,n=e.offset;t.x=n.x-i.width/2,t.y=n.y-i.height/2,t.width=i.width,t.height=i.height;var s=this._worldPoints,o=s[0],r=s[1],a=s[2],_=s[3];return t.transformMat4ToPoints(e.node.worldMatrix,o,r,a,_),s}}]),i}(vt),Bt=function(t){function i(){for(var e,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this)._worldPosition=new v,e}return h(i,t),i.prototype._createShapes=function(t,i,n,s){t=Math.abs(t),i=Math.abs(i);var o=this.collider,r=(n+o.offset.x*t)/e,a=(s+o.offset.y*i)/e,_=new j.CircleShape;return _.m_radius=o.radius/e*t,_.m_p.Set(r,a),[_]},m(i,[{key:"worldRadius",get:function(){return this._shapes[0].m_radius*e}},{key:"worldPosition",get:function(){var t=this._shapes[0].m_p;return this._worldPosition.set(t.x*e,t.y*e)}}]),i}(vt),bt=function(t){function i(){for(var e,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this)._worldPoints=[],e}return h(i,t),i.prototype._createShapes=function(t,i,n,s){var o=[],r=this.collider,_=r.points;_.length>0&&_[0].equals(_[_.length-1])&&(_.length-=1);var m=a(_);if(!m)return p(16408,r.node.name),o;for(var h=r.offset,l=0;l<m.length;l++){for(var u=m[l],c=null,f=[],d=null,y=0,v=u.length;y<v;y++){c||(c=new j.PolygonShape);var x=u[y],S=(n+(x.x+h.x)*t)/e,B=(s+(x.y+h.y)*i)/e,b=new j.Vec2(S,B);f.push(b),d||(d=b),f.length===j.maxPolygonVertices&&(c.Set(f,f.length),o.push(c),c=null,y<v-1&&(f=[d,f[f.length-1]]))}c&&(c.Set(f,f.length),o.push(c))}return o},m(i,[{key:"worldPoints",get:function(){for(var t=this.collider,e=t.points,i=this._worldPoints,n=t.node.worldMatrix,s=0;s<e.length;s++)i[s]||(i[s]=new v),v.transformMat4(i[s],e[s],n);return i.length=e.length,this._worldPoints}}]),i}(vt),At=function(){function t(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._jointComp=t},e.onEnable=function(){i.instance._callAfterStep(this,this._init)},e.onDisable=function(){i.instance._callAfterStep(this,this._destroy)},e.start=function(){i.instance._callAfterStep(this,this._init)},e.apply=function(){i.instance._callAfterStep(this,this._destroy),this.comp.enabledInHierarchy&&i.instance._callAfterStep(this,this._init)},e._init=function(){if(!this._inited){var t=this._jointComp;if(t.isValid){this._body=t.getComponent(r);var e=this._createJointDef();if(e){e.bodyA=this._body.impl.impl;var n=t.connectedBody;n&&!n.enabledInHierarchy||(e.bodyB=n?n.impl.impl:i.instance.physicsWorld.groundBodyImpl,e.collideConnected=t.collideConnected,this._b2joint=i.instance.physicsWorld.impl.CreateJoint(e),this._inited=!0)}}}},e._destroy=function(){this._inited&&(i.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)},e._createJointDef=function(){return null},e.isValid=function(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp},m(t,[{key:"impl",get:function(){return this._b2joint}},{key:"comp",get:function(){return this._jointComp}},{key:"body",get:function(){return this._body}}]),t}(),gt=new j.Vec2,Ct=function(t){function n(){for(var e,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this)._touchPoint=new v,e._isTouched=!1,e}h(n,t);var s=n.prototype;return s.setTarget=function(t){this._b2joint&&(gt.x=t.x/e,gt.y=t.y/e,this._b2joint.SetTarget(gt))},s.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},s.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},s.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},s._createJointDef=function(){var t=new j.MouseJointDef,i=this._jointComp;return t.target.Set(this._touchPoint.x/e,this._touchPoint.y/e),t.maxForce=i.maxForce,t.dampingRatio=i.dampingRatio,t.frequencyHz=i.frequency,t},s.start=function(){},s.onEnable=function(){this._enableTouch(!0)},s.onDisable=function(){t.prototype.onDisable.call(this),this._enableTouch(!1)},s._enableTouch=function(t){var e=w("Canvas");if(e){var i=t?e.on:e.off;i.call(e,I.TOUCH_START,this.onTouchBegan,this),i.call(e,I.TOUCH_MOVE,this.onTouchMove,this),i.call(e,I.TOUCH_END,this.onTouchEnd,this),i.call(e,I.TOUCH_CANCEL,this.onTouchEnd,this)}},s.onTouchBegan=function(t){this._isTouched=!0;var e=this._touchPoint.set(t.getUILocation()),n=i.instance.physicsWorld.testPoint(e);if(!(n.length<=0)){var s=n[0].body;s.wakeUp();var o=this._jointComp;o.connectedBody=s,this._init(),this.setMaxForce(o.maxForce*s.getMass()),this.setTarget(e)}},s.onTouchMove=function(t){this._touchPoint=t.getUILocation()},s.onTouchEnd=function(){this._destroy(),this._isTouched=!1},s.update=function(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)},n}(At),Vt=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var n=i.prototype;return n.setMaxLength=function(t){this._b2joint&&this._b2joint.SetMaxLength(t)},n._createJointDef=function(){var t=this._jointComp,i=new j.RopeJointDef;return i.localAnchorA.Set(t.anchor.x/e,t.anchor.y/e),i.localAnchorB.Set(t.connectedAnchor.x/e,t.connectedAnchor.y/e),i.maxLength=t.maxLength/e,i},i}(At),wt=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var n=i.prototype;return n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setDistance=function(t){this._b2joint&&this._b2joint.SetLength(t)},n._createJointDef=function(){var t=this._jointComp,i=new j.DistanceJointDef;return i.localAnchorA.Set(t.anchor.x/e,t.anchor.y/e),i.localAnchorB.Set(t.connectedAnchor.x/e,t.connectedAnchor.y/e),i.length=t.distance/e,i.dampingRatio=t.dampingRatio,i.frequencyHz=t.frequency,i},i}(At),Mt=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var n=i.prototype;return n.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},n.setAngularOffset=function(t){this._b2joint&&this._b2joint.SetAngularOffset(C(t))},n.setLinearOffset=function(t){this._b2joint&&this._b2joint.SetLinearOffset(new j.Vec2(t.x/e,t.y/e))},n.setCorrectionFactor=function(t){this._b2joint&&(this._b2joint.m_correctionFactor=t)},n.setMaxTorque=function(t){this._b2joint&&this._b2joint.SetMaxTorque(t)},n._createJointDef=function(){var t=this._jointComp,i=new j.MotorJointDef;return i.linearOffset.Set(t.linearOffset.x/e,t.linearOffset.y/e),i.angularOffset=C(t.angularOffset),i.maxForce=t.maxForce,i.maxTorque=t.maxTorque,i.correctionFactor=t.correctionFactor,i},i}(At),Pt=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var n=i.prototype;return n.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},n.setLowerLimit=function(){this.updateLimits()},n.setUpperLimit=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(t.lowerLimit/e,t.upperLimit/e)}},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorForce=function(t){this._b2joint&&this._b2joint.SetMaxMotorForce(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,i=new j.PrismaticJointDef;i.localAnchorA.Set(t.anchor.x/e,t.anchor.y/e),i.localAnchorB.Set(t.connectedAnchor.x/e,t.connectedAnchor.y/e);var n=C(t.angle);return i.localAxisA.Set(Math.cos(n),Math.sin(n)),i.referenceAngle=0,i.enableLimit=t.enableLimit,i.lowerTranslation=t.lowerLimit/e,i.upperTranslation=t.upperLimit/e,i.enableMotor=t.enableMotor,i.maxMotorForce=t.maxMotorForce,i.motorSpeed=t.motorSpeed,i},i}(At),It=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var n=i.prototype;return n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n._createJointDef=function(){var t=this._jointComp,i=new j.WeldJointDef;return i.localAnchorA.Set(t.anchor.x/e,t.anchor.y/e),i.localAnchorB.Set(t.connectedAnchor.x/e,t.connectedAnchor.y/e),i.referenceAngle=0,i.frequencyHz=t.frequency,i.dampingRatio=t.dampingRatio,i},i}(At),Gt=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var n=i.prototype;return n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetSpringDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetSpringFrequencyHz(t)},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,i=new j.WheelJointDef;i.localAnchorA.Set(t.anchor.x/e,t.anchor.y/e),i.localAnchorB.Set(t.connectedAnchor.x/e,t.connectedAnchor.y/e);var n=C(t.angle);return i.localAxisA.Set(Math.cos(n),Math.sin(n)),i.maxMotorTorque=t.maxMotorTorque,i.motorSpeed=C(t.motorSpeed),i.enableMotor=t.enableMotor,i.dampingRatio=t.dampingRatio,i.frequencyHz=t.frequency,i},i}(At),Dt=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var n=i.prototype;return n.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},n.setLowerAngle=function(){this.updateLimits()},n.setUpperAngle=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(C(t.lowerAngle),C(t.upperAngle))}},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,i=new j.RevoluteJointDef;return i.localAnchorA.Set(t.anchor.x/e,t.anchor.y/e),i.localAnchorB.Set(t.connectedAnchor.x/e,t.connectedAnchor.y/e),i.enableMotor=t.enableMotor,i.maxMotorTorque=t.maxMotorTorque,i.motorSpeed=C(t.motorSpeed),i.enableLimit=t.enableLimit,i.lowerAngle=C(t.lowerAngle),i.upperAngle=C(t.upperAngle),i},i}(At);G.once(D.EVENT_PRE_SUBSYSTEM_INIT,(function(){_.register("box2d",{PhysicsWorld:ht,RigidBody:ct,BoxShape:St,CircleShape:Bt,PolygonShape:bt,MouseJoint:Ct,DistanceJoint:Vt,SpringJoint:wt,RelativeJoint:Mt,SliderJoint:Pt,FixedJoint:It,WheelJoint:Gt,HingeJoint:Dt})}))}}}));
