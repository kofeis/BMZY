{"version":3,"sources":["file:///Users/jingfaxie/Documents/UGit/minigame3/Aby/assets/scripts/game/model/UserData.ts"],"names":["UserData","Game","game","js","sys","msgcmd","audioManager","eventManager","designManager","constants","constructor","$localKey","$playerData","$openLevel","$skillClearNum","$skillMoveNum","$skillRefreshNum","getInstance","_instance","onInit","getLocalData","initEvent","setBaseConfig","obj","localStorage","getItem","console","log","mixin","JSON","parse","setConfig","playerData","data","openLevel","level","addSkillClear","useSkillClear","addSkillMove","useSkillRefresh","setLevelData","nextId","getRowById","tableNames","food","on","EVENT_HIDE","resetAccount","saveData","EVENT_SHOW","gameOnShow","emit","saveDataBefore","createMap","key","indexOf","setItem","stringify","saveDataAfter","clearAccountData","removeItem"],"mappings":";;;kKAOaA,Q;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAPJC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,I,OAAAA,I;AAAMC,MAAAA,E,OAAAA,E;AAAIC,MAAAA,G,OAAAA,G;;AAChBC,MAAAA,M,iBAAAA,M;;AACAC,MAAAA,Y,iBAAAA,Y;;AACAC,MAAAA,Y,iBAAAA,Y;;AACAC,MAAAA,a,iBAAAA,a;;AACAC,MAAAA,S,iBAAAA,S;;;;;;;;;0BAEIT,Q,GAAN,MAAMA,QAAN,CAAe;AAIVU,QAAAA,WAAW,GAAG;AAAA,eASfC,SATe,GASK,UATL;AAAA,eAWdC,WAXc,GAWK,EAXL;AAatB;AAbsB,eAcdC,UAdc,GAcD,CAdC;AAgBtB;AAhBsB,eAiBdC,cAjBc,GAiBG,CAjBH;AAkBtB;AAlBsB,eAmBdC,aAnBc,GAmBE,CAnBF;AAoBtB;AApBsB,eAqBdC,gBArBc,GAqBK,CArBL;AAAE;;AACC,eAAXC,WAAW,GAAG;AACxB,cAAI,KAAKC,SAAL,IAAkB,IAAtB,EAA4B;AACxB,iBAAKA,SAAL,GAAiB,IAAIlB,QAAJ,EAAjB;;AACA,iBAAKkB,SAAL,CAAeC,MAAf;AACH;;AACD,iBAAO,KAAKD,SAAZ;AACH;;AAgBDC,QAAAA,MAAM,GAAG;AACL,eAAKC,YAAL;AACA,eAAKC,SAAL;AACA,eAAKC,aAAL;AACH;;AAEMF,QAAAA,YAAY,GAAG;AAClB,cAAIG,GAAG,GAAGnB,GAAG,CAACoB,YAAJ,CAAiBC,OAAjB,CAAyB,KAAKd,SAA9B,CAAV;;AACA,cAAIY,GAAJ,EAAS;AACLG,YAAAA,OAAO,CAACC,GAAR,CAAY,QAAZ,EAAsBJ,GAAtB;AACApB,YAAAA,EAAE,CAACyB,KAAH,CAAS,IAAT,EAAeC,IAAI,CAACC,KAAL,CAAWP,GAAX,CAAf;AACH,WAHD,MAGO;AACHG,YAAAA,OAAO,CAACC,GAAR,CAAY,QAAZ;AACA,iBAAKI,SAAL;AACH;AACJ;;AAEDT,QAAAA,aAAa,GAAG,CACf;;AAEDS,QAAAA,SAAS,GAAG,CACX;;AAEoB,YAAVC,UAAU,CAACC,IAAD,EAAY;AAC7B,eAAKrB,WAAL,GAAmBqB,IAAnB;AACH;;AACoB,YAAVD,UAAU,GAAG;AACpB,iBAAO,KAAKpB,WAAZ;AACH;;AAEmB,YAATsB,SAAS,CAACC,KAAD,EAAQ;AACxB,eAAKtB,UAAL,GAAkBsB,KAAlB;AACH;;AACmB,YAATD,SAAS,GAAG;AACnB,iBAAO,KAAKrB,UAAZ;AACH;;AAEMuB,QAAAA,aAAa,GAAG;AACnB,eAAKtB,cAAL,IAAuB,CAAvB;AACH;;AAEMuB,QAAAA,aAAa,GAAG;AACnB,eAAKvB,cAAL,IAAuB,CAAvB;AACH;;AAEMwB,QAAAA,YAAY,GAAG;AAClB,eAAKvB,aAAL,IAAsB,CAAtB;AACH;;AAEMwB,QAAAA,eAAe,GAAG;AACrB,eAAKvB,gBAAL,IAAyB,CAAzB;AACH,SA9EiB,CAgFlB;;;AACOwB,QAAAA,YAAY,CAACP,IAAD,EAAY;AAC3B;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA,cAAIQ,MAAM,GAAG,KAAK5B,UAAL,GAAkB,CAA/B;;AACA,cAAI;AAAA;AAAA,8CAAc6B,UAAd,CAAyB;AAAA;AAAA,sCAAUC,UAAV,CAAqBC,IAA9C,EAAoDH,MAApD,CAAJ,EAAiE;AAC7Df,YAAAA,OAAO,CAACC,GAAR,CAAY,kBAAZ,EAAgC,KAAKd,UAArC;AACA,iBAAKA,UAAL;AACH;AACJ,SApHiB,CAsHlB;;;AACUQ,QAAAA,SAAS,GAAG;AAClBnB,UAAAA,IAAI,CAAC2C,EAAL,CAAQ5C,IAAI,CAAC6C,UAAb,EAAyB,MAAM;AAC3B;AACA,gBAAI,KAAKC,YAAT,EAAuB;AACnB;AACH;;AACD,iBAAKC,QAAL;AACH,WAND;AAOA9C,UAAAA,IAAI,CAAC2C,EAAL,CAAQ5C,IAAI,CAACgD,UAAb,EAAyB,MAAM;AAC3B;AAAA;AAAA,8CAAaC,UAAb;AACH,WAFD;AAGH;;AAEMF,QAAAA,QAAQ,GAAG;AACd;AAAA;AAAA,4CAAaG,IAAb,CAAkB;AAAA;AAAA,gCAAOC,cAAzB;AACA,cAAI7B,GAAG,GAAGpB,EAAE,CAACkD,SAAH,CAAa,IAAb,CAAV;AAA6B;;AAC7B,eAAK,IAAIC,GAAT,IAAgB,IAAhB,EAAsB;AAClB,gBAAIA,GAAG,CAACC,OAAJ,CAAY,GAAZ,KAAoB,CAAC,CAAzB,EAA4B;AACxBhC,cAAAA,GAAG,CAAC+B,GAAD,CAAH,GAAW,KAAKA,GAAL,CAAX;AACH;AACJ;;AACDlD,UAAAA,GAAG,CAACoB,YAAJ,CAAiBgC,OAAjB,CAAyB,KAAK7C,SAA9B,EAAyCkB,IAAI,CAAC4B,SAAL,CAAelC,GAAf,CAAzC;AACA;AAAA;AAAA,4CAAa4B,IAAb,CAAkB;AAAA;AAAA,gCAAOO,aAAzB;AACH,SA9IiB,CAgJlB;;;AACOC,QAAAA,gBAAgB,GAAG;AACtBvD,UAAAA,GAAG,CAACoB,YAAJ,CAAiBoC,UAAjB,CAA4B,KAAKjD,SAAjC,EADsB,CAEtB;;AACA,eAAKQ,MAAL;AACH;;AArJiB,O;;AAElB;AAFSnB,MAAAA,Q,CAGMkB,S","sourcesContent":["import { Game, game, js, sys } from \"cc\";\nimport { msgcmd } from \"../data/MsgCmd\";\nimport { audioManager } from \"../../framework/manager/AudioManager\";\nimport { eventManager } from \"../../framework/manager/EventManager\";\nimport { designManager } from \"../../framework/manager/DesignManager\";\nimport { constants } from \"../data/Constants\";\n\nexport class UserData {\n\n    // 单例\n    private static _instance: UserData;\n    private constructor() {}\n    public static getInstance() {\n        if (this._instance == null) {\n            this._instance = new UserData()\n            this._instance.onInit()\n        }\n        return this._instance\n    }\n\n    public $localKey: string = \"UserData\";\n\n    private $playerData: any = {};\n\n    // 当前解锁到哪关\n    private $openLevel = 1;\n\n    // 消除道具数量\n    private $skillClearNum = 0;\n    // 换位道具数量\n    private $skillMoveNum = 0;\n    // 重发道具数量\n    private $skillRefreshNum = 0;\n\n    onInit() {\n        this.getLocalData();\n        this.initEvent();\n        this.setBaseConfig()\n    }\n\n    public getLocalData() {\n        let obj = sys.localStorage.getItem(this.$localKey);\n        if (obj) {\n            console.log(\"加载本地数据\", obj);\n            js.mixin(this, JSON.parse(obj));\n        } else {\n            console.log(\"本地数据为空\");\n            this.setConfig()\n        }\n    }\n\n    setBaseConfig() {\n    }\n\n    setConfig() {\n    }\n\n    public set playerData(data: any) {\n        this.$playerData = data;\n    }\n    public get playerData() {\n        return this.$playerData;\n    }\n\n    public set openLevel(level) {\n        this.$openLevel = level;\n    }\n    public get openLevel() {\n        return this.$openLevel;\n    }\n\n    public addSkillClear() {\n        this.$skillClearNum += 1;\n    }\n\n    public useSkillClear() {\n        this.$skillClearNum -= 1;\n    }\n\n    public addSkillMove() {\n        this.$skillMoveNum += 1;\n    }\n\n    public useSkillRefresh() {\n        this.$skillRefreshNum -= 1;\n    }\n\n    // 保存关卡完成情况的数据\n    public setLevelData(data: any) {\n        // let row = designManager.getRowById(constants.tableNames.map, data.Level);\n        // if (row.type != constants.mapTypes.main) {\n        //     return;\n        // }\n\n        // let index = data.Level - 1\n        // if (index < 0) {\n        //     index = 0\n        // }\n\n        // if (this.$levelData[index] == null) {\n        //     this.$levelData[index] = data\n        // } else {\n        //     if (data.Score > this.$levelData[index].Score) {\n        //         this.$levelData[index].Score = data.Score\n        //     }\n        // }\n\n        // // 通关后设置解锁下一关\n        // if (data.IsWin) {\n        //     if (this.$openLevel <= data.Level) {\n        //         let nextId = this.$openLevel + 1;\n        //         if (designManager.getRowById(constants.tableNames.map, nextId)) {\n        //             this.$openLevel++\n        //             this.$curMap = this.$openLevel\n        //         }\n        //     }\n        // }\n\n        let nextId = this.$openLevel + 1;\n        if (designManager.getRowById(constants.tableNames.food, nextId)) {\n            console.log(\"update openLevel\", this.$openLevel);\n            this.$openLevel++;\n        }\n    }\n\n    // 注冊事件\n    protected initEvent() {\n        game.on(Game.EVENT_HIDE, () => {\n            // @ts-ignore\n            if (this.resetAccount) {\n                return;\n            }\n            this.saveData()\n        });\n        game.on(Game.EVENT_SHOW, () => {\n            audioManager.gameOnShow();\n        });\n    }\n\n    public saveData() {\n        eventManager.emit(msgcmd.saveDataBefore);\n        let obj = js.createMap(true);;\n        for (let key in this) {\n            if (key.indexOf('$') != -1) {\n                obj[key] = this[key];\n            }\n        }\n        sys.localStorage.setItem(this.$localKey, JSON.stringify(obj));\n        eventManager.emit(msgcmd.saveDataAfter);\n    }\n\n    // 清除账号数据（测试使用）\n    public clearAccountData() {\n        sys.localStorage.removeItem(this.$localKey);\n        // 重新加载一次\n        this.onInit()\n    }\n}\n"]}